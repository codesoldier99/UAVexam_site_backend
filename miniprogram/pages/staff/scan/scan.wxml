<view class="scan-container">
  <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
  <view class="top-bar">
    <view class="staff-card">
      <view class="staff-avatar">
        <text class="avatar-text">{{staffInfo.name ? staffInfo.name.charAt(0) : 'è€ƒ'}}</text>
      </view>
      <view class="staff-details">
        <view class="staff-name">{{staffInfo.name || 'è€ƒè¯•ç®¡ç†å‘˜'}}</view>
        <view class="staff-role">{{staffInfo.role || 'ç›‘è€ƒè€å¸ˆ'}} Â· {{staffInfo.id || 'STAFF_8644'}}</view>
      </view>
    </view>
    <view class="top-actions">
      <view class="action-icon" bindtap="toggleFlash">
        <text class="icon">{{flashOn ? 'ğŸ”¦' : 'ğŸ’¡'}}</text>
      </view>
      <view class="action-icon" bindtap="logout">
        <text class="icon">ğŸšª</text>
      </view>
    </view>
  </view>

  <!-- ä¸»æ‰«ç åŒºåŸŸ -->
  <view class="main-scan-area">
    <view class="scan-header">
      <view class="scan-title">æ‰«æè€ƒç”ŸäºŒç»´ç </view>
      <view class="scan-subtitle">å°†äºŒç»´ç æ”¾å…¥æ¡†å†…å³å¯è‡ªåŠ¨æ‰«æ</view>
    </view>

    <!-- ç›¸æœºé¢„è§ˆåŒºåŸŸ -->
    <view class="camera-wrapper">
      <camera 
        class="camera-preview" 
        device-position="back" 
        flash="{{flashOn ? 'on' : 'off'}}"
        binderror="onCameraError"
        bindstop="onCameraStop"
        bindinitialized="onCameraReady"
        wx:if="{{cameraAuthorized}}"
      ></camera>
      
      <!-- ç›¸æœºæƒé™ç”³è¯· -->
      <view class="camera-permission" wx:else>
        <view class="permission-icon">ğŸ“·</view>
        <view class="permission-title">éœ€è¦ç›¸æœºæƒé™</view>
        <view class="permission-desc">æ‰«æäºŒç»´ç éœ€è¦ä½¿ç”¨ç›¸æœºåŠŸèƒ½</view>
        <button class="permission-btn" bindtap="requestCameraAuth">
          <text class="btn-icon">ğŸ”“</text>
          <text class="btn-text">æˆæƒä½¿ç”¨ç›¸æœº</text>
        </button>
      </view>
      
      <!-- æ‰«ææ¡†æ¶ -->
      <view class="scan-overlay" wx:if="{{cameraAuthorized}}">
        <view class="scan-box">
          <view class="corner corner-tl"></view>
          <view class="corner corner-tr"></view>
          <view class="corner corner-bl"></view>
          <view class="corner corner-br"></view>
          <view class="scan-line {{scanning ? 'scanning' : ''}}"></view>
        </view>
        <view class="scan-tip">è¯·å°†äºŒç»´ç æ”¾å…¥æ¡†å†…</view>
      </view>
    </view>

    <!-- æ‰«ç æŒ‰é’® -->
    <view class="scan-action" wx:if="{{cameraAuthorized}}">
      <button 
        class="scan-button {{scanning ? 'scanning' : ''}} {{processing ? 'processing' : ''}}" 
        bindtap="startScan" 
        disabled="{{scanning || processing}}"
      >
        <view class="button-content">
          <view class="button-icon">
            <text wx:if="{{processing}}">â³</text>
            <text wx:elif="{{scanning}}">â¸ï¸</text>
            <text wx:else>ğŸ“±</text>
          </view>
          <view class="button-text">
            <text wx:if="{{processing}}">å¤„ç†ä¸­...</text>
            <text wx:elif="{{scanning}}">æ‰«æä¸­...</text>
            <text wx:else>ç‚¹å‡»æ‰«æ</text>
          </view>
        </view>
        <view class="button-ripple"></view>
      </button>
    </view>
  </view>

  <!-- å¿«æ·åŠŸèƒ½åŒº -->
  <view class="quick-actions">
    <view class="action-header" bindtap="toggleQuickActions">
      <text class="header-title">å¿«æ·æ“ä½œ</text>
      <text class="header-arrow {{showQuickActions ? 'expanded' : ''}}">â–¼</text>
    </view>
    
    <view class="action-content {{showQuickActions ? 'show' : 'hide'}}">
      <!-- æ‰‹åŠ¨è¾“å…¥ -->
      <view class="manual-input-section">
        <view class="input-wrapper">
          <input 
            class="manual-input" 
            type="text" 
            placeholder="è¾“å…¥è€ƒç”ŸIDæˆ–äºŒç»´ç å†…å®¹"
            value="{{manualInput}}"
            bindinput="onManualInput"
            confirm-type="done"
            bindconfirm="handleManualInput"
          />
          <button 
            class="input-confirm-btn" 
            bindtap="handleManualInput" 
            disabled="{{!manualInput.trim() || processing}}"
          >
            ç¡®è®¤
          </button>
        </view>
      </view>
      
      <!-- å¿«é€Ÿæµ‹è¯• -->
      <view class="quick-test-section">
        <view class="test-label">å¿«é€Ÿæµ‹è¯•</view>
        <view class="test-buttons">
          <button class="test-btn" bindtap="quickTest" data-code="C001">
            <text class="test-name">å¼ ä¸‰</text>
            <text class="test-id">C001</text>
          </button>
          <button class="test-btn" bindtap="quickTest" data-code="C002">
            <text class="test-name">æå››</text>
            <text class="test-id">C002</text>
          </button>
          <button class="test-btn" bindtap="quickTest" data-code="C003">
            <text class="test-name">ç‹äº”</text>
            <text class="test-id">C003</text>
          </button>
        </view>
      </view>
    </view>
  </view>

  <!-- ç»Ÿè®¡å¡ç‰‡ -->
  <view class="stats-card">
    <view class="card-header">
      <text class="card-title">ä»Šæ—¥ç»Ÿè®¡</text>
      <text class="card-date">{{currentDate}}</text>
    </view>
    <view class="stats-grid">
      <view class="stat-item">
        <view class="stat-number primary">{{todayStats.scanned}}</view>
        <view class="stat-label">æ€»æ‰«æ</view>
      </view>
      <view class="stat-item">
        <view class="stat-number success">{{todayStats.checkedIn}}</view>
        <view class="stat-label">æˆåŠŸç­¾åˆ°</view>
      </view>
      <view class="stat-item">
        <view class="stat-number error">{{todayStats.failed}}</view>
        <view class="stat-label">å¤±è´¥æ¬¡æ•°</view>
      </view>
    </view>
  </view>

  <!-- æœ€è¿‘è®°å½• -->
  <view class="recent-records" wx:if="{{recentScans.length > 0}}">
    <view class="records-header" bindtap="toggleRecentRecords">
      <text class="header-title">æœ€è¿‘æ‰«æ</text>
      <view class="header-actions">
        <text class="record-count">{{recentScans.length}}</text>
        <text class="header-arrow {{showRecentRecords ? 'expanded' : ''}}">â–¼</text>
      </view>
    </view>
    
    <view class="records-content {{showRecentRecords ? 'show' : 'hide'}}">
      <view class="record-item" wx:for="{{recentScans}}" wx:key="id" bindtap="viewScanDetail" data-scan="{{item}}">
        <view class="record-avatar">
          <text class="avatar-text">{{item.candidateName.charAt(0)}}</text>
        </view>
        <view class="record-info">
          <view class="record-name">{{item.candidateName}}</view>
          <view class="record-time">{{item.scanTime}}</view>
        </view>
        <view class="record-status {{item.status}}">
          <text class="status-icon">{{item.statusIcon}}</text>
        </view>
      </view>
      
      <view class="view-all-btn" wx:if="{{recentScans.length >= 5}}" bindtap="viewAllRecords">
        <text class="btn-text">æŸ¥çœ‹å…¨éƒ¨è®°å½•</text>
        <text class="btn-arrow">â†’</text>
      </view>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:if="{{recentScans.length === 0}}">
    <view class="empty-icon">ğŸ“‹</view>
    <view class="empty-title">æš‚æ— æ‰«æè®°å½•</view>
    <view class="empty-desc">å¼€å§‹æ‰«æè€ƒç”ŸäºŒç»´ç è¿›è¡Œç­¾åˆ°ç®¡ç†</view>
  </view>
</view>

<!-- æ‰«æç»“æœå¼¹çª— -->
<view class="result-overlay" wx:if="{{showResult}}" bindtap="closeResult">
  <view class="result-modal" catchtap="">
    <view class="result-status">
      <view class="status-icon {{resultData.success ? 'success' : 'error'}}">
        <text class="icon-text">{{resultData.success ? 'âœ“' : 'âœ•'}}</text>
      </view>
      <view class="status-title">{{resultData.success ? 'ç­¾åˆ°æˆåŠŸ' : 'ç­¾åˆ°å¤±è´¥'}}</view>
      <view class="status-message">{{resultData.message}}</view>
    </view>
    
    <view class="result-details" wx:if="{{resultData.candidateInfo}}">
      <view class="detail-item">
        <text class="detail-label">è€ƒç”Ÿå§“å</text>
        <text class="detail-value">{{resultData.candidateInfo.name}}</text>
      </view>
      <view class="detail-item">
        <text class="detail-label">è€ƒè¯•ç§‘ç›®</text>
        <text class="detail-value">{{resultData.candidateInfo.examName}}</text>
      </view>
      <view class="detail-item">
        <text class="detail-label">è€ƒè¯•æ—¶é—´</text>
        <text class="detail-value">{{resultData.candidateInfo.examTime}}</text>
      </view>
      <view class="detail-item">
        <text class="detail-label">è€ƒè¯•åœ°ç‚¹</text>
        <text class="detail-value">{{resultData.candidateInfo.venue}}</text>
      </view>
      <view class="detail-item" wx:if="{{resultData.candidateInfo.checkInTime}}">
        <text class="detail-label">ç­¾åˆ°æ—¶é—´</text>
        <text class="detail-value">{{resultData.candidateInfo.checkInTime}}</text>
      </view>
    </view>
    
    <view class="result-actions">
      <button class="result-btn secondary" bindtap="closeResult">å…³é—­</button>
      <button class="result-btn primary" bindtap="continueScan" wx:if="{{resultData.success}}">ç»§ç»­æ‰«æ</button>
    </view>
  </view>
</view>

<!-- å…¨å±€åŠ è½½é®ç½© -->
<view class="global-loading" wx:if="{{processing}}">
  <view class="loading-spinner">
    <view class="spinner-ring"></view>
    <view class="spinner-ring"></view>
    <view class="spinner-ring"></view>
  </view>
  <view class="loading-text">æ­£åœ¨å¤„ç†...</view>
</view>
