<view class="scan-container">
  <!-- 顶部状态栏 -->
  <view class="top-bar">
    <view class="staff-card">
      <view class="staff-avatar">
        <text class="avatar-text">{{staffInfo.name ? staffInfo.name.charAt(0) : '考'}}</text>
      </view>
      <view class="staff-details">
        <view class="staff-name">{{staffInfo.name || '考试管理员'}}</view>
        <view class="staff-role">{{staffInfo.role || '监考老师'}} · {{staffInfo.id || 'STAFF_8644'}}</view>
      </view>
    </view>
    <view class="top-actions">
      <view class="action-icon" bindtap="toggleFlash">
        <text class="icon">{{flashOn ? '🔦' : '💡'}}</text>
      </view>
      <view class="action-icon" bindtap="logout">
        <text class="icon">🚪</text>
      </view>
    </view>
  </view>

  <!-- 主扫码区域 -->
  <view class="main-scan-area">
    <view class="scan-header">
      <view class="scan-title">扫描考生二维码</view>
      <view class="scan-subtitle">将二维码放入框内即可自动扫描</view>
    </view>

    <!-- 相机预览区域 -->
    <view class="camera-wrapper">
      <camera 
        class="camera-preview" 
        device-position="back" 
        flash="{{flashOn ? 'on' : 'off'}}"
        binderror="onCameraError"
        bindstop="onCameraStop"
        bindinitialized="onCameraReady"
        wx:if="{{cameraAuthorized}}"
      ></camera>
      
      <!-- 相机权限申请 -->
      <view class="camera-permission" wx:else>
        <view class="permission-icon">📷</view>
        <view class="permission-title">需要相机权限</view>
        <view class="permission-desc">扫描二维码需要使用相机功能</view>
        <button class="permission-btn" bindtap="requestCameraAuth">
          <text class="btn-icon">🔓</text>
          <text class="btn-text">授权使用相机</text>
        </button>
      </view>
      
      <!-- 扫描框架 -->
      <view class="scan-overlay" wx:if="{{cameraAuthorized}}">
        <view class="scan-box">
          <view class="corner corner-tl"></view>
          <view class="corner corner-tr"></view>
          <view class="corner corner-bl"></view>
          <view class="corner corner-br"></view>
          <view class="scan-line {{scanning ? 'scanning' : ''}}"></view>
        </view>
        <view class="scan-tip">请将二维码放入框内</view>
      </view>
    </view>

    <!-- 扫码按钮 -->
    <view class="scan-action" wx:if="{{cameraAuthorized}}">
      <button 
        class="scan-button {{scanning ? 'scanning' : ''}} {{processing ? 'processing' : ''}}" 
        bindtap="startScan" 
        disabled="{{scanning || processing}}"
      >
        <view class="button-content">
          <view class="button-icon">
            <text wx:if="{{processing}}">⏳</text>
            <text wx:elif="{{scanning}}">⏸️</text>
            <text wx:else>📱</text>
          </view>
          <view class="button-text">
            <text wx:if="{{processing}}">处理中...</text>
            <text wx:elif="{{scanning}}">扫描中...</text>
            <text wx:else>点击扫描</text>
          </view>
        </view>
        <view class="button-ripple"></view>
      </button>
    </view>
  </view>

  <!-- 快捷功能区 -->
  <view class="quick-actions">
    <view class="action-header" bindtap="toggleQuickActions">
      <text class="header-title">快捷操作</text>
      <text class="header-arrow {{showQuickActions ? 'expanded' : ''}}">▼</text>
    </view>
    
    <view class="action-content {{showQuickActions ? 'show' : 'hide'}}">
      <!-- 手动输入 -->
      <view class="manual-input-section">
        <view class="input-wrapper">
          <input 
            class="manual-input" 
            type="text" 
            placeholder="输入考生ID或二维码内容"
            value="{{manualInput}}"
            bindinput="onManualInput"
            confirm-type="done"
            bindconfirm="handleManualInput"
          />
          <button 
            class="input-confirm-btn" 
            bindtap="handleManualInput" 
            disabled="{{!manualInput.trim() || processing}}"
          >
            确认
          </button>
        </view>
      </view>
      
      <!-- 快速测试 -->
      <view class="quick-test-section">
        <view class="test-label">快速测试</view>
        <view class="test-buttons">
          <button class="test-btn" bindtap="quickTest" data-code="C001">
            <text class="test-name">张三</text>
            <text class="test-id">C001</text>
          </button>
          <button class="test-btn" bindtap="quickTest" data-code="C002">
            <text class="test-name">李四</text>
            <text class="test-id">C002</text>
          </button>
          <button class="test-btn" bindtap="quickTest" data-code="C003">
            <text class="test-name">王五</text>
            <text class="test-id">C003</text>
          </button>
        </view>
      </view>
    </view>
  </view>

  <!-- 统计卡片 -->
  <view class="stats-card">
    <view class="card-header">
      <text class="card-title">今日统计</text>
      <text class="card-date">{{currentDate}}</text>
    </view>
    <view class="stats-grid">
      <view class="stat-item">
        <view class="stat-number primary">{{todayStats.scanned}}</view>
        <view class="stat-label">总扫描</view>
      </view>
      <view class="stat-item">
        <view class="stat-number success">{{todayStats.checkedIn}}</view>
        <view class="stat-label">成功签到</view>
      </view>
      <view class="stat-item">
        <view class="stat-number error">{{todayStats.failed}}</view>
        <view class="stat-label">失败次数</view>
      </view>
    </view>
  </view>

  <!-- 最近记录 -->
  <view class="recent-records" wx:if="{{recentScans.length > 0}}">
    <view class="records-header" bindtap="toggleRecentRecords">
      <text class="header-title">最近扫描</text>
      <view class="header-actions">
        <text class="record-count">{{recentScans.length}}</text>
        <text class="header-arrow {{showRecentRecords ? 'expanded' : ''}}">▼</text>
      </view>
    </view>
    
    <view class="records-content {{showRecentRecords ? 'show' : 'hide'}}">
      <view class="record-item" wx:for="{{recentScans}}" wx:key="id" bindtap="viewScanDetail" data-scan="{{item}}">
        <view class="record-avatar">
          <text class="avatar-text">{{item.candidateName.charAt(0)}}</text>
        </view>
        <view class="record-info">
          <view class="record-name">{{item.candidateName}}</view>
          <view class="record-time">{{item.scanTime}}</view>
        </view>
        <view class="record-status {{item.status}}">
          <text class="status-icon">{{item.statusIcon}}</text>
        </view>
      </view>
      
      <view class="view-all-btn" wx:if="{{recentScans.length >= 5}}" bindtap="viewAllRecords">
        <text class="btn-text">查看全部记录</text>
        <text class="btn-arrow">→</text>
      </view>
    </view>
  </view>

  <!-- 空状态 -->
  <view class="empty-state" wx:if="{{recentScans.length === 0}}">
    <view class="empty-icon">📋</view>
    <view class="empty-title">暂无扫描记录</view>
    <view class="empty-desc">开始扫描考生二维码进行签到管理</view>
  </view>
</view>

<!-- 扫描结果弹窗 -->
<view class="result-overlay" wx:if="{{showResult}}" bindtap="closeResult">
  <view class="result-modal" catchtap="">
    <view class="result-status">
      <view class="status-icon {{resultData.success ? 'success' : 'error'}}">
        <text class="icon-text">{{resultData.success ? '✓' : '✕'}}</text>
      </view>
      <view class="status-title">{{resultData.success ? '签到成功' : '签到失败'}}</view>
      <view class="status-message">{{resultData.message}}</view>
    </view>
    
    <view class="result-details" wx:if="{{resultData.candidateInfo}}">
      <view class="detail-item">
        <text class="detail-label">考生姓名</text>
        <text class="detail-value">{{resultData.candidateInfo.name}}</text>
      </view>
      <view class="detail-item">
        <text class="detail-label">考试科目</text>
        <text class="detail-value">{{resultData.candidateInfo.examName}}</text>
      </view>
      <view class="detail-item">
        <text class="detail-label">考试时间</text>
        <text class="detail-value">{{resultData.candidateInfo.examTime}}</text>
      </view>
      <view class="detail-item">
        <text class="detail-label">考试地点</text>
        <text class="detail-value">{{resultData.candidateInfo.venue}}</text>
      </view>
      <view class="detail-item" wx:if="{{resultData.candidateInfo.checkInTime}}">
        <text class="detail-label">签到时间</text>
        <text class="detail-value">{{resultData.candidateInfo.checkInTime}}</text>
      </view>
    </view>
    
    <view class="result-actions">
      <button class="result-btn secondary" bindtap="closeResult">关闭</button>
      <button class="result-btn primary" bindtap="continueScan" wx:if="{{resultData.success}}">继续扫描</button>
    </view>
  </view>
</view>

<!-- 全局加载遮罩 -->
<view class="global-loading" wx:if="{{processing}}">
  <view class="loading-spinner">
    <view class="spinner-ring"></view>
    <view class="spinner-ring"></view>
    <view class="spinner-ring"></view>
  </view>
  <view class="loading-text">正在处理...</view>
</view>
