# 考点运营与流程管理微信小程序 - 详细模块分析

## 一、模块总览

基于需求文档和现有API分析，微信小程序可划分为以下9个功能模块：

### 核心业务模块（6个）
1. **身份认证模块** - 用户登录和身份验证
2. **考生个人中心模块** - 个人信息展示和管理
3. **动态二维码模块** - 考生身份凭证生成和展示
4. **考试日程模块** - 个人考试安排和排队状态
5. **考务扫码模块** - 考务人员签到操作
6. **公共看板模块** - 实时考场状态广播

### 辅助支持模块（3个）
7. **消息通知模块** - 状态变更和重要提醒
8. **帮助指引模块** - 使用说明和常见问题
9. **系统设置模块** - 个人偏好和应用设置

---

## 二、详细模块分析

### 模块1：身份认证模块（详细设计）

#### 模块作用与重要性
身份认证模块是整个小程序的入口和安全基础，承担着用户身份验证、权限分离、会话管理等核心职责。该模块的设计质量直接影响用户体验和系统安全性。

#### 业务场景分析
1. **考生场景**：考生通过身份证号快速登录，无需记忆复杂账号密码，降低使用门槛
2. **考务人员场景**：考务人员使用管理员分配的专用账号，确保操作权限的严格控制
3. **自动登录场景**：已登录用户再次进入小程序时自动识别身份，提升使用便利性

#### 详细功能设计

##### 1. 页面架构设计
```
app.js (应用入口)
├── pages/auth/
│   ├── role-select/     # 角色选择页
│   ├── candidate-login/ # 考生登录页
│   ├── staff-login/     # 考务登录页
│   ├── login-result/    # 登录结果页
│   └── auto-login/      # 自动登录处理页
```

##### 2. 核心功能实现思路

**2.1 角色选择与路由分发**
```javascript
// 实现思路：智能角色识别
onLaunch() {
  // 检查本地存储的用户信息
  const userInfo = wx.getStorageSync('userInfo');
  const userRole = wx.getStorageSync('userRole');
  
  if (userInfo && userRole) {
    // 自动登录验证
    this.autoLogin(userInfo, userRole);
  } else {
    // 跳转角色选择页
    wx.navigateTo({
      url: '/pages/auth/role-select/index'
    });
  }
}
```

**2.2 考生身份证登录机制**
```javascript
// 考生登录核心逻辑
candidateLogin(idCard) {
  // 1. 前端验证身份证格式
  if (!this.validateIdCard(idCard)) {
    wx.showToast({
      title: '身份证格式不正确',
      icon: 'error'
    });
    return;
  }
  
  // 2. 调用后端API验证
  wx.request({
    url: `${API_BASE}/wx/login-by-idcard`,
    method: 'POST',
    data: { id_card: idCard },
    success: (res) => {
      if (res.statusCode === 200) {
        // 3. 保存用户信息和令牌
        this.saveUserSession(res.data, 'candidate');
        // 4. 绑定微信openid
        this.bindWechatOpenId(res.data.access_token);
        // 5. 跳转到考生主页
        wx.switchTab({
          url: '/pages/candidate/index/index'
        });
      } else {
        this.handleLoginError(res.data);
      }
    }
  });
}
```

**2.3 考务人员账号登录机制**
```javascript
// 考务人员登录核心逻辑
staffLogin(username, password) {
  // 1. 前端基础验证
  if (!username || !password) {
    wx.showToast({
      title: '请输入账号和密码',
      icon: 'error'
    });
    return;
  }
  
  // 2. 调用标准登录接口
  wx.request({
    url: `${API_BASE}/wx/login`,
    method: 'POST',
    data: {
      code: '', // 微信登录code（可选）
      username: username,
      password: password,
      user_type: 'staff'
    },
    success: (res) => {
      if (res.statusCode === 200) {
        // 3. 保存会话信息
        this.saveUserSession(res.data, 'staff');
        // 4. 跳转到考务工作台
        wx.switchTab({
          url: '/pages/staff/workspace/index'
        });
      } else {
        this.handleLoginError(res.data);
      }
    }
  });
}
```

**2.4 自动登录与会话管理**
```javascript
// 自动登录验证机制
autoLogin(userInfo, userRole) {
  // 1. 检查令牌有效性
  wx.request({
    url: `${API_BASE}/wx/health`,
    method: 'GET',
    header: {
      'Authorization': `Bearer ${userInfo.access_token}`
    },
    success: (res) => {
      if (res.statusCode === 200) {
        // 令牌有效，直接跳转对应主页
        this.navigateToHomePage(userRole);
      } else {
        // 令牌失效，清除本地数据，重新登录
        this.clearUserSession();
        wx.navigateTo({
          url: '/pages/auth/role-select/index'
        });
      }
    }
  });
}
```

##### 3. API接口对接详情

**3.1 考生身份证登录接口**
```javascript
// API: POST /wx/login-by-idcard
// 请求参数：
{
  "id_card": "110101199001011234"  // 18位身份证号
}

// 响应数据：
{
  "message": "登录成功",
  "access_token": "candidate_1_1234",
  "candidate_info": {
    "id": 1,
    "name": "张三",
    "id_number": "110101199001011234",
    "phone": "13800138001",
    "exam_product": "无人机驾驶员考试",
    "institution": "北京航空培训中心",
    "status": "待排期"
  },
  "login_time": "2025-08-03T19:45:00"
}
```

**3.2 标准登录接口**
```javascript
// API: POST /wx/login
// 请求参数：
{
  "code": "微信登录code（可选）",
  "id_card": "身份证号（考生用）",
  "username": "用户名（考务用）",
  "password": "密码（考务用）"
}

// 响应数据：
{
  "access_token": "JWT令牌",
  "token_type": "bearer",
  "candidate_id": 1,  // 考生ID（考生登录时）
  "candidate_name": "张三",
  "phone": "13800138001",
  "status": "已排期"
}
```

**3.3 健康检查接口**
```javascript
// API: GET /wx/health
// 用途：验证服务可用性和令牌有效性
// 响应数据：
{
  "status": "healthy",
  "service": "微信小程序服务",
  "version": "1.0.0",
  "features": ["考生登录", "信息查询", "签到功能"]
}
```

##### 4. 技术实现细节

**4.1 身份证号验证算法**
```javascript
// 身份证号格式验证
validateIdCard(idCard) {
  // 基础格式检查
  if (!/^\d{17}[\dXx]$/.test(idCard)) {
    return false;
  }
  
  // 校验码验证
  const weights = [7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2];
  const checkCodes = ['1', '0', 'X', '9', '8', '7', '6', '5', '4', '3', '2'];
  
  let sum = 0;
  for (let i = 0; i < 17; i++) {
    sum += parseInt(idCard[i]) * weights[i];
  }
  
  const checkCode = checkCodes[sum % 11];
  return checkCode === idCard[17].toUpperCase();
}
```

**4.2 会话状态管理**
```javascript
// 用户会话管理工具类
class SessionManager {
  // 保存用户会话
  static saveUserSession(userData, userRole) {
    wx.setStorageSync('userInfo', userData);
    wx.setStorageSync('userRole', userRole);
    wx.setStorageSync('loginTime', new Date().getTime());
    
    // 设置全局请求头
    wx.setStorageSync('authToken', userData.access_token);
  }
  
  // 清除用户会话
  static clearUserSession() {
    wx.removeStorageSync('userInfo');
    wx.removeStorageSync('userRole');
    wx.removeStorageSync('loginTime');
    wx.removeStorageSync('authToken');
  }
  
  // 检查会话有效性
  static isSessionValid() {
    const loginTime = wx.getStorageSync('loginTime');
    const currentTime = new Date().getTime();
    const sessionTimeout = 24 * 60 * 60 * 1000; // 24小时
    
    return loginTime && (currentTime - loginTime < sessionTimeout);
  }
}
```

**4.3 微信OpenID绑定机制**
```javascript
// 绑定微信OpenID
bindWechatOpenId(accessToken) {
  wx.login({
    success: (res) => {
      if (res.code) {
        // 将微信code发送到后端进行OpenID绑定
        wx.request({
          url: `${API_BASE}/wx/bind-openid`,
          method: 'POST',
          header: {
            'Authorization': `Bearer ${accessToken}`
          },
          data: {
            wx_code: res.code
          },
          success: (bindRes) => {
            console.log('OpenID绑定成功', bindRes.data);
          }
        });
      }
    }
  });
}
```

##### 5. 用户体验优化

**5.1 加载状态管理**
```javascript
// 登录过程中的用户反馈
showLoginLoading() {
  wx.showLoading({
    title: '登录中...',
    mask: true
  });
}

hideLoginLoading() {
  wx.hideLoading();
}
```

**5.2 错误处理与用户提示**
```javascript
// 统一的错误处理机制
handleLoginError(errorData) {
  const errorMessages = {
    400: '输入信息格式不正确',
    404: '未找到该考生信息，请联系培训机构',
    403: '账号状态异常，无法登录',
    500: '系统繁忙，请稍后重试'
  };
  
  const message = errorMessages[errorData.status_code] || errorData.detail || '登录失败';
  
  wx.showModal({
    title: '登录失败',
    content: message,
    showCancel: false,
    confirmText: '确定'
  });
}
```

##### 6. 安全性考虑

**6.1 数据传输安全**
- 所有API请求使用HTTPS加密传输
- 敏感信息（如身份证号）在传输前进行基础验证
- 访问令牌采用JWT格式，包含过期时间

**6.2 本地存储安全**
- 敏感信息加密存储在本地
- 定期清理过期的会话数据
- 防止信息泄露的安全措施

**6.3 防重放攻击**
```javascript
// 请求防重复提交
let isSubmitting = false;

submitLogin() {
  if (isSubmitting) {
    wx.showToast({
      title: '请勿重复提交',
      icon: 'error'
    });
    return;
  }
  
  isSubmitting = true;
  
  // 执行登录逻辑
  this.performLogin().finally(() => {
    isSubmitting = false;
  });
}
```

##### 7. 数据流转详细设计

```
用户进入小程序
    ↓
检查本地会话状态
    ↓
[有效会话] → 自动登录验证 → [成功] → 跳转对应主页
    ↓                      ↓
[无效/无会话]              [失败] → 清除本地数据
    ↓                      ↓
显示角色选择页面 ←----------┘
    ↓
[考生] → 身份证登录页 → 输入身份证 → API验证 → 保存会话 → 考生主页
    ↓
[考务] → 账号登录页 → 输入账号密码 → API验证 → 保存会话 → 考务工作台
```

##### 8. 性能优化策略

**8.1 页面预加载**
```javascript
// 在角色选择页预加载后续页面
onReady() {
  // 预加载考生登录页
  wx.preloadPage({
    url: '/pages/auth/candidate-login/index'
  });
  
  // 预加载考务登录页
  wx.preloadPage({
    url: '/pages/auth/staff-login/index'
  });
}
```

**8.2 网络请求优化**
```javascript
// 网络请求封装，支持重试和缓存
class NetworkManager {
  static async request(options, retryCount = 3) {
    try {
      const response = await wx.request(options);
      return response;
    } catch (error) {
      if (retryCount > 0) {
        await this.delay(1000); // 延迟1秒重试
        return this.request(options, retryCount - 1);
      }
      throw error;
    }
  }
  
  static delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}
```

#### 模块总结
身份认证模块作为整个小程序的入口，需要在安全性、易用性、性能等方面做到平衡。通过双重登录机制（考生身份证登录 + 考务账号登录）、自动登录、会话管理等功能，为不同角色用户提供便捷而安全的身份验证服务。该模块的成功实现将为后续所有功能模块奠定坚实的基础。
# 考点运营与流程管理微信小程序 - 详细模块分析

## 一、模块总览

基于需求文档和现有API分析，微信小程序可划分为以下9个功能模块：

### 核心业务模块（6个）
1. **身份认证模块** - 用户登录和身份验证
2. **考生个人中心模块** - 个人信息展示和管理
3. **动态二维码模块** - 考生身份凭证生成和展示
4. **考试日程模块** - 个人考试安排和排队状态
5. **考务扫码模块** - 考务人员签到操作
6. **公共看板模块** - 实时考场状态广播

### 辅助支持模块（3个）
7. **消息通知模块** - 状态变更和重要提醒
8. **帮助指引模块** - 使用说明和常见问题
9. **系统设置模块** - 个人偏好和应用设置

---

## 二、详细模块分析

# 考点运营与流程管理微信小程序 - 详细模块分析

## 一、模块总览

基于需求文档和现有API分析，微信小程序可划分为以下9个功能模块：

### 核心业务模块（6个）
1. **身份认证模块** - 用户登录和身份验证
2. **考生个人中心模块** - 个人信息展示和管理
3. **动态二维码模块** - 考生身份凭证生成和展示
4. **考试日程模块** - 个人考试安排和排队状态
5. **考务扫码模块** - 考务人员签到操作
6. **公共看板模块** - 实时考场状态广播

### 辅助支持模块（3个）
7. **消息通知模块** - 状态变更和重要提醒
8. **帮助指引模块** - 使用说明和常见问题
9. **系统设置模块** - 个人偏好和应用设置

---

## 二、详细模块分析

### 模块1：身份认证模块

#### 功能描述
为考生和考务人员提供不同的登录方式，实现身份验证和权限分离。

#### 页面设计
- **登录选择页** - 用户角色选择（考生/考务人员）
- **考生登录页** - 身份证号快速登录
- **考务登录页** - 账号密码登录
- **登录结果页** - 登录成功/失败反馈

#### 核心功能点
1. **考生登录流程**：
   - 输入18位身份证号码
   - 系统验证身份证格式和考生信息
   - 绑定微信openid实现后续自动登录
   - 返回考生基本信息和访问令牌

2. **考务人员登录流程**：
   - 使用管理员分配的账号密码
   - 验证考务人员身份和权限
   - 进入考务工作台

3. **自动登录机制**：
   - 检测已绑定的微信用户
   - 自动跳转到对应角色的主页面

#### 对接API
- `POST /wx/login-by-idcard` - 考生身份证登录
- `POST /wx/login` - 标准登录接口
- `GET /wx/health` - 服务健康检查

#### 数据流转
```
用户输入 → 身份验证 → 角色判断 → 生成令牌 → 跳转主页
```

---

### 模块2：考生个人中心模块（详细设计）

#### 模块作用与重要性
考生个人中心模块是考生了解自身考试状态、查看个人信息的核心入口。该模块承担着信息展示、状态跟踪、用户引导等重要职责，是提升考生体验和减少咨询压力的关键模块。

#### 业务场景分析
1. **信息查询场景**：考生需要快速了解自己的基本信息、考试产品、培训机构等
2. **状态跟踪场景**：考生关心当前考试进度，下一步需要做什么
3. **问题排查场景**：当考生遇到问题时，需要通过个人信息进行自助排查

#### 详细功能设计

##### 1. 页面架构设计
```
pages/candidate/
├── profile/
│   ├── index/           # 个人中心主页
│   ├── basic-info/      # 基本信息详情页
│   ├── exam-info/       # 考试信息详情页
│   ├── status-track/    # 状态跟踪页
│   └── progress-guide/  # 进度指引页
```

##### 2. 核心功能实现思路

**2.1 个人信息数据获取与缓存**
```javascript
// 个人信息管理类
class CandidateProfileManager {
  constructor() {
    this.candidateId = wx.getStorageSync('userInfo').candidate_id;
    this.profileData = null;
    this.lastUpdateTime = 0;
    this.cacheExpireTime = 5 * 60 * 1000; // 5分钟缓存
  }
  
  // 获取考生详细信息
  async getCandidateInfo(forceRefresh = false) {
    // 检查缓存有效性
    if (!forceRefresh && this.profileData && 
        (Date.now() - this.lastUpdateTime < this.cacheExpireTime)) {
      return this.profileData;
    }
    
    try {
      wx.showLoading({ title: '加载中...' });
      
      const response = await wx.request({
        url: `${API_BASE}/wx/candidate-info/${this.candidateId}`,
        method: 'GET',
        header: {
          'Authorization': `Bearer ${wx.getStorageSync('authToken')}`
        }
      });
      
      if (response.statusCode === 200) {
        this.profileData = response.data.data;
        this.lastUpdateTime = Date.now();
        
        // 缓存到本地存储
        wx.setStorageSync('candidateProfile', this.profileData);
        
        return this.profileData;
      } else {
        throw new Error(response.data.detail || '获取信息失败');
      }
    } catch (error) {
      // 网络异常时使用本地缓存
      const cachedData = wx.getStorageSync('candidateProfile');
      if (cachedData) {
        console.warn('使用缓存数据:', error.message);
        return cachedData;
      }
      throw error;
    } finally {
      wx.hideLoading();
    }
  }
}
```

**2.2 信息展示与数据处理**
```javascript
// 个人中心页面逻辑
Page({
  data: {
    candidateInfo: {},
    statusConfig: {
      '待排期': { color: '#ff9500', icon: 'clock' },
      '已排期': { color: '#007aff', icon: 'calendar' },
      '考试中': { color: '#34c759', icon: 'play' },
      '已完成': { color: '#8e8e93', icon: 'checkmark' }
    },
    loading: true,
    error: null
  },
  
  async onLoad() {
    await this.loadCandidateInfo();
  },
  
  async onPullDownRefresh() {
    await this.loadCandidateInfo(true);
    wx.stopPullDownRefresh();
  },
  
  // 加载考生信息
  async loadCandidateInfo(forceRefresh = false) {
    try {
      this.setData({ loading: true, error: null });
      
      const profileManager = new CandidateProfileManager();
      const candidateInfo = await profileManager.getCandidateInfo(forceRefresh);
      
      // 数据处理和格式化
      const processedInfo = this.processCandidateInfo(candidateInfo);
      
      this.setData({
        candidateInfo: processedInfo,
        loading: false
      });
      
    } catch (error) {
      console.error('加载考生信息失败:', error);
      this.setData({
        error: error.message,
        loading: false
      });
      
      wx.showToast({
        title: '加载失败，请重试',
        icon: 'error'
      });
    }
  },
  
  // 数据处理和格式化
  processCandidateInfo(rawData) {
    return {
      // 基本信息处理
      basicInfo: {
        name: rawData.name,
        idNumber: this.maskIdNumber(rawData.id_number),
        phone: this.maskPhone(rawData.phone),
        email: rawData.email || '未填写',
        registrationDate: this.formatDate(rawData.registration_date),
        status: rawData.status
      },
      
      // 考试信息处理
      examInfo: {
        product: rawData.exam_product,
        institution: rawData.institution,
        institutionId: rawData.institution_id
      },
      
      // 状态信息处理
      statusInfo: {
        current: rawData.status,
        nextStep: this.getNextStepGuide(rawData.status),
        progress: this.calculateProgress(rawData.status),
        upcomingSchedules: rawData.upcoming_schedules || []
      }
    };
  }
}
```

**2.3 敏感信息脱敏处理**
```javascript
// 数据脱敏工具方法
const DataMaskUtils = {
  // 身份证号脱敏
  maskIdNumber(idNumber) {
    if (!idNumber || idNumber.length !== 18) return idNumber;
    return idNumber.substring(0, 6) + '****' + idNumber.substring(14);
  },
  
  // 手机号脱敏
  maskPhone(phone) {
    if (!phone || phone.length !== 11) return phone;
    return phone.substring(0, 3) + '****' + phone.substring(7);
  },
  
  // 邮箱脱敏
  maskEmail(email) {
    if (!email || !email.includes('@')) return email;
    const [username, domain] = email.split('@');
    const maskedUsername = username.length > 2 
      ? username.substring(0, 2) + '***' 
      : username;
    return maskedUsername + '@' + domain;
  }
};
```

##### 3. API接口对接详情

**3.1 考生详细信息接口**
```javascript
// API: GET /wx/candidate-info/{candidate_id}
// 请求头：Authorization: Bearer {access_token}

// 响应数据结构：
{
  "message": "考生信息获取成功",
  "data": {
    "id": 1,
    "name": "张三",
    "id_number": "110101199001011234",
    "phone": "13800138001",
    "email": "zhangsan@example.com",
    "exam_product": "无人机驾驶员考试",
    "institution": "北京航空培训中心",
    "institution_id": 1,
    "status": "已排期",
    "registration_date": "2025-08-01",
    "upcoming_schedules": [
      {
        "id": 1,
        "activity_name": "理论考试",
        "exam_date": "2025-08-15",
        "start_time": "09:00",
        "end_time": "10:30",
        "venue": "理论考场A",
        "status": "scheduled"
      }
    ],
    "current_queue_info": {
      "venue": "实操场地1",
      "position": 3,
      "estimated_wait_time": "约45分钟"
    }
  }
}
```

##### 4. 用户界面设计

**4.1 个人中心主页布局**
```xml
<!-- 个人中心主页模板 -->
<view class="profile-container">
  <!-- 头部信息卡片 -->
  <view class="profile-header">
    <view class="avatar-section">
      <image class="avatar" src="{{candidateInfo.avatar || '/images/default-avatar.png'}}" />
      <view class="status-badge status-{{candidateInfo.basicInfo.status}}">
        {{candidateInfo.basicInfo.status}}
      </view>
    </view>
    
    <view class="basic-info">
      <text class="name">{{candidateInfo.basicInfo.name}}</text>
      <text class="id-number">{{candidateInfo.basicInfo.idNumber}}</text>
      <text class="phone">{{candidateInfo.basicInfo.phone}}</text>
    </view>
  </view>
  
  <!-- 考试信息卡片 -->
  <view class="exam-info-card">
    <view class="card-title">考试信息</view>
    <view class="info-item">
      <text class="label">考试产品：</text>
      <text class="value">{{candidateInfo.examInfo.product}}</text>
    </view>
    <view class="info-item">
      <text class="label">培训机构：</text>
      <text class="value">{{candidateInfo.examInfo.institution}}</text>
    </view>
    <view class="info-item">
      <text class="label">报名时间：</text>
      <text class="value">{{candidateInfo.basicInfo.registrationDate}}</text>
    </view>
  </view>
  
  <!-- 状态跟踪卡片 -->
  <view class="status-track-card">
    <view class="card-title">考试进度</view>
    <view class="progress-bar">
      <view class="progress-fill" style="width: {{candidateInfo.statusInfo.progress}}%"></view>
    </view>
    <view class="next-step">
      <text class="step-title">下一步：</text>
      <text class="step-content">{{candidateInfo.statusInfo.nextStep}}</text>
    </view>
  </view>
  
  <!-- 功能入口 -->
  <view class="function-entries">
    <navigator url="/pages/candidate/schedule/index" class="entry-item">
      <image class="entry-icon" src="/images/schedule-icon.png" />
      <text class="entry-text">考试安排</text>
    </navigator>
    
    <navigator url="/pages/candidate/qrcode/index" class="entry-item">
      <image class="entry-icon" src="/images/qrcode-icon.png" />
      <text class="entry-text">我的二维码</text>
    </navigator>
    
    <navigator url="/pages/public/venues/index" class="entry-item">
      <image class="entry-icon" src="/images/venues-icon.png" />
      <text class="entry-text">考场状态</text>
    </navigator>
  </view>
</view>
```

**4.2 状态指示与进度计算**
```javascript
// 状态处理工具类
class StatusManager {
  // 获取下一步操作指引
  static getNextStepGuide(currentStatus) {
    const stepGuides = {
      '待排期': '请耐心等待考务管理员为您安排考试时间',
      '已排期': '请查看考试安排，准时参加考试',
      '考试中': '请按照考务人员指引完成考试流程',
      '已完成': '考试已完成，请等待成绩公布'
    };
    
    return stepGuides[currentStatus] || '请联系培训机构了解详情';
  }
  
  // 计算考试进度百分比
  static calculateProgress(currentStatus) {
    const progressMap = {
      '待排期': 25,
      '已排期': 50,
      '考试中': 75,
      '已完成': 100
    };
    
    return progressMap[currentStatus] || 0;
  }
  
  // 获取状态颜色配置
  static getStatusColor(status) {
    const colorMap = {
      '待排期': '#ff9500',
      '已排期': '#007aff',
      '考试中': '#34c759',
      '已完成': '#8e8e93'
    };
    
    return colorMap[status] || '#8e8e93';
  }
}
```

##### 5. 交互体验优化

**5.1 下拉刷新与上拉加载**
```javascript
// 下拉刷新实现
onPullDownRefresh() {
  this.loadCandidateInfo(true).then(() => {
    wx.stopPullDownRefresh();
    wx.showToast({
      title: '刷新成功',
      icon: 'success',
      duration: 1500
    });
  });
},

// 页面显示时自动刷新
onShow() {
  // 如果数据超过5分钟，自动刷新
  const lastUpdate = wx.getStorageSync('profileLastUpdate') || 0;
  if (Date.now() - lastUpdate > 5 * 60 * 1000) {
    this.loadCandidateInfo(true);
  }
}
```

**5.2 错误处理与重试机制**
```javascript
// 错误处理组件
const ErrorHandler = {
  // 显示错误信息
  showError(error, retryCallback) {
    wx.showModal({
      title: '加载失败',
      content: error.message || '网络异常，请检查网络连接',
      confirmText: '重试',
      cancelText: '取消',
      success: (res) => {
        if (res.confirm && retryCallback) {
          retryCallback();
        }
      }
    });
  },
  
  // 网络状态检查
  checkNetworkStatus() {
    return new Promise((resolve) => {
      wx.getNetworkType({
        success: (res) => {
          if (res.networkType === 'none') {
            wx.showToast({
              title: '网络连接异常',
              icon: 'error'
            });
            resolve(false);
          } else {
            resolve(true);
          }
        }
      });
    });
  }
};
```

##### 6. 数据同步与状态管理

**6.1 全局状态同步**
```javascript
// 全局状态管理
const GlobalState = {
  candidateInfo: null,
  
  // 更新考生信息
  updateCandidateInfo(newInfo) {
    this.candidateInfo = newInfo;
    
    // 通知其他页面更新
    wx.$emit('candidateInfoUpdated', newInfo);
    
    // 更新本地存储
    wx.setStorageSync('candidateProfile', newInfo);
  },
  
  // 获取考生信息
  getCandidateInfo() {
    if (!this.candidateInfo) {
      this.candidateInfo = wx.getStorageSync('candidateProfile');
    }
    return this.candidateInfo;
  }
};
```

**6.2 数据变更监听**
```javascript
// 页面数据变更监听
onLoad() {
  // 监听考生信息更新事件
  wx.$on('candidateInfoUpdated', (newInfo) => {
    this.setData({
      candidateInfo: this.processCandidateInfo(newInfo)
    });
  });
  
  // 监听考试状态变更
  wx.$on('examStatusChanged', (newStatus) => {
    this.updateExamStatus(newStatus);
  });
},

onUnload() {
  // 清理事件监听
  wx.$off('candidateInfoUpdated');
  wx.$off('examStatusChanged');
}
```

##### 7. 性能优化策略

**7.1 图片懒加载**
```javascript
// 图片懒加载实现
const ImageLazyLoader = {
  // 观察器实例
  observer: null,
  
  // 初始化懒加载
  init() {
    this.observer = wx.createIntersectionObserver();
    
    this.observer.relativeToViewport().observe('.lazy-image', (res) => {
      if (res.intersectionRatio > 0) {
        // 图片进入视口，开始加载
        const dataset = res.target.dataset;
        if (dataset.src) {
          res.target.src = dataset.src;
          res.target.classList.remove('lazy-image');
        }
      }
    });
  },
  
  // 销毁观察器
  destroy() {
    if (this.observer) {
      this.observer.disconnect();
    }
  }
};
```

**7.2 数据预加载**
```javascript
// 相关数据预加载
preloadRelatedData() {
  // 预加载考试安排数据
  wx.request({
    url: `${API_BASE}/wx/candidate-info/${this.candidateId}`,
    method: 'GET',
    header: {
      'Authorization': `Bearer ${wx.getStorageSync('authToken')}`
    },
    success: (res) => {
      // 缓存预加载的数据
      wx.setStorageSync('preloadedSchedules', res.data.upcoming_schedules);
    }
  });
}
```

#### 模块总结
考生个人中心模块通过清晰的信息展示、智能的状态跟踪、友好的交互体验，为考生提供了全面的个人信息管理功能。该模块不仅展示静态信息，更重要的是通过状态跟踪和进度指引，帮助考生了解当前所处的考试阶段和下一步操作，大大减少了考生的困惑和咨询需求。通过合理的缓存策略和性能优化，确保了良好的用户体验。
# 考点运营与流程管理微信小程序 - 详细模块分析

## 一、模块总览

基于需求文档和现有API分析，微信小程序可划分为以下9个功能模块：

### 核心业务模块（6个）
1. **身份认证模块** - 用户登录和身份验证
2. **考生个人中心模块** - 个人信息展示和管理
3. **动态二维码模块** - 考生身份凭证生成和展示
4. **考试日程模块** - 个人考试安排和排队状态
5. **考务扫码模块** - 考务人员签到操作
6. **公共看板模块** - 实时考场状态广播

### 辅助支持模块（3个）
7. **消息通知模块** - 状态变更和重要提醒
8. **帮助指引模块** - 使用说明和常见问题
9. **系统设置模块** - 个人偏好和应用设置

---

## 二、详细模块分析

### 模块1：身份认证模块（详细设计）

#### 模块作用与重要性
身份认证模块是整个小程序的入口和安全基础，承担着用户身份验证、权限分离、会话管理等核心职责。该模块的设计质量直接影响用户体验和系统安全性。

#### 业务场景分析
1. **考生场景**：考生通过身份证号快速登录，无需记忆复杂账号密码，降低使用门槛
2. **考务人员场景**：考务人员使用管理员分配的专用账号，确保操作权限的严格控制
3. **自动登录场景**：已登录用户再次进入小程序时自动识别身份，提升使用便利性

#### 详细功能设计

##### 1. 页面架构设计
```
app.js (应用入口)
├── pages/auth/
│   ├── role-select/     # 角色选择页
│   ├── candidate-login/ # 考生登录页
│   ├── staff-login/     # 考务登录页
│   ├── login-result/    # 登录结果页
│   └── auto-login/      # 自动登录处理页
```

##### 2. 核心功能实现思路

**2.1 角色选择与路由分发**
```javascript
// 实现思路：智能角色识别
onLaunch() {
  // 检查本地存储的用户信息
  const userInfo = wx.getStorageSync('userInfo');
  const userRole = wx.getStorageSync('userRole');
  
  if (userInfo && userRole) {
    // 自动登录验证
    this.autoLogin(userInfo, userRole);
  } else {
    // 跳转角色选择页
    wx.navigateTo({
      url: '/pages/auth/role-select/index'
    });
  }
}
```

**2.2 考生身份证登录机制**
```javascript
// 考生登录核心逻辑
candidateLogin(idCard) {
  // 1. 前端验证身份证格式
  if (!this.validateIdCard(idCard)) {
    wx.showToast({
      title: '身份证格式不正确',
      icon: 'error'
    });
    return;
  }
  
  // 2. 调用后端API验证
  wx.request({
    url: `${API_BASE}/wx/login-by-idcard`,
    method: 'POST',
    data: { id_card: idCard },
    success: (res) => {
      if (res.statusCode === 200) {
        // 3. 保存用户信息和令牌
        this.saveUserSession(res.data, 'candidate');
        // 4. 绑定微信openid
        this.bindWechatOpenId(res.data.access_token);
        // 5. 跳转到考生主页
        wx.switchTab({
          url: '/pages/candidate/index/index'
        });
      } else {
        this.handleLoginError(res.data);
      }
    }
  });
}
```

**2.3 考务人员账号登录机制**
```javascript
// 考务人员登录核心逻辑
staffLogin(username, password) {
  // 1. 前端基础验证
  if (!username || !password) {
    wx.showToast({
      title: '请输入账号和密码',
      icon: 'error'
    });
    return;
  }
  
  // 2. 调用标准登录接口
  wx.request({
    url: `${API_BASE}/wx/login`,
    method: 'POST',
    data: {
      code: '', // 微信登录code（可选）
      username: username,
      password: password,
      user_type: 'staff'
    },
    success: (res) => {
      if (res.statusCode === 200) {
        // 3. 保存会话信息
        this.saveUserSession(res.data, 'staff');
        // 4. 跳转到考务工作台
        wx.switchTab({
          url: '/pages/staff/workspace/index'
        });
      } else {
        this.handleLoginError(res.data);
      }
    }
  });
}
```

**2.4 自动登录与会话管理**
```javascript
// 自动登录验证机制
autoLogin(userInfo, userRole) {
  // 1. 检查令牌有效性
  wx.request({
    url: `${API_BASE}/wx/health`,
    method: 'GET',
    header: {
      'Authorization': `Bearer ${userInfo.access_token}`
    },
    success: (res) => {
      if (res.statusCode === 200) {
        // 令牌有效，直接跳转对应主页
        this.navigateToHomePage(userRole);
      } else {
        // 令牌失效，清除本地数据，重新登录
        this.clearUserSession();
        wx.navigateTo({
          url: '/pages/auth/role-select/index'
        });
      }
    }
  });
}
```

##### 3. API接口对接详情

**3.1 考生身份证登录接口**
```javascript
// API: POST /wx/login-by-idcard
// 请求参数：
{
  "id_card": "110101199001011234"  // 18位身份证号
}

// 响应数据：
{
  "message": "登录成功",
  "access_token": "candidate_1_1234",
  "candidate_info": {
    "id": 1,
    "name": "张三",
    "id_number": "110101199001011234",
    "phone": "13800138001",
    "exam_product": "无人机驾驶员考试",
    "institution": "北京航空培训中心",
    "status": "待排期"
  },
  "login_time": "2025-08-03T19:45:00"
}
```

**3.2 标准登录接口**
```javascript
// API: POST /wx/login
// 请求参数：
{
  "code": "微信登录code（可选）",
  "id_card": "身份证号（考生用）",
  "username": "用户名（考务用）",
  "password": "密码（考务用）"
}

// 响应数据：
{
  "access_token": "JWT令牌",
  "token_type": "bearer",
  "candidate_id": 1,  // 考生ID（考生登录时）
  "candidate_name": "张三",
  "phone": "13800138001",
  "status": "已排期"
}
```

**3.3 健康检查接口**
```javascript
// API: GET /wx/health
// 用途：验证服务可用性和令牌有效性
// 响应数据：
{
  "status": "healthy",
  "service": "微信小程序服务",
  "version": "1.0.0",
  "features": ["考生登录", "信息查询", "签到功能"]
}
```

##### 4. 技术实现细节

**4.1 身份证号验证算法**
```javascript
// 身份证号格式验证
validateIdCard(idCard) {
  // 基础格式检查
  if (!/^\d{17}[\dXx]$/.test(idCard)) {
    return false;
  }
  
  // 校验码验证
  const weights = [7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2];
  const checkCodes = ['1', '0', 'X', '9', '8', '7', '6', '5', '4', '3', '2'];
  
  let sum = 0;
  for (let i = 0; i < 17; i++) {
    sum += parseInt(idCard[i]) * weights[i];
  }
  
  const checkCode = checkCodes[sum % 11];
  return checkCode === idCard[17].toUpperCase();
}
```

**4.2 会话状态管理**
```javascript
// 用户会话管理工具类
class SessionManager {
  // 保存用户会话
  static saveUserSession(userData, userRole) {
    wx.setStorageSync('userInfo', userData);
    wx.setStorageSync('userRole', userRole);
    wx.setStorageSync('loginTime', new Date().getTime());
    
    // 设置全局请求头
    wx.setStorageSync('authToken', userData.access_token);
  }
  
  // 清除用户会话
  static clearUserSession() {
    wx.removeStorageSync('userInfo');
    wx.removeStorageSync('userRole');
    wx.removeStorageSync('loginTime');
    wx.removeStorageSync('authToken');
  }
  
  // 检查会话有效性
  static isSessionValid() {
    const loginTime = wx.getStorageSync('loginTime');
    const currentTime = new Date().getTime();
    const sessionTimeout = 24 * 60 * 60 * 1000; // 24小时
    
    return loginTime && (currentTime - loginTime < sessionTimeout);
  }
}
```

**4.3 微信OpenID绑定机制**
```javascript
// 绑定微信OpenID
bindWechatOpenId(accessToken) {
  wx.login({
    success: (res) => {
      if (res.code) {
        // 将微信code发送到后端进行OpenID绑定
        wx.request({
          url: `${API_BASE}/wx/bind-openid`,
          method: 'POST',
          header: {
            'Authorization': `Bearer ${accessToken}`
          },
          data: {
            wx_code: res.code
          },
          success: (bindRes) => {
            console.log('OpenID绑定成功', bindRes.data);
          }
        });
      }
    }
  });
}
```

##### 5. 用户体验优化

**5.1 加载状态管理**
```javascript
// 登录过程中的用户反馈
showLoginLoading() {
  wx.showLoading({
    title: '登录中...',
    mask: true
  });
}

hideLoginLoading() {
  wx.hideLoading();
}
```

**5.2 错误处理与用户提示**
```javascript
// 统一的错误处理机制
handleLoginError(errorData) {
  const errorMessages = {
    400: '输入信息格式不正确',
    404: '未找到该考生信息，请联系培训机构',
    403: '账号状态异常，无法登录',
    500: '系统繁忙，请稍后重试'
  };
  
  const message = errorMessages[errorData.status_code] || errorData.detail || '登录失败';
  
  wx.showModal({
    title: '登录失败',
    content: message,
    showCancel: false,
    confirmText: '确定'
  });
}
```

##### 6. 安全性考虑

**6.1 数据传输安全**
- 所有API请求使用HTTPS加密传输
- 敏感信息（如身份证号）在传输前进行基础验证
- 访问令牌采用JWT格式，包含过期时间

**6.2 本地存储安全**
- 敏感信息加密存储在本地
- 定期清理过期的会话数据
- 防止信息泄露的安全措施

**6.3 防重放攻击**
```javascript
// 请求防重复提交
let isSubmitting = false;

submitLogin() {
  if (isSubmitting) {
    wx.showToast({
      title: '请勿重复提交',
      icon: 'error'
    });
    return;
  }
  
  isSubmitting = true;
  
  // 执行登录逻辑
  this.performLogin().finally(() => {
    isSubmitting = false;
  });
}
```

##### 7. 数据流转详细设计

```
用户进入小程序
    ↓
检查本地会话状态
    ↓
[有效会话] → 自动登录验证 → [成功] → 跳转对应主页
    ↓                      ↓
[无效/无会话]              [失败] → 清除本地数据
    ↓                      ↓
显示角色选择页面 ←----------┘
    ↓
[考生] → 身份证登录页 → 输入身份证 → API验证 → 保存会话 → 考生主页
    ↓
[考务] → 账号登录页 → 输入账号密码 → API验证 → 保存会话 → 考务工作台
```

##### 8. 性能优化策略

**8.1 页面预加载**
```javascript
// 在角色选择页预加载后续页面
onReady() {
  // 预加载考生登录页
  wx.preloadPage({
    url: '/pages/auth/candidate-login/index'
  });
  
  // 预加载考务登录页
  wx.preloadPage({
    url: '/pages/auth/staff-login/index'
  });
}
```

**8.2 网络请求优化**
```javascript
// 网络请求封装，支持重试和缓存
class NetworkManager {
  static async request(options, retryCount = 3) {
    try {
      const response = await wx.request(options);
      return response;
    } catch (error) {
      if (retryCount > 0) {
        await this.delay(1000); // 延迟1秒重试
        return this.request(options, retryCount - 1);
      }
      throw error;
    }
  }
  
  static delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}
```

#### 模块总结
身份认证模块作为整个小程序的入口，需要在安全性、易用性、性能等方面做到平衡。通过双重登录机制（考生身份证登录 + 考务账号登录）、自动登录、会话管理等功能，为不同角色用户提供便捷而安全的身份验证服务。该模块的成功实现将为后续所有功能模块奠定坚实的基础。
# 考点运营与流程管理微信小程序 - 详细模块分析

## 一、模块总览

基于需求文档和现有API分析，微信小程序可划分为以下9个功能模块：

### 核心业务模块（6个）
1. **身份认证模块** - 用户登录和身份验证
2. **考生个人中心模块** - 个人信息展示和管理
3. **动态二维码模块** - 考生身份凭证生成和展示
4. **考试日程模块** - 个人考试安排和排队状态
5. **考务扫码模块** - 考务人员签到操作
6. **公共看板模块** - 实时考场状态广播

### 辅助支持模块（3个）
7. **消息通知模块** - 状态变更和重要提醒
8. **帮助指引模块** - 使用说明和常见问题
9. **系统设置模块** - 个人偏好和应用设置

---

## 二、详细模块分析

# 考点运营与流程管理微信小程序 - 详细模块分析

## 一、模块总览

基于需求文档和现有API分析，微信小程序可划分为以下9个功能模块：

### 核心业务模块（6个）
1. **身份认证模块** - 用户登录和身份验证
2. **考生个人中心模块** - 个人信息展示和管理
3. **动态二维码模块** - 考生身份凭证生成和展示
4. **考试日程模块** - 个人考试安排和排队状态
5. **考务扫码模块** - 考务人员签到操作
6. **公共看板模块** - 实时考场状态广播

### 辅助支持模块（3个）
7. **消息通知模块** - 状态变更和重要提醒
8. **帮助指引模块** - 使用说明和常见问题
9. **系统设置模块** - 个人偏好和应用设置

---

## 二、详细模块分析

### 模块1：身份认证模块

#### 功能描述
为考生和考务人员提供不同的登录方式，实现身份验证和权限分离。

#### 页面设计
- **登录选择页** - 用户角色选择（考生/考务人员）
- **考生登录页** - 身份证号快速登录
- **考务登录页** - 账号密码登录
- **登录结果页** - 登录成功/失败反馈

#### 核心功能点
1. **考生登录流程**：
   - 输入18位身份证号码
   - 系统验证身份证格式和考生信息
   - 绑定微信openid实现后续自动登录
   - 返回考生基本信息和访问令牌

2. **考务人员登录流程**：
   - 使用管理员分配的账号密码
   - 验证考务人员身份和权限
   - 进入考务工作台

3. **自动登录机制**：
   - 检测已绑定的微信用户
   - 自动跳转到对应角色的主页面

#### 对接API
- `POST /wx/login-by-idcard` - 考生身份证登录
- `POST /wx/login` - 标准登录接口
- `GET /wx/health` - 服务健康检查

#### 数据流转
```
用户输入 → 身份验证 → 角色判断 → 生成令牌 → 跳转主页
```

---

# 考点运营与流程管理微信小程序 - 详细模块分析

## 一、模块总览

基于需求文档和现有API分析，微信小程序可划分为以下9个功能模块：

### 核心业务模块（6个）
1. **身份认证模块** - 用户登录和身份验证
2. **考生个人中心模块** - 个人信息展示和管理
3. **动态二维码模块** - 考生身份凭证生成和展示
4. **考试日程模块** - 个人考试安排和排队状态
5. **考务扫码模块** - 考务人员签到操作
6. **公共看板模块** - 实时考场状态广播

### 辅助支持模块（3个）
7. **消息通知模块** - 状态变更和重要提醒
8. **帮助指引模块** - 使用说明和常见问题
9. **系统设置模块** - 个人偏好和应用设置

---

## 二、详细模块分析

### 模块1：身份认证模块（详细设计）

#### 模块作用与重要性
身份认证模块是整个小程序的入口和安全基础，承担着用户身份验证、权限分离、会话管理等核心职责。该模块的设计质量直接影响用户体验和系统安全性。

#### 业务场景分析
1. **考生场景**：考生通过身份证号快速登录，无需记忆复杂账号密码，降低使用门槛
2. **考务人员场景**：考务人员使用管理员分配的专用账号，确保操作权限的严格控制
3. **自动登录场景**：已登录用户再次进入小程序时自动识别身份，提升使用便利性

#### 详细功能设计

##### 1. 页面架构设计
```
app.js (应用入口)
├── pages/auth/
│   ├── role-select/     # 角色选择页
│   ├── candidate-login/ # 考生登录页
│   ├── staff-login/     # 考务登录页
│   ├── login-result/    # 登录结果页
│   └── auto-login/      # 自动登录处理页
```

##### 2. 核心功能实现思路

**2.1 角色选择与路由分发**
```javascript
// 实现思路：智能角色识别
onLaunch() {
  // 检查本地存储的用户信息
  const userInfo = wx.getStorageSync('userInfo');
  const userRole = wx.getStorageSync('userRole');
  
  if (userInfo && userRole) {
    // 自动登录验证
    this.autoLogin(userInfo, userRole);
  } else {
    // 跳转角色选择页
    wx.navigateTo({
      url: '/pages/auth/role-select/index'
    });
  }
}
```

**2.2 考生身份证登录机制**
```javascript
// 考生登录核心逻辑
candidateLogin(idCard) {
  // 1. 前端验证身份证格式
  if (!this.validateIdCard(idCard)) {
    wx.showToast({
      title: '身份证格式不正确',
      icon: 'error'
    });
    return;
  }
  
  // 2. 调用后端API验证
  wx.request({
    url: `${API_BASE}/wx/login-by-idcard`,
    method: 'POST',
    data: { id_card: idCard },
    success: (res) => {
      if (res.statusCode === 200) {
        // 3. 保存用户信息和令牌
        this.saveUserSession(res.data, 'candidate');
        // 4. 绑定微信openid
        this.bindWechatOpenId(res.data.access_token);
        // 5. 跳转到考生主页
        wx.switchTab({
          url: '/pages/candidate/index/index'
        });
      } else {
        this.handleLoginError(res.data);
      }
    }
  });
}
```

**2.3 考务人员账号登录机制**
```javascript
// 考务人员登录核心逻辑
staffLogin(username, password) {
  // 1. 前端基础验证
  if (!username || !password) {
    wx.showToast({
      title: '请输入账号和密码',
      icon: 'error'
    });
    return;
  }
  
  // 2. 调用标准登录接口
  wx.request({
    url: `${API_BASE}/wx/login`,
    method: 'POST',
    data: {
      code: '', // 微信登录code（可选）
      username: username,
      password: password,
      user_type: 'staff'
    },
    success: (res) => {
      if (res.statusCode === 200) {
        // 3. 保存会话信息
        this.saveUserSession(res.data, 'staff');
        // 4. 跳转到考务工作台
        wx.switchTab({
          url: '/pages/staff/workspace/index'
        });
      } else {
        this.handleLoginError(res.data);
      }
    }
  });
}
```

**2.4 自动登录与会话管理**
```javascript
// 自动登录验证机制
autoLogin(userInfo, userRole) {
  // 1. 检查令牌有效性
  wx.request({
    url: `${API_BASE}/wx/health`,
    method: 'GET',
    header: {
      'Authorization': `Bearer ${userInfo.access_token}`
    },
    success: (res) => {
      if (res.statusCode === 200) {
        // 令牌有效，直接跳转对应主页
        this.navigateToHomePage(userRole);
      } else {
        // 令牌失效，清除本地数据，重新登录
        this.clearUserSession();
        wx.navigateTo({
          url: '/pages/auth/role-select/index'
        });
      }
    }
  });
}
```

##### 3. API接口对接详情

**3.1 考生身份证登录接口**
```javascript
// API: POST /wx/login-by-idcard
// 请求参数：
{
  "id_card": "110101199001011234"  // 18位身份证号
}

// 响应数据：
{
  "message": "登录成功",
  "access_token": "candidate_1_1234",
  "candidate_info": {
    "id": 1,
    "name": "张三",
    "id_number": "110101199001011234",
    "phone": "13800138001",
    "exam_product": "无人机驾驶员考试",
    "institution": "北京航空培训中心",
    "status": "待排期"
  },
  "login_time": "2025-08-03T19:45:00"
}
```

**3.2 标准登录接口**
```javascript
// API: POST /wx/login
// 请求参数：
{
  "code": "微信登录code（可选）",
  "id_card": "身份证号（考生用）",
  "username": "用户名（考务用）",
  "password": "密码（考务用）"
}

// 响应数据：
{
  "access_token": "JWT令牌",
  "token_type": "bearer",
  "candidate_id": 1,  // 考生ID（考生登录时）
  "candidate_name": "张三",
  "phone": "13800138001",
  "status": "已排期"
}
```

**3.3 健康检查接口**
```javascript
// API: GET /wx/health
// 用途：验证服务可用性和令牌有效性
// 响应数据：
{
  "status": "healthy",
  "service": "微信小程序服务",
  "version": "1.0.0",
  "features": ["考生登录", "信息查询", "签到功能"]
}
```

##### 4. 技术实现细节

**4.1 身份证号验证算法**
```javascript
// 身份证号格式验证
validateIdCard(idCard) {
  // 基础格式检查
  if (!/^\d{17}[\dXx]$/.test(idCard)) {
    return false;
  }
  
  // 校验码验证
  const weights = [7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2];
  const checkCodes = ['1', '0', 'X', '9', '8', '7', '6', '5', '4', '3', '2'];
  
  let sum = 0;
  for (let i = 0; i < 17; i++) {
    sum += parseInt(idCard[i]) * weights[i];
  }
  
  const checkCode = checkCodes[sum % 11];
  return checkCode === idCard[17].toUpperCase();
}
```

**4.2 会话状态管理**
```javascript
// 用户会话管理工具类
class SessionManager {
  // 保存用户会话
  static saveUserSession(userData, userRole) {
    wx.setStorageSync('userInfo', userData);
    wx.setStorageSync('userRole', userRole);
    wx.setStorageSync('loginTime', new Date().getTime());
    
    // 设置全局请求头
    wx.setStorageSync('authToken', userData.access_token);
  }
  
  // 清除用户会话
  static clearUserSession() {
    wx.removeStorageSync('userInfo');
    wx.removeStorageSync('userRole');
    wx.removeStorageSync('loginTime');
    wx.removeStorageSync('authToken');
  }
  
  // 检查会话有效性
  static isSessionValid() {
    const loginTime = wx.getStorageSync('loginTime');
    const currentTime = new Date().getTime();
    const sessionTimeout = 24 * 60 * 60 * 1000; // 24小时
    
    return loginTime && (currentTime - loginTime < sessionTimeout);
  }
}
```

**4.3 微信OpenID绑定机制**
```javascript
// 绑定微信OpenID
bindWechatOpenId(accessToken) {
  wx.login({
    success: (res) => {
      if (res.code) {
        // 将微信code发送到后端进行OpenID绑定
        wx.request({
          url: `${API_BASE}/wx/bind-openid`,
          method: 'POST',
          header: {
            'Authorization': `Bearer ${accessToken}`
          },
          data: {
            wx_code: res.code
          },
          success: (bindRes) => {
            console.log('OpenID绑定成功', bindRes.data);
          }
        });
      }
    }
  });
}
```

##### 5. 用户体验优化

**5.1 加载状态管理**
```javascript
// 登录过程中的用户反馈
showLoginLoading() {
  wx.showLoading({
    title: '登录中...',
    mask: true
  });
}

hideLoginLoading() {
  wx.hideLoading();
}
```

**5.2 错误处理与用户提示**
```javascript
// 统一的错误处理机制
handleLoginError(errorData) {
  const errorMessages = {
    400: '输入信息格式不正确',
    404: '未找到该考生信息，请联系培训机构',
    403: '账号状态异常，无法登录',
    500: '系统繁忙，请稍后重试'
  };
  
  const message = errorMessages[errorData.status_code] || errorData.detail || '登录失败';
  
  wx.showModal({
    title: '登录失败',
    content: message,
    showCancel: false,
    confirmText: '确定'
  });
}
```

##### 6. 安全性考虑

**6.1 数据传输安全**
- 所有API请求使用HTTPS加密传输
- 敏感信息（如身份证号）在传输前进行基础验证
- 访问令牌采用JWT格式，包含过期时间

**6.2 本地存储安全**
- 敏感信息加密存储在本地
- 定期清理过期的会话数据
- 防止信息泄露的安全措施

**6.3 防重放攻击**
```javascript
// 请求防重复提交
let isSubmitting = false;

submitLogin() {
  if (isSubmitting) {
    wx.showToast({
      title: '请勿重复提交',
      icon: 'error'
    });
    return;
  }
  
  isSubmitting = true;
  
  // 执行登录逻辑
  this.performLogin().finally(() => {
    isSubmitting = false;
  });
}
```

##### 7. 数据流转详细设计

```
用户进入小程序
    ↓
检查本地会话状态
    ↓
[有效会话] → 自动登录验证 → [成功] → 跳转对应主页
    ↓                      ↓
[无效/无会话]              [失败] → 清除本地数据
    ↓                      ↓
显示角色选择页面 ←----------┘
    ↓
[考生] → 身份证登录页 → 输入身份证 → API验证 → 保存会话 → 考生主页
    ↓
[考务] → 账号登录页 → 输入账号密码 → API验证 → 保存会话 → 考务工作台
```

##### 8. 性能优化策略

**8.1 页面预加载**
```javascript
// 在角色选择页预加载后续页面
onReady() {
  // 预加载考生登录页
  wx.preloadPage({
    url: '/pages/auth/candidate-login/index'
  });
  
  // 预加载考务登录页
  wx.preloadPage({
    url: '/pages/auth/staff-login/index'
  });
}
```

**8.2 网络请求优化**
```javascript
// 网络请求封装，支持重试和缓存
class NetworkManager {
  static async request(options, retryCount = 3) {
    try {
      const response = await wx.request(options);
      return response;
    } catch (error) {
      if (retryCount > 0) {
        await this.delay(1000); // 延迟1秒重试
        return this.request(options, retryCount - 1);
      }
      throw error;
    }
  }
  
  static delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}
```

#### 模块总结
身份认证模块作为整个小程序的入口，需要在安全性、易用性、性能等方面做到平衡。通过双重登录机制（考生身份证登录 + 考务账号登录）、自动登录、会话管理等功能，为不同角色用户提供便捷而安全的身份验证服务。该模块的成功实现将为后续所有功能模块奠定坚实的基础。
# 考点运营与流程管理微信小程序 - 详细模块分析

## 一、模块总览

基于需求文档和现有API分析，微信小程序可划分为以下9个功能模块：

### 核心业务模块（6个）
1. **身份认证模块** - 用户登录和身份验证
2. **考生个人中心模块** - 个人信息展示和管理
3. **动态二维码模块** - 考生身份凭证生成和展示
4. **考试日程模块** - 个人考试安排和排队状态
5. **考务扫码模块** - 考务人员签到操作
6. **公共看板模块** - 实时考场状态广播

### 辅助支持模块（3个）
7. **消息通知模块** - 状态变更和重要提醒
8. **帮助指引模块** - 使用说明和常见问题
9. **系统设置模块** - 个人偏好和应用设置

---

## 二、详细模块分析

# 考点运营与流程管理微信小程序 - 详细模块分析

## 一、模块总览

基于需求文档和现有API分析，微信小程序可划分为以下9个功能模块：

### 核心业务模块（6个）
1. **身份认证模块** - 用户登录和身份验证
2. **考生个人中心模块** - 个人信息展示和管理
3. **动态二维码模块** - 考生身份凭证生成和展示
4. **考试日程模块** - 个人考试安排和排队状态
5. **考务扫码模块** - 考务人员签到操作
6. **公共看板模块** - 实时考场状态广播

### 辅助支持模块（3个）
7. **消息通知模块** - 状态变更和重要提醒
8. **帮助指引模块** - 使用说明和常见问题
9. **系统设置模块** - 个人偏好和应用设置

---

## 二、详细模块分析

### 模块1：身份认证模块

#### 功能描述
为考生和考务人员提供不同的登录方式，实现身份验证和权限分离。

#### 页面设计
- **登录选择页** - 用户角色选择（考生/考务人员）
- **考生登录页** - 身份证号快速登录
- **考务登录页** - 账号密码登录
- **登录结果页** - 登录成功/失败反馈

#### 核心功能点
1. **考生登录流程**：
   - 输入18位身份证号码
   - 系统验证身份证格式和考生信息
   - 绑定微信openid实现后续自动登录
   - 返回考生基本信息和访问令牌

2. **考务人员登录流程**：
   - 使用管理员分配的账号密码
   - 验证考务人员身份和权限
   - 进入考务工作台

3. **自动登录机制**：
   - 检测已绑定的微信用户
   - 自动跳转到对应角色的主页面

#### 对接API
- `POST /wx/login-by-idcard` - 考生身份证登录
- `POST /wx/login` - 标准登录接口
- `GET /wx/health` - 服务健康检查

#### 数据流转
```
用户输入 → 身份验证 → 角色判断 → 生成令牌 → 跳转主页
```

---

### 模块2：考生个人中心模块

#### 功能描述
展示考生的完整个人信息，包括基本资料、考试产品、培训机构等信息。

#### 页面设计
- **个人信息页** - 基本资料展示
- **考试信息页** - 考试产品和机构信息
- **状态概览页** - 当前考试状态和进度

#### 核心功能点
1. **基本信息展示**：
   - 考生姓名、身份证号（脱敏显示）
   - 联系电话、邮箱
   - 报名时间和当前状态

2. **考试相关信息**：
   - 报考的考试产品（如"多旋翼视距内驾驶员"）
   - 所属培训机构信息
   - 考试进度和完成状态

3. **状态跟踪**：
   - 当前考试阶段（待排期/已排期/考试中/已完成）
   - 下一步操作提示
   - 重要时间节点提醒

#### 对接API
- `GET /wx/candidate-info/{candidate_id}` - 获取考生详细信息

#### 数据展示结构
```json
{
  "basic_info": {
    "name": "张三",
    "id_number": "110101****1234",
    "phone": "138****8001",
    "status": "已排期"
  },
  "exam_info": {
    "product": "无人机驾驶员考试",
    "institution": "北京航空培训中心",
    "registration_date": "2025-08-01"
  }
}
```

---

### 模块3：动态二维码模块（核心功能详细设计）

#### 模块作用与重要性
动态二维码模块是整个考点管理系统的核心功能，承担着考生身份验证、流程节点确认、状态同步等关键职责。该模块的稳定性和安全性直接影响现场考务工作的效率和准确性。

#### 业务场景分析
1. **现场签到场景**：考生向考务人员出示二维码进行身份确认和流程签到
2. **状态同步场景**：二维码内容随考生状态变化动态更新，确保信息准确性
3. **安全验证场景**：通过时间戳、有效期等机制防止二维码被恶意使用

#### 详细功能设计

##### 1. 页面架构设计
```
pages/candidate/qrcode/
├── index/              # 二维码主展示页
├── guide/              # 使用说明页
├── status/             # 状态说明页
└── components/
    ├── qr-display/     # 二维码显示组件
    ├── refresh-timer/  # 刷新倒计时组件
    └── status-indicator/ # 状态指示器组件
```

##### 2. 核心功能实现思路

**2.1 动态二维码生成与管理**
```javascript
// 二维码管理核心类
class QRCodeManager {
  constructor(candidateId) {
    this.candidateId = candidateId;
    this.currentQRData = null;
    this.refreshTimer = null;
    this.refreshInterval = 300000; // 5分钟
    this.isRefreshing = false;
  }
  
  // 获取动态二维码
  async generateQRCode(forceRefresh = false) {
    if (this.isRefreshing && !forceRefresh) {
      return this.currentQRData;
    }
    
    try {
      this.isRefreshing = true;
      
      const response = await wx.request({
        url: `${API_BASE}/wx/my-qrcode/${this.candidateId}`,
        method: 'GET',
        header: {
          'Authorization': `Bearer ${wx.getStorageSync('authToken')}`
        }
      });
      
      if (response.statusCode === 200) {
        const qrData = response.data;
        
        // 验证二维码数据完整性
        if (this.validateQRData(qrData)) {
          this.currentQRData = qrData;
          this.scheduleNextRefresh();
          
          // 缓存二维码数据
          wx.setStorageSync('currentQRCode', {
            data: qrData,
            timestamp: Date.now()
          });
          
          return qrData;
        } else {
          throw new Error('二维码数据格式异常');
        }
      } else {
        throw new Error(response.data.detail || '获取二维码失败');
      }
    } catch (error) {
      console.error('生成二维码失败:', error);
      
      // 尝试使用缓存数据
      const cachedQR = wx.getStorageSync('currentQRCode');
      if (cachedQR && this.isCacheValid(cachedQR)) {
        console.warn('使用缓存的二维码数据');
        return cachedQR.data;
      }
      
      throw error;
    } finally {
      this.isRefreshing = false;
    }
  }
  
  // 验证二维码数据完整性
  validateQRData(qrData) {
    const requiredFields = ['qr_data', 'qr_url', 'refresh_interval'];
    const qrDataFields = ['type', 'candidate_id', 'schedule_id', 'timestamp', 'valid_until'];
    
    // 检查顶层字段
    for (const field of requiredFields) {
      if (!qrData.hasOwnProperty(field)) {
        console.error(`缺少必需字段: ${field}`);
        return false;
      }
    }
    
    // 检查二维码数据字段
    if (qrData.qr_data) {
      for (const field of qrDataFields) {
        if (!qrData.qr_data.hasOwnProperty(field)) {
          console.error(`二维码数据缺少字段: ${field}`);
          return false;
        }
      }
    }
    
    return true;
  }
  
  // 检查缓存有效性
  isCacheValid(cachedQR) {
    const cacheAge = Date.now() - cachedQR.timestamp;
    const maxCacheAge = 2 * 60 * 1000; // 2分钟缓存有效期
    
    if (cacheAge > maxCacheAge) {
      return false;
    }
    
    // 检查二维码本身是否过期
    const validUntil = new Date(cachedQR.data.qr_data.valid_until);
    return validUntil > new Date();
  }
  
  // 安排下次刷新
  scheduleNextRefresh() {
    if (this.refreshTimer) {
      clearTimeout(this.refreshTimer);
    }
    
    this.refreshTimer = setTimeout(() => {
      this.generateQRCode(true).catch(error => {
        console.error('自动刷新二维码失败:', error);
        // 重试机制
        setTimeout(() => this.scheduleNextRefresh(), 30000); // 30秒后重试
      });
    }, this.refreshInterval);
  }
  
  // 清理定时器
  destroy() {
    if (this.refreshTimer) {
      clearTimeout(this.refreshTimer);
      this.refreshTimer = null;
    }
  }
}
```

**2.2 二维码显示与状态管理**
```javascript
// 二维码展示页面逻辑
Page({
  data: {
    qrCodeData: null,
    qrImageUrl: '',
    examInfo: {},
    refreshCountdown: 300,
    isLoading: true,
    hasSchedule: false,
    errorMessage: '',
    statusConfig: {
      'no_schedule': {
        title: '暂无考试安排',
        message: '请等待考务管理员为您安排考试时间',
        icon: '/images/no-schedule.png'
      },
      'scheduled': {
        title: '请出示此二维码',
        message: '向考务人员展示下方二维码进行签到',
        icon: '/images/qr-ready.png'
      },
      'completed': {
        title: '考试已完成',
        message: '您的考试流程已全部完成',
        icon: '/images/completed.png'
      }
    }
  },
  
  qrManager: null,
  countdownTimer: null,
  
  onLoad() {
    const candidateId = wx.getStorageSync('userInfo').candidate_id;
    this.qrManager = new QRCodeManager(candidateId);
    this.loadQRCode();
    this.startCountdown();
  },
  
  onUnload() {
    this.cleanup();
  },
  
  onShow() {
    // 页面显示时检查是否需要刷新
    this.checkAndRefreshQRCode();
  },
  
  // 加载二维码
  async loadQRCode(forceRefresh = false) {
    try {
      this.setData({ isLoading: true, errorMessage: '' });
      
      const qrData = await this.qrManager.generateQRCode(forceRefresh);
      
      if (qrData.status === 'no_schedule') {
        // 无考试安排状态
        this.setData({
          hasSchedule: false,
          isLoading: false
        });
      } else {
        // 有考试安排，显示二维码
        this.setData({
          qrCodeData: qrData.qr_data,
          qrImageUrl: qrData.qr_url,
          examInfo: {
            activityName: qrData.qr_data.activity_name,
            venue: qrData.qr_data.venue,
            examDate: this.formatDate(qrData.qr_data.valid_until)
          },
          hasSchedule: true,
          isLoading: false,
          refreshCountdown: qrData.refresh_interval || 300
        });
        
        // 重新开始倒计时
        this.startCountdown();
      }
      
    } catch (error) {
      console.error('加载二维码失败:', error);
      this.setData({
        errorMessage: error.message,
        isLoading: false
      });
      
      this.showRetryDialog(error.message);
    }
  },
  
  // 手动刷新二维码
  async onRefreshQRCode() {
    wx.showLoading({ title: '刷新中...' });
    
    try {
      await this.loadQRCode(true);
      wx.showToast({
        title: '刷新成功',
        icon: 'success'
      });
    } catch (error) {
      wx.showToast({
        title: '刷新失败',
        icon: 'error'
      });
    } finally {
      wx.hideLoading();
    }
  },
  
  // 开始倒计时
  startCountdown() {
    if (this.countdownTimer) {
      clearInterval(this.countdownTimer);
    }
    
    this.countdownTimer = setInterval(() => {
      const countdown = this.data.refreshCountdown - 1;
      
      if (countdown <= 0) {
        // 自动刷新
        this.loadQRCode(true);
        this.setData({ refreshCountdown: 300 });
      } else {
        this.setData({ refreshCountdown: countdown });
      }
    }, 1000);
  },
  
  // 检查并刷新二维码
  checkAndRefreshQRCode() {
    if (!this.data.qrCodeData) return;
    
    const validUntil = new Date(this.data.qrCodeData.valid_until);
    const now = new Date();
    
    // 如果二维码即将过期（5分钟内），立即刷新
    if (validUntil - now < 5 * 60 * 1000) {
      this.loadQRCode(true);
    }
  },
  
  // 显示重试对话框
  showRetryDialog(errorMessage) {
    wx.showModal({
      title: '加载失败',
      content: errorMessage || '网络异常，请检查网络连接',
      confirmText: '重试',
      cancelText: '取消',
      success: (res) => {
        if (res.confirm) {
          this.loadQRCode(true);
        }
      }
    });
  },
  
  // 清理资源
  cleanup() {
    if (this.qrManager) {
      this.qrManager.destroy();
    }
    
    if (this.countdownTimer) {
      clearInterval(this.countdownTimer);
    }
  }
});
```

##### 3. API接口对接详情

**3.1 动态二维码生成接口**
```javascript
// API: GET /wx/my-qrcode/{candidate_id}
// 请求头：Authorization: Bearer {access_token}

// 成功响应（有考试安排）：
{
  "message": "动态二维码生成成功",
  "candidate_id": 1,
  "candidate_name": "张三",
  "qr_data": {
    "type": "candidate_checkin",
    "candidate_id": 1,
    "schedule_id": 1,
    "candidate_name": "张三",
    "activity_name": "理论考试",
    "venue": "理论考场A",
    "timestamp": "2025-08-03T19:50:00",
    "valid_until": "2025-08-15T23:59:59"
  },
  "qr_url": "https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=schedule_1_candidate_1",
  "next_schedule": {
    "id": 1,
    "activity_name": "理论考试",
    "exam_date": "2025-08-15",
    "start_time": "09:00",
    "venue": "理论考场A",
    "status": "待签到"
  },
  "instructions": "请向考务人员出示此二维码进行签到",
  "refresh_interval": 300
}

// 成功响应（无考试安排）：
{
  "message": "暂无待进行的考试安排",
  "candidate_id": 1,
  "candidate_name": "张三",
  "qr_code": null,
  "status": "no_schedule"
}
```

##### 4. 用户界面设计

**4.1 二维码展示页面模板**
```xml
<!-- 二维码展示页面 -->
<view class="qrcode-container">
  <!-- 加载状态 -->
  <view wx:if="{{isLoading}}" class="loading-container">
    <view class="loading-spinner"></view>
    <text class="loading-text">正在生成二维码...</text>
  </view>
  
  <!-- 有考试安排时显示二维码 -->
  <view wx:elif="{{hasSchedule}}" class="qrcode-content">
    <!-- 状态提示 -->
    <view class="status-header">
      <image class="status-icon" src="{{statusConfig.scheduled.icon}}" />
      <text class="status-title">{{statusConfig.scheduled.title}}</text>
      <text class="status-message">{{statusConfig.scheduled.message}}</text>
    </view>
    
    <!-- 考试信息 -->
    <view class="exam-info">
      <view class="info-item">
        <text class="label">考试项目：</text>
        <text class="value">{{examInfo.activityName}}</text>
      </view>
      <view class="info-item">
        <text class="label">考试地点：</text>
        <text class="value">{{examInfo.venue}}</text>
      </view>
      <view class="info-item">
        <text class="label">有效期至：</text>
        <text class="value">{{examInfo.examDate}}</text>
      </view>
    </view>
    
    <!-- 二维码显示区域 -->
    <view class="qrcode-display">
      <image 
        class="qrcode-image" 
        src="{{qrImageUrl}}" 
        mode="aspectFit"
        bindload="onQRImageLoad"
        binderror="onQRImageError"
      />
      
      <!-- 刷新倒计时 -->
      <view class="refresh-countdown">
        <text class="countdown-text">{{Math.floor(refreshCountdown / 60)}}:{{(refreshCountdown % 60).toString().padStart(2, '0')}} 后自动刷新</text>
        <button class="refresh-btn" bindtap="onRefreshQRCode">
          <image class="refresh-icon" src="/images/refresh.png" />
          立即刷新
        </button>
      </view>
    </view>
    
    <!-- 使用说明 -->
    <view class="usage-tips">
      <view class="tip-item">
        <text class="tip-number">1</text>
        <text class="tip-text">请确保二维码清晰可见</text>
      </view>
      <view class="tip-item">
        <text class="tip-number">2</text>
        <text class="tip-text">向考务人员出示此二维码</text>
      </view>
      <view class="tip-item">
        <text class="tip-number">3</text>
        <text class="tip-text">等待考务人员扫码确认</text>
      </view>
    </view>
  </view>
  
  <!-- 无考试安排状态 -->
  <view wx:elif="{{!hasSchedule}}" class="no-schedule-container">
    <image class="no-schedule-icon" src="{{statusConfig.no_schedule.icon}}" />
    <text class="no-schedule-title">{{statusConfig.no_schedule.title}}</text>
    <text class="no-schedule-message">{{statusConfig.no_schedule.message}}</text>
    
    <button class="contact-btn" bindtap="onContactInstitution">
      联系培训机构
    </button>
  </view>
  
  <!-- 错误状态 -->
  <view wx:else class="error-container">
    <image class="error-icon" src="/images/error.png" />
    <text class="error-title">加载失败</text>
    <text class="error-message">{{errorMessage}}</text>
    
    <button class="retry-btn" bindtap="onRefreshQRCode">
      重新加载
    </button>
  </view>
</view>
```

##### 5. 安全性与防护机制

**5.1 二维码防伪验证**
```javascript
// 二维码安全验证工具
class QRSecurityValidator {
  // 验证二维码时间戳
  static validateTimestamp(qrData) {
    const timestamp = new Date(qrData.timestamp);
    const now = new Date();
    const maxAge = 10 * 60 * 1000; // 10分钟有效期
    
    return (now - timestamp) <= maxAge;
  }
  
  // 验证二维码有效期
  static validateExpiry(qrData) {
    const validUntil = new Date(qrData.valid_until);
    const now = new Date();
    
    return validUntil > now;
  }
  
  // 生成二维码校验码
  static generateChecksum(qrData) {
    const dataString = JSON.stringify({
      candidate_id: qrData.candidate_id,
      schedule_id: qrData.schedule_id,
      timestamp: qrData.timestamp
    });
    
    // 简单的校验码生成（实际应用中应使用更安全的算法）
    let checksum = 0;
    for (let i = 0; i < dataString.length; i++) {
      checksum += dataString.charCodeAt(i);
    }
    
    return checksum.toString(36);
  }
  
  // 验证二维码完整性
  static validateIntegrity(qrData) {
    const requiredFields = ['type', 'candidate_id', 'schedule_id', 'timestamp', 'valid_until'];
    
    for (const field of requiredFields) {
      if (!qrData.hasOwnProperty(field) || qrData[field] === null || qrData[field] === undefined) {
        return false;
      }
    }
    
    return true;
  }
}
```

**5.2 网络请求安全**
```javascript
// 安全的网络请求封装
class SecureRequest {
  static async request(options) {
    // 添加请求时间戳防重放
    const timestamp = Date.now();
    const nonce = Math.random().toString(36).substring(2);
    
    const secureOptions = {
      ...options,
      header: {
        ...options.header,
        'X-Timestamp': timestamp,
        'X-Nonce': nonce,
        'X-Request-ID': this.generateRequestId()
      },
      timeout: 10000 // 10秒超时
    };
    
    return new Promise((resolve, reject) => {
      wx.request({
        ...secureOptions,
        success: (res) => {
          if (this.validateResponse(res)) {
            resolve(res);
          } else {
            reject(new Error('响应数据验证失败'));
          }
        },
        fail: reject
      });
    });
  }
  
  static generateRequestId() {
    return Date.now().toString(36) + Math.random().toString(36).substring(2);
  }
  
  static validateResponse(response) {
    // 验证响应状态码
    if (response.statusCode < 200 || response.statusCode >= 300) {
      return false;
    }
    
    // 验证响应数据格式
    if (!response.data || typeof response.data !== 'object') {
      return false;
    }
    
    return true;
  }
}
```

##### 6. 性能优化策略

**6.1 二维码图片缓存**
```javascript
// 二维码图片缓存管理
class QRImageCache {
  static cacheKey = 'qr_image_cache';
  static maxCacheSize = 10; // 最多缓存10个二维码图片
  
  // 缓存二维码图片
  static async cacheImage(qrUrl, qrData) {
    try {
      // 下载图片到本地
      const downloadResult = await wx.downloadFile({
        url: qrUrl
      });
      
      if (downloadResult.statusCode === 200) {
        // 保存到本地文件系统
        const savedPath = await wx.saveFile({
          tempFilePath: downloadResult.tempFilePath
        });
        
        // 更新缓存记录
        this.updateCacheRecord(qrData.schedule_id, savedPath.savedFilePath);
        
        return savedPath.savedFilePath;
      }
    } catch (error) {
      console.error('缓存二维码图片失败:', error);
      return qrUrl; // 返回原始URL
    }
  }
  
  // 获取缓存的图片
  static getCachedImage(scheduleId) {
    const cache = wx.getStorageSync(this.cacheKey) || {};
    const cacheItem = cache[scheduleId];
    
    if (cacheItem && this.isFileExists(cacheItem.path)) {
      return cacheItem.path;
    }
    
    return null;
  }
  
  // 更新缓存记录
  static updateCacheRecord(scheduleId, filePath) {
    let cache = wx.getStorageSync(this.cacheKey) || {};
    
    // 添加新记录
    cache[scheduleId] = {
      path: filePath,
      timestamp: Date.now()
    };
    
    // 清理过期缓存
    cache = this.cleanExpiredCache(cache);
    
    wx.setStorageSync(this.cacheKey, cache);
  }
  
  // 清理过期缓存
  static cleanExpiredCache(cache) {
    const now = Date.now();
    const maxAge = 24 * 60 * 60 * 1000; // 24小时
    
    const cleanedCache = {};
    const entries = Object.entries(cache);
    
    // 按时间排序，保留最新的
    entries.sort((a, b) => b[1].timestamp - a[1].timestamp);
    
    let count = 0;
    for (const [key, value] of entries) {
      if (count < this.maxCacheSize && (now - value.timestamp) < maxAge) {
        cleanedCache[key] = value;
        count++;
      } else {
        // 删除过期或超出限制的文件
        this.deleteFile(value.path);
      }
    }
    
    return cleanedCache;
  }
  
  // 检查文件是否存在
  static isFileExists(filePath) {
    try {
      wx.getFileInfo({
        filePath: filePath,
        success: () => true,
        fail: () => false
      });
    } catch {
      return false;
    }
  }
  
  // 删除文件
  static deleteFile(filePath) {
    try {
      wx.removeSavedFile({
        filePath: filePath
      });
    } catch (error) {
      console.error('删除缓存文件失败:', error);
    }
  }
}
```

#### 模块总结
动态二维码模块作为整个考点管理系统的核心功能，通过智能的生成机制、完善的安全验证、友好的用户界面和高效的性能优化，为考生提供了可靠的身份验证凭证。该模块不仅要确保二维码的实时性和准确性，还要考虑网络异常、缓存策略、安全防护等多个方面，是技术实现难度最高但也是最关键的模块之一。
# 考点运营与流程管理微信小程序 - 详细模块分析

## 一、模块总览

基于需求文档和现有API分析，微信小程序可划分为以下9个功能模块：

### 核心业务模块（6个）
1. **身份认证模块** - 用户登录和身份验证
2. **考生个人中心模块** - 个人信息展示和管理
3. **动态二维码模块** - 考生身份凭证生成和展示
4. **考试日程模块** - 个人考试安排和排队状态
5. **考务扫码模块** - 考务人员签到操作
6. **公共看板模块** - 实时考场状态广播

### 辅助支持模块（3个）
7. **消息通知模块** - 状态变更和重要提醒
8. **帮助指引模块** - 使用说明和常见问题
9. **系统设置模块** - 个人偏好和应用设置

---

## 二、详细模块分析

### 模块1：身份认证模块（详细设计）

#### 模块作用与重要性
身份认证模块是整个小程序的入口和安全基础，承担着用户身份验证、权限分离、会话管理等核心职责。该模块的设计质量直接影响用户体验和系统安全性。

#### 业务场景分析
1. **考生场景**：考生通过身份证号快速登录，无需记忆复杂账号密码，降低使用门槛
2. **考务人员场景**：考务人员使用管理员分配的专用账号，确保操作权限的严格控制
3. **自动登录场景**：已登录用户再次进入小程序时自动识别身份，提升使用便利性

#### 详细功能设计

##### 1. 页面架构设计
```
app.js (应用入口)
├── pages/auth/
│   ├── role-select/     # 角色选择页
│   ├── candidate-login/ # 考生登录页
│   ├── staff-login/     # 考务登录页
│   ├── login-result/    # 登录结果页
│   └── auto-login/      # 自动登录处理页
```

##### 2. 核心功能实现思路

**2.1 角色选择与路由分发**
```javascript
// 实现思路：智能角色识别
onLaunch() {
  // 检查本地存储的用户信息
  const userInfo = wx.getStorageSync('userInfo');
  const userRole = wx.getStorageSync('userRole');
  
  if (userInfo && userRole) {
    // 自动登录验证
    this.autoLogin(userInfo, userRole);
  } else {
    // 跳转角色选择页
    wx.navigateTo({
      url: '/pages/auth/role-select/index'
    });
  }
}
```

**2.2 考生身份证登录机制**
```javascript
// 考生登录核心逻辑
candidateLogin(idCard) {
  // 1. 前端验证身份证格式
  if (!this.validateIdCard(idCard)) {
    wx.showToast({
      title: '身份证格式不正确',
      icon: 'error'
    });
    return;
  }
  
  // 2. 调用后端API验证
  wx.request({
    url: `${API_BASE}/wx/login-by-idcard`,
    method: 'POST',
    data: { id_card: idCard },
    success: (res) => {
      if (res.statusCode === 200) {
        // 3. 保存用户信息和令牌
        this.saveUserSession(res.data, 'candidate');
        // 4. 绑定微信openid
        this.bindWechatOpenId(res.data.access_token);
        // 5. 跳转到考生主页
        wx.switchTab({
          url: '/pages/candidate/index/index'
        });
      } else {
        this.handleLoginError(res.data);
      }
    }
  });
}
```

**2.3 考务人员账号登录机制**
```javascript
// 考务人员登录核心逻辑
staffLogin(username, password) {
  // 1. 前端基础验证
  if (!username || !password) {
    wx.showToast({
      title: '请输入账号和密码',
      icon: 'error'
    });
    return;
  }
  
  // 2. 调用标准登录接口
  wx.request({
    url: `${API_BASE}/wx/login`,
    method: 'POST',
    data: {
      code: '', // 微信登录code（可选）
      username: username,
      password: password,
      user_type: 'staff'
    },
    success: (res) => {
      if (res.statusCode === 200) {
        // 3. 保存会话信息
        this.saveUserSession(res.data, 'staff');
        // 4. 跳转到考务工作台
        wx.switchTab({
          url: '/pages/staff/workspace/index'
        });
      } else {
        this.handleLoginError(res.data);
      }
    }
  });
}
```

**2.4 自动登录与会话管理**
```javascript
// 自动登录验证机制
autoLogin(userInfo, userRole) {
  // 1. 检查令牌有效性
  wx.request({
    url: `${API_BASE}/wx/health`,
    method: 'GET',
    header: {
      'Authorization': `Bearer ${userInfo.access_token}`
    },
    success: (res) => {
      if (res.statusCode === 200) {
        // 令牌有效，直接跳转对应主页
        this.navigateToHomePage(userRole);
      } else {
        // 令牌失效，清除本地数据，重新登录
        this.clearUserSession();
        wx.navigateTo({
          url: '/pages/auth/role-select/index'
        });
      }
    }
  });
}
```

##### 3. API接口对接详情

**3.1 考生身份证登录接口**
```javascript
// API: POST /wx/login-by-idcard
// 请求参数：
{
  "id_card": "110101199001011234"  // 18位身份证号
}

// 响应数据：
{
  "message": "登录成功",
  "access_token": "candidate_1_1234",
  "candidate_info": {
    "id": 1,
    "name": "张三",
    "id_number": "110101199001011234",
    "phone": "13800138001",
    "exam_product": "无人机驾驶员考试",
    "institution": "北京航空培训中心",
    "status": "待排期"
  },
  "login_time": "2025-08-03T19:45:00"
}
```

**3.2 标准登录接口**
```javascript
// API: POST /wx/login
// 请求参数：
{
  "code": "微信登录code（可选）",
  "id_card": "身份证号（考生用）",
  "username": "用户名（考务用）",
  "password": "密码（考务用）"
}

// 响应数据：
{
  "access_token": "JWT令牌",
  "token_type": "bearer",
  "candidate_id": 1,  // 考生ID（考生登录时）
  "candidate_name": "张三",
  "phone": "13800138001",
  "status": "已排期"
}
```

**3.3 健康检查接口**
```javascript
// API: GET /wx/health
// 用途：验证服务可用性和令牌有效性
// 响应数据：
{
  "status": "healthy",
  "service": "微信小程序服务",
  "version": "1.0.0",
  "features": ["考生登录", "信息查询", "签到功能"]
}
```

##### 4. 技术实现细节

**4.1 身份证号验证算法**
```javascript
// 身份证号格式验证
validateIdCard(idCard) {
  // 基础格式检查
  if (!/^\d{17}[\dXx]$/.test(idCard)) {
    return false;
  }
  
  // 校验码验证
  const weights = [7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2];
  const checkCodes = ['1', '0', 'X', '9', '8', '7', '6', '5', '4', '3', '2'];
  
  let sum = 0;
  for (let i = 0; i < 17; i++) {
    sum += parseInt(idCard[i]) * weights[i];
  }
  
  const checkCode = checkCodes[sum % 11];
  return checkCode === idCard[17].toUpperCase();
}
```

**4.2 会话状态管理**
```javascript
// 用户会话管理工具类
class SessionManager {
  // 保存用户会话
  static saveUserSession(userData, userRole) {
    wx.setStorageSync('userInfo', userData);
    wx.setStorageSync('userRole', userRole);
    wx.setStorageSync('loginTime', new Date().getTime());
    
    // 设置全局请求头
    wx.setStorageSync('authToken', userData.access_token);
  }
  
  // 清除用户会话
  static clearUserSession() {
    wx.removeStorageSync('userInfo');
    wx.removeStorageSync('userRole');
    wx.removeStorageSync('loginTime');
    wx.removeStorageSync('authToken');
  }
  
  // 检查会话有效性
  static isSessionValid() {
    const loginTime = wx.getStorageSync('loginTime');
    const currentTime = new Date().getTime();
    const sessionTimeout = 24 * 60 * 60 * 1000; // 24小时
    
    return loginTime && (currentTime - loginTime < sessionTimeout);
  }
}
```

**4.3 微信OpenID绑定机制**
```javascript
// 绑定微信OpenID
bindWechatOpenId(accessToken) {
  wx.login({
    success: (res) => {
      if (res.code) {
        // 将微信code发送到后端进行OpenID绑定
        wx.request({
          url: `${API_BASE}/wx/bind-openid`,
          method: 'POST',
          header: {
            'Authorization': `Bearer ${accessToken}`
          },
          data: {
            wx_code: res.code
          },
          success: (bindRes) => {
            console.log('OpenID绑定成功', bindRes.data);
          }
        });
      }
    }
  });
}
```

##### 5. 用户体验优化

**5.1 加载状态管理**
```javascript
// 登录过程中的用户反馈
showLoginLoading() {
  wx.showLoading({
    title: '登录中...',
    mask: true
  });
}

hideLoginLoading() {
  wx.hideLoading();
}
```

**5.2 错误处理与用户提示**
```javascript
// 统一的错误处理机制
handleLoginError(errorData) {
  const errorMessages = {
    400: '输入信息格式不正确',
    404: '未找到该考生信息，请联系培训机构',
    403: '账号状态异常，无法登录',
    500: '系统繁忙，请稍后重试'
  };
  
  const message = errorMessages[errorData.status_code] || errorData.detail || '登录失败';
  
  wx.showModal({
    title: '登录失败',
    content: message,
    showCancel: false,
    confirmText: '确定'
  });
}
```

##### 6. 安全性考虑

**6.1 数据传输安全**
- 所有API请求使用HTTPS加密传输
- 敏感信息（如身份证号）在传输前进行基础验证
- 访问令牌采用JWT格式，包含过期时间

**6.2 本地存储安全**
- 敏感信息加密存储在本地
- 定期清理过期的会话数据
- 防止信息泄露的安全措施

**6.3 防重放攻击**
```javascript
// 请求防重复提交
let isSubmitting = false;

submitLogin() {
  if (isSubmitting) {
    wx.showToast({
      title: '请勿重复提交',
      icon: 'error'
    });
    return;
  }
  
  isSubmitting = true;
  
  // 执行登录逻辑
  this.performLogin().finally(() => {
    isSubmitting = false;
  });
}
```

##### 7. 数据流转详细设计

```
用户进入小程序
    ↓
检查本地会话状态
    ↓
[有效会话] → 自动登录验证 → [成功] → 跳转对应主页
    ↓                      ↓
[无效/无会话]              [失败] → 清除本地数据
    ↓                      ↓
显示角色选择页面 ←----------┘
    ↓
[考生] → 身份证登录页 → 输入身份证 → API验证 → 保存会话 → 考生主页
    ↓
[考务] → 账号登录页 → 输入账号密码 → API验证 → 保存会话 → 考务工作台
```

##### 8. 性能优化策略

**8.1 页面预加载**
```javascript
// 在角色选择页预加载后续页面
onReady() {
  // 预加载考生登录页
  wx.preloadPage({
    url: '/pages/auth/candidate-login/index'
  });
  
  // 预加载考务登录页
  wx.preloadPage({
    url: '/pages/auth/staff-login/index'
  });
}
```

**8.2 网络请求优化**
```javascript
// 网络请求封装，支持重试和缓存
class NetworkManager {
  static async request(options, retryCount = 3) {
    try {
      const response = await wx.request(options);
      return response;
    } catch (error) {
      if (retryCount > 0) {
        await this.delay(1000); // 延迟1秒重试
        return this.request(options, retryCount - 1);
      }
      throw error;
    }
  }
  
  static delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}
```

#### 模块总结
身份认证模块作为整个小程序的入口，需要在安全性、易用性、性能等方面做到平衡。通过双重登录机制（考生身份证登录 + 考务账号登录）、自动登录、会话管理等功能，为不同角色用户提供便捷而安全的身份验证服务。该模块的成功实现将为后续所有功能模块奠定坚实的基础。
# 考点运营与流程管理微信小程序 - 详细模块分析

## 一、模块总览

基于需求文档和现有API分析，微信小程序可划分为以下9个功能模块：

### 核心业务模块（6个）
1. **身份认证模块** - 用户登录和身份验证
2. **考生个人中心模块** - 个人信息展示和管理
3. **动态二维码模块** - 考生身份凭证生成和展示
4. **考试日程模块** - 个人考试安排和排队状态
5. **考务扫码模块** - 考务人员签到操作
6. **公共看板模块** - 实时考场状态广播

### 辅助支持模块（3个）
7. **消息通知模块** - 状态变更和重要提醒
8. **帮助指引模块** - 使用说明和常见问题
9. **系统设置模块** - 个人偏好和应用设置

---

## 二、详细模块分析

# 考点运营与流程管理微信小程序 - 详细模块分析

## 一、模块总览

基于需求文档和现有API分析，微信小程序可划分为以下9个功能模块：

### 核心业务模块（6个）
1. **身份认证模块** - 用户登录和身份验证
2. **考生个人中心模块** - 个人信息展示和管理
3. **动态二维码模块** - 考生身份凭证生成和展示
4. **考试日程模块** - 个人考试安排和排队状态
5. **考务扫码模块** - 考务人员签到操作
6. **公共看板模块** - 实时考场状态广播

### 辅助支持模块（3个）
7. **消息通知模块** - 状态变更和重要提醒
8. **帮助指引模块** - 使用说明和常见问题
9. **系统设置模块** - 个人偏好和应用设置

---

## 二、详细模块分析

### 模块1：身份认证模块

#### 功能描述
为考生和考务人员提供不同的登录方式，实现身份验证和权限分离。

#### 页面设计
- **登录选择页** - 用户角色选择（考生/考务人员）
- **考生登录页** - 身份证号快速登录
- **考务登录页** - 账号密码登录
- **登录结果页** - 登录成功/失败反馈

#### 核心功能点
1. **考生登录流程**：
   - 输入18位身份证号码
   - 系统验证身份证格式和考生信息
   - 绑定微信openid实现后续自动登录
   - 返回考生基本信息和访问令牌

2. **考务人员登录流程**：
   - 使用管理员分配的账号密码
   - 验证考务人员身份和权限
   - 进入考务工作台

3. **自动登录机制**：
   - 检测已绑定的微信用户
   - 自动跳转到对应角色的主页面

#### 对接API
- `POST /wx/login-by-idcard` - 考生身份证登录
- `POST /wx/login` - 标准登录接口
- `GET /wx/health` - 服务健康检查

#### 数据流转
```
用户输入 → 身份验证 → 角色判断 → 生成令牌 → 跳转主页
```

---

### 模块2：考生个人中心模块（详细设计）

#### 模块作用与重要性
考生个人中心模块是考生了解自身考试状态、查看个人信息的核心入口。该模块承担着信息展示、状态跟踪、用户引导等重要职责，是提升考生体验和减少咨询压力的关键模块。

#### 业务场景分析
1. **信息查询场景**：考生需要快速了解自己的基本信息、考试产品、培训机构等
2. **状态跟踪场景**：考生关心当前考试进度，下一步需要做什么
3. **问题排查场景**：当考生遇到问题时，需要通过个人信息进行自助排查

#### 详细功能设计

##### 1. 页面架构设计
```
pages/candidate/
├── profile/
│   ├── index/           # 个人中心主页
│   ├── basic-info/      # 基本信息详情页
│   ├── exam-info/       # 考试信息详情页
│   ├── status-track/    # 状态跟踪页
│   └── progress-guide/  # 进度指引页
```

##### 2. 核心功能实现思路

**2.1 个人信息数据获取与缓存**
```javascript
// 个人信息管理类
class CandidateProfileManager {
  constructor() {
    this.candidateId = wx.getStorageSync('userInfo').candidate_id;
    this.profileData = null;
    this.lastUpdateTime = 0;
    this.cacheExpireTime = 5 * 60 * 1000; // 5分钟缓存
  }
  
  // 获取考生详细信息
  async getCandidateInfo(forceRefresh = false) {
    // 检查缓存有效性
    if (!forceRefresh && this.profileData && 
        (Date.now() - this.lastUpdateTime < this.cacheExpireTime)) {
      return this.profileData;
    }
    
    try {
      wx.showLoading({ title: '加载中...' });
      
      const response = await wx.request({
        url: `${API_BASE}/wx/candidate-info/${this.candidateId}`,
        method: 'GET',
        header: {
          'Authorization': `Bearer ${wx.getStorageSync('authToken')}`
        }
      });
      
      if (response.statusCode === 200) {
        this.profileData = response.data.data;
        this.lastUpdateTime = Date.now();
        
        // 缓存到本地存储
        wx.setStorageSync('candidateProfile', this.profileData);
        
        return this.profileData;
      } else {
        throw new Error(response.data.detail || '获取信息失败');
      }
    } catch (error) {
      // 网络异常时使用本地缓存
      const cachedData = wx.getStorageSync('candidateProfile');
      if (cachedData) {
        console.warn('使用缓存数据:', error.message);
        return cachedData;
      }
      throw error;
    } finally {
      wx.hideLoading();
    }
  }
}
```

**2.2 信息展示与数据处理**
```javascript
// 个人中心页面逻辑
Page({
  data: {
    candidateInfo: {},
    statusConfig: {
      '待排期': { color: '#ff9500', icon: 'clock' },
      '已排期': { color: '#007aff', icon: 'calendar' },
      '考试中': { color: '#34c759', icon: 'play' },
      '已完成': { color: '#8e8e93', icon: 'checkmark' }
    },
    loading: true,
    error: null
  },
  
  async onLoad() {
    await this.loadCandidateInfo();
  },
  
  async onPullDownRefresh() {
    await this.loadCandidateInfo(true);
    wx.stopPullDownRefresh();
  },
  
  // 加载考生信息
  async loadCandidateInfo(forceRefresh = false) {
    try {
      this.setData({ loading: true, error: null });
      
      const profileManager = new CandidateProfileManager();
      const candidateInfo = await profileManager.getCandidateInfo(forceRefresh);
      
      // 数据处理和格式化
      const processedInfo = this.processCandidateInfo(candidateInfo);
      
      this.setData({
        candidateInfo: processedInfo,
        loading: false
      });
      
    } catch (error) {
      console.error('加载考生信息失败:', error);
      this.setData({
        error: error.message,
        loading: false
      });
      
      wx.showToast({
        title: '加载失败，请重试',
        icon: 'error'
      });
    }
  },
  
  // 数据处理和格式化
  processCandidateInfo(rawData) {
    return {
      // 基本信息处理
      basicInfo: {
        name: rawData.name,
        idNumber: this.maskIdNumber(rawData.id_number),
        phone: this.maskPhone(rawData.phone),
        email: rawData.email || '未填写',
        registrationDate: this.formatDate(rawData.registration_date),
        status: rawData.status
      },
      
      // 考试信息处理
      examInfo: {
        product: rawData.exam_product,
        institution: rawData.institution,
        institutionId: rawData.institution_id
      },
      
      // 状态信息处理
      statusInfo: {
        current: rawData.status,
        nextStep: this.getNextStepGuide(rawData.status),
        progress: this.calculateProgress(rawData.status),
        upcomingSchedules: rawData.upcoming_schedules || []
      }
    };
  }
}
```

**2.3 敏感信息脱敏处理**
```javascript
// 数据脱敏工具方法
const DataMaskUtils = {
  // 身份证号脱敏
  maskIdNumber(idNumber) {
    if (!idNumber || idNumber.length !== 18) return idNumber;
    return idNumber.substring(0, 6) + '****' + idNumber.substring(14);
  },
  
  // 手机号脱敏
  maskPhone(phone) {
    if (!phone || phone.length !== 11) return phone;
    return phone.substring(0, 3) + '****' + phone.substring(7);
  },
  
  // 邮箱脱敏
  maskEmail(email) {
    if (!email || !email.includes('@')) return email;
    const [username, domain] = email.split('@');
    const maskedUsername = username.length > 2 
      ? username.substring(0, 2) + '***' 
      : username;
    return maskedUsername + '@' + domain;
  }
};
```

##### 3. API接口对接详情

**3.1 考生详细信息接口**
```javascript
// API: GET /wx/candidate-info/{candidate_id}
// 请求头：Authorization: Bearer {access_token}

// 响应数据结构：
{
  "message": "考生信息获取成功",
  "data": {
    "id": 1,
    "name": "张三",
    "id_number": "110101199001011234",
    "phone": "13800138001",
    "email": "zhangsan@example.com",
    "exam_product": "无人机驾驶员考试",
    "institution": "北京航空培训中心",
    "institution_id": 1,
    "status": "已排期",
    "registration_date": "2025-08-01",
    "upcoming_schedules": [
      {
        "id": 1,
        "activity_name": "理论考试",
        "exam_date": "2025-08-15",
        "start_time": "09:00",
        "end_time": "10:30",
        "venue": "理论考场A",
        "status": "scheduled"
      }
    ],
    "current_queue_info": {
      "venue": "实操场地1",
      "position": 3,
      "estimated_wait_time": "约45分钟"
    }
  }
}
```

##### 4. 用户界面设计

**4.1 个人中心主页布局**
```xml
<!-- 个人中心主页模板 -->
<view class="profile-container">
  <!-- 头部信息卡片 -->
  <view class="profile-header">
    <view class="avatar-section">
      <image class="avatar" src="{{candidateInfo.avatar || '/images/default-avatar.png'}}" />
      <view class="status-badge status-{{candidateInfo.basicInfo.status}}">
        {{candidateInfo.basicInfo.status}}
      </view>
    </view>
    
    <view class="basic-info">
      <text class="name">{{candidateInfo.basicInfo.name}}</text>
      <text class="id-number">{{candidateInfo.basicInfo.idNumber}}</text>
      <text class="phone">{{candidateInfo.basicInfo.phone}}</text>
    </view>
  </view>
  
  <!-- 考试信息卡片 -->
  <view class="exam-info-card">
    <view class="card-title">考试信息</view>
    <view class="info-item">
      <text class="label">考试产品：</text>
      <text class="value">{{candidateInfo.examInfo.product}}</text>
    </view>
    <view class="info-item">
      <text class="label">培训机构：</text>
      <text class="value">{{candidateInfo.examInfo.institution}}</text>
    </view>
    <view class="info-item">
      <text class="label">报名时间：</text>
      <text class="value">{{candidateInfo.basicInfo.registrationDate}}</text>
    </view>
  </view>
  
  <!-- 状态跟踪卡片 -->
  <view class="status-track-card">
    <view class="card-title">考试进度</view>
    <view class="progress-bar">
      <view class="progress-fill" style="width: {{candidateInfo.statusInfo.progress}}%"></view>
    </view>
    <view class="next-step">
      <text class="step-title">下一步：</text>
      <text class="step-content">{{candidateInfo.statusInfo.nextStep}}</text>
    </view>
  </view>
  
  <!-- 功能入口 -->
  <view class="function-entries">
    <navigator url="/pages/candidate/schedule/index" class="entry-item">
      <image class="entry-icon" src="/images/schedule-icon.png" />
      <text class="entry-text">考试安排</text>
    </navigator>
    
    <navigator url="/pages/candidate/qrcode/index" class="entry-item">
      <image class="entry-icon" src="/images/qrcode-icon.png" />
      <text class="entry-text">我的二维码</text>
    </navigator>
    
    <navigator url="/pages/public/venues/index" class="entry-item">
      <image class="entry-icon" src="/images/venues-icon.png" />
      <text class="entry-text">考场状态</text>
    </navigator>
  </view>
</view>
```

**4.2 状态指示与进度计算**
```javascript
// 状态处理工具类
class StatusManager {
  // 获取下一步操作指引
  static getNextStepGuide(currentStatus) {
    const stepGuides = {
      '待排期': '请耐心等待考务管理员为您安排考试时间',
      '已排期': '请查看考试安排，准时参加考试',
      '考试中': '请按照考务人员指引完成考试流程',
      '已完成': '考试已完成，请等待成绩公布'
    };
    
    return stepGuides[currentStatus] || '请联系培训机构了解详情';
  }
  
  // 计算考试进度百分比
  static calculateProgress(currentStatus) {
    const progressMap = {
      '待排期': 25,
      '已排期': 50,
      '考试中': 75,
      '已完成': 100
    };
    
    return progressMap[currentStatus] || 0;
  }
  
  // 获取状态颜色配置
  static getStatusColor(status) {
    const colorMap = {
      '待排期': '#ff9500',
      '已排期': '#007aff',
      '考试中': '#34c759',
      '已完成': '#8e8e93'
    };
    
    return colorMap[status] || '#8e8e93';
  }
}
```

##### 5. 交互体验优化

**5.1 下拉刷新与上拉加载**
```javascript
// 下拉刷新实现
onPullDownRefresh() {
  this.loadCandidateInfo(true).then(() => {
    wx.stopPullDownRefresh();
    wx.showToast({
      title: '刷新成功',
      icon: 'success',
      duration: 1500
    });
  });
},

// 页面显示时自动刷新
onShow() {
  // 如果数据超过5分钟，自动刷新
  const lastUpdate = wx.getStorageSync('profileLastUpdate') || 0;
  if (Date.now() - lastUpdate > 5 * 60 * 1000) {
    this.loadCandidateInfo(true);
  }
}
```

**5.2 错误处理与重试机制**
```javascript
// 错误处理组件
const ErrorHandler = {
  // 显示错误信息
  showError(error, retryCallback) {
    wx.showModal({
      title: '加载失败',
      content: error.message || '网络异常，请检查网络连接',
      confirmText: '重试',
      cancelText: '取消',
      success: (res) => {
        if (res.confirm && retryCallback) {
          retryCallback();
        }
      }
    });
  },
  
  // 网络状态检查
  checkNetworkStatus() {
    return new Promise((resolve) => {
      wx.getNetworkType({
        success: (res) => {
          if (res.networkType === 'none') {
            wx.showToast({
              title: '网络连接异常',
              icon: 'error'
            });
            resolve(false);
          } else {
            resolve(true);
          }
        }
      });
    });
  }
};
```

##### 6. 数据同步与状态管理

**6.1 全局状态同步**
```javascript
// 全局状态管理
const GlobalState = {
  candidateInfo: null,
  
  // 更新考生信息
  updateCandidateInfo(newInfo) {
    this.candidateInfo = newInfo;
    
    // 通知其他页面更新
    wx.$emit('candidateInfoUpdated', newInfo);
    
    // 更新本地存储
    wx.setStorageSync('candidateProfile', newInfo);
  },
  
  // 获取考生信息
  getCandidateInfo() {
    if (!this.candidateInfo) {
      this.candidateInfo = wx.getStorageSync('candidateProfile');
    }
    return this.candidateInfo;
  }
};
```

**6.2 数据变更监听**
```javascript
// 页面数据变更监听
onLoad() {
  // 监听考生信息更新事件
  wx.$on('candidateInfoUpdated', (newInfo) => {
    this.setData({
      candidateInfo: this.processCandidateInfo(newInfo)
    });
  });
  
  // 监听考试状态变更
  wx.$on('examStatusChanged', (newStatus) => {
    this.updateExamStatus(newStatus);
  });
},

onUnload() {
  // 清理事件监听
  wx.$off('candidateInfoUpdated');
  wx.$off('examStatusChanged');
}
```

##### 7. 性能优化策略

**7.1 图片懒加载**
```javascript
// 图片懒加载实现
const ImageLazyLoader = {
  // 观察器实例
  observer: null,
  
  // 初始化懒加载
  init() {
    this.observer = wx.createIntersectionObserver();
    
    this.observer.relativeToViewport().observe('.lazy-image', (res) => {
      if (res.intersectionRatio > 0) {
        // 图片进入视口，开始加载
        const dataset = res.target.dataset;
        if (dataset.src) {
          res.target.src = dataset.src;
          res.target.classList.remove('lazy-image');
        }
      }
    });
  },
  
  // 销毁观察器
  destroy() {
    if (this.observer) {
      this.observer.disconnect();
    }
  }
};
```

**7.2 数据预加载**
```javascript
// 相关数据预加载
preloadRelatedData() {
  // 预加载考试安排数据
  wx.request({
    url: `${API_BASE}/wx/candidate-info/${this.candidateId}`,
    method: 'GET',
    header: {
      'Authorization': `Bearer ${wx.getStorageSync('authToken')}`
    },
    success: (res) => {
      // 缓存预加载的数据
      wx.setStorageSync('preloadedSchedules', res.data.upcoming_schedules);
    }
  });
}
```

#### 模块总结
考生个人中心模块通过清晰的信息展示、智能的状态跟踪、友好的交互体验，为考生提供了全面的个人信息管理功能。该模块不仅展示静态信息，更重要的是通过状态跟踪和进度指引，帮助考生了解当前所处的考试阶段和下一步操作，大大减少了考生的困惑和咨询需求。通过合理的缓存策略和性能优化，确保了良好的用户体验。
# 考点运营与流程管理微信小程序 - 详细模块分析

## 一、模块总览

基于需求文档和现有API分析，微信小程序可划分为以下9个功能模块：

### 核心业务模块（6个）
1. **身份认证模块** - 用户登录和身份验证
2. **考生个人中心模块** - 个人信息展示和管理
3. **动态二维码模块** - 考生身份凭证生成和展示
4. **考试日程模块** - 个人考试安排和排队状态
5. **考务扫码模块** - 考务人员签到操作
6. **公共看板模块** - 实时考场状态广播

### 辅助支持模块（3个）
7. **消息通知模块** - 状态变更和重要提醒
8. **帮助指引模块** - 使用说明和常见问题
9. **系统设置模块** - 个人偏好和应用设置

---

## 二、详细模块分析

### 模块1：身份认证模块（详细设计）

#### 模块作用与重要性
身份认证模块是整个小程序的入口和安全基础，承担着用户身份验证、权限分离、会话管理等核心职责。该模块的设计质量直接影响用户体验和系统安全性。

#### 业务场景分析
1. **考生场景**：考生通过身份证号快速登录，无需记忆复杂账号密码，降低使用门槛
2. **考务人员场景**：考务人员使用管理员分配的专用账号，确保操作权限的严格控制
3. **自动登录场景**：已登录用户再次进入小程序时自动识别身份，提升使用便利性

#### 详细功能设计

##### 1. 页面架构设计
```
app.js (应用入口)
├── pages/auth/
│   ├── role-select/     # 角色选择页
│   ├── candidate-login/ # 考生登录页
│   ├── staff-login/     # 考务登录页
│   ├── login-result/    # 登录结果页
│   └── auto-login/      # 自动登录处理页
```

##### 2. 核心功能实现思路

**2.1 角色选择与路由分发**
```javascript
// 实现思路：智能角色识别
onLaunch() {
  // 检查本地存储的用户信息
  const userInfo = wx.getStorageSync('userInfo');
  const userRole = wx.getStorageSync('userRole');
  
  if (userInfo && userRole) {
    // 自动登录验证
    this.autoLogin(userInfo, userRole);
  } else {
    // 跳转角色选择页
    wx.navigateTo({
      url: '/pages/auth/role-select/index'
    });
  }
}
```

**2.2 考生身份证登录机制**
```javascript
// 考生登录核心逻辑
candidateLogin(idCard) {
  // 1. 前端验证身份证格式
  if (!this.validateIdCard(idCard)) {
    wx.showToast({
      title: '身份证格式不正确',
      icon: 'error'
    });
    return;
  }
  
  // 2. 调用后端API验证
  wx.request({
    url: `${API_BASE}/wx/login-by-idcard`,
    method: 'POST',
    data: { id_card: idCard },
    success: (res) => {
      if (res.statusCode === 200) {
        // 3. 保存用户信息和令牌
        this.saveUserSession(res.data, 'candidate');
        // 4. 绑定微信openid
        this.bindWechatOpenId(res.data.access_token);
        // 5. 跳转到考生主页
        wx.switchTab({
          url: '/pages/candidate/index/index'
        });
      } else {
        this.handleLoginError(res.data);
      }
    }
  });
}
```

**2.3 考务人员账号登录机制**
```javascript
// 考务人员登录核心逻辑
staffLogin(username, password) {
  // 1. 前端基础验证
  if (!username || !password) {
    wx.showToast({
      title: '请输入账号和密码',
      icon: 'error'
    });
    return;
  }
  
  // 2. 调用标准登录接口
  wx.request({
    url: `${API_BASE}/wx/login`,
    method: 'POST',
    data: {
      code: '', // 微信登录code（可选）
      username: username,
      password: password,
      user_type: 'staff'
    },
    success: (res) => {
      if (res.statusCode === 200) {
        // 3. 保存会话信息
        this.saveUserSession(res.data, 'staff');
        // 4. 跳转到考务工作台
        wx.switchTab({
          url: '/pages/staff/workspace/index'
        });
      } else {
        this.handleLoginError(res.data);
      }
    }
  });
}
```

**2.4 自动登录与会话管理**
```javascript
// 自动登录验证机制
autoLogin(userInfo, userRole) {
  // 1. 检查令牌有效性
  wx.request({
    url: `${API_BASE}/wx/health`,
    method: 'GET',
    header: {
      'Authorization': `Bearer ${userInfo.access_token}`
    },
    success: (res) => {
      if (res.statusCode === 200) {
        // 令牌有效，直接跳转对应主页
        this.navigateToHomePage(userRole);
      } else {
        // 令牌失效，清除本地数据，重新登录
        this.clearUserSession();
        wx.navigateTo({
          url: '/pages/auth/role-select/index'
        });
      }
    }
  });
}
```

##### 3. API接口对接详情

**3.1 考生身份证登录接口**
```javascript
// API: POST /wx/login-by-idcard
// 请求参数：
{
  "id_card": "110101199001011234"  // 18位身份证号
}

// 响应数据：
{
  "message": "登录成功",
  "access_token": "candidate_1_1234",
  "candidate_info": {
    "id": 1,
    "name": "张三",
    "id_number": "110101199001011234",
    "phone": "13800138001",
    "exam_product": "无人机驾驶员考试",
    "institution": "北京航空培训中心",
    "status": "待排期"
  },
  "login_time": "2025-08-03T19:45:00"
}
```

**3.2 标准登录接口**
```javascript
// API: POST /wx/login
// 请求参数：
{
  "code": "微信登录code（可选）",
  "id_card": "身份证号（考生用）",
  "username": "用户名（考务用）",
  "password": "密码（考务用）"
}

// 响应数据：
{
  "access_token": "JWT令牌",
  "token_type": "bearer",
  "candidate_id": 1,  // 考生ID（考生登录时）
  "candidate_name": "张三",
  "phone": "13800138001",
  "status": "已排期"
}
```

**3.3 健康检查接口**
```javascript
// API: GET /wx/health
// 用途：验证服务可用性和令牌有效性
// 响应数据：
{
  "status": "healthy",
  "service": "微信小程序服务",
  "version": "1.0.0",
  "features": ["考生登录", "信息查询", "签到功能"]
}
```

##### 4. 技术实现细节

**4.1 身份证号验证算法**
```javascript
// 身份证号格式验证
validateIdCard(idCard) {
  // 基础格式检查
  if (!/^\d{17}[\dXx]$/.test(idCard)) {
    return false;
  }
  
  // 校验码验证
  const weights = [7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2];
  const checkCodes = ['1', '0', 'X', '9', '8', '7', '6', '5', '4', '3', '2'];
  
  let sum = 0;
  for (let i = 0; i < 17; i++) {
    sum += parseInt(idCard[i]) * weights[i];
  }
  
  const checkCode = checkCodes[sum % 11];
  return checkCode === idCard[17].toUpperCase();
}
```

**4.2 会话状态管理**
```javascript
// 用户会话管理工具类
class SessionManager {
  // 保存用户会话
  static saveUserSession(userData, userRole) {
    wx.setStorageSync('userInfo', userData);
    wx.setStorageSync('userRole', userRole);
    wx.setStorageSync('loginTime', new Date().getTime());
    
    // 设置全局请求头
    wx.setStorageSync('authToken', userData.access_token);
  }
  
  // 清除用户会话
  static clearUserSession() {
    wx.removeStorageSync('userInfo');
    wx.removeStorageSync('userRole');
    wx.removeStorageSync('loginTime');
    wx.removeStorageSync('authToken');
  }
  
  // 检查会话有效性
  static isSessionValid() {
    const loginTime = wx.getStorageSync('loginTime');
    const currentTime = new Date().getTime();
    const sessionTimeout = 24 * 60 * 60 * 1000; // 24小时
    
    return loginTime && (currentTime - loginTime < sessionTimeout);
  }
}
```

**4.3 微信OpenID绑定机制**
```javascript
// 绑定微信OpenID
bindWechatOpenId(accessToken) {
  wx.login({
    success: (res) => {
      if (res.code) {
        // 将微信code发送到后端进行OpenID绑定
        wx.request({
          url: `${API_BASE}/wx/bind-openid`,
          method: 'POST',
          header: {
            'Authorization': `Bearer ${accessToken}`
          },
          data: {
            wx_code: res.code
          },
          success: (bindRes) => {
            console.log('OpenID绑定成功', bindRes.data);
          }
        });
      }
    }
  });
}
```

##### 5. 用户体验优化

**5.1 加载状态管理**
```javascript
// 登录过程中的用户反馈
showLoginLoading() {
  wx.showLoading({
    title: '登录中...',
    mask: true
  });
}

hideLoginLoading() {
  wx.hideLoading();
}
```

**5.2 错误处理与用户提示**
```javascript
// 统一的错误处理机制
handleLoginError(errorData) {
  const errorMessages = {
    400: '输入信息格式不正确',
    404: '未找到该考生信息，请联系培训机构',
    403: '账号状态异常，无法登录',
    500: '系统繁忙，请稍后重试'
  };
  
  const message = errorMessages[errorData.status_code] || errorData.detail || '登录失败';
  
  wx.showModal({
    title: '登录失败',
    content: message,
    showCancel: false,
    confirmText: '确定'
  });
}
```

##### 6. 安全性考虑

**6.1 数据传输安全**
- 所有API请求使用HTTPS加密传输
- 敏感信息（如身份证号）在传输前进行基础验证
- 访问令牌采用JWT格式，包含过期时间

**6.2 本地存储安全**
- 敏感信息加密存储在本地
- 定期清理过期的会话数据
- 防止信息泄露的安全措施

**6.3 防重放攻击**
```javascript
// 请求防重复提交
let isSubmitting = false;

submitLogin() {
  if (isSubmitting) {
    wx.showToast({
      title: '请勿重复提交',
      icon: 'error'
    });
    return;
  }
  
  isSubmitting = true;
  
  // 执行登录逻辑
  this.performLogin().finally(() => {
    isSubmitting = false;
  });
}
```

##### 7. 数据流转详细设计

```
用户进入小程序
    ↓
检查本地会话状态
    ↓
[有效会话] → 自动登录验证 → [成功] → 跳转对应主页
    ↓                      ↓
[无效/无会话]              [失败] → 清除本地数据
    ↓                      ↓
显示角色选择页面 ←----------┘
    ↓
[考生] → 身份证登录页 → 输入身份证 → API验证 → 保存会话 → 考生主页
    ↓
[考务] → 账号登录页 → 输入账号密码 → API验证 → 保存会话 → 考务工作台
```

##### 8. 性能优化策略

**8.1 页面预加载**
```javascript
// 在角色选择页预加载后续页面
onReady() {
  // 预加载考生登录页
  wx.preloadPage({
    url: '/pages/auth/candidate-login/index'
  });
  
  // 预加载考务登录页
  wx.preloadPage({
    url: '/pages/auth/staff-login/index'
  });
}
```

**8.2 网络请求优化**
```javascript
// 网络请求封装，支持重试和缓存
class NetworkManager {
  static async request(options, retryCount = 3) {
    try {
      const response = await wx.request(options);
      return response;
    } catch (error) {
      if (retryCount > 0) {
        await this.delay(1000); // 延迟1秒重试
        return this.request(options, retryCount - 1);
      }
      throw error;
    }
  }
  
  static delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}
```

#### 模块总结
身份认证模块作为整个小程序的入口，需要在安全性、易用性、性能等方面做到平衡。通过双重登录机制（考生身份证登录 + 考务账号登录）、自动登录、会话管理等功能，为不同角色用户提供便捷而安全的身份验证服务。该模块的成功实现将为后续所有功能模块奠定坚实的基础。
# 考点运营与流程管理微信小程序 - 详细模块分析

## 一、模块总览

基于需求文档和现有API分析，微信小程序可划分为以下9个功能模块：

### 核心业务模块（6个）
1. **身份认证模块** - 用户登录和身份验证
2. **考生个人中心模块** - 个人信息展示和管理
3. **动态二维码模块** - 考生身份凭证生成和展示
4. **考试日程模块** - 个人考试安排和排队状态
5. **考务扫码模块** - 考务人员签到操作
6. **公共看板模块** - 实时考场状态广播

### 辅助支持模块（3个）
7. **消息通知模块** - 状态变更和重要提醒
8. **帮助指引模块** - 使用说明和常见问题
9. **系统设置模块** - 个人偏好和应用设置

---

## 二、详细模块分析

# 考点运营与流程管理微信小程序 - 详细模块分析

## 一、模块总览

基于需求文档和现有API分析，微信小程序可划分为以下9个功能模块：

### 核心业务模块（6个）
1. **身份认证模块** - 用户登录和身份验证
2. **考生个人中心模块** - 个人信息展示和管理
3. **动态二维码模块** - 考生身份凭证生成和展示
4. **考试日程模块** - 个人考试安排和排队状态
5. **考务扫码模块** - 考务人员签到操作
6. **公共看板模块** - 实时考场状态广播

### 辅助支持模块（3个）
7. **消息通知模块** - 状态变更和重要提醒
8. **帮助指引模块** - 使用说明和常见问题
9. **系统设置模块** - 个人偏好和应用设置

---

## 二、详细模块分析

### 模块1：身份认证模块

#### 功能描述
为考生和考务人员提供不同的登录方式，实现身份验证和权限分离。

#### 页面设计
- **登录选择页** - 用户角色选择（考生/考务人员）
- **考生登录页** - 身份证号快速登录
- **考务登录页** - 账号密码登录
- **登录结果页** - 登录成功/失败反馈

#### 核心功能点
1. **考生登录流程**：
   - 输入18位身份证号码
   - 系统验证身份证格式和考生信息
   - 绑定微信openid实现后续自动登录
   - 返回考生基本信息和访问令牌

2. **考务人员登录流程**：
   - 使用管理员分配的账号密码
   - 验证考务人员身份和权限
   - 进入考务工作台

3. **自动登录机制**：
   - 检测已绑定的微信用户
   - 自动跳转到对应角色的主页面

#### 对接API
- `POST /wx/login-by-idcard` - 考生身份证登录
- `POST /wx/login` - 标准登录接口
- `GET /wx/health` - 服务健康检查

#### 数据流转
```
用户输入 → 身份验证 → 角色判断 → 生成令牌 → 跳转主页
```

---

# 考点运营与流程管理微信小程序 - 详细模块分析

## 一、模块总览

基于需求文档和现有API分析，微信小程序可划分为以下9个功能模块：

### 核心业务模块（6个）
1. **身份认证模块** - 用户登录和身份验证
2. **考生个人中心模块** - 个人信息展示和管理
3. **动态二维码模块** - 考生身份凭证生成和展示
4. **考试日程模块** - 个人考试安排和排队状态
5. **考务扫码模块** - 考务人员签到操作
6. **公共看板模块** - 实时考场状态广播

### 辅助支持模块（3个）
7. **消息通知模块** - 状态变更和重要提醒
8. **帮助指引模块** - 使用说明和常见问题
9. **系统设置模块** - 个人偏好和应用设置

---

## 二、详细模块分析

### 模块1：身份认证模块（详细设计）

#### 模块作用与重要性
身份认证模块是整个小程序的入口和安全基础，承担着用户身份验证、权限分离、会话管理等核心职责。该模块的设计质量直接影响用户体验和系统安全性。

#### 业务场景分析
1. **考生场景**：考生通过身份证号快速登录，无需记忆复杂账号密码，降低使用门槛
2. **考务人员场景**：考务人员使用管理员分配的专用账号，确保操作权限的严格控制
3. **自动登录场景**：已登录用户再次进入小程序时自动识别身份，提升使用便利性

#### 详细功能设计

##### 1. 页面架构设计
```
app.js (应用入口)
├── pages/auth/
│   ├── role-select/     # 角色选择页
│   ├── candidate-login/ # 考生登录页
│   ├── staff-login/     # 考务登录页
│   ├── login-result/    # 登录结果页
│   └── auto-login/      # 自动登录处理页
```

##### 2. 核心功能实现思路

**2.1 角色选择与路由分发**
```javascript
// 实现思路：智能角色识别
onLaunch() {
  // 检查本地存储的用户信息
  const userInfo = wx.getStorageSync('userInfo');
  const userRole = wx.getStorageSync('userRole');
  
  if (userInfo && userRole) {
    // 自动登录验证
    this.autoLogin(userInfo, userRole);
  } else {
    // 跳转角色选择页
    wx.navigateTo({
      url: '/pages/auth/role-select/index'
    });
  }
}
```

**2.2 考生身份证登录机制**
```javascript
// 考生登录核心逻辑
candidateLogin(idCard) {
  // 1. 前端验证身份证格式
  if (!this.validateIdCard(idCard)) {
    wx.showToast({
      title: '身份证格式不正确',
      icon: 'error'
    });
    return;
  }
  
  // 2. 调用后端API验证
  wx.request({
    url: `${API_BASE}/wx/login-by-idcard`,
    method: 'POST',
    data: { id_card: idCard },
    success: (res) => {
      if (res.statusCode === 200) {
        // 3. 保存用户信息和令牌
        this.saveUserSession(res.data, 'candidate');
        // 4. 绑定微信openid
        this.bindWechatOpenId(res.data.access_token);
        // 5. 跳转到考生主页
        wx.switchTab({
          url: '/pages/candidate/index/index'
        });
      } else {
        this.handleLoginError(res.data);
      }
    }
  });
}
```

**2.3 考务人员账号登录机制**
```javascript
// 考务人员登录核心逻辑
staffLogin(username, password) {
  // 1. 前端基础验证
  if (!username || !password) {
    wx.showToast({
      title: '请输入账号和密码',
      icon: 'error'
    });
    return;
  }
  
  // 2. 调用标准登录接口
  wx.request({
    url: `${API_BASE}/wx/login`,
    method: 'POST',
    data: {
      code: '', // 微信登录code（可选）
      username: username,
      password: password,
      user_type: 'staff'
    },
    success: (res) => {
      if (res.statusCode === 200) {
        // 3. 保存会话信息
        this.saveUserSession(res.data, 'staff');
        // 4. 跳转到考务工作台
        wx.switchTab({
          url: '/pages/staff/workspace/index'
        });
      } else {
        this.handleLoginError(res.data);
      }
    }
  });
}
```

**2.4 自动登录与会话管理**
```javascript
// 自动登录验证机制
autoLogin(userInfo, userRole) {
  // 1. 检查令牌有效性
  wx.request({
    url: `${API_BASE}/wx/health`,
    method: 'GET',
    header: {
      'Authorization': `Bearer ${userInfo.access_token}`
    },
    success: (res) => {
      if (res.statusCode === 200) {
        // 令牌有效，直接跳转对应主页
        this.navigateToHomePage(userRole);
      } else {
        // 令牌失效，清除本地数据，重新登录
        this.clearUserSession();
        wx.navigateTo({
          url: '/pages/auth/role-select/index'
        });
      }
    }
  });
}
```

##### 3. API接口对接详情

**3.1 考生身份证登录接口**
```javascript
// API: POST /wx/login-by-idcard
// 请求参数：
{
  "id_card": "110101199001011234"  // 18位身份证号
}

// 响应数据：
{
  "message": "登录成功",
  "access_token": "candidate_1_1234",
  "candidate_info": {
    "id": 1,
    "name": "张三",
    "id_number": "110101199001011234",
    "phone": "13800138001",
    "exam_product": "无人机驾驶员考试",
    "institution": "北京航空培训中心",
    "status": "待排期"
  },
  "login_time": "2025-08-03T19:45:00"
}
```

**3.2 标准登录接口**
```javascript
// API: POST /wx/login
// 请求参数：
{
  "code": "微信登录code（可选）",
  "id_card": "身份证号（考生用）",
  "username": "用户名（考务用）",
  "password": "密码（考务用）"
}

// 响应数据：
{
  "access_token": "JWT令牌",
  "token_type": "bearer",
  "candidate_id": 1,  // 考生ID（考生登录时）
  "candidate_name": "张三",
  "phone": "13800138001",
  "status": "已排期"
}
```

**3.3 健康检查接口**
```javascript
// API: GET /wx/health
// 用途：验证服务可用性和令牌有效性
// 响应数据：
{
  "status": "healthy",
  "service": "微信小程序服务",
  "version": "1.0.0",
  "features": ["考生登录", "信息查询", "签到功能"]
}
```

##### 4. 技术实现细节

**4.1 身份证号验证算法**
```javascript
// 身份证号格式验证
validateIdCard(idCard) {
  // 基础格式检查
  if (!/^\d{17}[\dXx]$/.test(idCard)) {
    return false;
  }
  
  // 校验码验证
  const weights = [7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2];
  const checkCodes = ['1', '0', 'X', '9', '8', '7', '6', '5', '4', '3', '2'];
  
  let sum = 0;
  for (let i = 0; i < 17; i++) {
    sum += parseInt(idCard[i]) * weights[i];
  }
  
  const checkCode = checkCodes[sum % 11];
  return checkCode === idCard[17].toUpperCase();
}
```

**4.2 会话状态管理**
```javascript
// 用户会话管理工具类
class SessionManager {
  // 保存用户会话
  static saveUserSession(userData, userRole) {
    wx.setStorageSync('userInfo', userData);
    wx.setStorageSync('userRole', userRole);
    wx.setStorageSync('loginTime', new Date().getTime());
    
    // 设置全局请求头
    wx.setStorageSync('authToken', userData.access_token);
  }
  
  // 清除用户会话
  static clearUserSession() {
    wx.removeStorageSync('userInfo');
    wx.removeStorageSync('userRole');
    wx.removeStorageSync('loginTime');
    wx.removeStorageSync('authToken');
  }
  
  // 检查会话有效性
  static isSessionValid() {
    const loginTime = wx.getStorageSync('loginTime');
    const currentTime = new Date().getTime();
    const sessionTimeout = 24 * 60 * 60 * 1000; // 24小时
    
    return loginTime && (currentTime - loginTime < sessionTimeout);
  }
}
```

**4.3 微信OpenID绑定机制**
```javascript
// 绑定微信OpenID
bindWechatOpenId(accessToken) {
  wx.login({
    success: (res) => {
      if (res.code) {
        // 将微信code发送到后端进行OpenID绑定
        wx.request({
          url: `${API_BASE}/wx/bind-openid`,
          method: 'POST',
          header: {
            'Authorization': `Bearer ${accessToken}`
          },
          data: {
            wx_code: res.code
          },
          success: (bindRes) => {
            console.log('OpenID绑定成功', bindRes.data);
          }
        });
      }
    }
  });
}
```

##### 5. 用户体验优化

**5.1 加载状态管理**
```javascript
// 登录过程中的用户反馈
showLoginLoading() {
  wx.showLoading({
    title: '登录中...',
    mask: true
  });
}

hideLoginLoading() {
  wx.hideLoading();
}
```

**5.2 错误处理与用户提示**
```javascript
// 统一的错误处理机制
handleLoginError(errorData) {
  const errorMessages = {
    400: '输入信息格式不正确',
    404: '未找到该考生信息，请联系培训机构',
    403: '账号状态异常，无法登录',
    500: '系统繁忙，请稍后重试'
  };
  
  const message = errorMessages[errorData.status_code] || errorData.detail || '登录失败';
  
  wx.showModal({
    title: '登录失败',
    content: message,
    showCancel: false,
    confirmText: '确定'
  });
}
```

##### 6. 安全性考虑

**6.1 数据传输安全**
- 所有API请求使用HTTPS加密传输
- 敏感信息（如身份证号）在传输前进行基础验证
- 访问令牌采用JWT格式，包含过期时间

**6.2 本地存储安全**
- 敏感信息加密存储在本地
- 定期清理过期的会话数据
- 防止信息泄露的安全措施

**6.3 防重放攻击**
```javascript
// 请求防重复提交
let isSubmitting = false;

submitLogin() {
  if (isSubmitting) {
    wx.showToast({
      title: '请勿重复提交',
      icon: 'error'
    });
    return;
  }
  
  isSubmitting = true;
  
  // 执行登录逻辑
  this.performLogin().finally(() => {
    isSubmitting = false;
  });
}
```

##### 7. 数据流转详细设计

```
用户进入小程序
    ↓
检查本地会话状态
    ↓
[有效会话] → 自动登录验证 → [成功] → 跳转对应主页
    ↓                      ↓
[无效/无会话]              [失败] → 清除本地数据
    ↓                      ↓
显示角色选择页面 ←----------┘
    ↓
[考生] → 身份证登录页 → 输入身份证 → API验证 → 保存会话 → 考生主页
    ↓
[考务] → 账号登录页 → 输入账号密码 → API验证 → 保存会话 → 考务工作台
```

##### 8. 性能优化策略

**8.1 页面预加载**
```javascript
// 在角色选择页预加载后续页面
onReady() {
  // 预加载考生登录页
  wx.preloadPage({
    url: '/pages/auth/candidate-login/index'
  });
  
  // 预加载考务登录页
  wx.preloadPage({
    url: '/pages/auth/staff-login/index'
  });
}
```

**8.2 网络请求优化**
```javascript
// 网络请求封装，支持重试和缓存
class NetworkManager {
  static async request(options, retryCount = 3) {
    try {
      const response = await wx.request(options);
      return response;
    } catch (error) {
      if (retryCount > 0) {
        await this.delay(1000); // 延迟1秒重试
        return this.request(options, retryCount - 1);
      }
      throw error;
    }
  }
  
  static delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}
```

#### 模块总结
身份认证模块作为整个小程序的入口，需要在安全性、易用性、性能等方面做到平衡。通过双重登录机制（考生身份证登录 + 考务账号登录）、自动登录、会话管理等功能，为不同角色用户提供便捷而安全的身份验证服务。该模块的成功实现将为后续所有功能模块奠定坚实的基础。
# 考点运营与流程管理微信小程序 - 详细模块分析

## 一、模块总览

基于需求文档和现有API分析，微信小程序可划分为以下9个功能模块：

### 核心业务模块（6个）
1. **身份认证模块** - 用户登录和身份验证
2. **考生个人中心模块** - 个人信息展示和管理
3. **动态二维码模块** - 考生身份凭证生成和展示
4. **考试日程模块** - 个人考试安排和排队状态
5. **考务扫码模块** - 考务人员签到操作
6. **公共看板模块** - 实时考场状态广播

### 辅助支持模块（3个）
7. **消息通知模块** - 状态变更和重要提醒
8. **帮助指引模块** - 使用说明和常见问题
9. **系统设置模块** - 个人偏好和应用设置

---

## 二、详细模块分析

# 考点运营与流程管理微信小程序 - 详细模块分析

## 一、模块总览

基于需求文档和现有API分析，微信小程序可划分为以下9个功能模块：

### 核心业务模块（6个）
1. **身份认证模块** - 用户登录和身份验证
2. **考生个人中心模块** - 个人信息展示和管理
3. **动态二维码模块** - 考生身份凭证生成和展示
4. **考试日程模块** - 个人考试安排和排队状态
5. **考务扫码模块** - 考务人员签到操作
6. **公共看板模块** - 实时考场状态广播

### 辅助支持模块（3个）
7. **消息通知模块** - 状态变更和重要提醒
8. **帮助指引模块** - 使用说明和常见问题
9. **系统设置模块** - 个人偏好和应用设置

---

## 二、详细模块分析

### 模块1：身份认证模块

#### 功能描述
为考生和考务人员提供不同的登录方式，实现身份验证和权限分离。

#### 页面设计
- **登录选择页** - 用户角色选择（考生/考务人员）
- **考生登录页** - 身份证号快速登录
- **考务登录页** - 账号密码登录
- **登录结果页** - 登录成功/失败反馈

#### 核心功能点
1. **考生登录流程**：
   - 输入18位身份证号码
   - 系统验证身份证格式和考生信息
   - 绑定微信openid实现后续自动登录
   - 返回考生基本信息和访问令牌

2. **考务人员登录流程**：
   - 使用管理员分配的账号密码
   - 验证考务人员身份和权限
   - 进入考务工作台

3. **自动登录机制**：
   - 检测已绑定的微信用户
   - 自动跳转到对应角色的主页面

#### 对接API
- `POST /wx/login-by-idcard` - 考生身份证登录
- `POST /wx/login` - 标准登录接口
- `GET /wx/health` - 服务健康检查

#### 数据流转
```
用户输入 → 身份验证 → 角色判断 → 生成令牌 → 跳转主页
```

---

### 模块2：考生个人中心模块

#### 功能描述
展示考生的完整个人信息，包括基本资料、考试产品、培训机构等信息。

#### 页面设计
- **个人信息页** - 基本资料展示
- **考试信息页** - 考试产品和机构信息
- **状态概览页** - 当前考试状态和进度

#### 核心功能点
1. **基本信息展示**：
   - 考生姓名、身份证号（脱敏显示）
   - 联系电话、邮箱
   - 报名时间和当前状态

2. **考试相关信息**：
   - 报考的考试产品（如"多旋翼视距内驾驶员"）
   - 所属培训机构信息
   - 考试进度和完成状态

3. **状态跟踪**：
   - 当前考试阶段（待排期/已排期/考试中/已完成）
   - 下一步操作提示
   - 重要时间节点提醒

#### 对接API
- `GET /wx/candidate-info/{candidate_id}` - 获取考生详细信息

#### 数据展示结构
```json
{
  "basic_info": {
    "name": "张三",
    "id_number": "110101****1234",
    "phone": "138****8001",
    "status": "已排期"
  },
  "exam_info": {
    "product": "无人机驾驶员考试",
    "institution": "北京航空培训中心",
    "registration_date": "2025-08-01"
  }
}
```

---

# 考点运营与流程管理微信小程序 - 详细模块分析

## 一、模块总览

基于需求文档和现有API分析，微信小程序可划分为以下9个功能模块：

### 核心业务模块（6个）
1. **身份认证模块** - 用户登录和身份验证
2. **考生个人中心模块** - 个人信息展示和管理
3. **动态二维码模块** - 考生身份凭证生成和展示
4. **考试日程模块** - 个人考试安排和排队状态
5. **考务扫码模块** - 考务人员签到操作
6. **公共看板模块** - 实时考场状态广播

### 辅助支持模块（3个）
7. **消息通知模块** - 状态变更和重要提醒
8. **帮助指引模块** - 使用说明和常见问题
9. **系统设置模块** - 个人偏好和应用设置

---

## 二、详细模块分析

### 模块1：身份认证模块（详细设计）

#### 模块作用与重要性
身份认证模块是整个小程序的入口和安全基础，承担着用户身份验证、权限分离、会话管理等核心职责。该模块的设计质量直接影响用户体验和系统安全性。

#### 业务场景分析
1. **考生场景**：考生通过身份证号快速登录，无需记忆复杂账号密码，降低使用门槛
2. **考务人员场景**：考务人员使用管理员分配的专用账号，确保操作权限的严格控制
3. **自动登录场景**：已登录用户再次进入小程序时自动识别身份，提升使用便利性

#### 详细功能设计

##### 1. 页面架构设计
```
app.js (应用入口)
├── pages/auth/
│   ├── role-select/     # 角色选择页
│   ├── candidate-login/ # 考生登录页
│   ├── staff-login/     # 考务登录页
│   ├── login-result/    # 登录结果页
│   └── auto-login/      # 自动登录处理页
```

##### 2. 核心功能实现思路

**2.1 角色选择与路由分发**
```javascript
// 实现思路：智能角色识别
onLaunch() {
  // 检查本地存储的用户信息
  const userInfo = wx.getStorageSync('userInfo');
  const userRole = wx.getStorageSync('userRole');
  
  if (userInfo && userRole) {
    // 自动登录验证
    this.autoLogin(userInfo, userRole);
  } else {
    // 跳转角色选择页
    wx.navigateTo({
      url: '/pages/auth/role-select/index'
    });
  }
}
```

**2.2 考生身份证登录机制**
```javascript
// 考生登录核心逻辑
candidateLogin(idCard) {
  // 1. 前端验证身份证格式
  if (!this.validateIdCard(idCard)) {
    wx.showToast({
      title: '身份证格式不正确',
      icon: 'error'
    });
    return;
  }
  
  // 2. 调用后端API验证
  wx.request({
    url: `${API_BASE}/wx/login-by-idcard`,
    method: 'POST',
    data: { id_card: idCard },
    success: (res) => {
      if (res.statusCode === 200) {
        // 3. 保存用户信息和令牌
        this.saveUserSession(res.data, 'candidate');
        // 4. 绑定微信openid
        this.bindWechatOpenId(res.data.access_token);
        // 5. 跳转到考生主页
        wx.switchTab({
          url: '/pages/candidate/index/index'
        });
      } else {
        this.handleLoginError(res.data);
      }
    }
  });
}
```

**2.3 考务人员账号登录机制**
```javascript
// 考务人员登录核心逻辑
staffLogin(username, password) {
  // 1. 前端基础验证
  if (!username || !password) {
    wx.showToast({
      title: '请输入账号和密码',
      icon: 'error'
    });
    return;
  }
  
  // 2. 调用标准登录接口
  wx.request({
    url: `${API_BASE}/wx/login`,
    method: 'POST',
    data: {
      code: '', // 微信登录code（可选）
      username: username,
      password: password,
      user_type: 'staff'
    },
    success: (res) => {
      if (res.statusCode === 200) {
        // 3. 保存会话信息
        this.saveUserSession(res.data, 'staff');
        // 4. 跳转到考务工作台
        wx.switchTab({
          url: '/pages/staff/workspace/index'
        });
      } else {
        this.handleLoginError(res.data);
      }
    }
  });
}
```

**2.4 自动登录与会话管理**
```javascript
// 自动登录验证机制
autoLogin(userInfo, userRole) {
  // 1. 检查令牌有效性
  wx.request({
    url: `${API_BASE}/wx/health`,
    method: 'GET',
    header: {
      'Authorization': `Bearer ${userInfo.access_token}`
    },
    success: (res) => {
      if (res.statusCode === 200) {
        // 令牌有效，直接跳转对应主页
        this.navigateToHomePage(userRole);
      } else {
        // 令牌失效，清除本地数据，重新登录
        this.clearUserSession();
        wx.navigateTo({
          url: '/pages/auth/role-select/index'
        });
      }
    }
  });
}
```

##### 3. API接口对接详情

**3.1 考生身份证登录接口**
```javascript
// API: POST /wx/login-by-idcard
// 请求参数：
{
  "id_card": "110101199001011234"  // 18位身份证号
}

// 响应数据：
{
  "message": "登录成功",
  "access_token": "candidate_1_1234",
  "candidate_info": {
    "id": 1,
    "name": "张三",
    "id_number": "110101199001011234",
    "phone": "13800138001",
    "exam_product": "无人机驾驶员考试",
    "institution": "北京航空培训中心",
    "status": "待排期"
  },
  "login_time": "2025-08-03T19:45:00"
}
```

**3.2 标准登录接口**
```javascript
// API: POST /wx/login
// 请求参数：
{
  "code": "微信登录code（可选）",
  "id_card": "身份证号（考生用）",
  "username": "用户名（考务用）",
  "password": "密码（考务用）"
}

// 响应数据：
{
  "access_token": "JWT令牌",
  "token_type": "bearer",
  "candidate_id": 1,  // 考生ID（考生登录时）
  "candidate_name": "张三",
  "phone": "13800138001",
  "status": "已排期"
}
```

**3.3 健康检查接口**
```javascript
// API: GET /wx/health
// 用途：验证服务可用性和令牌有效性
// 响应数据：
{
  "status": "healthy",
  "service": "微信小程序服务",
  "version": "1.0.0",
  "features": ["考生登录", "信息查询", "签到功能"]
}
```

##### 4. 技术实现细节

**4.1 身份证号验证算法**
```javascript
// 身份证号格式验证
validateIdCard(idCard) {
  // 基础格式检查
  if (!/^\d{17}[\dXx]$/.test(idCard)) {
    return false;
  }
  
  // 校验码验证
  const weights = [7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2];
  const checkCodes = ['1', '0', 'X', '9', '8', '7', '6', '5', '4', '3', '2'];
  
  let sum = 0;
  for (let i = 0; i < 17; i++) {
    sum += parseInt(idCard[i]) * weights[i];
  }
  
  const checkCode = checkCodes[sum % 11];
  return checkCode === idCard[17].toUpperCase();
}
```

**4.2 会话状态管理**
```javascript
// 用户会话管理工具类
class SessionManager {
  // 保存用户会话
  static saveUserSession(userData, userRole) {
    wx.setStorageSync('userInfo', userData);
    wx.setStorageSync('userRole', userRole);
    wx.setStorageSync('loginTime', new Date().getTime());
    
    // 设置全局请求头
    wx.setStorageSync('authToken', userData.access_token);
  }
  
  // 清除用户会话
  static clearUserSession() {
    wx.removeStorageSync('userInfo');
    wx.removeStorageSync('userRole');
    wx.removeStorageSync('loginTime');
    wx.removeStorageSync('authToken');
  }
  
  // 检查会话有效性
  static isSessionValid() {
    const loginTime = wx.getStorageSync('loginTime');
    const currentTime = new Date().getTime();
    const sessionTimeout = 24 * 60 * 60 * 1000; // 24小时
    
    return loginTime && (currentTime - loginTime < sessionTimeout);
  }
}
```

**4.3 微信OpenID绑定机制**
```javascript
// 绑定微信OpenID
bindWechatOpenId(accessToken) {
  wx.login({
    success: (res) => {
      if (res.code) {
        // 将微信code发送到后端进行OpenID绑定
        wx.request({
          url: `${API_BASE}/wx/bind-openid`,
          method: 'POST',
          header: {
            'Authorization': `Bearer ${accessToken}`
          },
          data: {
            wx_code: res.code
          },
          success: (bindRes) => {
            console.log('OpenID绑定成功', bindRes.data);
          }
        });
      }
    }
  });
}
```

##### 5. 用户体验优化

**5.1 加载状态管理**
```javascript
// 登录过程中的用户反馈
showLoginLoading() {
  wx.showLoading({
    title: '登录中...',
    mask: true
  });
}

hideLoginLoading() {
  wx.hideLoading();
}
```

**5.2 错误处理与用户提示**
```javascript
// 统一的错误处理机制
handleLoginError(errorData) {
  const errorMessages = {
    400: '输入信息格式不正确',
    404: '未找到该考生信息，请联系培训机构',
    403: '账号状态异常，无法登录',
    500: '系统繁忙，请稍后重试'
  };
  
  const message = errorMessages[errorData.status_code] || errorData.detail || '登录失败';
  
  wx.showModal({
    title: '登录失败',
    content: message,
    showCancel: false,
    confirmText: '确定'
  });
}
```

##### 6. 安全性考虑

**6.1 数据传输安全**
- 所有API请求使用HTTPS加密传输
- 敏感信息（如身份证号）在传输前进行基础验证
- 访问令牌采用JWT格式，包含过期时间

**6.2 本地存储安全**
- 敏感信息加密存储在本地
- 定期清理过期的会话数据
- 防止信息泄露的安全措施

**6.3 防重放攻击**
```javascript
// 请求防重复提交
let isSubmitting = false;

submitLogin() {
  if (isSubmitting) {
    wx.showToast({
      title: '请勿重复提交',
      icon: 'error'
    });
    return;
  }
  
  isSubmitting = true;
  
  // 执行登录逻辑
  this.performLogin().finally(() => {
    isSubmitting = false;
  });
}
```

##### 7. 数据流转详细设计

```
用户进入小程序
    ↓
检查本地会话状态
    ↓
[有效会话] → 自动登录验证 → [成功] → 跳转对应主页
    ↓                      ↓
[无效/无会话]              [失败] → 清除本地数据
    ↓                      ↓
显示角色选择页面 ←----------┘
    ↓
[考生] → 身份证登录页 → 输入身份证 → API验证 → 保存会话 → 考生主页
    ↓
[考务] → 账号登录页 → 输入账号密码 → API验证 → 保存会话 → 考务工作台
```

##### 8. 性能优化策略

**8.1 页面预加载**
```javascript
// 在角色选择页预加载后续页面
onReady() {
  // 预加载考生登录页
  wx.preloadPage({
    url: '/pages/auth/candidate-login/index'
  });
  
  // 预加载考务登录页
  wx.preloadPage({
    url: '/pages/auth/staff-login/index'
  });
}
```

**8.2 网络请求优化**
```javascript
// 网络请求封装，支持重试和缓存
class NetworkManager {
  static async request(options, retryCount = 3) {
    try {
      const response = await wx.request(options);
      return response;
    } catch (error) {
      if (retryCount > 0) {
        await this.delay(1000); // 延迟1秒重试
        return this.request(options, retryCount - 1);
      }
      throw error;
    }
  }
  
  static delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}
```

#### 模块总结
身份认证模块作为整个小程序的入口，需要在安全性、易用性、性能等方面做到平衡。通过双重登录机制（考生身份证登录 + 考务账号登录）、自动登录、会话管理等功能，为不同角色用户提供便捷而安全的身份验证服务。该模块的成功实现将为后续所有功能模块奠定坚实的基础。
# 考点运营与流程管理微信小程序 - 详细模块分析

## 一、模块总览

基于需求文档和现有API分析，微信小程序可划分为以下9个功能模块：

### 核心业务模块（6个）
1. **身份认证模块** - 用户登录和身份验证
2. **考生个人中心模块** - 个人信息展示和管理
3. **动态二维码模块** - 考生身份凭证生成和展示
4. **考试日程模块** - 个人考试安排和排队状态
5. **考务扫码模块** - 考务人员签到操作
6. **公共看板模块** - 实时考场状态广播

### 辅助支持模块（3个）
7. **消息通知模块** - 状态变更和重要提醒
8. **帮助指引模块** - 使用说明和常见问题
9. **系统设置模块** - 个人偏好和应用设置

---

## 二、详细模块分析

# 考点运营与流程管理微信小程序 - 详细模块分析

## 一、模块总览

基于需求文档和现有API分析，微信小程序可划分为以下9个功能模块：

### 核心业务模块（6个）
1. **身份认证模块** - 用户登录和身份验证
2. **考生个人中心模块** - 个人信息展示和管理
3. **动态二维码模块** - 考生身份凭证生成和展示
4. **考试日程模块** - 个人考试安排和排队状态
5. **考务扫码模块** - 考务人员签到操作
6. **公共看板模块** - 实时考场状态广播

### 辅助支持模块（3个）
7. **消息通知模块** - 状态变更和重要提醒
8. **帮助指引模块** - 使用说明和常见问题
9. **系统设置模块** - 个人偏好和应用设置

---

## 二、详细模块分析

### 模块1：身份认证模块

#### 功能描述
为考生和考务人员提供不同的登录方式，实现身份验证和权限分离。

#### 页面设计
- **登录选择页** - 用户角色选择（考生/考务人员）
- **考生登录页** - 身份证号快速登录
- **考务登录页** - 账号密码登录
- **登录结果页** - 登录成功/失败反馈

#### 核心功能点
1. **考生登录流程**：
   - 输入18位身份证号码
   - 系统验证身份证格式和考生信息
   - 绑定微信openid实现后续自动登录
   - 返回考生基本信息和访问令牌

2. **考务人员登录流程**：
   - 使用管理员分配的账号密码
   - 验证考务人员身份和权限
   - 进入考务工作台

3. **自动登录机制**：
   - 检测已绑定的微信用户
   - 自动跳转到对应角色的主页面

#### 对接API
- `POST /wx/login-by-idcard` - 考生身份证登录
- `POST /wx/login` - 标准登录接口
- `GET /wx/health` - 服务健康检查

#### 数据流转
```
用户输入 → 身份验证 → 角色判断 → 生成令牌 → 跳转主页
```

---

### 模块2：考生个人中心模块（详细设计）

#### 模块作用与重要性
考生个人中心模块是考生了解自身考试状态、查看个人信息的核心入口。该模块承担着信息展示、状态跟踪、用户引导等重要职责，是提升考生体验和减少咨询压力的关键模块。

#### 业务场景分析
1. **信息查询场景**：考生需要快速了解自己的基本信息、考试产品、培训机构等
2. **状态跟踪场景**：考生关心当前考试进度，下一步需要做什么
3. **问题排查场景**：当考生遇到问题时，需要通过个人信息进行自助排查

#### 详细功能设计

##### 1. 页面架构设计
```
pages/candidate/
├── profile/
│   ├── index/           # 个人中心主页
│   ├── basic-info/      # 基本信息详情页
│   ├── exam-info/       # 考试信息详情页
│   ├── status-track/    # 状态跟踪页
│   └── progress-guide/  # 进度指引页
```

##### 2. 核心功能实现思路

**2.1 个人信息数据获取与缓存**
```javascript
// 个人信息管理类
class CandidateProfileManager {
  constructor() {
    this.candidateId = wx.getStorageSync('userInfo').candidate_id;
    this.profileData = null;
    this.lastUpdateTime = 0;
    this.cacheExpireTime = 5 * 60 * 1000; // 5分钟缓存
  }
  
  // 获取考生详细信息
  async getCandidateInfo(forceRefresh = false) {
    // 检查缓存有效性
    if (!forceRefresh && this.profileData && 
        (Date.now() - this.lastUpdateTime < this.cacheExpireTime)) {
      return this.profileData;
    }
    
    try {
      wx.showLoading({ title: '加载中...' });
      
      const response = await wx.request({
        url: `${API_BASE}/wx/candidate-info/${this.candidateId}`,
        method: 'GET',
        header: {
          'Authorization': `Bearer ${wx.getStorageSync('authToken')}`
        }
      });
      
      if (response.statusCode === 200) {
        this.profileData = response.data.data;
        this.lastUpdateTime = Date.now();
        
        // 缓存到本地存储
        wx.setStorageSync('candidateProfile', this.profileData);
        
        return this.profileData;
      } else {
        throw new Error(response.data.detail || '获取信息失败');
      }
    } catch (error) {
      // 网络异常时使用本地缓存
      const cachedData = wx.getStorageSync('candidateProfile');
      if (cachedData) {
        console.warn('使用缓存数据:', error.message);
        return cachedData;
      }
      throw error;
    } finally {
      wx.hideLoading();
    }
  }
}
```

**2.2 信息展示与数据处理**
```javascript
// 个人中心页面逻辑
Page({
  data: {
    candidateInfo: {},
    statusConfig: {
      '待排期': { color: '#ff9500', icon: 'clock' },
      '已排期': { color: '#007aff', icon: 'calendar' },
      '考试中': { color: '#34c759', icon: 'play' },
      '已完成': { color: '#8e8e93', icon: 'checkmark' }
    },
    loading: true,
    error: null
  },
  
  async onLoad() {
    await this.loadCandidateInfo();
  },
  
  async onPullDownRefresh() {
    await this.loadCandidateInfo(true);
    wx.stopPullDownRefresh();
  },
  
  // 加载考生信息
  async loadCandidateInfo(forceRefresh = false) {
    try {
      this.setData({ loading: true, error: null });
      
      const profileManager = new CandidateProfileManager();
      const candidateInfo = await profileManager.getCandidateInfo(forceRefresh);
      
      // 数据处理和格式化
      const processedInfo = this.processCandidateInfo(candidateInfo);
      
      this.setData({
        candidateInfo: processedInfo,
        loading: false
      });
      
    } catch (error) {
      console.error('加载考生信息失败:', error);
      this.setData({
        error: error.message,
        loading: false
      });
      
      wx.showToast({
        title: '加载失败，请重试',
        icon: 'error'
      });
    }
  },
  
  // 数据处理和格式化
  processCandidateInfo(rawData) {
    return {
      // 基本信息处理
      basicInfo: {
        name: rawData.name,
        idNumber: this.maskIdNumber(rawData.id_number),
        phone: this.maskPhone(rawData.phone),
        email: rawData.email || '未填写',
        registrationDate: this.formatDate(rawData.registration_date),
        status: rawData.status
      },
      
      // 考试信息处理
      examInfo: {
        product: rawData.exam_product,
        institution: rawData.institution,
        institutionId: rawData.institution_id
      },
      
      // 状态信息处理
      statusInfo: {
        current: rawData.status,
        nextStep: this.getNextStepGuide(rawData.status),
        progress: this.calculateProgress(rawData.status),
        upcomingSchedules: rawData.upcoming_schedules || []
      }
    };
  }
}
```

**2.3 敏感信息脱敏处理**
```javascript
// 数据脱敏工具方法
const DataMaskUtils = {
  // 身份证号脱敏
  maskIdNumber(idNumber) {
    if (!idNumber || idNumber.length !== 18) return idNumber;
    return idNumber.substring(0, 6) + '****' + idNumber.substring(14);
  },
  
  // 手机号脱敏
  maskPhone(phone) {
    if (!phone || phone.length !== 11) return phone;
    return phone.substring(0, 3) + '****' + phone.substring(7);
  },
  
  // 邮箱脱敏
  maskEmail(email) {
    if (!email || !email.includes('@')) return email;
    const [username, domain] = email.split('@');
    const maskedUsername = username.length > 2 
      ? username.substring(0, 2) + '***' 
      : username;
    return maskedUsername + '@' + domain;
  }
};
```

##### 3. API接口对接详情

**3.1 考生详细信息接口**
```javascript
// API: GET /wx/candidate-info/{candidate_id}
// 请求头：Authorization: Bearer {access_token}

// 响应数据结构：
{
  "message": "考生信息获取成功",
  "data": {
    "id": 1,
    "name": "张三",
    "id_number": "110101199001011234",
    "phone": "13800138001",
    "email": "zhangsan@example.com",
    "exam_product": "无人机驾驶员考试",
    "institution": "北京航空培训中心",
    "institution_id": 1,
    "status": "已排期",
    "registration_date": "2025-08-01",
    "upcoming_schedules": [
      {
        "id": 1,
        "activity_name": "理论考试",
        "exam_date": "2025-08-15",
        "start_time": "09:00",
        "end_time": "10:30",
        "venue": "理论考场A",
        "status": "scheduled"
      }
    ],
    "current_queue_info": {
      "venue": "实操场地1",
      "position": 3,
      "estimated_wait_time": "约45分钟"
    }
  }
}
```

##### 4. 用户界面设计

**4.1 个人中心主页布局**
```xml
<!-- 个人中心主页模板 -->
<view class="profile-container">
  <!-- 头部信息卡片 -->
  <view class="profile-header">
    <view class="avatar-section">
      <image class="avatar" src="{{candidateInfo.avatar || '/images/default-avatar.png'}}" />
      <view class="status-badge status-{{candidateInfo.basicInfo.status}}">
        {{candidateInfo.basicInfo.status}}
      </view>
    </view>
    
    <view class="basic-info">
      <text class="name">{{candidateInfo.basicInfo.name}}</text>
      <text class="id-number">{{candidateInfo.basicInfo.idNumber}}</text>
      <text class="phone">{{candidateInfo.basicInfo.phone}}</text>
    </view>
  </view>
  
  <!-- 考试信息卡片 -->
  <view class="exam-info-card">
    <view class="card-title">考试信息</view>
    <view class="info-item">
      <text class="label">考试产品：</text>
      <text class="value">{{candidateInfo.examInfo.product}}</text>
    </view>
    <view class="info-item">
      <text class="label">培训机构：</text>
      <text class="value">{{candidateInfo.examInfo.institution}}</text>
    </view>
    <view class="info-item">
      <text class="label">报名时间：</text>
      <text class="value">{{candidateInfo.basicInfo.registrationDate}}</text>
    </view>
  </view>
  
  <!-- 状态跟踪卡片 -->
  <view class="status-track-card">
    <view class="card-title">考试进度</view>
    <view class="progress-bar">
      <view class="progress-fill" style="width: {{candidateInfo.statusInfo.progress}}%"></view>
    </view>
    <view class="next-step">
      <text class="step-title">下一步：</text>
      <text class="step-content">{{candidateInfo.statusInfo.nextStep}}</text>
    </view>
  </view>
  
  <!-- 功能入口 -->
  <view class="function-entries">
    <navigator url="/pages/candidate/schedule/index" class="entry-item">
      <image class="entry-icon" src="/images/schedule-icon.png" />
      <text class="entry-text">考试安排</text>
    </navigator>
    
    <navigator url="/pages/candidate/qrcode/index" class="entry-item">
      <image class="entry-icon" src="/images/qrcode-icon.png" />
      <text class="entry-text">我的二维码</text>
    </navigator>
    
    <navigator url="/pages/public/venues/index" class="entry-item">
      <image class="entry-icon" src="/images/venues-icon.png" />
      <text class="entry-text">考场状态</text>
    </navigator>
  </view>
</view>
```

**4.2 状态指示与进度计算**
```javascript
// 状态处理工具类
class StatusManager {
  // 获取下一步操作指引
  static getNextStepGuide(currentStatus) {
    const stepGuides = {
      '待排期': '请耐心等待考务管理员为您安排考试时间',
      '已排期': '请查看考试安排，准时参加考试',
      '考试中': '请按照考务人员指引完成考试流程',
      '已完成': '考试已完成，请等待成绩公布'
    };
    
    return stepGuides[currentStatus] || '请联系培训机构了解详情';
  }
  
  // 计算考试进度百分比
  static calculateProgress(currentStatus) {
    const progressMap = {
      '待排期': 25,
      '已排期': 50,
      '考试中': 75,
      '已完成': 100
    };
    
    return progressMap[currentStatus] || 0;
  }
  
  // 获取状态颜色配置
  static getStatusColor(status) {
    const colorMap = {
      '待排期': '#ff9500',
      '已排期': '#007aff',
      '考试中': '#34c759',
      '已完成': '#8e8e93'
    };
    
    return colorMap[status] || '#8e8e93';
  }
}
```

##### 5. 交互体验优化

**5.1 下拉刷新与上拉加载**
```javascript
// 下拉刷新实现
onPullDownRefresh() {
  this.loadCandidateInfo(true).then(() => {
    wx.stopPullDownRefresh();
    wx.showToast({
      title: '刷新成功',
      icon: 'success',
      duration: 1500
    });
  });
},

// 页面显示时自动刷新
onShow() {
  // 如果数据超过5分钟，自动刷新
  const lastUpdate = wx.getStorageSync('profileLastUpdate') || 0;
  if (Date.now() - lastUpdate > 5 * 60 * 1000) {
    this.loadCandidateInfo(true);
  }
}
```

**5.2 错误处理与重试机制**
```javascript
// 错误处理组件
const ErrorHandler = {
  // 显示错误信息
  showError(error, retryCallback) {
    wx.showModal({
      title: '加载失败',
      content: error.message || '网络异常，请检查网络连接',
      confirmText: '重试',
      cancelText: '取消',
      success: (res) => {
        if (res.confirm && retryCallback) {
          retryCallback();
        }
      }
    });
  },
  
  // 网络状态检查
  checkNetworkStatus() {
    return new Promise((resolve) => {
      wx.getNetworkType({
        success: (res) => {
          if (res.networkType === 'none') {
            wx.showToast({
              title: '网络连接异常',
              icon: 'error'
            });
            resolve(false);
          } else {
            resolve(true);
          }
        }
      });
    });
  }
};
```

##### 6. 数据同步与状态管理

**6.1 全局状态同步**
```javascript
// 全局状态管理
const GlobalState = {
  candidateInfo: null,
  
  // 更新考生信息
  updateCandidateInfo(newInfo) {
    this.candidateInfo = newInfo;
    
    // 通知其他页面更新
    wx.$emit('candidateInfoUpdated', newInfo);
    
    // 更新本地存储
    wx.setStorageSync('candidateProfile', newInfo);
  },
  
  // 获取考生信息
  getCandidateInfo() {
    if (!this.candidateInfo) {
      this.candidateInfo = wx.getStorageSync('candidateProfile');
    }
    return this.candidateInfo;
  }
};
```

**6.2 数据变更监听**
```javascript
// 页面数据变更监听
onLoad() {
  // 监听考生信息更新事件
  wx.$on('candidateInfoUpdated', (newInfo) => {
    this.setData({
      candidateInfo: this.processCandidateInfo(newInfo)
    });
  });
  
  // 监听考试状态变更
  wx.$on('examStatusChanged', (newStatus) => {
    this.updateExamStatus(newStatus);
  });
},

onUnload() {
  // 清理事件监听
  wx.$off('candidateInfoUpdated');
  wx.$off('examStatusChanged');
}
```

##### 7. 性能优化策略

**7.1 图片懒加载**
```javascript
// 图片懒加载实现
const ImageLazyLoader = {
  // 观察器实例
  observer: null,
  
  // 初始化懒加载
  init() {
    this.observer = wx.createIntersectionObserver();
    
    this.observer.relativeToViewport().observe('.lazy-image', (res) => {
      if (res.intersectionRatio > 0) {
        // 图片进入视口，开始加载
        const dataset = res.target.dataset;
        if (dataset.src) {
          res.target.src = dataset.src;
          res.target.classList.remove('lazy-image');
        }
      }
    });
  },
  
  // 销毁观察器
  destroy() {
    if (this.observer) {
      this.observer.disconnect();
    }
  }
};
```

**7.2 数据预加载**
```javascript
// 相关数据预加载
preloadRelatedData() {
  // 预加载考试安排数据
  wx.request({
    url: `${API_BASE}/wx/candidate-info/${this.candidateId}`,
    method: 'GET',
    header: {
      'Authorization': `Bearer ${wx.getStorageSync('authToken')}`
    },
    success: (res) => {
      // 缓存预加载的数据
      wx.setStorageSync('preloadedSchedules', res.data.upcoming_schedules);
    }
  });
}
```

#### 模块总结
考生个人中心模块通过清晰的信息展示、智能的状态跟踪、友好的交互体验，为考生提供了全面的个人信息管理功能。该模块不仅展示静态信息，更重要的是通过状态跟踪和进度指引，帮助考生了解当前所处的考试阶段和下一步操作，大大减少了考生的困惑和咨询需求。通过合理的缓存策略和性能优化，确保了良好的用户体验。
# 考点运营与流程管理微信小程序 - 详细模块分析

## 一、模块总览

基于需求文档和现有API分析，微信小程序可划分为以下9个功能模块：

### 核心业务模块（6个）
1. **身份认证模块** - 用户登录和身份验证
2. **考生个人中心模块** - 个人信息展示和管理
3. **动态二维码模块** - 考生身份凭证生成和展示
4. **考试日程模块** - 个人考试安排和排队状态
5. **考务扫码模块** - 考务人员签到操作
6. **公共看板模块** - 实时考场状态广播

### 辅助支持模块（3个）
7. **消息通知模块** - 状态变更和重要提醒
8. **帮助指引模块** - 使用说明和常见问题
9. **系统设置模块** - 个人偏好和应用设置

---

## 二、详细模块分析

### 模块1：身份认证模块（详细设计）

#### 模块作用与重要性
身份认证模块是整个小程序的入口和安全基础，承担着用户身份验证、权限分离、会话管理等核心职责。该模块的设计质量直接影响用户体验和系统安全性。

#### 业务场景分析
1. **考生场景**：考生通过身份证号快速登录，无需记忆复杂账号密码，降低使用门槛
2. **考务人员场景**：考务人员使用管理员分配的专用账号，确保操作权限的严格控制
3. **自动登录场景**：已登录用户再次进入小程序时自动识别身份，提升使用便利性

#### 详细功能设计

##### 1. 页面架构设计
```
app.js (应用入口)
├── pages/auth/
│   ├── role-select/     # 角色选择页
│   ├── candidate-login/ # 考生登录页
│   ├── staff-login/     # 考务登录页
│   ├── login-result/    # 登录结果页
│   └── auto-login/      # 自动登录处理页
```

##### 2. 核心功能实现思路

**2.1 角色选择与路由分发**
```javascript
// 实现思路：智能角色识别
onLaunch() {
  // 检查本地存储的用户信息
  const userInfo = wx.getStorageSync('userInfo');
  const userRole = wx.getStorageSync('userRole');
  
  if (userInfo && userRole) {
    // 自动登录验证
    this.autoLogin(userInfo, userRole);
  } else {
    // 跳转角色选择页
    wx.navigateTo({
      url: '/pages/auth/role-select/index'
    });
  }
}
```

**2.2 考生身份证登录机制**
```javascript
// 考生登录核心逻辑
candidateLogin(idCard) {
  // 1. 前端验证身份证格式
  if (!this.validateIdCard(idCard)) {
    wx.showToast({
      title: '身份证格式不正确',
      icon: 'error'
    });
    return;
  }
  
  // 2. 调用后端API验证
  wx.request({
    url: `${API_BASE}/wx/login-by-idcard`,
    method: 'POST',
    data: { id_card: idCard },
    success: (res) => {
      if (res.statusCode === 200) {
        // 3. 保存用户信息和令牌
        this.saveUserSession(res.data, 'candidate');
        // 4. 绑定微信openid
        this.bindWechatOpenId(res.data.access_token);
        // 5. 跳转到考生主页
        wx.switchTab({
          url: '/pages/candidate/index/index'
        });
      } else {
        this.handleLoginError(res.data);
      }
    }
  });
}
```

**2.3 考务人员账号登录机制**
```javascript
// 考务人员登录核心逻辑
staffLogin(username, password) {
  // 1. 前端基础验证
  if (!username || !password) {
    wx.showToast({
      title: '请输入账号和密码',
      icon: 'error'
    });
    return;
  }
  
  // 2. 调用标准登录接口
  wx.request({
    url: `${API_BASE}/wx/login`,
    method: 'POST',
    data: {
      code: '', // 微信登录code（可选）
      username: username,
      password: password,
      user_type: 'staff'
    },
    success: (res) => {
      if (res.statusCode === 200) {
        // 3. 保存会话信息
        this.saveUserSession(res.data, 'staff');
        // 4. 跳转到考务工作台
        wx.switchTab({
          url: '/pages/staff/workspace/index'
        });
      } else {
        this.handleLoginError(res.data);
      }
    }
  });
}
```

**2.4 自动登录与会话管理**
```javascript
// 自动登录验证机制
autoLogin(userInfo, userRole) {
  // 1. 检查令牌有效性
  wx.request({
    url: `${API_BASE}/wx/health`,
    method: 'GET',
    header: {
      'Authorization': `Bearer ${userInfo.access_token}`
    },
    success: (res) => {
      if (res.statusCode === 200) {
        // 令牌有效，直接跳转对应主页
        this.navigateToHomePage(userRole);
      } else {
        // 令牌失效，清除本地数据，重新登录
        this.clearUserSession();
        wx.navigateTo({
          url: '/pages/auth/role-select/index'
        });
      }
    }
  });
}
```

##### 3. API接口对接详情

**3.1 考生身份证登录接口**
```javascript
// API: POST /wx/login-by-idcard
// 请求参数：
{
  "id_card": "110101199001011234"  // 18位身份证号
}

// 响应数据：
{
  "message": "登录成功",
  "access_token": "candidate_1_1234",
  "candidate_info": {
    "id": 1,
    "name": "张三",
    "id_number": "110101199001011234",
    "phone": "13800138001",
    "exam_product": "无人机驾驶员考试",
    "institution": "北京航空培训中心",
    "status": "待排期"
  },
  "login_time": "2025-08-03T19:45:00"
}
```

**3.2 标准登录接口**
```javascript
// API: POST /wx/login
// 请求参数：
{
  "code": "微信登录code（可选）",
  "id_card": "身份证号（考生用）",
  "username": "用户名（考务用）",
  "password": "密码（考务用）"
}

// 响应数据：
{
  "access_token": "JWT令牌",
  "token_type": "bearer",
  "candidate_id": 1,  // 考生ID（考生登录时）
  "candidate_name": "张三",
  "phone": "13800138001",
  "status": "已排期"
}
```

**3.3 健康检查接口**
```javascript
// API: GET /wx/health
// 用途：验证服务可用性和令牌有效性
// 响应数据：
{
  "status": "healthy",
  "service": "微信小程序服务",
  "version": "1.0.0",
  "features": ["考生登录", "信息查询", "签到功能"]
}
```

##### 4. 技术实现细节

**4.1 身份证号验证算法**
```javascript
// 身份证号格式验证
validateIdCard(idCard) {
  // 基础格式检查
  if (!/^\d{17}[\dXx]$/.test(idCard)) {
    return false;
  }
  
  // 校验码验证
  const weights = [7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2];
  const checkCodes = ['1', '0', 'X', '9', '8', '7', '6', '5', '4', '3', '2'];
  
  let sum = 0;
  for (let i = 0; i < 17; i++) {
    sum += parseInt(idCard[i]) * weights[i];
  }
  
  const checkCode = checkCodes[sum % 11];
  return checkCode === idCard[17].toUpperCase();
}
```

**4.2 会话状态管理**
```javascript
// 用户会话管理工具类
class SessionManager {
  // 保存用户会话
  static saveUserSession(userData, userRole) {
    wx.setStorageSync('userInfo', userData);
    wx.setStorageSync('userRole', userRole);
    wx.setStorageSync('loginTime', new Date().getTime());
    
    // 设置全局请求头
    wx.setStorageSync('authToken', userData.access_token);
  }
  
  // 清除用户会话
  static clearUserSession() {
    wx.removeStorageSync('userInfo');
    wx.removeStorageSync('userRole');
    wx.removeStorageSync('loginTime');
    wx.removeStorageSync('authToken');
  }
  
  // 检查会话有效性
  static isSessionValid() {
    const loginTime = wx.getStorageSync('loginTime');
    const currentTime = new Date().getTime();
    const sessionTimeout = 24 * 60 * 60 * 1000; // 24小时
    
    return loginTime && (currentTime - loginTime < sessionTimeout);
  }
}
```

**4.3 微信OpenID绑定机制**
```javascript
// 绑定微信OpenID
bindWechatOpenId(accessToken) {
  wx.login({
    success: (res) => {
      if (res.code) {
        // 将微信code发送到后端进行OpenID绑定
        wx.request({
          url: `${API_BASE}/wx/bind-openid`,
          method: 'POST',
          header: {
            'Authorization': `Bearer ${accessToken}`
          },
          data: {
            wx_code: res.code
          },
          success: (bindRes) => {
            console.log('OpenID绑定成功', bindRes.data);
          }
        });
      }
    }
  });
}
```

##### 5. 用户体验优化

**5.1 加载状态管理**
```javascript
// 登录过程中的用户反馈
showLoginLoading() {
  wx.showLoading({
    title: '登录中...',
    mask: true
  });
}

hideLoginLoading() {
  wx.hideLoading();
}
```

**5.2 错误处理与用户提示**
```javascript
// 统一的错误处理机制
handleLoginError(errorData) {
  const errorMessages = {
    400: '输入信息格式不正确',
    404: '未找到该考生信息，请联系培训机构',
    403: '账号状态异常，无法登录',
    500: '系统繁忙，请稍后重试'
  };
  
  const message = errorMessages[errorData.status_code] || errorData.detail || '登录失败';
  
  wx.showModal({
    title: '登录失败',
    content: message,
    showCancel: false,
    confirmText: '确定'
  });
}
```

##### 6. 安全性考虑

**6.1 数据传输安全**
- 所有API请求使用HTTPS加密传输
- 敏感信息（如身份证号）在传输前进行基础验证
- 访问令牌采用JWT格式，包含过期时间

**6.2 本地存储安全**
- 敏感信息加密存储在本地
- 定期清理过期的会话数据
- 防止信息泄露的安全措施

**6.3 防重放攻击**
```javascript
// 请求防重复提交
let isSubmitting = false;

submitLogin() {
  if (isSubmitting) {
    wx.showToast({
      title: '请勿重复提交',
      icon: 'error'
    });
    return;
  }
  
  isSubmitting = true;
  
  // 执行登录逻辑
  this.performLogin().finally(() => {
    isSubmitting = false;
  });
}
```

##### 7. 数据流转详细设计

```
用户进入小程序
    ↓
检查本地会话状态
    ↓
[有效会话] → 自动登录验证 → [成功] → 跳转对应主页
    ↓                      ↓
[无效/无会话]              [失败] → 清除本地数据
    ↓                      ↓
显示角色选择页面 ←----------┘
    ↓
[考生] → 身份证登录页 → 输入身份证 → API验证 → 保存会话 → 考生主页
    ↓
[考务] → 账号登录页 → 输入账号密码 → API验证 → 保存会话 → 考务工作台
```

##### 8. 性能优化策略

**8.1 页面预加载**
```javascript
// 在角色选择页预加载后续页面
onReady() {
  // 预加载考生登录页
  wx.preloadPage({
    url: '/pages/auth/candidate-login/index'
  });
  
  // 预加载考务登录页
  wx.preloadPage({
    url: '/pages/auth/staff-login/index'
  });
}
```

**8.2 网络请求优化**
```javascript
// 网络请求封装，支持重试和缓存
class NetworkManager {
  static async request(options, retryCount = 3) {
    try {
      const response = await wx.request(options);
      return response;
    } catch (error) {
      if (retryCount > 0) {
        await this.delay(1000); // 延迟1秒重试
        return this.request(options, retryCount - 1);
      }
      throw error;
    }
  }
  
  static delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}
```

#### 模块总结
身份认证模块作为整个小程序的入口，需要在安全性、易用性、性能等方面做到平衡。通过双重登录机制（考生身份证登录 + 考务账号登录）、自动登录、会话管理等功能，为不同角色用户提供便捷而安全的身份验证服务。该模块的成功实现将为后续所有功能模块奠定坚实的基础。
# 考点运营与流程管理微信小程序 - 详细模块分析

## 一、模块总览

基于需求文档和现有API分析，微信小程序可划分为以下9个功能模块：

### 核心业务模块（6个）
1. **身份认证模块** - 用户登录和身份验证
2. **考生个人中心模块** - 个人信息展示和管理
3. **动态二维码模块** - 考生身份凭证生成和展示
4. **考试日程模块** - 个人考试安排和排队状态
5. **考务扫码模块** - 考务人员签到操作
6. **公共看板模块** - 实时考场状态广播

### 辅助支持模块（3个）
7. **消息通知模块** - 状态变更和重要提醒
8. **帮助指引模块** - 使用说明和常见问题
9. **系统设置模块** - 个人偏好和应用设置

---

## 二、详细模块分析

# 考点运营与流程管理微信小程序 - 详细模块分析

## 一、模块总览

基于需求文档和现有API分析，微信小程序可划分为以下9个功能模块：

### 核心业务模块（6个）
1. **身份认证模块** - 用户登录和身份验证
2. **考生个人中心模块** - 个人信息展示和管理
3. **动态二维码模块** - 考生身份凭证生成和展示
4. **考试日程模块** - 个人考试安排和排队状态
5. **考务扫码模块** - 考务人员签到操作
6. **公共看板模块** - 实时考场状态广播

### 辅助支持模块（3个）
7. **消息通知模块** - 状态变更和重要提醒
8. **帮助指引模块** - 使用说明和常见问题
9. **系统设置模块** - 个人偏好和应用设置

---

## 二、详细模块分析

### 模块1：身份认证模块

#### 功能描述
为考生和考务人员提供不同的登录方式，实现身份验证和权限分离。

#### 页面设计
- **登录选择页** - 用户角色选择（考生/考务人员）
- **考生登录页** - 身份证号快速登录
- **考务登录页** - 账号密码登录
- **登录结果页** - 登录成功/失败反馈

#### 核心功能点
1. **考生登录流程**：
   - 输入18位身份证号码
   - 系统验证身份证格式和考生信息
   - 绑定微信openid实现后续自动登录
   - 返回考生基本信息和访问令牌

2. **考务人员登录流程**：
   - 使用管理员分配的账号密码
   - 验证考务人员身份和权限
   - 进入考务工作台

3. **自动登录机制**：
   - 检测已绑定的微信用户
   - 自动跳转到对应角色的主页面

#### 对接API
- `POST /wx/login-by-idcard` - 考生身份证登录
- `POST /wx/login` - 标准登录接口
- `GET /wx/health` - 服务健康检查

#### 数据流转
```
用户输入 → 身份验证 → 角色判断 → 生成令牌 → 跳转主页
```

---

# 考点运营与流程管理微信小程序 - 详细模块分析

## 一、模块总览

基于需求文档和现有API分析，微信小程序可划分为以下9个功能模块：

### 核心业务模块（6个）
1. **身份认证模块** - 用户登录和身份验证
2. **考生个人中心模块** - 个人信息展示和管理
3. **动态二维码模块** - 考生身份凭证生成和展示
4. **考试日程模块** - 个人考试安排和排队状态
5. **考务扫码模块** - 考务人员签到操作
6. **公共看板模块** - 实时考场状态广播

### 辅助支持模块（3个）
7. **消息通知模块** - 状态变更和重要提醒
8. **帮助指引模块** - 使用说明和常见问题
9. **系统设置模块** - 个人偏好和应用设置

---

## 二、详细模块分析

### 模块1：身份认证模块（详细设计）

#### 模块作用与重要性
身份认证模块是整个小程序的入口和安全基础，承担着用户身份验证、权限分离、会话管理等核心职责。该模块的设计质量直接影响用户体验和系统安全性。

#### 业务场景分析
1. **考生场景**：考生通过身份证号快速登录，无需记忆复杂账号密码，降低使用门槛
2. **考务人员场景**：考务人员使用管理员分配的专用账号，确保操作权限的严格控制
3. **自动登录场景**：已登录用户再次进入小程序时自动识别身份，提升使用便利性

#### 详细功能设计

##### 1. 页面架构设计
```
app.js (应用入口)
├── pages/auth/
│   ├── role-select/     # 角色选择页
│   ├── candidate-login/ # 考生登录页
│   ├── staff-login/     # 考务登录页
│   ├── login-result/    # 登录结果页
│   └── auto-login/      # 自动登录处理页
```

##### 2. 核心功能实现思路

**2.1 角色选择与路由分发**
```javascript
// 实现思路：智能角色识别
onLaunch() {
  // 检查本地存储的用户信息
  const userInfo = wx.getStorageSync('userInfo');
  const userRole = wx.getStorageSync('userRole');
  
  if (userInfo && userRole) {
    // 自动登录验证
    this.autoLogin(userInfo, userRole);
  } else {
    // 跳转角色选择页
    wx.navigateTo({
      url: '/pages/auth/role-select/index'
    });
  }
}
```

**2.2 考生身份证登录机制**
```javascript
// 考生登录核心逻辑
candidateLogin(idCard) {
  // 1. 前端验证身份证格式
  if (!this.validateIdCard(idCard)) {
    wx.showToast({
      title: '身份证格式不正确',
      icon: 'error'
    });
    return;
  }
  
  // 2. 调用后端API验证
  wx.request({
    url: `${API_BASE}/wx/login-by-idcard`,
    method: 'POST',
    data: { id_card: idCard },
    success: (res) => {
      if (res.statusCode === 200) {
        // 3. 保存用户信息和令牌
        this.saveUserSession(res.data, 'candidate');
        // 4. 绑定微信openid
        this.bindWechatOpenId(res.data.access_token);
        // 5. 跳转到考生主页
        wx.switchTab({
          url: '/pages/candidate/index/index'
        });
      } else {
        this.handleLoginError(res.data);
      }
    }
  });
}
```

**2.3 考务人员账号登录机制**
```javascript
// 考务人员登录核心逻辑
staffLogin(username, password) {
  // 1. 前端基础验证
  if (!username || !password) {
    wx.showToast({
      title: '请输入账号和密码',
      icon: 'error'
    });
    return;
  }
  
  // 2. 调用标准登录接口
  wx.request({
    url: `${API_BASE}/wx/login`,
    method: 'POST',
    data: {
      code: '', // 微信登录code（可选）
      username: username,
      password: password,
      user_type: 'staff'
    },
    success: (res) => {
      if (res.statusCode === 200) {
        // 3. 保存会话信息
        this.saveUserSession(res.data, 'staff');
        // 4. 跳转到考务工作台
        wx.switchTab({
          url: '/pages/staff/workspace/index'
        });
      } else {
        this.handleLoginError(res.data);
      }
    }
  });
}
```

**2.4 自动登录与会话管理**
```javascript
// 自动登录验证机制
autoLogin(userInfo, userRole) {
  // 1. 检查令牌有效性
  wx.request({
    url: `${API_BASE}/wx/health`,
    method: 'GET',
    header: {
      'Authorization': `Bearer ${userInfo.access_token}`
    },
    success: (res) => {
      if (res.statusCode === 200) {
        // 令牌有效，直接跳转对应主页
        this.navigateToHomePage(userRole);
      } else {
        // 令牌失效，清除本地数据，重新登录
        this.clearUserSession();
        wx.navigateTo({
          url: '/pages/auth/role-select/index'
        });
      }
    }
  });
}
```

##### 3. API接口对接详情

**3.1 考生身份证登录接口**
```javascript
// API: POST /wx/login-by-idcard
// 请求参数：
{
  "id_card": "110101199001011234"  // 18位身份证号
}

// 响应数据：
{
  "message": "登录成功",
  "access_token": "candidate_1_1234",
  "candidate_info": {
    "id": 1,
    "name": "张三",
    "id_number": "110101199001011234",
    "phone": "13800138001",
    "exam_product": "无人机驾驶员考试",
    "institution": "北京航空培训中心",
    "status": "待排期"
  },
  "login_time": "2025-08-03T19:45:00"
}
```

**3.2 标准登录接口**
```javascript
// API: POST /wx/login
// 请求参数：
{
  "code": "微信登录code（可选）",
  "id_card": "身份证号（考生用）",
  "username": "用户名（考务用）",
  "password": "密码（考务用）"
}

// 响应数据：
{
  "access_token": "JWT令牌",
  "token_type": "bearer",
  "candidate_id": 1,  // 考生ID（考生登录时）
  "candidate_name": "张三",
  "phone": "13800138001",
  "status": "已排期"
}
```

**3.3 健康检查接口**
```javascript
// API: GET /wx/health
// 用途：验证服务可用性和令牌有效性
// 响应数据：
{
  "status": "healthy",
  "service": "微信小程序服务",
  "version": "1.0.0",
  "features": ["考生登录", "信息查询", "签到功能"]
}
```

##### 4. 技术实现细节

**4.1 身份证号验证算法**
```javascript
// 身份证号格式验证
validateIdCard(idCard) {
  // 基础格式检查
  if (!/^\d{17}[\dXx]$/.test(idCard)) {
    return false;
  }
  
  // 校验码验证
  const weights = [7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2];
  const checkCodes = ['1', '0', 'X', '9', '8', '7', '6', '5', '4', '3', '2'];
  
  let sum = 0;
  for (let i = 0; i < 17; i++) {
    sum += parseInt(idCard[i]) * weights[i];
  }
  
  const checkCode = checkCodes[sum % 11];
  return checkCode === idCard[17].toUpperCase();
}
```

**4.2 会话状态管理**
```javascript
// 用户会话管理工具类
class SessionManager {
  // 保存用户会话
  static saveUserSession(userData, userRole) {
    wx.setStorageSync('userInfo', userData);
    wx.setStorageSync('userRole', userRole);
    wx.setStorageSync('loginTime', new Date().getTime());
    
    // 设置全局请求头
    wx.setStorageSync('authToken', userData.access_token);
  }
  
  // 清除用户会话
  static clearUserSession() {
    wx.removeStorageSync('userInfo');
    wx.removeStorageSync('userRole');
    wx.removeStorageSync('loginTime');
    wx.removeStorageSync('authToken');
  }
  
  // 检查会话有效性
  static isSessionValid() {
    const loginTime = wx.getStorageSync('loginTime');
    const currentTime = new Date().getTime();
    const sessionTimeout = 24 * 60 * 60 * 1000; // 24小时
    
    return loginTime && (currentTime - loginTime < sessionTimeout);
  }
}
```

**4.3 微信OpenID绑定机制**
```javascript
// 绑定微信OpenID
bindWechatOpenId(accessToken) {
  wx.login({
    success: (res) => {
      if (res.code) {
        // 将微信code发送到后端进行OpenID绑定
        wx.request({
          url: `${API_BASE}/wx/bind-openid`,
          method: 'POST',
          header: {
            'Authorization': `Bearer ${accessToken}`
          },
          data: {
            wx_code: res.code
          },
          success: (bindRes) => {
            console.log('OpenID绑定成功', bindRes.data);
          }
        });
      }
    }
  });
}
```

##### 5. 用户体验优化

**5.1 加载状态管理**
```javascript
// 登录过程中的用户反馈
showLoginLoading() {
  wx.showLoading({
    title: '登录中...',
    mask: true
  });
}

hideLoginLoading() {
  wx.hideLoading();
}
```

**5.2 错误处理与用户提示**
```javascript
// 统一的错误处理机制
handleLoginError(errorData) {
  const errorMessages = {
    400: '输入信息格式不正确',
    404: '未找到该考生信息，请联系培训机构',
    403: '账号状态异常，无法登录',
    500: '系统繁忙，请稍后重试'
  };
  
  const message = errorMessages[errorData.status_code] || errorData.detail || '登录失败';
  
  wx.showModal({
    title: '登录失败',
    content: message,
    showCancel: false,
    confirmText: '确定'
  });
}
```

##### 6. 安全性考虑

**6.1 数据传输安全**
- 所有API请求使用HTTPS加密传输
- 敏感信息（如身份证号）在传输前进行基础验证
- 访问令牌采用JWT格式，包含过期时间

**6.2 本地存储安全**
- 敏感信息加密存储在本地
- 定期清理过期的会话数据
- 防止信息泄露的安全措施

**6.3 防重放攻击**
```javascript
// 请求防重复提交
let isSubmitting = false;

submitLogin() {
  if (isSubmitting) {
    wx.showToast({
      title: '请勿重复提交',
      icon: 'error'
    });
    return;
  }
  
  isSubmitting = true;
  
  // 执行登录逻辑
  this.performLogin().finally(() => {
    isSubmitting = false;
  });
}
```

##### 7. 数据流转详细设计

```
用户进入小程序
    ↓
检查本地会话状态
    ↓
[有效会话] → 自动登录验证 → [成功] → 跳转对应主页
    ↓                      ↓
[无效/无会话]              [失败] → 清除本地数据
    ↓                      ↓
显示角色选择页面 ←----------┘
    ↓
[考生] → 身份证登录页 → 输入身份证 → API验证 → 保存会话 → 考生主页
    ↓
[考务] → 账号登录页 → 输入账号密码 → API验证 → 保存会话 → 考务工作台
```

##### 8. 性能优化策略

**8.1 页面预加载**
```javascript
// 在角色选择页预加载后续页面
onReady() {
  // 预加载考生登录页
  wx.preloadPage({
    url: '/pages/auth/candidate-login/index'
  });
  
  // 预加载考务登录页
  wx.preloadPage({
    url: '/pages/auth/staff-login/index'
  });
}
```

**8.2 网络请求优化**
```javascript
// 网络请求封装，支持重试和缓存
class NetworkManager {
  static async request(options, retryCount = 3) {
    try {
      const response = await wx.request(options);
      return response;
    } catch (error) {
      if (retryCount > 0) {
        await this.delay(1000); // 延迟1秒重试
        return this.request(options, retryCount - 1);
      }
      throw error;
    }
  }
  
  static delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}
```

#### 模块总结
身份认证模块作为整个小程序的入口，需要在安全性、易用性、性能等方面做到平衡。通过双重登录机制（考生身份证登录 + 考务账号登录）、自动登录、会话管理等功能，为不同角色用户提供便捷而安全的身份验证服务。该模块的成功实现将为后续所有功能模块奠定坚实的基础。
# 考点运营与流程管理微信小程序 - 详细模块分析

## 一、模块总览

基于需求文档和现有API分析，微信小程序可划分为以下9个功能模块：

### 核心业务模块（6个）
1. **身份认证模块** - 用户登录和身份验证
2. **考生个人中心模块** - 个人信息展示和管理
3. **动态二维码模块** - 考生身份凭证生成和展示
4. **考试日程模块** - 个人考试安排和排队状态
5. **考务扫码模块** - 考务人员签到操作
6. **公共看板模块** - 实时考场状态广播

### 辅助支持模块（3个）
7. **消息通知模块** - 状态变更和重要提醒
8. **帮助指引模块** - 使用说明和常见问题
9. **系统设置模块** - 个人偏好和应用设置

---

## 二、详细模块分析

# 考点运营与流程管理微信小程序 - 详细模块分析

## 一、模块总览

基于需求文档和现有API分析，微信小程序可划分为以下9个功能模块：

### 核心业务模块（6个）
1. **身份认证模块** - 用户登录和身份验证
2. **考生个人中心模块** - 个人信息展示和管理
3. **动态二维码模块** - 考生身份凭证生成和展示
4. **考试日程模块** - 个人考试安排和排队状态
5. **考务扫码模块** - 考务人员签到操作
6. **公共看板模块** - 实时考场状态广播

### 辅助支持模块（3个）
7. **消息通知模块** - 状态变更和重要提醒
8. **帮助指引模块** - 使用说明和常见问题
9. **系统设置模块** - 个人偏好和应用设置

---

## 二、详细模块分析

### 模块1：身份认证模块

#### 功能描述
为考生和考务人员提供不同的登录方式，实现身份验证和权限分离。

#### 页面设计
- **登录选择页** - 用户角色选择（考生/考务人员）
- **考生登录页** - 身份证号快速登录
- **考务登录页** - 账号密码登录
- **登录结果页** - 登录成功/失败反馈

#### 核心功能点
1. **考生登录流程**：
   - 输入18位身份证号码
   - 系统验证身份证格式和考生信息
   - 绑定微信openid实现后续自动登录
   - 返回考生基本信息和访问令牌

2. **考务人员登录流程**：
   - 使用管理员分配的账号密码
   - 验证考务人员身份和权限
   - 进入考务工作台

3. **自动登录机制**：
   - 检测已绑定的微信用户
   - 自动跳转到对应角色的主页面

#### 对接API
- `POST /wx/login-by-idcard` - 考生身份证登录
- `POST /wx/login` - 标准登录接口
- `GET /wx/health` - 服务健康检查

#### 数据流转
```
用户输入 → 身份验证 → 角色判断 → 生成令牌 → 跳转主页
```

---

### 模块2：考生个人中心模块

#### 功能描述
展示考生的完整个人信息，包括基本资料、考试产品、培训机构等信息。

#### 页面设计
- **个人信息页** - 基本资料展示
- **考试信息页** - 考试产品和机构信息
- **状态概览页** - 当前考试状态和进度

#### 核心功能点
1. **基本信息展示**：
   - 考生姓名、身份证号（脱敏显示）
   - 联系电话、邮箱
   - 报名时间和当前状态

2. **考试相关信息**：
   - 报考的考试产品（如"多旋翼视距内驾驶员"）
   - 所属培训机构信息
   - 考试进度和完成状态

3. **状态跟踪**：
   - 当前考试阶段（待排期/已排期/考试中/已完成）
   - 下一步操作提示
   - 重要时间节点提醒

#### 对接API
- `GET /wx/candidate-info/{candidate_id}` - 获取考生详细信息

#### 数据展示结构
```json
{
  "basic_info": {
    "name": "张三",
    "id_number": "110101****1234",
    "phone": "138****8001",
    "status": "已排期"
  },
  "exam_info": {
    "product": "无人机驾驶员考试",
    "institution": "北京航空培训中心",
    "registration_date": "2025-08-01"
  }
}
```

---

### 模块3：动态二维码模块（核心功能）

#### 功能描述
为考生生成动态身份二维码，作为现场签到的唯一凭证。

#### 页面设计
- **二维码展示页** - 主要的二维码显示界面
- **二维码说明页** - 使用方法和注意事项
- **刷新状态页** - 二维码更新和有效期提示

#### 核心功能点
1. **动态二维码生成**：
   - 包含考生ID和下一个待进行日程的ID
   - 自动关联考生的下一个考试安排
   - 包含时间戳和有效期验证

2. **自动刷新机制**：
   - 每5分钟自动刷新二维码
   - 考生状态变更时立即更新
   - 显示二维码剩余有效时间

3. **状态适配**：
   - 有考试安排时显示对应二维码
   - 无安排时显示"暂无考试安排"
   - 考试完成后显示完成状态

#### 对接API
- `GET /wx/my-qrcode/{candidate_id}` - 生成考生动态二维码

#### 二维码数据结构
```json
{
  "qr_data": {
    "type": "candidate_checkin",
    "candidate_id": 1,
    "schedule_id": 1,
    "candidate_name": "张三",
    "activity_name": "理论考试",
    "venue": "理论考场A",
    "timestamp": "2025-08-03T19:50:00",
    "valid_until": "2025-08-15T23:59:59"
  },
  "qr_url": "二维码图片URL",
  "refresh_interval": 300
}
```

---

### 模块4：考试日程模块（详细设计）

#### 模块作用与重要性
考试日程模块是考生了解自己考试安排的重要窗口，承担着信息展示、状态跟踪、排队管理等关键功能。该模块需要实时反映考生的考试进度，帮助考生合理安排时间，减少现场等待的焦虑感。

#### 业务场景分析
1. **日程查看场景**：考生查看完整的考试时间安排，包括理论、实操等各个环节
2. **排队监控场景**：考生实时了解自己在考场的排队位置和预估等待时间
3. **状态跟踪场景**：考生跟踪每个考试环节的完成状态和下一步安排

#### 详细功能设计

##### 1. 页面架构设计
```
pages/candidate/schedule/
├── index/              # 日程列表主页
├── detail/             # 日程详情页
├── queue/              # 排队状态页
└── components/
    ├── schedule-item/  # 日程项组件
    ├── queue-status/   # 排队状态组件
    ├── timeline/       # 时间线组件
    └── status-badge/   # 状态标识组件
```

##### 2. 核心功能实现思路

**2.1 日程数据管理**
```javascript
// 日程管理核心类
class ScheduleManager {
  constructor(candidateId) {
    this.candidateId = candidateId;
    this.schedules = [];
    this.queueInfo = null;
    this.refreshTimer = null;
    this.refreshInterval = 30000; // 30秒刷新一次排队状态
  }
  
  // 获取考生日程信息
  async loadScheduleData(forceRefresh = false) {
    try {
      // 检查缓存
      if (!forceRefresh && this.isCacheValid()) {
        return this.getCachedData();
      }
      
      const response = await wx.request({
        url: `${API_BASE}/wx/candidate-info/${this.candidateId}`,
        method: 'GET',
        header: {
          'Authorization': `Bearer ${wx.getStorageSync('authToken')}`
        }
      });
      
      if (response.statusCode === 200) {
        const data = response.data.data;
        
        // 处理日程数据
        this.schedules = this.processScheduleData(data.upcoming_schedules || []);
        this.queueInfo = data.current_queue_info;
        
        // 缓存数据
        this.cacheData({
          schedules: this.schedules,
          queueInfo: this.queueInfo,
          timestamp: Date.now()
        });
        
        return {
          schedules: this.schedules,
          queueInfo: this.queueInfo
        };
      } else {
        throw new Error(response.data.detail || '获取日程信息失败');
      }
    } catch (error) {
      console.error('加载日程数据失败:', error);
      
      // 尝试使用缓存数据
      const cachedData = this.getCachedData();
      if (cachedData) {
        console.warn('使用缓存的日程数据');
        return cachedData;
      }
      
      throw error;
    }
  }
  
  // 处理日程数据
  processScheduleData(rawSchedules) {
    return rawSchedules.map(schedule => ({
      ...schedule,
      // 格式化日期时间
      formattedDate: this.formatDate(schedule.exam_date),
      formattedTime: this.formatTimeRange(schedule.start_time, schedule.end_time),
      // 计算状态
      displayStatus: this.calculateDisplayStatus(schedule),
      // 是否是当前进行的项目
      isCurrent: this.isCurrentSchedule(schedule),
      // 是否可以签到
      canCheckIn: this.canCheckIn(schedule),
      // 排序权重
      sortWeight: this.calculateSortWeight(schedule)
    })).sort((a, b) => a.sortWeight - b.sortWeight);
  }
  
  // 计算显示状态
  calculateDisplayStatus(schedule) {
    const now = new Date();
    const examDateTime = new Date(`${schedule.exam_date} ${schedule.start_time}`);
    const endDateTime = new Date(`${schedule.exam_date} ${schedule.end_time}`);
    
    switch (schedule.status) {
      case 'scheduled':
        if (now < examDateTime) {
          return {
            text: '待进行',
            color: '#1890ff',
            icon: '/images/scheduled.png'
          };
        } else if (now >= examDateTime && now <= endDateTime) {
          return {
            text: '进行中',
            color: '#52c41a',
            icon: '/images/ongoing.png'
          };
        } else {
          return {
            text: '已过期',
            color: '#ff4d4f',
            icon: '/images/expired.png'
          };
        }
      case 'completed':
        return {
          text: '已完成',
          color: '#52c41a',
          icon: '/images/completed.png'
        };
      case 'cancelled':
        return {
          text: '已取消',
          color: '#d9d9d9',
          icon: '/images/cancelled.png'
        };
      default:
        return {
          text: '未知',
          color: '#d9d9d9',
          icon: '/images/unknown.png'
        };
    }
  }
  
  // 判断是否是当前进行的日程
  isCurrentSchedule(schedule) {
    const now = new Date();
    const examDateTime = new Date(`${schedule.exam_date} ${schedule.start_time}`);
    const endDateTime = new Date(`${schedule.exam_date} ${schedule.end_time}`);
    
    return schedule.status === 'scheduled' && 
           now >= examDateTime && 
           now <= endDateTime;
  }
  
  // 判断是否可以签到
  canCheckIn(schedule) {
    const now = new Date();
    const examDateTime = new Date(`${schedule.exam_date} ${schedule.start_time}`);
    const checkInWindow = 30 * 60 * 1000; // 考试前30分钟可以签到
    
    return schedule.status === 'scheduled' && 
           (examDateTime - now) <= checkInWindow && 
           now < examDateTime;
  }
  
  // 计算排序权重
  calculateSortWeight(schedule) {
    const now = new Date();
    const examDateTime = new Date(`${schedule.exam_date} ${schedule.start_time}`);
    
    // 正在进行的排在最前面
    if (this.isCurrentSchedule(schedule)) {
      return 1;
    }
    
    // 即将开始的排在第二位
    if (schedule.status === 'scheduled' && examDateTime > now) {
      return 2;
    }
    
    // 已完成的排在后面
    if (schedule.status === 'completed') {
      return 4;
    }
    
    // 其他状态
    return 3;
  }
  
  // 开始排队状态监控
  startQueueMonitoring() {
    if (this.refreshTimer) {
      clearInterval(this.refreshTimer);
    }
    
    this.refreshTimer = setInterval(async () => {
      try {
        await this.loadScheduleData(true);
        // 通知页面更新
        this.notifyDataUpdate();
      } catch (error) {
        console.error('刷新排队状态失败:', error);
      }
    }, this.refreshInterval);
  }
  
  // 停止排队状态监控
  stopQueueMonitoring() {
    if (this.refreshTimer) {
      clearInterval(this.refreshTimer);
      this.refreshTimer = null;
    }
  }
  
  // 通知数据更新
  notifyDataUpdate() {
    // 发送自定义事件通知页面更新
    wx.eventBus && wx.eventBus.emit('scheduleDataUpdated', {
      schedules: this.schedules,
      queueInfo: this.queueInfo
    });
  }
  
  // 缓存相关方法
  cacheData(data) {
    wx.setStorageSync('scheduleCache', data);
  }
  
  getCachedData() {
    const cached = wx.getStorageSync('scheduleCache');
    if (cached && this.isCacheValid(cached)) {
      this.schedules = cached.schedules;
      this.queueInfo = cached.queueInfo;
      return {
        schedules: this.schedules,
        queueInfo: this.queueInfo
      };
    }
    return null;
  }
  
  isCacheValid(cached = null) {
    const cacheData = cached || wx.getStorageSync('scheduleCache');
    if (!cacheData || !cacheData.timestamp) {
      return false;
    }
    
    const cacheAge = Date.now() - cacheData.timestamp;
    const maxCacheAge = 2 * 60 * 1000; // 2分钟缓存有效期
    
    return cacheAge < maxCacheAge;
  }
  
  // 格式化方法
  formatDate(dateString) {
    const date = new Date(dateString);
    const today = new Date();
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);
    
    if (this.isSameDay(date, today)) {
      return '今天';
    } else if (this.isSameDay(date, tomorrow)) {
      return '明天';
    } else {
      return `${date.getMonth() + 1}月${date.getDate()}日`;
    }
  }
  
  formatTimeRange(startTime, endTime) {
    return `${startTime} - ${endTime}`;
  }
  
  isSameDay(date1, date2) {
    return date1.getFullYear() === date2.getFullYear() &&
           date1.getMonth() === date2.getMonth() &&
           date1.getDate() === date2.getDate();
  }
}
```

**2.2 日程列表页面实现**
```javascript
// 日程列表页面
Page({
  data: {
    schedules: [],
    queueInfo: null,
    isLoading: true,
    hasSchedules: false,
    currentScheduleId: null,
    refreshing: false,
    errorMessage: ''
  },
  
  scheduleManager: null,
  
  onLoad() {
    const candidateId = wx.getStorageSync('userInfo').candidate_id;
    this.scheduleManager = new ScheduleManager(candidateId);
    
    // 注册数据更新监听
    this.registerEventListeners();
    
    this.loadScheduleData();
  },
  
  onShow() {
    // 页面显示时刷新数据
    this.loadScheduleData(true);
    
    // 开始排队状态监控
    if (this.scheduleManager) {
      this.scheduleManager.startQueueMonitoring();
    }
  },
  
  onHide() {
    // 页面隐藏时停止监控
    if (this.scheduleManager) {
      this.scheduleManager.stopQueueMonitoring();
    }
  },
  
  onUnload() {
    this.cleanup();
  },
  
  // 加载日程数据
  async loadScheduleData(forceRefresh = false) {
    try {
      this.setData({ 
        isLoading: !forceRefresh, 
        refreshing: forceRefresh,
        errorMessage: '' 
      });
      
      const data = await this.scheduleManager.loadScheduleData(forceRefresh);
      
      this.setData({
        schedules: data.schedules,
        queueInfo: data.queueInfo,
        hasSchedules: data.schedules.length > 0,
        currentScheduleId: this.findCurrentScheduleId(data.schedules),
        isLoading: false,
        refreshing: false
      });
      
    } catch (error) {
      console.error('加载日程数据失败:', error);
      this.setData({
        errorMessage: error.message,
        isLoading: false,
        refreshing: false
      });
      
      this.showErrorToast(error.message);
    }
  },
  
  // 查找当前进行的日程ID
  findCurrentScheduleId(schedules) {
    const currentSchedule = schedules.find(s => s.isCurrent);
    return currentSchedule ? currentSchedule.id : null;
  },
  
  // 下拉刷新
  async onPullDownRefresh() {
    try {
      await this.loadScheduleData(true);
    } finally {
      wx.stopPullDownRefresh();
    }
  },
  
  // 点击日程项
  onScheduleItemTap(e) {
    const scheduleId = e.currentTarget.dataset.scheduleId;
    const schedule = this.data.schedules.find(s => s.id === scheduleId);
    
    if (schedule) {
      wx.navigateTo({
        url: `/pages/candidate/schedule/detail/index?scheduleId=${scheduleId}`
      });
    }
  },
  
  // 查看排队状态
  onViewQueueStatus() {
    if (this.data.queueInfo) {
      wx.navigateTo({
        url: '/pages/candidate/schedule/queue/index'
      });
    } else {
      wx.showToast({
        title: '暂无排队信息',
        icon: 'none'
      });
    }
  },
  
  // 快速签到
  onQuickCheckIn(e) {
    const scheduleId = e.currentTarget.dataset.scheduleId;
    
    wx.navigateTo({
      url: `/pages/candidate/qrcode/index?scheduleId=${scheduleId}`
    });
  },
  
  // 注册事件监听
  registerEventListeners() {
    // 监听数据更新事件
    wx.eventBus = wx.eventBus || {
      listeners: {},
      emit(event, data) {
        if (this.listeners[event]) {
          this.listeners[event].forEach(callback => callback(data));
        }
      },
      on(event, callback) {
        if (!this.listeners[event]) {
          this.listeners[event] = [];
        }
        this.listeners[event].push(callback);
      },
      off(event, callback) {
        if (this.listeners[event]) {
          const index = this.listeners[event].indexOf(callback);
          if (index > -1) {
            this.listeners[event].splice(index, 1);
          }
        }
      }
    };
    
    this.onScheduleDataUpdated = (data) => {
      this.setData({
        schedules: data.schedules,
        queueInfo: data.queueInfo,
        currentScheduleId: this.findCurrentScheduleId(data.schedules)
      });
    };
    
    wx.eventBus.on('scheduleDataUpdated', this.onScheduleDataUpdated);
  },
  
  // 显示错误提示
  showErrorToast(message) {
    wx.showToast({
      title: message || '加载失败',
      icon: 'none',
      duration: 2000
    });
  },
  
  // 清理资源
  cleanup() {
    if (this.scheduleManager) {
      this.scheduleManager.stopQueueMonitoring();
    }
    
    if (wx.eventBus && this.onScheduleDataUpdated) {
      wx.eventBus.off('scheduleDataUpdated', this.onScheduleDataUpdated);
    }
  }
});
```

##### 3. API接口对接详情

**3.1 考生日程信息接口**
```javascript
// API: GET /wx/candidate-info/{candidate_id}
// 请求头：Authorization: Bearer {access_token}

// 成功响应：
{
  "message": "获取考生信息成功",
  "data": {
    "candidate_info": {
      "id": 1,
      "name": "张三",
      "id_number": "110101199001011234",
      "phone": "13800138001",
      "exam_product": "无人机驾驶员考试",
      "institution": "北京航空培训中心",
      "status": "已排期"
    },
    "upcoming_schedules": [
      {
        "id": 1,
        "activity_name": "理论考试",
        "exam_date": "2025-08-15",
        "start_time": "09:00",
        "end_time": "10:30",
        "venue": "理论考场A",
        "status": "scheduled",
        "description": "无人机理论知识考试",
        "requirements": "请携带身份证原件"
      },
      {
        "id": 2,
        "activity_name": "实操考试",
        "exam_date": "2025-08-16",
        "start_time": "14:00",
        "end_time": "14:15",
        "venue": "实操场地1",
        "status": "scheduled",
        "description": "多旋翼无人机实际操作考试",
        "requirements": "请提前30分钟到达考场"
      }
    ],
    "current_queue_info": {
      "venue": "实操场地1",
      "position": 3,
      "total_waiting": 8,
      "estimated_wait_time": "约45分钟",
      "current_candidate": "李*",
      "last_updated": "2025-08-03T20:15:00"
    },
    "completed_schedules": [
      {
        "id": 0,
        "activity_name": "报名确认",
        "exam_date": "2025-08-10",
        "start_time": "10:00",
        "end_time": "10:05",
        "venue": "报名处",
        "status": "completed",
        "completed_at": "2025-08-10T10:03:00"
      }
    ]
  }
}
```

##### 4. 用户界面设计

**4.1 日程列表页面模板**
```xml
<!-- 日程列表页面 -->
<view class="schedule-container">
  <!-- 加载状态 -->
  <view wx:if="{{isLoading}}" class="loading-container">
    <view class="loading-spinner"></view>
    <text class="loading-text">正在加载日程...</text>
  </view>
  
  <!-- 有日程时显示列表 -->
  <view wx:elif="{{hasSchedules}}" class="schedule-content">
    <!-- 排队状态卡片 -->
    <view wx:if="{{queueInfo}}" class="queue-status-card" bindtap="onViewQueueStatus">
      <view class="queue-header">
        <image class="queue-icon" src="/images/queue.png" />
        <text class="queue-title">当前排队状态</text>
        <text class="queue-venue">{{queueInfo.venue}}</text>
      </view>
      
      <view class="queue-info">
        <view class="queue-position">
          <text class="position-number">{{queueInfo.position}}</text>
          <text class="position-label">当前位置</text>
        </view>
        
        <view class="queue-details">
          <view class="detail-item">
            <text class="detail-label">等待时间：</text>
            <text class="detail-value">{{queueInfo.estimated_wait_time}}</text>
          </view>
          <view class="detail-item">
            <text class="detail-label">前方人数：</text>
            <text class="detail-value">{{queueInfo.position - 1}}人</text>
          </view>
          <view class="detail-item">
            <text class="detail-label">当前考生：</text>
            <text class="detail-value">{{queueInfo.current_candidate}}</text>
          </view>
        </view>
      </view>
      
      <view class="queue-arrow">
        <image src="/images/arrow-right.png" />
      </view>
    </view>
    
    <!-- 日程列表 -->
    <view class="schedule-list">
      <view class="list-header">
        <text class="header-title">我的考试安排</text>
        <text class="header-count">共{{schedules.length}}项</text>
      </view>
      
      <view 
        wx:for="{{schedules}}" 
        wx:key="id" 
        class="schedule-item {{item.isCurrent ? 'current' : ''}}"
        data-schedule-id="{{item.id}}"
        bindtap="onScheduleItemTap"
      >
        <!-- 时间线指示器 -->
        <view class="timeline-indicator">
          <view class="timeline-dot {{item.displayStatus.color}}"></view>
          <view wx:if="{{index < schedules.length - 1}}" class="timeline-line"></view>
        </view>
        
        <!-- 日程内容 -->
        <view class="schedule-content">
          <view class="schedule-header">
            <text class="activity-name">{{item.activity_name}}</text>
            <view class="status-badge" style="background-color: {{item.displayStatus.color}}">
              <image class="status-icon" src="{{item.displayStatus.icon}}" />
              <text class="status-text">{{item.displayStatus.text}}</text>
            </view>
          </view>
          
          <view class="schedule-details">
            <view class="detail-row">
              <image class="detail-icon" src="/images/calendar.png" />
              <text class="detail-text">{{item.formattedDate}} {{item.formattedTime}}</text>
            </view>
            
            <view class="detail-row">
              <image class="detail-icon" src="/images/location.png" />
              <text class="detail-text">{{item.venue}}</text>
            </view>
            
            <view wx:if="{{item.description}}" class="detail-row">
              <image class="detail-icon" src="/images/info.png" />
              <text class="detail-text">{{item.description}}</text>
            </view>
          </view>
          
          <!-- 操作按钮 -->
          <view wx:if="{{item.canCheckIn}}" class="schedule-actions">
            <button 
              class="check-in-btn" 
              data-schedule-id="{{item.id}}"
              bindtap="onQuickCheckIn"
            >
              立即签到
            </button>
          </view>
          
          <!-- 当前进行标识 -->
          <view wx:if="{{item.isCurrent}}" class="current-indicator">
            <text class="current-text">正在进行</text>
            <view class="current-pulse"></view>
          </view>
        </view>
      </view>
    </view>
  </view>
  
  <!-- 无日程状态 -->
  <view wx:elif="{{!hasSchedules && !isLoading}}" class="no-schedule-container">
    <image class="no-schedule-icon" src="/images/no-schedule.png" />
    <text class="no-schedule-title">暂无考试安排</text>
    <text class="no-schedule-message">请等待考务管理员为您安排考试时间</text>
    
    <button class="refresh-btn" bindtap="loadScheduleData">
      刷新查看
    </button>
  </view>
  
  <!-- 错误状态 -->
  <view wx:else class="error-container">
    <image class="error-icon" src="/images/error.png" />
    <text class="error-title">加载失败</text>
    <text class="error-message">{{errorMessage}}</text>
    
    <button class="retry-btn" bindtap="loadScheduleData">
      重新加载
    </button>
  </view>
</view>

<!-- 下拉刷新提示 -->
<view wx:if="{{refreshing}}" class="refresh-indicator">
  <view class="refresh-spinner"></view>
  <text class="refresh-text">正在刷新...</text>
</view>
```

**4.2 排队状态页面模板**
```xml
<!-- 排队状态页面 -->
<view class="queue-page-container">
  <view class="queue-header">
    <text class="page-title">排队状态</text>
    <text class="venue-name">{{queueInfo.venue}}</text>
  </view>
  
  <!-- 排队可视化 -->
  <view class="queue-visualization">
    <view class="queue-progress">
      <view class="progress-bar">
        <view 
          class="progress-fill" 
          style="width: {{(queueInfo.total_waiting - queueInfo.position + 1) / queueInfo.total_waiting * 100}}%"
        ></view>
      </view>
      
      <view class="progress-labels">
        <text class="label-start">1</text>
        <text class="label-current">{{queueInfo.position}}</text>
        <text class="label-end">{{queueInfo.total_waiting}}</text>
      </view>
    </view>
    
    <!-- 当前位置指示 -->
    <view class="current-position">
      <view class="position-circle">
        <text class="position-number">{{queueInfo.position}}</text>
      </view>
      <text class="position-label">您的位置</text>
    </view>
  </view>
  
  <!-- 详细信息 -->
  <view class="queue-details">
    <view class="detail-card">
      <view class="detail-item">
        <text class="detail-label">预估等待时间</text>
        <text class="detail-value highlight">{{queueInfo.estimated_wait_time}}</text>
      </view>
      
      <view class="detail-item">
        <text class="detail-label">前方等待人数</text>
        <text class="detail-value">{{queueInfo.position - 1}}人</text>
      </view>
      
      <view class="detail-item">
        <text class="detail-label">当前考试考生</text>
        <text class="detail-value">{{queueInfo.current_candidate}}</text>
      </view>
      
      <view class="detail-item">
        <text class="detail-label">最后更新时间</text>
        <text class="detail-value">{{formatTime(queueInfo.last_updated)}}</text>
      </view>
    </view>
  </view>
  
  <!-- 温馨提示 -->
  <view class="queue-tips">
    <view class="tips-header">
      <image class="tips-icon" src="/images/tips.png" />
      <text class="tips-title">温馨提示</text>
    </view>
    
    <view class="tips-content">
      <view class="tip-item">
        <text class="tip-text">• 排队时间仅供参考，实际时间可能有所差异</text>
      </view>
      <view class="tip-item">
        <text class="tip-text">• 请保持手机畅通，注意听取现场广播</text>
      </view>
      <view class="tip-item">
        <text class="tip-text">• 轮到您时请及时到达指定考场</text>
      </view>
    </view>
  </view>
  
  <!-- 操作按钮 -->
  <view class="queue-actions">
    <button class="refresh-btn" bindtap="onRefreshQueue">
      <image class="btn-icon" src="/images/refresh.png" />
      刷新状态
    </button>
    
    <button class="qrcode-btn" bindtap="onShowQRCode">
      <image class="btn-icon" src="/images/qrcode.png" />
      查看二维码
    </button>
  </view>
</view>
```

##### 5. 实时数据更新机制

**5.1 WebSocket连接管理（可选增强功能）**
```javascript
// WebSocket连接管理类
class QueueWebSocketManager {
  constructor(candidateId) {
    this.candidateId = candidateId;
    this.socket = null;
    this.reconnectAttempts = 0;
    this.maxReconnectAttempts = 5;
    this.reconnectInterval = 3000;
    this.isConnected = false;
  }
  
  // 建立WebSocket连接
  connect() {
    try {
      this.socket = wx.connectSocket({
        url: `${WS_BASE}/queue/${this.candidateId}`,
        header: {
          'Authorization': `Bearer ${wx.getStorageSync('authToken')}`
        }
      });
      
      this.socket.onOpen(() => {
        console.log('WebSocket连接已建立');
        this.isConnected = true;
        this.reconnectAttempts = 0;
      });
      
      this.socket.onMessage((res) => {
        try {
          const data = JSON.parse(res.data);
          this.handleMessage(data);
        } catch (error) {
          console.error('解析WebSocket消息失败:', error);
        }
      });
      
      this.socket.onClose(() => {
        console.log('WebSocket连接已关闭');
        this.isConnected = false;
        this.attemptReconnect();
      });
      
      this.socket.onError((error) => {
        console.error('WebSocket连接错误:', error);
        this.isConnected = false;
      });
      
    } catch (error) {
      console.error('建立WebSocket连接失败:', error);
    }
  }
  
  // 处理接收到的消息
  handleMessage(data) {
    switch (data.type) {
      case 'queue_update':
        // 排队状态更新
        wx.eventBus.emit('queueStatusUpdated', data.payload);
        break;
      case 'schedule_update':
        // 日程状态更新
        wx.eventBus.emit('scheduleStatusUpdated', data.payload);
        break;
      case 'notification':
        // 通知消息
        this.showNotification(data.payload);
        break;
    }
  }
  
  // 显示通知
  showNotification(notification) {
    wx.showToast({
      title: notification.message,
      icon: notification.type === 'success' ? 'success' : 'none',
      duration: 3000
    });
  }
  
  // 尝试重连
  attemptReconnect() {
    if (this.reconnectAttempts < this.maxReconnectAttempts) {
      this.reconnectAttempts++;
      console.log(`尝试重连WebSocket (${this.reconnectAttempts}/${this.maxReconnectAttempts})`);
      
      setTimeout(() => {
        this.connect();
      }, this.reconnectInterval);
    } else {
      console.log('WebSocket重连次数已达上限，停止重连');
    }
  }
  
  // 断开连接
  disconnect() {
    if (this.socket) {
      this.socket.close();
      this.socket = null;
    }
    this.isConnected = false;
  }
  
  // 发送消息
  sendMessage(message) {
    if (this.isConnected && this.socket) {
      this.socket.send({
        data: JSON.stringify(message)
      });
    }
  }
}
```

##### 6. 性能优化策略

**6.1 数据预加载和缓存**
```javascript
// 数据预加载管理
class ScheduleDataPreloader {
  static preloadKey = 'schedule_preload_data';
  
  // 预加载下一页数据
  static async preloadNextPageData(candidateId) {
    try {
      // 在后台预加载相关数据
      const promises = [
        this.preloadQueueStatus(candidateId),
        this.preloadVenueInfo(candidateId),
        this.preloadNotifications(candidateId)
      ];
      
      const results = await Promise.allSettled(promises);
      
      // 缓存预加载的数据
      const preloadData = {
        queueStatus: results[0].status === 'fulfilled' ? results[0].value : null,
        venueInfo: results[1].status === 'fulfilled' ? results[1].value : null,
        notifications: results[2].status === 'fulfilled' ? results[2].value : null,
        timestamp: Date.now()
      };
      
      wx.setStorageSync(this.preloadKey, preloadData);
      
    } catch (error) {
      console.error('预加载数据失败:', error);
    }
  }
  
  // 预加载排队状态
  static async preloadQueueStatus(candidateId) {
    const response = await wx.request({
      url: `${API_BASE}/queue/status/${candidateId}`,
      method: 'GET',
      header: {
        'Authorization': `Bearer ${wx.getStorageSync('authToken')}`
      }
    });
    
    return response.data;
  }
  
  // 预加载考场信息
  static async preloadVenueInfo(candidateId) {
    const response = await wx.request({
      url: `${API_BASE}/venues/candidate/${candidateId}`,
      method: 'GET',
      header: {
        'Authorization': `Bearer ${wx.getStorageSync('authToken')}`
      }
    });
    
    return response.data;
  }
  
  // 预加载通知信息
  static async preloadNotifications(candidateId) {
    const response = await wx.request({
      url: `${API_BASE}/notifications/${candidateId}`,
      method: 'GET',
      header: {
        'Authorization': `Bearer ${wx.getStorageSync('authToken')}`
      }
    });
    
    return response.data;
  }
  
  // 获取预加载的数据
  static getPreloadedData() {
    const data = wx.getStorageSync(this.preloadKey);
    
    if (data && this.isPreloadDataValid(data)) {
      return data;
    }
    
    return null;
  }
  
  // 检查预加载数据有效性
  static isPreloadDataValid(data) {
    const maxAge = 5 * 60 * 1000; // 5分钟有效期
    return (Date.now() - data.timestamp) < maxAge;
  }
}
```

**6.2 列表虚拟化（大量日程时使用）**
```javascript
// 虚拟列表组件
Component({
  properties: {
    items: {
      type: Array,
      value: []
    },
    itemHeight: {
      type: Number,
      value: 120
    },
    visibleCount: {
      type: Number,
      value: 10
    }
  },
  
  data: {
    visibleItems: [],
    scrollTop: 0,
    containerHeight: 0
  },
  
  lifetimes: {
    attached() {
      this.calculateVisibleItems();
    }
  },
  
  observers: {
    'items': function(newItems) {
      this.calculateVisibleItems();
    }
  },
  
  methods: {
    // 计算可见项目
    calculateVisibleItems() {
      const { items, itemHeight, visibleCount } = this.properties;
      const { scrollTop } = this.data;
      
      const startIndex = Math.floor(scrollTop / itemHeight);
      const endIndex = Math.min(startIndex + visibleCount, items.length);
      
      const visibleItems = items.slice(startIndex, endIndex).map((item, index) => ({
        ...item,
        _virtualIndex: startIndex + index,
        _top: (startIndex + index) * itemHeight
      }));
      
      this.setData({
        visibleItems,
        containerHeight: items.length * itemHeight
      });
    },
    
    // 滚动事件处理
    onScroll(e) {
      const scrollTop = e.detail.scrollTop;
      
      this.setData({ scrollTop });
      
      // 节流处理
      if (this.scrollTimer) {
        clearTimeout(this.scrollTimer);
      }
      
      this.scrollTimer = setTimeout(() => {
        this.calculateVisibleItems();
      }, 16); // 60fps
    }
  }
});
```

#### 模块总结
考试日程模块通过完善的数据管理、实时状态更新、友好的用户界面和高效的性能优化，为考生提供了全面的考试安排查看和排队状态监控功能。该模块不仅要准确展示考试信息，还要实时反映排队状态变化，帮助考生合理安排时间，提升整体考试体验。通过WebSocket实时通信、数据预加载、虚拟列表等技术手段，确保了模块在高并发场景下的稳定性和流畅性。
# 考点运营与流程管理微信小程序 - 详细模块分析

## 一、模块总览

基于需求文档和现有API分析，微信小程序可划分为以下9个功能模块：

### 核心业务模块（6个）
1. **身份认证模块** - 用户登录和身份验证
2. **考生个人中心模块** - 个人信息展示和管理
3. **动态二维码模块** - 考生身份凭证生成和展示
4. **考试日程模块** - 个人考试安排和排队状态
5. **考务扫码模块** - 考务人员签到操作
6. **公共看板模块** - 实时考场状态广播

### 辅助支持模块（3个）
7. **消息通知模块** - 状态变更和重要提醒
8. **帮助指引模块** - 使用说明和常见问题
9. **系统设置模块** - 个人偏好和应用设置

---

## 二、详细模块分析

### 模块1：身份认证模块（详细设计）

#### 模块作用与重要性
身份认证模块是整个小程序的入口和安全基础，承担着用户身份验证、权限分离、会话管理等核心职责。该模块的设计质量直接影响用户体验和系统安全性。

#### 业务场景分析
1. **考生场景**：考生通过身份证号快速登录，无需记忆复杂账号密码，降低使用门槛
2. **考务人员场景**：考务人员使用管理员分配的专用账号，确保操作权限的严格控制
3. **自动登录场景**：已登录用户再次进入小程序时自动识别身份，提升使用便利性

#### 详细功能设计

##### 1. 页面架构设计
```
app.js (应用入口)
├── pages/auth/
│   ├── role-select/     # 角色选择页
│   ├── candidate-login/ # 考生登录页
│   ├── staff-login/     # 考务登录页
│   ├── login-result/    # 登录结果页
│   └── auto-login/      # 自动登录处理页
```

##### 2. 核心功能实现思路

**2.1 角色选择与路由分发**
```javascript
// 实现思路：智能角色识别
onLaunch() {
  // 检查本地存储的用户信息
  const userInfo = wx.getStorageSync('userInfo');
  const userRole = wx.getStorageSync('userRole');
  
  if (userInfo && userRole) {
    // 自动登录验证
    this.autoLogin(userInfo, userRole);
  } else {
    // 跳转角色选择页
    wx.navigateTo({
      url: '/pages/auth/role-select/index'
    });
  }
}
```

**2.2 考生身份证登录机制**
```javascript
// 考生登录核心逻辑
candidateLogin(idCard) {
  // 1. 前端验证身份证格式
  if (!this.validateIdCard(idCard)) {
    wx.showToast({
      title: '身份证格式不正确',
      icon: 'error'
    });
    return;
  }
  
  // 2. 调用后端API验证
  wx.request({
    url: `${API_BASE}/wx/login-by-idcard`,
    method: 'POST',
    data: { id_card: idCard },
    success: (res) => {
      if (res.statusCode === 200) {
        // 3. 保存用户信息和令牌
        this.saveUserSession(res.data, 'candidate');
        // 4. 绑定微信openid
        this.bindWechatOpenId(res.data.access_token);
        // 5. 跳转到考生主页
        wx.switchTab({
          url: '/pages/candidate/index/index'
        });
      } else {
        this.handleLoginError(res.data);
      }
    }
  });
}
```

**2.3 考务人员账号登录机制**
```javascript
// 考务人员登录核心逻辑
staffLogin(username, password) {
  // 1. 前端基础验证
  if (!username || !password) {
    wx.showToast({
      title: '请输入账号和密码',
      icon: 'error'
    });
    return;
  }
  
  // 2. 调用标准登录接口
  wx.request({
    url: `${API_BASE}/wx/login`,
    method: 'POST',
    data: {
      code: '', // 微信登录code（可选）
      username: username,
      password: password,
      user_type: 'staff'
    },
    success: (res) => {
      if (res.statusCode === 200) {
        // 3. 保存会话信息
        this.saveUserSession(res.data, 'staff');
        // 4. 跳转到考务工作台
        wx.switchTab({
          url: '/pages/staff/workspace/index'
        });
      } else {
        this.handleLoginError(res.data);
      }
    }
  });
}
```

**2.4 自动登录与会话管理**
```javascript
// 自动登录验证机制
autoLogin(userInfo, userRole) {
  // 1. 检查令牌有效性
  wx.request({
    url: `${API_BASE}/wx/health`,
    method: 'GET',
    header: {
      'Authorization': `Bearer ${userInfo.access_token}`
    },
    success: (res) => {
      if (res.statusCode === 200) {
        // 令牌有效，直接跳转对应主页
        this.navigateToHomePage(userRole);
      } else {
        // 令牌失效，清除本地数据，重新登录
        this.clearUserSession();
        wx.navigateTo({
          url: '/pages/auth/role-select/index'
        });
      }
    }
  });
}
```

##### 3. API接口对接详情

**3.1 考生身份证登录接口**
```javascript
// API: POST /wx/login-by-idcard
// 请求参数：
{
  "id_card": "110101199001011234"  // 18位身份证号
}

// 响应数据：
{
  "message": "登录成功",
  "access_token": "candidate_1_1234",
  "candidate_info": {
    "id": 1,
    "name": "张三",
    "id_number": "110101199001011234",
    "phone": "13800138001",
    "exam_product": "无人机驾驶员考试",
    "institution": "北京航空培训中心",
    "status": "待排期"
  },
  "login_time": "2025-08-03T19:45:00"
}
```

**3.2 标准登录接口**
```javascript
// API: POST /wx/login
// 请求参数：
{
  "code": "微信登录code（可选）",
  "id_card": "身份证号（考生用）",
  "username": "用户名（考务用）",
  "password": "密码（考务用）"
}

// 响应数据：
{
  "access_token": "JWT令牌",
  "token_type": "bearer",
  "candidate_id": 1,  // 考生ID（考生登录时）
  "candidate_name": "张三",
  "phone": "13800138001",
  "status": "已排期"
}
```

**3.3 健康检查接口**
```javascript
// API: GET /wx/health
// 用途：验证服务可用性和令牌有效性
// 响应数据：
{
  "status": "healthy",
  "service": "微信小程序服务",
  "version": "1.0.0",
  "features": ["考生登录", "信息查询", "签到功能"]
}
```

##### 4. 技术实现细节

**4.1 身份证号验证算法**
```javascript
// 身份证号格式验证
validateIdCard(idCard) {
  // 基础格式检查
  if (!/^\d{17}[\dXx]$/.test(idCard)) {
    return false;
  }
  
  // 校验码验证
  const weights = [7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2];
  const checkCodes = ['1', '0', 'X', '9', '8', '7', '6', '5', '4', '3', '2'];
  
  let sum = 0;
  for (let i = 0; i < 17; i++) {
    sum += parseInt(idCard[i]) * weights[i];
  }
  
  const checkCode = checkCodes[sum % 11];
  return checkCode === idCard[17].toUpperCase();
}
```

**4.2 会话状态管理**
```javascript
// 用户会话管理工具类
class SessionManager {
  // 保存用户会话
  static saveUserSession(userData, userRole) {
    wx.setStorageSync('userInfo', userData);
    wx.setStorageSync('userRole', userRole);
    wx.setStorageSync('loginTime', new Date().getTime());
    
    // 设置全局请求头
    wx.setStorageSync('authToken', userData.access_token);
  }
  
  // 清除用户会话
  static clearUserSession() {
    wx.removeStorageSync('userInfo');
    wx.removeStorageSync('userRole');
    wx.removeStorageSync('loginTime');
    wx.removeStorageSync('authToken');
  }
  
  // 检查会话有效性
  static isSessionValid() {
    const loginTime = wx.getStorageSync('loginTime');
    const currentTime = new Date().getTime();
    const sessionTimeout = 24 * 60 * 60 * 1000; // 24小时
    
    return loginTime && (currentTime - loginTime < sessionTimeout);
  }
}
```

**4.3 微信OpenID绑定机制**
```javascript
// 绑定微信OpenID
bindWechatOpenId(accessToken) {
  wx.login({
    success: (res) => {
      if (res.code) {
        // 将微信code发送到后端进行OpenID绑定
        wx.request({
          url: `${API_BASE}/wx/bind-openid`,
          method: 'POST',
          header: {
            'Authorization': `Bearer ${accessToken}`
          },
          data: {
            wx_code: res.code
          },
          success: (bindRes) => {
            console.log('OpenID绑定成功', bindRes.data);
          }
        });
      }
    }
  });
}
```

##### 5. 用户体验优化

**5.1 加载状态管理**
```javascript
// 登录过程中的用户反馈
showLoginLoading() {
  wx.showLoading({
    title: '登录中...',
    mask: true
  });
}

hideLoginLoading() {
  wx.hideLoading();
}
```

**5.2 错误处理与用户提示**
```javascript
// 统一的错误处理机制
handleLoginError(errorData) {
  const errorMessages = {
    400: '输入信息格式不正确',
    404: '未找到该考生信息，请联系培训机构',
    403: '账号状态异常，无法登录',
    500: '系统繁忙，请稍后重试'
  };
  
  const message = errorMessages[errorData.status_code] || errorData.detail || '登录失败';
  
  wx.showModal({
    title: '登录失败',
    content: message,
    showCancel: false,
    confirmText: '确定'
  });
}
```

##### 6. 安全性考虑

**6.1 数据传输安全**
- 所有API请求使用HTTPS加密传输
- 敏感信息（如身份证号）在传输前进行基础验证
- 访问令牌采用JWT格式，包含过期时间

**6.2 本地存储安全**
- 敏感信息加密存储在本地
- 定期清理过期的会话数据
- 防止信息泄露的安全措施

**6.3 防重放攻击**
```javascript
// 请求防重复提交
let isSubmitting = false;

submitLogin() {
  if (isSubmitting) {
    wx.showToast({
      title: '请勿重复提交',
      icon: 'error'
    });
    return;
  }
  
  isSubmitting = true;
  
  // 执行登录逻辑
  this.performLogin().finally(() => {
    isSubmitting = false;
  });
}
```

##### 7. 数据流转详细设计

```
用户进入小程序
    ↓
检查本地会话状态
    ↓
[有效会话] → 自动登录验证 → [成功] → 跳转对应主页
    ↓                      ↓
[无效/无会话]              [失败] → 清除本地数据
    ↓                      ↓
显示角色选择页面 ←----------┘
    ↓
[考生] → 身份证登录页 → 输入身份证 → API验证 → 保存会话 → 考生主页
    ↓
[考务] → 账号登录页 → 输入账号密码 → API验证 → 保存会话 → 考务工作台
```

##### 8. 性能优化策略

**8.1 页面预加载**
```javascript
// 在角色选择页预加载后续页面
onReady() {
  // 预加载考生登录页
  wx.preloadPage({
    url: '/pages/auth/candidate-login/index'
  });
  
  // 预加载考务登录页
  wx.preloadPage({
    url: '/pages/auth/staff-login/index'
  });
}
```

**8.2 网络请求优化**
```javascript
// 网络请求封装，支持重试和缓存
class NetworkManager {
  static async request(options, retryCount = 3) {
    try {
      const response = await wx.request(options);
      return response;
    } catch (error) {
      if (retryCount > 0) {
        await this.delay(1000); // 延迟1秒重试
        return this.request(options, retryCount - 1);
      }
      throw error;
    }
  }
  
  static delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}
```

#### 模块总结
身份认证模块作为整个小程序的入口，需要在安全性、易用性、性能等方面做到平衡。通过双重登录机制（考生身份证登录 + 考务账号登录）、自动登录、会话管理等功能，为不同角色用户提供便捷而安全的身份验证服务。该模块的成功实现将为后续所有功能模块奠定坚实的基础。
# 考点运营与流程管理微信小程序 - 详细模块分析

## 一、模块总览

基于需求文档和现有API分析，微信小程序可划分为以下9个功能模块：

### 核心业务模块（6个）
1. **身份认证模块** - 用户登录和身份验证
2. **考生个人中心模块** - 个人信息展示和管理
3. **动态二维码模块** - 考生身份凭证生成和展示
4. **考试日程模块** - 个人考试安排和排队状态
5. **考务扫码模块** - 考务人员签到操作
6. **公共看板模块** - 实时考场状态广播

### 辅助支持模块（3个）
7. **消息通知模块** - 状态变更和重要提醒
8. **帮助指引模块** - 使用说明和常见问题
9. **系统设置模块** - 个人偏好和应用设置

---

## 二、详细模块分析

# 考点运营与流程管理微信小程序 - 详细模块分析

## 一、模块总览

基于需求文档和现有API分析，微信小程序可划分为以下9个功能模块：

### 核心业务模块（6个）
1. **身份认证模块** - 用户登录和身份验证
2. **考生个人中心模块** - 个人信息展示和管理
3. **动态二维码模块** - 考生身份凭证生成和展示
4. **考试日程模块** - 个人考试安排和排队状态
5. **考务扫码模块** - 考务人员签到操作
6. **公共看板模块** - 实时考场状态广播

### 辅助支持模块（3个）
7. **消息通知模块** - 状态变更和重要提醒
8. **帮助指引模块** - 使用说明和常见问题
9. **系统设置模块** - 个人偏好和应用设置

---

## 二、详细模块分析

### 模块1：身份认证模块

#### 功能描述
为考生和考务人员提供不同的登录方式，实现身份验证和权限分离。

#### 页面设计
- **登录选择页** - 用户角色选择（考生/考务人员）
- **考生登录页** - 身份证号快速登录
- **考务登录页** - 账号密码登录
- **登录结果页** - 登录成功/失败反馈

#### 核心功能点
1. **考生登录流程**：
   - 输入18位身份证号码
   - 系统验证身份证格式和考生信息
   - 绑定微信openid实现后续自动登录
   - 返回考生基本信息和访问令牌

2. **考务人员登录流程**：
   - 使用管理员分配的账号密码
   - 验证考务人员身份和权限
   - 进入考务工作台

3. **自动登录机制**：
   - 检测已绑定的微信用户
   - 自动跳转到对应角色的主页面

#### 对接API
- `POST /wx/login-by-idcard` - 考生身份证登录
- `POST /wx/login` - 标准登录接口
- `GET /wx/health` - 服务健康检查

#### 数据流转
```
用户输入 → 身份验证 → 角色判断 → 生成令牌 → 跳转主页
```

---

### 模块2：考生个人中心模块（详细设计）

#### 模块作用与重要性
考生个人中心模块是考生了解自身考试状态、查看个人信息的核心入口。该模块承担着信息展示、状态跟踪、用户引导等重要职责，是提升考生体验和减少咨询压力的关键模块。

#### 业务场景分析
1. **信息查询场景**：考生需要快速了解自己的基本信息、考试产品、培训机构等
2. **状态跟踪场景**：考生关心当前考试进度，下一步需要做什么
3. **问题排查场景**：当考生遇到问题时，需要通过个人信息进行自助排查

#### 详细功能设计

##### 1. 页面架构设计
```
pages/candidate/
├── profile/
│   ├── index/           # 个人中心主页
│   ├── basic-info/      # 基本信息详情页
│   ├── exam-info/       # 考试信息详情页
│   ├── status-track/    # 状态跟踪页
│   └── progress-guide/  # 进度指引页
```

##### 2. 核心功能实现思路

**2.1 个人信息数据获取与缓存**
```javascript
// 个人信息管理类
class CandidateProfileManager {
  constructor() {
    this.candidateId = wx.getStorageSync('userInfo').candidate_id;
    this.profileData = null;
    this.lastUpdateTime = 0;
    this.cacheExpireTime = 5 * 60 * 1000; // 5分钟缓存
  }
  
  // 获取考生详细信息
  async getCandidateInfo(forceRefresh = false) {
    // 检查缓存有效性
    if (!forceRefresh && this.profileData && 
        (Date.now() - this.lastUpdateTime < this.cacheExpireTime)) {
      return this.profileData;
    }
    
    try {
      wx.showLoading({ title: '加载中...' });
      
      const response = await wx.request({
        url: `${API_BASE}/wx/candidate-info/${this.candidateId}`,
        method: 'GET',
        header: {
          'Authorization': `Bearer ${wx.getStorageSync('authToken')}`
        }
      });
      
      if (response.statusCode === 200) {
        this.profileData = response.data.data;
        this.lastUpdateTime = Date.now();
        
        // 缓存到本地存储
        wx.setStorageSync('candidateProfile', this.profileData);
        
        return this.profileData;
      } else {
        throw new Error(response.data.detail || '获取信息失败');
      }
    } catch (error) {
      // 网络异常时使用本地缓存
      const cachedData = wx.getStorageSync('candidateProfile');
      if (cachedData) {
        console.warn('使用缓存数据:', error.message);
        return cachedData;
      }
      throw error;
    } finally {
      wx.hideLoading();
    }
  }
}
```

**2.2 信息展示与数据处理**
```javascript
// 个人中心页面逻辑
Page({
  data: {
    candidateInfo: {},
    statusConfig: {
      '待排期': { color: '#ff9500', icon: 'clock' },
      '已排期': { color: '#007aff', icon: 'calendar' },
      '考试中': { color: '#34c759', icon: 'play' },
      '已完成': { color: '#8e8e93', icon: 'checkmark' }
    },
    loading: true,
    error: null
  },
  
  async onLoad() {
    await this.loadCandidateInfo();
  },
  
  async onPullDownRefresh() {
    await this.loadCandidateInfo(true);
    wx.stopPullDownRefresh();
  },
  
  // 加载考生信息
  async loadCandidateInfo(forceRefresh = false) {
    try {
      this.setData({ loading: true, error: null });
      
      const profileManager = new CandidateProfileManager();
      const candidateInfo = await profileManager.getCandidateInfo(forceRefresh);
      
      // 数据处理和格式化
      const processedInfo = this.processCandidateInfo(candidateInfo);
      
      this.setData({
        candidateInfo: processedInfo,
        loading: false
      });
      
    } catch (error) {
      console.error('加载考生信息失败:', error);
      this.setData({
        error: error.message,
        loading: false
      });
      
      wx.showToast({
        title: '加载失败，请重试',
        icon: 'error'
      });
    }
  },
  
  // 数据处理和格式化
  processCandidateInfo(rawData) {
    return {
      // 基本信息处理
      basicInfo: {
        name: rawData.name,
        idNumber: this.maskIdNumber(rawData.id_number),
        phone: this.maskPhone(rawData.phone),
        email: rawData.email || '未填写',
        registrationDate: this.formatDate(rawData.registration_date),
        status: rawData.status
      },
      
      // 考试信息处理
      examInfo: {
        product: rawData.exam_product,
        institution: rawData.institution,
        institutionId: rawData.institution_id
      },
      
      // 状态信息处理
      statusInfo: {
        current: rawData.status,
        nextStep: this.getNextStepGuide(rawData.status),
        progress: this.calculateProgress(rawData.status),
        upcomingSchedules: rawData.upcoming_schedules || []
      }
    };
  }
}
```

**2.3 敏感信息脱敏处理**
```javascript
// 数据脱敏工具方法
const DataMaskUtils = {
  // 身份证号脱敏
  maskIdNumber(idNumber) {
    if (!idNumber || idNumber.length !== 18) return idNumber;
    return idNumber.substring(0, 6) + '****' + idNumber.substring(14);
  },
  
  // 手机号脱敏
  maskPhone(phone) {
    if (!phone || phone.length !== 11) return phone;
    return phone.substring(0, 3) + '****' + phone.substring(7);
  },
  
  // 邮箱脱敏
  maskEmail(email) {
    if (!email || !email.includes('@')) return email;
    const [username, domain] = email.split('@');
    const maskedUsername = username.length > 2 
      ? username.substring(0, 2) + '***' 
      : username;
    return maskedUsername + '@' + domain;
  }
};
```

##### 3. API接口对接详情

**3.1 考生详细信息接口**
```javascript
// API: GET /wx/candidate-info/{candidate_id}
// 请求头：Authorization: Bearer {access_token}

// 响应数据结构：
{
  "message": "考生信息获取成功",
  "data": {
    "id": 1,
    "name": "张三",
    "id_number": "110101199001011234",
    "phone": "13800138001",
    "email": "zhangsan@example.com",
    "exam_product": "无人机驾驶员考试",
    "institution": "北京航空培训中心",
    "institution_id": 1,
    "status": "已排期",
    "registration_date": "2025-08-01",
    "upcoming_schedules": [
      {
        "id": 1,
        "activity_name": "理论考试",
        "exam_date": "2025-08-15",
        "start_time": "09:00",
        "end_time": "10:30",
        "venue": "理论考场A",
        "status": "scheduled"
      }
    ],
    "current_queue_info": {
      "venue": "实操场地1",
      "position": 3,
      "estimated_wait_time": "约45分钟"
    }
  }
}
```

##### 4. 用户界面设计

**4.1 个人中心主页布局**
```xml
<!-- 个人中心主页模板 -->
<view class="profile-container">
  <!-- 头部信息卡片 -->
  <view class="profile-header">
    <view class="avatar-section">
      <image class="avatar" src="{{candidateInfo.avatar || '/images/default-avatar.png'}}" />
      <view class="status-badge status-{{candidateInfo.basicInfo.status}}">
        {{candidateInfo.basicInfo.status}}
      </view>
    </view>
    
    <view class="basic-info">
      <text class="name">{{candidateInfo.basicInfo.name}}</text>
      <text class="id-number">{{candidateInfo.basicInfo.idNumber}}</text>
      <text class="phone">{{candidateInfo.basicInfo.phone}}</text>
    </view>
  </view>
  
  <!-- 考试信息卡片 -->
  <view class="exam-info-card">
    <view class="card-title">考试信息</view>
    <view class="info-item">
      <text class="label">考试产品：</text>
      <text class="value">{{candidateInfo.examInfo.product}}</text>
    </view>
    <view class="info-item">
      <text class="label">培训机构：</text>
      <text class="value">{{candidateInfo.examInfo.institution}}</text>
    </view>
    <view class="info-item">
      <text class="label">报名时间：</text>
      <text class="value">{{candidateInfo.basicInfo.registrationDate}}</text>
    </view>
  </view>
  
  <!-- 状态跟踪卡片 -->
  <view class="status-track-card">
    <view class="card-title">考试进度</view>
    <view class="progress-bar">
      <view class="progress-fill" style="width: {{candidateInfo.statusInfo.progress}}%"></view>
    </view>
    <view class="next-step">
      <text class="step-title">下一步：</text>
      <text class="step-content">{{candidateInfo.statusInfo.nextStep}}</text>
    </view>
  </view>
  
  <!-- 功能入口 -->
  <view class="function-entries">
    <navigator url="/pages/candidate/schedule/index" class="entry-item">
      <image class="entry-icon" src="/images/schedule-icon.png" />
      <text class="entry-text">考试安排</text>
    </navigator>
    
    <navigator url="/pages/candidate/qrcode/index" class="entry-item">
      <image class="entry-icon" src="/images/qrcode-icon.png" />
      <text class="entry-text">我的二维码</text>
    </navigator>
    
    <navigator url="/pages/public/venues/index" class="entry-item">
      <image class="entry-icon" src="/images/venues-icon.png" />
      <text class="entry-text">考场状态</text>
    </navigator>
  </view>
</view>
```

**4.2 状态指示与进度计算**
```javascript
// 状态处理工具类
class StatusManager {
  // 获取下一步操作指引
  static getNextStepGuide(currentStatus) {
    const stepGuides = {
      '待排期': '请耐心等待考务管理员为您安排考试时间',
      '已排期': '请查看考试安排，准时参加考试',
      '考试中': '请按照考务人员指引完成考试流程',
      '已完成': '考试已完成，请等待成绩公布'
    };
    
    return stepGuides[currentStatus] || '请联系培训机构了解详情';
  }
  
  // 计算考试进度百分比
  static calculateProgress(currentStatus) {
    const progressMap = {
      '待排期': 25,
      '已排期': 50,
      '考试中': 75,
      '已完成': 100
    };
    
    return progressMap[currentStatus] || 0;
  }
  
  // 获取状态颜色配置
  static getStatusColor(status) {
    const colorMap = {
      '待排期': '#ff9500',
      '已排期': '#007aff',
      '考试中': '#34c759',
      '已完成': '#8e8e93'
    };
    
    return colorMap[status] || '#8e8e93';
  }
}
```

##### 5. 交互体验优化

**5.1 下拉刷新与上拉加载**
```javascript
// 下拉刷新实现
onPullDownRefresh() {
  this.loadCandidateInfo(true).then(() => {
    wx.stopPullDownRefresh();
    wx.showToast({
      title: '刷新成功',
      icon: 'success',
      duration: 1500
    });
  });
},

// 页面显示时自动刷新
onShow() {
  // 如果数据超过5分钟，自动刷新
  const lastUpdate = wx.getStorageSync('profileLastUpdate') || 0;
  if (Date.now() - lastUpdate > 5 * 60 * 1000) {
    this.loadCandidateInfo(true);
  }
}
```

**5.2 错误处理与重试机制**
```javascript
// 错误处理组件
const ErrorHandler = {
  // 显示错误信息
  showError(error, retryCallback) {
    wx.showModal({
      title: '加载失败',
      content: error.message || '网络异常，请检查网络连接',
      confirmText: '重试',
      cancelText: '取消',
      success: (res) => {
        if (res.confirm && retryCallback) {
          retryCallback();
        }
      }
    });
  },
  
  // 网络状态检查
  checkNetworkStatus() {
    return new Promise((resolve) => {
      wx.getNetworkType({
        success: (res) => {
          if (res.networkType === 'none') {
            wx.showToast({
              title: '网络连接异常',
              icon: 'error'
            });
            resolve(false);
          } else {
            resolve(true);
          }
        }
      });
    });
  }
};
```

##### 6. 数据同步与状态管理

**6.1 全局状态同步**
```javascript
// 全局状态管理
const GlobalState = {
  candidateInfo: null,
  
  // 更新考生信息
  updateCandidateInfo(newInfo) {
    this.candidateInfo = newInfo;
    
    // 通知其他页面更新
    wx.$emit('candidateInfoUpdated', newInfo);
    
    // 更新本地存储
    wx.setStorageSync('candidateProfile', newInfo);
  },
  
  // 获取考生信息
  getCandidateInfo() {
    if (!this.candidateInfo) {
      this.candidateInfo = wx.getStorageSync('candidateProfile');
    }
    return this.candidateInfo;
  }
};
```

**6.2 数据变更监听**
```javascript
// 页面数据变更监听
onLoad() {
  // 监听考生信息更新事件
  wx.$on('candidateInfoUpdated', (newInfo) => {
    this.setData({
      candidateInfo: this.processCandidateInfo(newInfo)
    });
  });
  
  // 监听考试状态变更
  wx.$on('examStatusChanged', (newStatus) => {
    this.updateExamStatus(newStatus);
  });
},

onUnload() {
  // 清理事件监听
  wx.$off('candidateInfoUpdated');
  wx.$off('examStatusChanged');
}
```

##### 7. 性能优化策略

**7.1 图片懒加载**
```javascript
// 图片懒加载实现
const ImageLazyLoader = {
  // 观察器实例
  observer: null,
  
  // 初始化懒加载
  init() {
    this.observer = wx.createIntersectionObserver();
    
    this.observer.relativeToViewport().observe('.lazy-image', (res) => {
      if (res.intersectionRatio > 0) {
        // 图片进入视口，开始加载
        const dataset = res.target.dataset;
        if (dataset.src) {
          res.target.src = dataset.src;
          res.target.classList.remove('lazy-image');
        }
      }
    });
  },
  
  // 销毁观察器
  destroy() {
    if (this.observer) {
      this.observer.disconnect();
    }
  }
};
```

**7.2 数据预加载**
```javascript
// 相关数据预加载
preloadRelatedData() {
  // 预加载考试安排数据
  wx.request({
    url: `${API_BASE}/wx/candidate-info/${this.candidateId}`,
    method: 'GET',
    header: {
      'Authorization': `Bearer ${wx.getStorageSync('authToken')}`
    },
    success: (res) => {
      // 缓存预加载的数据
      wx.setStorageSync('preloadedSchedules', res.data.upcoming_schedules);
    }
  });
}
```

#### 模块总结
考生个人中心模块通过清晰的信息展示、智能的状态跟踪、友好的交互体验，为考生提供了全面的个人信息管理功能。该模块不仅展示静态信息，更重要的是通过状态跟踪和进度指引，帮助考生了解当前所处的考试阶段和下一步操作，大大减少了考生的困惑和咨询需求。通过合理的缓存策略和性能优化，确保了良好的用户体验。
# 考点运营与流程管理微信小程序 - 详细模块分析

## 一、模块总览

基于需求文档和现有API分析，微信小程序可划分为以下9个功能模块：

### 核心业务模块（6个）
1. **身份认证模块** - 用户登录和身份验证
2. **考生个人中心模块** - 个人信息展示和管理
3. **动态二维码模块** - 考生身份凭证生成和展示
4. **考试日程模块** - 个人考试安排和排队状态
5. **考务扫码模块** - 考务人员签到操作
6. **公共看板模块** - 实时考场状态广播

### 辅助支持模块（3个）
7. **消息通知模块** - 状态变更和重要提醒
8. **帮助指引模块** - 使用说明和常见问题
9. **系统设置模块** - 个人偏好和应用设置

---

## 二、详细模块分析

### 模块1：身份认证模块（详细设计）

#### 模块作用与重要性
身份认证模块是整个小程序的入口和安全基础，承担着用户身份验证、权限分离、会话管理等核心职责。该模块的设计质量直接影响用户体验和系统安全性。

#### 业务场景分析
1. **考生场景**：考生通过身份证号快速登录，无需记忆复杂账号密码，降低使用门槛
2. **考务人员场景**：考务人员使用管理员分配的专用账号，确保操作权限的严格控制
3. **自动登录场景**：已登录用户再次进入小程序时自动识别身份，提升使用便利性

#### 详细功能设计

##### 1. 页面架构设计
```
app.js (应用入口)
├── pages/auth/
│   ├── role-select/     # 角色选择页
│   ├── candidate-login/ # 考生登录页
│   ├── staff-login/     # 考务登录页
│   ├── login-result/    # 登录结果页
│   └── auto-login/      # 自动登录处理页
```

##### 2. 核心功能实现思路

**2.1 角色选择与路由分发**
```javascript
// 实现思路：智能角色识别
onLaunch() {
  // 检查本地存储的用户信息
  const userInfo = wx.getStorageSync('userInfo');
  const userRole = wx.getStorageSync('userRole');
  
  if (userInfo && userRole) {
    // 自动登录验证
    this.autoLogin(userInfo, userRole);
  } else {
    // 跳转角色选择页
    wx.navigateTo({
      url: '/pages/auth/role-select/index'
    });
  }
}
```

**2.2 考生身份证登录机制**
```javascript
// 考生登录核心逻辑
candidateLogin(idCard) {
  // 1. 前端验证身份证格式
  if (!this.validateIdCard(idCard)) {
    wx.showToast({
      title: '身份证格式不正确',
      icon: 'error'
    });
    return;
  }
  
  // 2. 调用后端API验证
  wx.request({
    url: `${API_BASE}/wx/login-by-idcard`,
    method: 'POST',
    data: { id_card: idCard },
    success: (res) => {
      if (res.statusCode === 200) {
        // 3. 保存用户信息和令牌
        this.saveUserSession(res.data, 'candidate');
        // 4. 绑定微信openid
        this.bindWechatOpenId(res.data.access_token);
        // 5. 跳转到考生主页
        wx.switchTab({
          url: '/pages/candidate/index/index'
        });
      } else {
        this.handleLoginError(res.data);
      }
    }
  });
}
```

**2.3 考务人员账号登录机制**
```javascript
// 考务人员登录核心逻辑
staffLogin(username, password) {
  // 1. 前端基础验证
  if (!username || !password) {
    wx.showToast({
      title: '请输入账号和密码',
      icon: 'error'
    });
    return;
  }
  
  // 2. 调用标准登录接口
  wx.request({
    url: `${API_BASE}/wx/login`,
    method: 'POST',
    data: {
      code: '', // 微信登录code（可选）
      username: username,
      password: password,
      user_type: 'staff'
    },
    success: (res) => {
      if (res.statusCode === 200) {
        // 3. 保存会话信息
        this.saveUserSession(res.data, 'staff');
        // 4. 跳转到考务工作台
        wx.switchTab({
          url: '/pages/staff/workspace/index'
        });
      } else {
        this.handleLoginError(res.data);
      }
    }
  });
}
```

**2.4 自动登录与会话管理**
```javascript
// 自动登录验证机制
autoLogin(userInfo, userRole) {
  // 1. 检查令牌有效性
  wx.request({
    url: `${API_BASE}/wx/health`,
    method: 'GET',
    header: {
      'Authorization': `Bearer ${userInfo.access_token}`
    },
    success: (res) => {
      if (res.statusCode === 200) {
        // 令牌有效，直接跳转对应主页
        this.navigateToHomePage(userRole);
      } else {
        // 令牌失效，清除本地数据，重新登录
        this.clearUserSession();
        wx.navigateTo({
          url: '/pages/auth/role-select/index'
        });
      }
    }
  });
}
```

##### 3. API接口对接详情

**3.1 考生身份证登录接口**
```javascript
// API: POST /wx/login-by-idcard
// 请求参数：
{
  "id_card": "110101199001011234"  // 18位身份证号
}

// 响应数据：
{
  "message": "登录成功",
  "access_token": "candidate_1_1234",
  "candidate_info": {
    "id": 1,
    "name": "张三",
    "id_number": "110101199001011234",
    "phone": "13800138001",
    "exam_product": "无人机驾驶员考试",
    "institution": "北京航空培训中心",
    "status": "待排期"
  },
  "login_time": "2025-08-03T19:45:00"
}
```

**3.2 标准登录接口**
```javascript
// API: POST /wx/login
// 请求参数：
{
  "code": "微信登录code（可选）",
  "id_card": "身份证号（考生用）",
  "username": "用户名（考务用）",
  "password": "密码（考务用）"
}

// 响应数据：
{
  "access_token": "JWT令牌",
  "token_type": "bearer",
  "candidate_id": 1,  // 考生ID（考生登录时）
  "candidate_name": "张三",
  "phone": "13800138001",
  "status": "已排期"
}
```

**3.3 健康检查接口**
```javascript
// API: GET /wx/health
// 用途：验证服务可用性和令牌有效性
// 响应数据：
{
  "status": "healthy",
  "service": "微信小程序服务",
  "version": "1.0.0",
  "features": ["考生登录", "信息查询", "签到功能"]
}
```

##### 4. 技术实现细节

**4.1 身份证号验证算法**
```javascript
// 身份证号格式验证
validateIdCard(idCard) {
  // 基础格式检查
  if (!/^\d{17}[\dXx]$/.test(idCard)) {
    return false;
  }
  
  // 校验码验证
  const weights = [7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2];
  const checkCodes = ['1', '0', 'X', '9', '8', '7', '6', '5', '4', '3', '2'];
  
  let sum = 0;
  for (let i = 0; i < 17; i++) {
    sum += parseInt(idCard[i]) * weights[i];
  }
  
  const checkCode = checkCodes[sum % 11];
  return checkCode === idCard[17].toUpperCase();
}
```

**4.2 会话状态管理**
```javascript
// 用户会话管理工具类
class SessionManager {
  // 保存用户会话
  static saveUserSession(userData, userRole) {
    wx.setStorageSync('userInfo', userData);
    wx.setStorageSync('userRole', userRole);
    wx.setStorageSync('loginTime', new Date().getTime());
    
    // 设置全局请求头
    wx.setStorageSync('authToken', userData.access_token);
  }
  
  // 清除用户会话
  static clearUserSession() {
    wx.removeStorageSync('userInfo');
    wx.removeStorageSync('userRole');
    wx.removeStorageSync('loginTime');
    wx.removeStorageSync('authToken');
  }
  
  // 检查会话有效性
  static isSessionValid() {
    const loginTime = wx.getStorageSync('loginTime');
    const currentTime = new Date().getTime();
    const sessionTimeout = 24 * 60 * 60 * 1000; // 24小时
    
    return loginTime && (currentTime - loginTime < sessionTimeout);
  }
}
```

**4.3 微信OpenID绑定机制**
```javascript
// 绑定微信OpenID
bindWechatOpenId(accessToken) {
  wx.login({
    success: (res) => {
      if (res.code) {
        // 将微信code发送到后端进行OpenID绑定
        wx.request({
          url: `${API_BASE}/wx/bind-openid`,
          method: 'POST',
          header: {
            'Authorization': `Bearer ${accessToken}`
          },
          data: {
            wx_code: res.code
          },
          success: (bindRes) => {
            console.log('OpenID绑定成功', bindRes.data);
          }
        });
      }
    }
  });
}
```

##### 5. 用户体验优化

**5.1 加载状态管理**
```javascript
// 登录过程中的用户反馈
showLoginLoading() {
  wx.showLoading({
    title: '登录中...',
    mask: true
  });
}

hideLoginLoading() {
  wx.hideLoading();
}
```

**5.2 错误处理与用户提示**
```javascript
// 统一的错误处理机制
handleLoginError(errorData) {
  const errorMessages = {
    400: '输入信息格式不正确',
    404: '未找到该考生信息，请联系培训机构',
    403: '账号状态异常，无法登录',
    500: '系统繁忙，请稍后重试'
  };
  
  const message = errorMessages[errorData.status_code] || errorData.detail || '登录失败';
  
  wx.showModal({
    title: '登录失败',
    content: message,
    showCancel: false,
    confirmText: '确定'
  });
}
```

##### 6. 安全性考虑

**6.1 数据传输安全**
- 所有API请求使用HTTPS加密传输
- 敏感信息（如身份证号）在传输前进行基础验证
- 访问令牌采用JWT格式，包含过期时间

**6.2 本地存储安全**
- 敏感信息加密存储在本地
- 定期清理过期的会话数据
- 防止信息泄露的安全措施

**6.3 防重放攻击**
```javascript
// 请求防重复提交
let isSubmitting = false;

submitLogin() {
  if (isSubmitting) {
    wx.showToast({
      title: '请勿重复提交',
      icon: 'error'
    });
    return;
  }
  
  isSubmitting = true;
  
  // 执行登录逻辑
  this.performLogin().finally(() => {
    isSubmitting = false;
  });
}
```

##### 7. 数据流转详细设计

```
用户进入小程序
    ↓
检查本地会话状态
    ↓
[有效会话] → 自动登录验证 → [成功] → 跳转对应主页
    ↓                      ↓
[无效/无会话]              [失败] → 清除本地数据
    ↓                      ↓
显示角色选择页面 ←----------┘
    ↓
[考生] → 身份证登录页 → 输入身份证 → API验证 → 保存会话 → 考生主页
    ↓
[考务] → 账号登录页 → 输入账号密码 → API验证 → 保存会话 → 考务工作台
```

##### 8. 性能优化策略

**8.1 页面预加载**
```javascript
// 在角色选择页预加载后续页面
onReady() {
  // 预加载考生登录页
  wx.preloadPage({
    url: '/pages/auth/candidate-login/index'
  });
  
  // 预加载考务登录页
  wx.preloadPage({
    url: '/pages/auth/staff-login/index'
  });
}
```

**8.2 网络请求优化**
```javascript
// 网络请求封装，支持重试和缓存
class NetworkManager {
  static async request(options, retryCount = 3) {
    try {
      const response = await wx.request(options);
      return response;
    } catch (error) {
      if (retryCount > 0) {
        await this.delay(1000); // 延迟1秒重试
        return this.request(options, retryCount - 1);
      }
      throw error;
    }
  }
  
  static delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}
```

#### 模块总结
身份认证模块作为整个小程序的入口，需要在安全性、易用性、性能等方面做到平衡。通过双重登录机制（考生身份证登录 + 考务账号登录）、自动登录、会话管理等功能，为不同角色用户提供便捷而安全的身份验证服务。该模块的成功实现将为后续所有功能模块奠定坚实的基础。
# 考点运营与流程管理微信小程序 - 详细模块分析

## 一、模块总览

基于需求文档和现有API分析，微信小程序可划分为以下9个功能模块：

### 核心业务模块（6个）
1. **身份认证模块** - 用户登录和身份验证
2. **考生个人中心模块** - 个人信息展示和管理
3. **动态二维码模块** - 考生身份凭证生成和展示
4. **考试日程模块** - 个人考试安排和排队状态
5. **考务扫码模块** - 考务人员签到操作
6. **公共看板模块** - 实时考场状态广播

### 辅助支持模块（3个）
7. **消息通知模块** - 状态变更和重要提醒
8. **帮助指引模块** - 使用说明和常见问题
9. **系统设置模块** - 个人偏好和应用设置

---

## 二、详细模块分析

# 考点运营与流程管理微信小程序 - 详细模块分析

## 一、模块总览

基于需求文档和现有API分析，微信小程序可划分为以下9个功能模块：

### 核心业务模块（6个）
1. **身份认证模块** - 用户登录和身份验证
2. **考生个人中心模块** - 个人信息展示和管理
3. **动态二维码模块** - 考生身份凭证生成和展示
4. **考试日程模块** - 个人考试安排和排队状态
5. **考务扫码模块** - 考务人员签到操作
6. **公共看板模块** - 实时考场状态广播

### 辅助支持模块（3个）
7. **消息通知模块** - 状态变更和重要提醒
8. **帮助指引模块** - 使用说明和常见问题
9. **系统设置模块** - 个人偏好和应用设置

---

## 二、详细模块分析

### 模块1：身份认证模块

#### 功能描述
为考生和考务人员提供不同的登录方式，实现身份验证和权限分离。

#### 页面设计
- **登录选择页** - 用户角色选择（考生/考务人员）
- **考生登录页** - 身份证号快速登录
- **考务登录页** - 账号密码登录
- **登录结果页** - 登录成功/失败反馈

#### 核心功能点
1. **考生登录流程**：
   - 输入18位身份证号码
   - 系统验证身份证格式和考生信息
   - 绑定微信openid实现后续自动登录
   - 返回考生基本信息和访问令牌

2. **考务人员登录流程**：
   - 使用管理员分配的账号密码
   - 验证考务人员身份和权限
   - 进入考务工作台

3. **自动登录机制**：
   - 检测已绑定的微信用户
   - 自动跳转到对应角色的主页面

#### 对接API
- `POST /wx/login-by-idcard` - 考生身份证登录
- `POST /wx/login` - 标准登录接口
- `GET /wx/health` - 服务健康检查

#### 数据流转
```
用户输入 → 身份验证 → 角色判断 → 生成令牌 → 跳转主页
```

---

# 考点运营与流程管理微信小程序 - 详细模块分析

## 一、模块总览

基于需求文档和现有API分析，微信小程序可划分为以下9个功能模块：

### 核心业务模块（6个）
1. **身份认证模块** - 用户登录和身份验证
2. **考生个人中心模块** - 个人信息展示和管理
3. **动态二维码模块** - 考生身份凭证生成和展示
4. **考试日程模块** - 个人考试安排和排队状态
5. **考务扫码模块** - 考务人员签到操作
6. **公共看板模块** - 实时考场状态广播

### 辅助支持模块（3个）
7. **消息通知模块** - 状态变更和重要提醒
8. **帮助指引模块** - 使用说明和常见问题
9. **系统设置模块** - 个人偏好和应用设置

---

## 二、详细模块分析

### 模块1：身份认证模块（详细设计）

#### 模块作用与重要性
身份认证模块是整个小程序的入口和安全基础，承担着用户身份验证、权限分离、会话管理等核心职责。该模块的设计质量直接影响用户体验和系统安全性。

#### 业务场景分析
1. **考生场景**：考生通过身份证号快速登录，无需记忆复杂账号密码，降低使用门槛
2. **考务人员场景**：考务人员使用管理员分配的专用账号，确保操作权限的严格控制
3. **自动登录场景**：已登录用户再次进入小程序时自动识别身份，提升使用便利性

#### 详细功能设计

##### 1. 页面架构设计
```
app.js (应用入口)
├── pages/auth/
│   ├── role-select/     # 角色选择页
│   ├── candidate-login/ # 考生登录页
│   ├── staff-login/     # 考务登录页
│   ├── login-result/    # 登录结果页
│   └── auto-login/      # 自动登录处理页
```

##### 2. 核心功能实现思路

**2.1 角色选择与路由分发**
```javascript
// 实现思路：智能角色识别
onLaunch() {
  // 检查本地存储的用户信息
  const userInfo = wx.getStorageSync('userInfo');
  const userRole = wx.getStorageSync('userRole');
  
  if (userInfo && userRole) {
    // 自动登录验证
    this.autoLogin(userInfo, userRole);
  } else {
    // 跳转角色选择页
    wx.navigateTo({
      url: '/pages/auth/role-select/index'
    });
  }
}
```

**2.2 考生身份证登录机制**
```javascript
// 考生登录核心逻辑
candidateLogin(idCard) {
  // 1. 前端验证身份证格式
  if (!this.validateIdCard(idCard)) {
    wx.showToast({
      title: '身份证格式不正确',
      icon: 'error'
    });
    return;
  }
  
  // 2. 调用后端API验证
  wx.request({
    url: `${API_BASE}/wx/login-by-idcard`,
    method: 'POST',
    data: { id_card: idCard },
    success: (res) => {
      if (res.statusCode === 200) {
        // 3. 保存用户信息和令牌
        this.saveUserSession(res.data, 'candidate');
        // 4. 绑定微信openid
        this.bindWechatOpenId(res.data.access_token);
        // 5. 跳转到考生主页
        wx.switchTab({
          url: '/pages/candidate/index/index'
        });
      } else {
        this.handleLoginError(res.data);
      }
    }
  });
}
```

**2.3 考务人员账号登录机制**
```javascript
// 考务人员登录核心逻辑
staffLogin(username, password) {
  // 1. 前端基础验证
  if (!username || !password) {
    wx.showToast({
      title: '请输入账号和密码',
      icon: 'error'
    });
    return;
  }
  
  // 2. 调用标准登录接口
  wx.request({
    url: `${API_BASE}/wx/login`,
    method: 'POST',
    data: {
      code: '', // 微信登录code（可选）
      username: username,
      password: password,
      user_type: 'staff'
    },
    success: (res) => {
      if (res.statusCode === 200) {
        // 3. 保存会话信息
        this.saveUserSession(res.data, 'staff');
        // 4. 跳转到考务工作台
        wx.switchTab({
          url: '/pages/staff/workspace/index'
        });
      } else {
        this.handleLoginError(res.data);
      }
    }
  });
}
```

**2.4 自动登录与会话管理**
```javascript
// 自动登录验证机制
autoLogin(userInfo, userRole) {
  // 1. 检查令牌有效性
  wx.request({
    url: `${API_BASE}/wx/health`,
    method: 'GET',
    header: {
      'Authorization': `Bearer ${userInfo.access_token}`
    },
    success: (res) => {
      if (res.statusCode === 200) {
        // 令牌有效，直接跳转对应主页
        this.navigateToHomePage(userRole);
      } else {
        // 令牌失效，清除本地数据，重新登录
        this.clearUserSession();
        wx.navigateTo({
          url: '/pages/auth/role-select/index'
        });
      }
    }
  });
}
```

##### 3. API接口对接详情

**3.1 考生身份证登录接口**
```javascript
// API: POST /wx/login-by-idcard
// 请求参数：
{
  "id_card": "110101199001011234"  // 18位身份证号
}

// 响应数据：
{
  "message": "登录成功",
  "access_token": "candidate_1_1234",
  "candidate_info": {
    "id": 1,
    "name": "张三",
    "id_number": "110101199001011234",
    "phone": "13800138001",
    "exam_product": "无人机驾驶员考试",
    "institution": "北京航空培训中心",
    "status": "待排期"
  },
  "login_time": "2025-08-03T19:45:00"
}
```

**3.2 标准登录接口**
```javascript
// API: POST /wx/login
// 请求参数：
{
  "code": "微信登录code（可选）",
  "id_card": "身份证号（考生用）",
  "username": "用户名（考务用）",
  "password": "密码（考务用）"
}

// 响应数据：
{
  "access_token": "JWT令牌",
  "token_type": "bearer",
  "candidate_id": 1,  // 考生ID（考生登录时）
  "candidate_name": "张三",
  "phone": "13800138001",
  "status": "已排期"
}
```

**3.3 健康检查接口**
```javascript
// API: GET /wx/health
// 用途：验证服务可用性和令牌有效性
// 响应数据：
{
  "status": "healthy",
  "service": "微信小程序服务",
  "version": "1.0.0",
  "features": ["考生登录", "信息查询", "签到功能"]
}
```

##### 4. 技术实现细节

**4.1 身份证号验证算法**
```javascript
// 身份证号格式验证
validateIdCard(idCard) {
  // 基础格式检查
  if (!/^\d{17}[\dXx]$/.test(idCard)) {
    return false;
  }
  
  // 校验码验证
  const weights = [7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2];
  const checkCodes = ['1', '0', 'X', '9', '8', '7', '6', '5', '4', '3', '2'];
  
  let sum = 0;
  for (let i = 0; i < 17; i++) {
    sum += parseInt(idCard[i]) * weights[i];
  }
  
  const checkCode = checkCodes[sum % 11];
  return checkCode === idCard[17].toUpperCase();
}
```

**4.2 会话状态管理**
```javascript
// 用户会话管理工具类
class SessionManager {
  // 保存用户会话
  static saveUserSession(userData, userRole) {
    wx.setStorageSync('userInfo', userData);
    wx.setStorageSync('userRole', userRole);
    wx.setStorageSync('loginTime', new Date().getTime());
    
    // 设置全局请求头
    wx.setStorageSync('authToken', userData.access_token);
  }
  
  // 清除用户会话
  static clearUserSession() {
    wx.removeStorageSync('userInfo');
    wx.removeStorageSync('userRole');
    wx.removeStorageSync('loginTime');
    wx.removeStorageSync('authToken');
  }
  
  // 检查会话有效性
  static isSessionValid() {
    const loginTime = wx.getStorageSync('loginTime');
    const currentTime = new Date().getTime();
    const sessionTimeout = 24 * 60 * 60 * 1000; // 24小时
    
    return loginTime && (currentTime - loginTime < sessionTimeout);
  }
}
```

**4.3 微信OpenID绑定机制**
```javascript
// 绑定微信OpenID
bindWechatOpenId(accessToken) {
  wx.login({
    success: (res) => {
      if (res.code) {
        // 将微信code发送到后端进行OpenID绑定
        wx.request({
          url: `${API_BASE}/wx/bind-openid`,
          method: 'POST',
          header: {
            'Authorization': `Bearer ${accessToken}`
          },
          data: {
            wx_code: res.code
          },
          success: (bindRes) => {
            console.log('OpenID绑定成功', bindRes.data);
          }
        });
      }
    }
  });
}
```

##### 5. 用户体验优化

**5.1 加载状态管理**
```javascript
// 登录过程中的用户反馈
showLoginLoading() {
  wx.showLoading({
    title: '登录中...',
    mask: true
  });
}

hideLoginLoading() {
  wx.hideLoading();
}
```

**5.2 错误处理与用户提示**
```javascript
// 统一的错误处理机制
handleLoginError(errorData) {
  const errorMessages = {
    400: '输入信息格式不正确',
    404: '未找到该考生信息，请联系培训机构',
    403: '账号状态异常，无法登录',
    500: '系统繁忙，请稍后重试'
  };
  
  const message = errorMessages[errorData.status_code] || errorData.detail || '登录失败';
  
  wx.showModal({
    title: '登录失败',
    content: message,
    showCancel: false,
    confirmText: '确定'
  });
}
```

##### 6. 安全性考虑

**6.1 数据传输安全**
- 所有API请求使用HTTPS加密传输
- 敏感信息（如身份证号）在传输前进行基础验证
- 访问令牌采用JWT格式，包含过期时间

**6.2 本地存储安全**
- 敏感信息加密存储在本地
- 定期清理过期的会话数据
- 防止信息泄露的安全措施

**6.3 防重放攻击**
```javascript
// 请求防重复提交
let isSubmitting = false;

submitLogin() {
  if (isSubmitting) {
    wx.showToast({
      title: '请勿重复提交',
      icon: 'error'
    });
    return;
  }
  
  isSubmitting = true;
  
  // 执行登录逻辑
  this.performLogin().finally(() => {
    isSubmitting = false;
  });
}
```

##### 7. 数据流转详细设计

```
用户进入小程序
    ↓
检查本地会话状态
    ↓
[有效会话] → 自动登录验证 → [成功] → 跳转对应主页
    ↓                      ↓
[无效/无会话]              [失败] → 清除本地数据
    ↓                      ↓
显示角色选择页面 ←----------┘
    ↓
[考生] → 身份证登录页 → 输入身份证 → API验证 → 保存会话 → 考生主页
    ↓
[考务] → 账号登录页 → 输入账号密码 → API验证 → 保存会话 → 考务工作台
```

##### 8. 性能优化策略

**8.1 页面预加载**
```javascript
// 在角色选择页预加载后续页面
onReady() {
  // 预加载考生登录页
  wx.preloadPage({
    url: '/pages/auth/candidate-login/index'
  });
  
  // 预加载考务登录页
  wx.preloadPage({
    url: '/pages/auth/staff-login/index'
  });
}
```

**8.2 网络请求优化**
```javascript
// 网络请求封装，支持重试和缓存
class NetworkManager {
  static async request(options, retryCount = 3) {
    try {
      const response = await wx.request(options);
      return response;
    } catch (error) {
      if (retryCount > 0) {
        await this.delay(1000); // 延迟1秒重试
        return this.request(options, retryCount - 1);
      }
      throw error;
    }
  }
  
  static delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}
```

#### 模块总结
身份认证模块作为整个小程序的入口，需要在安全性、易用性、性能等方面做到平衡。通过双重登录机制（考生身份证登录 + 考务账号登录）、自动登录、会话管理等功能，为不同角色用户提供便捷而安全的身份验证服务。该模块的成功实现将为后续所有功能模块奠定坚实的基础。
# 考点运营与流程管理微信小程序 - 详细模块分析

## 一、模块总览

基于需求文档和现有API分析，微信小程序可划分为以下9个功能模块：

### 核心业务模块（6个）
1. **身份认证模块** - 用户登录和身份验证
2. **考生个人中心模块** - 个人信息展示和管理
3. **动态二维码模块** - 考生身份凭证生成和展示
4. **考试日程模块** - 个人考试安排和排队状态
5. **考务扫码模块** - 考务人员签到操作
6. **公共看板模块** - 实时考场状态广播

### 辅助支持模块（3个）
7. **消息通知模块** - 状态变更和重要提醒
8. **帮助指引模块** - 使用说明和常见问题
9. **系统设置模块** - 个人偏好和应用设置

---

## 二、详细模块分析

# 考点运营与流程管理微信小程序 - 详细模块分析

## 一、模块总览

基于需求文档和现有API分析，微信小程序可划分为以下9个功能模块：

### 核心业务模块（6个）
1. **身份认证模块** - 用户登录和身份验证
2. **考生个人中心模块** - 个人信息展示和管理
3. **动态二维码模块** - 考生身份凭证生成和展示
4. **考试日程模块** - 个人考试安排和排队状态
5. **考务扫码模块** - 考务人员签到操作
6. **公共看板模块** - 实时考场状态广播

### 辅助支持模块（3个）
7. **消息通知模块** - 状态变更和重要提醒
8. **帮助指引模块** - 使用说明和常见问题
9. **系统设置模块** - 个人偏好和应用设置

---

## 二、详细模块分析

### 模块1：身份认证模块

#### 功能描述
为考生和考务人员提供不同的登录方式，实现身份验证和权限分离。

#### 页面设计
- **登录选择页** - 用户角色选择（考生/考务人员）
- **考生登录页** - 身份证号快速登录
- **考务登录页** - 账号密码登录
- **登录结果页** - 登录成功/失败反馈

#### 核心功能点
1. **考生登录流程**：
   - 输入18位身份证号码
   - 系统验证身份证格式和考生信息
   - 绑定微信openid实现后续自动登录
   - 返回考生基本信息和访问令牌

2. **考务人员登录流程**：
   - 使用管理员分配的账号密码
   - 验证考务人员身份和权限
   - 进入考务工作台

3. **自动登录机制**：
   - 检测已绑定的微信用户
   - 自动跳转到对应角色的主页面

#### 对接API
- `POST /wx/login-by-idcard` - 考生身份证登录
- `POST /wx/login` - 标准登录接口
- `GET /wx/health` - 服务健康检查

#### 数据流转
```
用户输入 → 身份验证 → 角色判断 → 生成令牌 → 跳转主页
```

---

### 模块2：考生个人中心模块

#### 功能描述
展示考生的完整个人信息，包括基本资料、考试产品、培训机构等信息。

#### 页面设计
- **个人信息页** - 基本资料展示
- **考试信息页** - 考试产品和机构信息
- **状态概览页** - 当前考试状态和进度

#### 核心功能点
1. **基本信息展示**：
   - 考生姓名、身份证号（脱敏显示）
   - 联系电话、邮箱
   - 报名时间和当前状态

2. **考试相关信息**：
   - 报考的考试产品（如"多旋翼视距内驾驶员"）
   - 所属培训机构信息
   - 考试进度和完成状态

3. **状态跟踪**：
   - 当前考试阶段（待排期/已排期/考试中/已完成）
   - 下一步操作提示
   - 重要时间节点提醒

#### 对接API
- `GET /wx/candidate-info/{candidate_id}` - 获取考生详细信息

#### 数据展示结构
```json
{
  "basic_info": {
    "name": "张三",
    "id_number": "110101****1234",
    "phone": "138****8001",
    "status": "已排期"
  },
  "exam_info": {
    "product": "无人机驾驶员考试",
    "institution": "北京航空培训中心",
    "registration_date": "2025-08-01"
  }
}
```

---

### 模块3：动态二维码模块（核心功能详细设计）

#### 模块作用与重要性
动态二维码模块是整个考点管理系统的核心功能，承担着考生身份验证、流程节点确认、状态同步等关键职责。该模块的稳定性和安全性直接影响现场考务工作的效率和准确性。

#### 业务场景分析
1. **现场签到场景**：考生向考务人员出示二维码进行身份确认和流程签到
2. **状态同步场景**：二维码内容随考生状态变化动态更新，确保信息准确性
3. **安全验证场景**：通过时间戳、有效期等机制防止二维码被恶意使用

#### 详细功能设计

##### 1. 页面架构设计
```
pages/candidate/qrcode/
├── index/              # 二维码主展示页
├── guide/              # 使用说明页
├── status/             # 状态说明页
└── components/
    ├── qr-display/     # 二维码显示组件
    ├── refresh-timer/  # 刷新倒计时组件
    └── status-indicator/ # 状态指示器组件
```

##### 2. 核心功能实现思路

**2.1 动态二维码生成与管理**
```javascript
// 二维码管理核心类
class QRCodeManager {
  constructor(candidateId) {
    this.candidateId = candidateId;
    this.currentQRData = null;
    this.refreshTimer = null;
    this.refreshInterval = 300000; // 5分钟
    this.isRefreshing = false;
  }
  
  // 获取动态二维码
  async generateQRCode(forceRefresh = false) {
    if (this.isRefreshing && !forceRefresh) {
      return this.currentQRData;
    }
    
    try {
      this.isRefreshing = true;
      
      const response = await wx.request({
        url: `${API_BASE}/wx/my-qrcode/${this.candidateId}`,
        method: 'GET',
        header: {
          'Authorization': `Bearer ${wx.getStorageSync('authToken')}`
        }
      });
      
      if (response.statusCode === 200) {
        const qrData = response.data;
        
        // 验证二维码数据完整性
        if (this.validateQRData(qrData)) {
          this.currentQRData = qrData;
          this.scheduleNextRefresh();
          
          // 缓存二维码数据
          wx.setStorageSync('currentQRCode', {
            data: qrData,
            timestamp: Date.now()
          });
          
          return qrData;
        } else {
          throw new Error('二维码数据格式异常');
        }
      } else {
        throw new Error(response.data.detail || '获取二维码失败');
      }
    } catch (error) {
      console.error('生成二维码失败:', error);
      
      // 尝试使用缓存数据
      const cachedQR = wx.getStorageSync('currentQRCode');
      if (cachedQR && this.isCacheValid(cachedQR)) {
        console.warn('使用缓存的二维码数据');
        return cachedQR.data;
      }
      
      throw error;
    } finally {
      this.isRefreshing = false;
    }
  }
  
  // 验证二维码数据完整性
  validateQRData(qrData) {
    const requiredFields = ['qr_data', 'qr_url', 'refresh_interval'];
    const qrDataFields = ['type', 'candidate_id', 'schedule_id', 'timestamp', 'valid_until'];
    
    // 检查顶层字段
    for (const field of requiredFields) {
      if (!qrData.hasOwnProperty(field)) {
        console.error(`缺少必需字段: ${field}`);
        return false;
      }
    }
    
    // 检查二维码数据字段
    if (qrData.qr_data) {
      for (const field of qrDataFields) {
        if (!qrData.qr_data.hasOwnProperty(field)) {
          console.error(`二维码数据缺少字段: ${field}`);
          return false;
        }
      }
    }
    
    return true;
  }
  
  // 检查缓存有效性
  isCacheValid(cachedQR) {
    const cacheAge = Date.now() - cachedQR.timestamp;
    const maxCacheAge = 2 * 60 * 1000; // 2分钟缓存有效期
    
    if (cacheAge > maxCacheAge) {
      return false;
    }
    
    // 检查二维码本身是否过期
    const validUntil = new Date(cachedQR.data.qr_data.valid_until);
    return validUntil > new Date();
  }
  
  // 安排下次刷新
  scheduleNextRefresh() {
    if (this.refreshTimer) {
      clearTimeout(this.refreshTimer);
    }
    
    this.refreshTimer = setTimeout(() => {
      this.generateQRCode(true).catch(error => {
        console.error('自动刷新二维码失败:', error);
        // 重试机制
        setTimeout(() => this.scheduleNextRefresh(), 30000); // 30秒后重试
      });
    }, this.refreshInterval);
  }
  
  // 清理定时器
  destroy() {
    if (this.refreshTimer) {
      clearTimeout(this.refreshTimer);
      this.refreshTimer = null;
    }
  }
}
```

**2.2 二维码显示与状态管理**
```javascript
// 二维码展示页面逻辑
Page({
  data: {
    qrCodeData: null,
    qrImageUrl: '',
    examInfo: {},
    refreshCountdown: 300,
    isLoading: true,
    hasSchedule: false,
    errorMessage: '',
    statusConfig: {
      'no_schedule': {
        title: '暂无考试安排',
        message: '请等待考务管理员为您安排考试时间',
        icon: '/images/no-schedule.png'
      },
      'scheduled': {
        title: '请出示此二维码',
        message: '向考务人员展示下方二维码进行签到',
        icon: '/images/qr-ready.png'
      },
      'completed': {
        title: '考试已完成',
        message: '您的考试流程已全部完成',
        icon: '/images/completed.png'
      }
    }
  },
  
  qrManager: null,
  countdownTimer: null,
  
  onLoad() {
    const candidateId = wx.getStorageSync('userInfo').candidate_id;
    this.qrManager = new QRCodeManager(candidateId);
    this.loadQRCode();
    this.startCountdown();
  },
  
  onUnload() {
    this.cleanup();
  },
  
  onShow() {
    // 页面显示时检查是否需要刷新
    this.checkAndRefreshQRCode();
  },
  
  // 加载二维码
  async loadQRCode(forceRefresh = false) {
    try {
      this.setData({ isLoading: true, errorMessage: '' });
      
      const qrData = await this.qrManager.generateQRCode(forceRefresh);
      
      if (qrData.status === 'no_schedule') {
        // 无考试安排状态
        this.setData({
          hasSchedule: false,
          isLoading: false
        });
      } else {
        // 有考试安排，显示二维码
        this.setData({
          qrCodeData: qrData.qr_data,
          qrImageUrl: qrData.qr_url,
          examInfo: {
            activityName: qrData.qr_data.activity_name,
            venue: qrData.qr_data.venue,
            examDate: this.formatDate(qrData.qr_data.valid_until)
          },
          hasSchedule: true,
          isLoading: false,
          refreshCountdown: qrData.refresh_interval || 300
        });
        
        // 重新开始倒计时
        this.startCountdown();
      }
      
    } catch (error) {
      console.error('加载二维码失败:', error);
      this.setData({
        errorMessage: error.message,
        isLoading: false
      });
      
      this.showRetryDialog(error.message);
    }
  },
  
  // 手动刷新二维码
  async onRefreshQRCode() {
    wx.showLoading({ title: '刷新中...' });
    
    try {
      await this.loadQRCode(true);
      wx.showToast({
        title: '刷新成功',
        icon: 'success'
      });
    } catch (error) {
      wx.showToast({
        title: '刷新失败',
        icon: 'error'
      });
    } finally {
      wx.hideLoading();
    }
  },
  
  // 开始倒计时
  startCountdown() {
    if (this.countdownTimer) {
      clearInterval(this.countdownTimer);
    }
    
    this.countdownTimer = setInterval(() => {
      const countdown = this.data.refreshCountdown - 1;
      
      if (countdown <= 0) {
        // 自动刷新
        this.loadQRCode(true);
        this.setData({ refreshCountdown: 300 });
      } else {
        this.setData({ refreshCountdown: countdown });
      }
    }, 1000);
  },
  
  // 检查并刷新二维码
  checkAndRefreshQRCode() {
    if (!this.data.qrCodeData) return;
    
    const validUntil = new Date(this.data.qrCodeData.valid_until);
    const now = new Date();
    
    // 如果二维码即将过期（5分钟内），立即刷新
    if (validUntil - now < 5 * 60 * 1000) {
      this.loadQRCode(true);
    }
  },
  
  // 显示重试对话框
  showRetryDialog(errorMessage) {
    wx.showModal({
      title: '加载失败',
      content: errorMessage || '网络异常，请检查网络连接',
      confirmText: '重试',
      cancelText: '取消',
      success: (res) => {
        if (res.confirm) {
          this.loadQRCode(true);
        }
      }
    });
  },
  
  // 清理资源
  cleanup() {
    if (this.qrManager) {
      this.qrManager.destroy();
    }
    
    if (this.countdownTimer) {
      clearInterval(this.countdownTimer);
    }
  }
});
```

##### 3. API接口对接详情

**3.1 动态二维码生成接口**
```javascript
// API: GET /wx/my-qrcode/{candidate_id}
// 请求头：Authorization: Bearer {access_token}

// 成功响应（有考试安排）：
{
  "message": "动态二维码生成成功",
  "candidate_id": 1,
  "candidate_name": "张三",
  "qr_data": {
    "type": "candidate_checkin",
    "candidate_id": 1,
    "schedule_id": 1,
    "candidate_name": "张三",
    "activity_name": "理论考试",
    "venue": "理论考场A",
    "timestamp": "2025-08-03T19:50:00",
    "valid_until": "2025-08-15T23:59:59"
  },
  "qr_url": "https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=schedule_1_candidate_1",
  "next_schedule": {
    "id": 1,
    "activity_name": "理论考试",
    "exam_date": "2025-08-15",
    "start_time": "09:00",
    "venue": "理论考场A",
    "status": "待签到"
  },
  "instructions": "请向考务人员出示此二维码进行签到",
  "refresh_interval": 300
}

// 成功响应（无考试安排）：
{
  "message": "暂无待进行的考试安排",
  "candidate_id": 1,
  "candidate_name": "张三",
  "qr_code": null,
  "status": "no_schedule"
}
```

##### 4. 用户界面设计

**4.1 二维码展示页面模板**
```xml
<!-- 二维码展示页面 -->
<view class="qrcode-container">
  <!-- 加载状态 -->
  <view wx:if="{{isLoading}}" class="loading-container">
    <view class="loading-spinner"></view>
    <text class="loading-text">正在生成二维码...</text>
  </view>
  
  <!-- 有考试安排时显示二维码 -->
  <view wx:elif="{{hasSchedule}}" class="qrcode-content">
    <!-- 状态提示 -->
    <view class="status-header">
      <image class="status-icon" src="{{statusConfig.scheduled.icon}}" />
      <text class="status-title">{{statusConfig.scheduled.title}}</text>
      <text class="status-message">{{statusConfig.scheduled.message}}</text>
    </view>
    
    <!-- 考试信息 -->
    <view class="exam-info">
      <view class="info-item">
        <text class="label">考试项目：</text>
        <text class="value">{{examInfo.activityName}}</text>
      </view>
      <view class="info-item">
        <text class="label">考试地点：</text>
        <text class="value">{{examInfo.venue}}</text>
      </view>
      <view class="info-item">
        <text class="label">有效期至：</text>
        <text class="value">{{examInfo.examDate}}</text>
      </view>
    </view>
    
    <!-- 二维码显示区域 -->
    <view class="qrcode-display">
      <image 
        class="qrcode-image" 
        src="{{qrImageUrl}}" 
        mode="aspectFit"
        bindload="onQRImageLoad"
        binderror="onQRImageError"
      />
      
      <!-- 刷新倒计时 -->
      <view class="refresh-countdown">
        <text class="countdown-text">{{Math.floor(refreshCountdown / 60)}}:{{(refreshCountdown % 60).toString().padStart(2, '0')}} 后自动刷新</text>
        <button class="refresh-btn" bindtap="onRefreshQRCode">
          <image class="refresh-icon" src="/images/refresh.png" />
          立即刷新
        </button>
      </view>
    </view>
    
    <!-- 使用说明 -->
    <view class="usage-tips">
      <view class="tip-item">
        <text class="tip-number">1</text>
        <text class="tip-text">请确保二维码清晰可见</text>
      </view>
      <view class="tip-item">
        <text class="tip-number">2</text>
        <text class="tip-text">向考务人员出示此二维码</text>
      </view>
      <view class="tip-item">
        <text class="tip-number">3</text>
        <text class="tip-text">等待考务人员扫码确认</text>
      </view>
    </view>
  </view>
  
  <!-- 无考试安排状态 -->
  <view wx:elif="{{!hasSchedule}}" class="no-schedule-container">
    <image class="no-schedule-icon" src="{{statusConfig.no_schedule.icon}}" />
    <text class="no-schedule-title">{{statusConfig.no_schedule.title}}</text>
    <text class="no-schedule-message">{{statusConfig.no_schedule.message}}</text>
    
    <button class="contact-btn" bindtap="onContactInstitution">
      联系培训机构
    </button>
  </view>
  
  <!-- 错误状态 -->
  <view wx:else class="error-container">
    <image class="error-icon" src="/images/error.png" />
    <text class="error-title">加载失败</text>
    <text class="error-message">{{errorMessage}}</text>
    
    <button class="retry-btn" bindtap="onRefreshQRCode">
      重新加载
    </button>
  </view>
</view>
```

##### 5. 安全性与防护机制

**5.1 二维码防伪验证**
```javascript
// 二维码安全验证工具
class QRSecurityValidator {
  // 验证二维码时间戳
  static validateTimestamp(qrData) {
    const timestamp = new Date(qrData.timestamp);
    const now = new Date();
    const maxAge = 10 * 60 * 1000; // 10分钟有效期
    
    return (now - timestamp) <= maxAge;
  }
  
  // 验证二维码有效期
  static validateExpiry(qrData) {
    const validUntil = new Date(qrData.valid_until);
    const now = new Date();
    
    return validUntil > now;
  }
  
  // 生成二维码校验码
  static generateChecksum(qrData) {
    const dataString = JSON.stringify({
      candidate_id: qrData.candidate_id,
      schedule_id: qrData.schedule_id,
      timestamp: qrData.timestamp
    });
    
    // 简单的校验码生成（实际应用中应使用更安全的算法）
    let checksum = 0;
    for (let i = 0; i < dataString.length; i++) {
      checksum += dataString.charCodeAt(i);
    }
    
    return checksum.toString(36);
  }
  
  // 验证二维码完整性
  static validateIntegrity(qrData) {
    const requiredFields = ['type', 'candidate_id', 'schedule_id', 'timestamp', 'valid_until'];
    
    for (const field of requiredFields) {
      if (!qrData.hasOwnProperty(field) || qrData[field] === null || qrData[field] === undefined) {
        return false;
      }
    }
    
    return true;
  }
}
```

**5.2 网络请求安全**
```javascript
// 安全的网络请求封装
class SecureRequest {
  static async request(options) {
    // 添加请求时间戳防重放
    const timestamp = Date.now();
    const nonce = Math.random().toString(36).substring(2);
    
    const secureOptions = {
      ...options,
      header: {
        ...options.header,
        'X-Timestamp': timestamp,
        'X-Nonce': nonce,
        'X-Request-ID': this.generateRequestId()
      },
      timeout: 10000 // 10秒超时
    };
    
    return new Promise((resolve, reject) => {
      wx.request({
        ...secureOptions,
        success: (res) => {
          if (this.validateResponse(res)) {
            resolve(res);
          } else {
            reject(new Error('响应数据验证失败'));
          }
        },
        fail: reject
      });
    });
  }
  
  static generateRequestId() {
    return Date.now().toString(36) + Math.random().toString(36).substring(2);
  }
  
  static validateResponse(response) {
    // 验证响应状态码
    if (response.statusCode < 200 || response.statusCode >= 300) {
      return false;
    }
    
    // 验证响应数据格式
    if (!response.data || typeof response.data !== 'object') {
      return false;
    }
    
    return true;
  }
}
```

##### 6. 性能优化策略

**6.1 二维码图片缓存**
```javascript
// 二维码图片缓存管理
class QRImageCache {
  static cacheKey = 'qr_image_cache';
  static maxCacheSize = 10; // 最多缓存10个二维码图片
  
  // 缓存二维码图片
  static async cacheImage(qrUrl, qrData) {
    try {
      // 下载图片到本地
      const downloadResult = await wx.downloadFile({
        url: qrUrl
      });
      
      if (downloadResult.statusCode === 200) {
        // 保存到本地文件系统
        const savedPath = await wx.saveFile({
          tempFilePath: downloadResult.tempFilePath
        });
        
        // 更新缓存记录
        this.updateCacheRecord(qrData.schedule_id, savedPath.savedFilePath);
        
        return savedPath.savedFilePath;
      }
    } catch (error) {
      console.error('缓存二维码图片失败:', error);
      return qrUrl; // 返回原始URL
    }
  }
  
  // 获取缓存的图片
  static getCachedImage(scheduleId) {
    const cache = wx.getStorageSync(this.cacheKey) || {};
    const cacheItem = cache[scheduleId];
    
    if (cacheItem && this.isFileExists(cacheItem.path)) {
      return cacheItem.path;
    }
    
    return null;
  }
  
  // 更新缓存记录
  static updateCacheRecord(scheduleId, filePath) {
    let cache = wx.getStorageSync(this.cacheKey) || {};
    
    // 添加新记录
    cache[scheduleId] = {
      path: filePath,
      timestamp: Date.now()
    };
    
    // 清理过期缓存
    cache = this.cleanExpiredCache(cache);
    
    wx.setStorageSync(this.cacheKey, cache);
  }
  
  // 清理过期缓存
  static cleanExpiredCache(cache) {
    const now = Date.now();
    const maxAge = 24 * 60 * 60 * 1000; // 24小时
    
    const cleanedCache = {};
    const entries = Object.entries(cache);
    
    // 按时间排序，保留最新的
    entries.sort((a, b) => b[1].timestamp - a[1].timestamp);
    
    let count = 0;
    for (const [key, value] of entries) {
      if (count < this.maxCacheSize && (now - value.timestamp) < maxAge) {
        cleanedCache[key] = value;
        count++;
      } else {
        // 删除过期或超出限制的文件
        this.deleteFile(value.path);
      }
    }
    
    return cleanedCache;
  }
  
  // 检查文件是否存在
  static isFileExists(filePath) {
    try {
      wx.getFileInfo({
        filePath: filePath,
        success: () => true,
        fail: () => false
      });
    } catch {
      return false;
    }
  }
  
  // 删除文件
  static deleteFile(filePath) {
    try {
      wx.removeSavedFile({
        filePath: filePath
      });
    } catch (error) {
      console.error('删除缓存文件失败:', error);
    }
  }
}
```

#### 模块总结
动态二维码模块作为整个考点管理系统的核心功能，通过智能的生成机制、完善的安全验证、友好的用户界面和高效的性能优化，为考生提供了可靠的身份验证凭证。该模块不仅要确保二维码的实时性和准确性，还要考虑网络异常、缓存策略、安全防护等多个方面，是技术实现难度最高但也是最关键的模块之一。
# 考点运营与流程管理微信小程序 - 详细模块分析

## 一、模块总览

基于需求文档和现有API分析，微信小程序可划分为以下9个功能模块：

### 核心业务模块（6个）
1. **身份认证模块** - 用户登录和身份验证
2. **考生个人中心模块** - 个人信息展示和管理
3. **动态二维码模块** - 考生身份凭证生成和展示
4. **考试日程模块** - 个人考试安排和排队状态
5. **考务扫码模块** - 考务人员签到操作
6. **公共看板模块** - 实时考场状态广播

### 辅助支持模块（3个）
7. **消息通知模块** - 状态变更和重要提醒
8. **帮助指引模块** - 使用说明和常见问题
9. **系统设置模块** - 个人偏好和应用设置

---

## 二、详细模块分析

### 模块1：身份认证模块（详细设计）

#### 模块作用与重要性
身份认证模块是整个小程序的入口和安全基础，承担着用户身份验证、权限分离、会话管理等核心职责。该模块的设计质量直接影响用户体验和系统安全性。

#### 业务场景分析
1. **考生场景**：考生通过身份证号快速登录，无需记忆复杂账号密码，降低使用门槛
2. **考务人员场景**：考务人员使用管理员分配的专用账号，确保操作权限的严格控制
3. **自动登录场景**：已登录用户再次进入小程序时自动识别身份，提升使用便利性

#### 详细功能设计

##### 1. 页面架构设计
```
app.js (应用入口)
├── pages/auth/
│   ├── role-select/     # 角色选择页
│   ├── candidate-login/ # 考生登录页
│   ├── staff-login/     # 考务登录页
│   ├── login-result/    # 登录结果页
│   └── auto-login/      # 自动登录处理页
```

##### 2. 核心功能实现思路

**2.1 角色选择与路由分发**
```javascript
// 实现思路：智能角色识别
onLaunch() {
  // 检查本地存储的用户信息
  const userInfo = wx.getStorageSync('userInfo');
  const userRole = wx.getStorageSync('userRole');
  
  if (userInfo && userRole) {
    // 自动登录验证
    this.autoLogin(userInfo, userRole);
  } else {
    // 跳转角色选择页
    wx.navigateTo({
      url: '/pages/auth/role-select/index'
    });
  }
}
```

**2.2 考生身份证登录机制**
```javascript
// 考生登录核心逻辑
candidateLogin(idCard) {
  // 1. 前端验证身份证格式
  if (!this.validateIdCard(idCard)) {
    wx.showToast({
      title: '身份证格式不正确',
      icon: 'error'
    });
    return;
  }
  
  // 2. 调用后端API验证
  wx.request({
    url: `${API_BASE}/wx/login-by-idcard`,
    method: 'POST',
    data: { id_card: idCard },
    success: (res) => {
      if (res.statusCode === 200) {
        // 3. 保存用户信息和令牌
        this.saveUserSession(res.data, 'candidate');
        // 4. 绑定微信openid
        this.bindWechatOpenId(res.data.access_token);
        // 5. 跳转到考生主页
        wx.switchTab({
          url: '/pages/candidate/index/index'
        });
      } else {
        this.handleLoginError(res.data);
      }
    }
  });
}
```

**2.3 考务人员账号登录机制**
```javascript
// 考务人员登录核心逻辑
staffLogin(username, password) {
  // 1. 前端基础验证
  if (!username || !password) {
    wx.showToast({
      title: '请输入账号和密码',
      icon: 'error'
    });
    return;
  }
  
  // 2. 调用标准登录接口
  wx.request({
    url: `${API_BASE}/wx/login`,
    method: 'POST',
    data: {
      code: '', // 微信登录code（可选）
      username: username,
      password: password,
      user_type: 'staff'
    },
    success: (res) => {
      if (res.statusCode === 200) {
        // 3. 保存会话信息
        this.saveUserSession(res.data, 'staff');
        // 4. 跳转到考务工作台
        wx.switchTab({
          url: '/pages/staff/workspace/index'
        });
      } else {
        this.handleLoginError(res.data);
      }
    }
  });
}
```

**2.4 自动登录与会话管理**
```javascript
// 自动登录验证机制
autoLogin(userInfo, userRole) {
  // 1. 检查令牌有效性
  wx.request({
    url: `${API_BASE}/wx/health`,
    method: 'GET',
    header: {
      'Authorization': `Bearer ${userInfo.access_token}`
    },
    success: (res) => {
      if (res.statusCode === 200) {
        // 令牌有效，直接跳转对应主页
        this.navigateToHomePage(userRole);
      } else {
        // 令牌失效，清除本地数据，重新登录
        this.clearUserSession();
        wx.navigateTo({
          url: '/pages/auth/role-select/index'
        });
      }
    }
  });
}
```

##### 3. API接口对接详情

**3.1 考生身份证登录接口**
```javascript
// API: POST /wx/login-by-idcard
// 请求参数：
{
  "id_card": "110101199001011234"  // 18位身份证号
}

// 响应数据：
{
  "message": "登录成功",
  "access_token": "candidate_1_1234",
  "candidate_info": {
    "id": 1,
    "name": "张三",
    "id_number": "110101199001011234",
    "phone": "13800138001",
    "exam_product": "无人机驾驶员考试",
    "institution": "北京航空培训中心",
    "status": "待排期"
  },
  "login_time": "2025-08-03T19:45:00"
}
```

**3.2 标准登录接口**
```javascript
// API: POST /wx/login
// 请求参数：
{
  "code": "微信登录code（可选）",
  "id_card": "身份证号（考生用）",
  "username": "用户名（考务用）",
  "password": "密码（考务用）"
}

// 响应数据：
{
  "access_token": "JWT令牌",
  "token_type": "bearer",
  "candidate_id": 1,  // 考生ID（考生登录时）
  "candidate_name": "张三",
  "phone": "13800138001",
  "status": "已排期"
}
```

**3.3 健康检查接口**
```javascript
// API: GET /wx/health
// 用途：验证服务可用性和令牌有效性
// 响应数据：
{
  "status": "healthy",
  "service": "微信小程序服务",
  "version": "1.0.0",
  "features": ["考生登录", "信息查询", "签到功能"]
}
```

##### 4. 技术实现细节

**4.1 身份证号验证算法**
```javascript
// 身份证号格式验证
validateIdCard(idCard) {
  // 基础格式检查
  if (!/^\d{17}[\dXx]$/.test(idCard)) {
    return false;
  }
  
  // 校验码验证
  const weights = [7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2];
  const checkCodes = ['1', '0', 'X', '9', '8', '7', '6', '5', '4', '3', '2'];
  
  let sum = 0;
  for (let i = 0; i < 17; i++) {
    sum += parseInt(idCard[i]) * weights[i];
  }
  
  const checkCode = checkCodes[sum % 11];
  return checkCode === idCard[17].toUpperCase();
}
```

**4.2 会话状态管理**
```javascript
// 用户会话管理工具类
class SessionManager {
  // 保存用户会话
  static saveUserSession(userData, userRole) {
    wx.setStorageSync('userInfo', userData);
    wx.setStorageSync('userRole', userRole);
    wx.setStorageSync('loginTime', new Date().getTime());
    
    // 设置全局请求头
    wx.setStorageSync('authToken', userData.access_token);
  }
  
  // 清除用户会话
  static clearUserSession() {
    wx.removeStorageSync('userInfo');
    wx.removeStorageSync('userRole');
    wx.removeStorageSync('loginTime');
    wx.removeStorageSync('authToken');
  }
  
  // 检查会话有效性
  static isSessionValid() {
    const loginTime = wx.getStorageSync('loginTime');
    const currentTime = new Date().getTime();
    const sessionTimeout = 24 * 60 * 60 * 1000; // 24小时
    
    return loginTime && (currentTime - loginTime < sessionTimeout);
  }
}
```

**4.3 微信OpenID绑定机制**
```javascript
// 绑定微信OpenID
bindWechatOpenId(accessToken) {
  wx.login({
    success: (res) => {
      if (res.code) {
        // 将微信code发送到后端进行OpenID绑定
        wx.request({
          url: `${API_BASE}/wx/bind-openid`,
          method: 'POST',
          header: {
            'Authorization': `Bearer ${accessToken}`
          },
          data: {
            wx_code: res.code
          },
          success: (bindRes) => {
            console.log('OpenID绑定成功', bindRes.data);
          }
        });
      }
    }
  });
}
```

##### 5. 用户体验优化

**5.1 加载状态管理**
```javascript
// 登录过程中的用户反馈
showLoginLoading() {
  wx.showLoading({
    title: '登录中...',
    mask: true
  });
}

hideLoginLoading() {
  wx.hideLoading();
}
```

**5.2 错误处理与用户提示**
```javascript
// 统一的错误处理机制
handleLoginError(errorData) {
  const errorMessages = {
    400: '输入信息格式不正确',
    404: '未找到该考生信息，请联系培训机构',
    403: '账号状态异常，无法登录',
    500: '系统繁忙，请稍后重试'
  };
  
  const message = errorMessages[errorData.status_code] || errorData.detail || '登录失败';
  
  wx.showModal({
    title: '登录失败',
    content: message,
    showCancel: false,
    confirmText: '确定'
  });
}
```

##### 6. 安全性考虑

**6.1 数据传输安全**
- 所有API请求使用HTTPS加密传输
- 敏感信息（如身份证号）在传输前进行基础验证
- 访问令牌采用JWT格式，包含过期时间

**6.2 本地存储安全**
- 敏感信息加密存储在本地
- 定期清理过期的会话数据
- 防止信息泄露的安全措施

**6.3 防重放攻击**
```javascript
// 请求防重复提交
let isSubmitting = false;

submitLogin() {
  if (isSubmitting) {
    wx.showToast({
      title: '请勿重复提交',
      icon: 'error'
    });
    return;
  }
  
  isSubmitting = true;
  
  // 执行登录逻辑
  this.performLogin().finally(() => {
    isSubmitting = false;
  });
}
```

##### 7. 数据流转详细设计

```
用户进入小程序
    ↓
检查本地会话状态
    ↓
[有效会话] → 自动登录验证 → [成功] → 跳转对应主页
    ↓                      ↓
[无效/无会话]              [失败] → 清除本地数据
    ↓                      ↓
显示角色选择页面 ←----------┘
    ↓
[考生] → 身份证登录页 → 输入身份证 → API验证 → 保存会话 → 考生主页
    ↓
[考务] → 账号登录页 → 输入账号密码 → API验证 → 保存会话 → 考务工作台
```

##### 8. 性能优化策略

**8.1 页面预加载**
```javascript
// 在角色选择页预加载后续页面
onReady() {
  // 预加载考生登录页
  wx.preloadPage({
    url: '/pages/auth/candidate-login/index'
  });
  
  // 预加载考务登录页
  wx.preloadPage({
    url: '/pages/auth/staff-login/index'
  });
}
```

**8.2 网络请求优化**
```javascript
// 网络请求封装，支持重试和缓存
class NetworkManager {
  static async request(options, retryCount = 3) {
    try {
      const response = await wx.request(options);
      return response;
    } catch (error) {
      if (retryCount > 0) {
        await this.delay(1000); // 延迟1秒重试
        return this.request(options, retryCount - 1);
      }
      throw error;
    }
  }
  
  static delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}
```

#### 模块总结
身份认证模块作为整个小程序的入口，需要在安全性、易用性、性能等方面做到平衡。通过双重登录机制（考生身份证登录 + 考务账号登录）、自动登录、会话管理等功能，为不同角色用户提供便捷而安全的身份验证服务。该模块的成功实现将为后续所有功能模块奠定坚实的基础。
# 考点运营与流程管理微信小程序 - 详细模块分析

## 一、模块总览

基于需求文档和现有API分析，微信小程序可划分为以下9个功能模块：

### 核心业务模块（6个）
1. **身份认证模块** - 用户登录和身份验证
2. **考生个人中心模块** - 个人信息展示和管理
3. **动态二维码模块** - 考生身份凭证生成和展示
4. **考试日程模块** - 个人考试安排和排队状态
5. **考务扫码模块** - 考务人员签到操作
6. **公共看板模块** - 实时考场状态广播

### 辅助支持模块（3个）
7. **消息通知模块** - 状态变更和重要提醒
8. **帮助指引模块** - 使用说明和常见问题
9. **系统设置模块** - 个人偏好和应用设置

---

## 二、详细模块分析

# 考点运营与流程管理微信小程序 - 详细模块分析

## 一、模块总览

基于需求文档和现有API分析，微信小程序可划分为以下9个功能模块：

### 核心业务模块（6个）
1. **身份认证模块** - 用户登录和身份验证
2. **考生个人中心模块** - 个人信息展示和管理
3. **动态二维码模块** - 考生身份凭证生成和展示
4. **考试日程模块** - 个人考试安排和排队状态
5. **考务扫码模块** - 考务人员签到操作
6. **公共看板模块** - 实时考场状态广播

### 辅助支持模块（3个）
7. **消息通知模块** - 状态变更和重要提醒
8. **帮助指引模块** - 使用说明和常见问题
9. **系统设置模块** - 个人偏好和应用设置

---

## 二、详细模块分析

### 模块1：身份认证模块

#### 功能描述
为考生和考务人员提供不同的登录方式，实现身份验证和权限分离。

#### 页面设计
- **登录选择页** - 用户角色选择（考生/考务人员）
- **考生登录页** - 身份证号快速登录
- **考务登录页** - 账号密码登录
- **登录结果页** - 登录成功/失败反馈

#### 核心功能点
1. **考生登录流程**：
   - 输入18位身份证号码
   - 系统验证身份证格式和考生信息
   - 绑定微信openid实现后续自动登录
   - 返回考生基本信息和访问令牌

2. **考务人员登录流程**：
   - 使用管理员分配的账号密码
   - 验证考务人员身份和权限
   - 进入考务工作台

3. **自动登录机制**：
   - 检测已绑定的微信用户
   - 自动跳转到对应角色的主页面

#### 对接API
- `POST /wx/login-by-idcard` - 考生身份证登录
- `POST /wx/login` - 标准登录接口
- `GET /wx/health` - 服务健康检查

#### 数据流转
```
用户输入 → 身份验证 → 角色判断 → 生成令牌 → 跳转主页
```

---

### 模块2：考生个人中心模块（详细设计）

#### 模块作用与重要性
考生个人中心模块是考生了解自身考试状态、查看个人信息的核心入口。该模块承担着信息展示、状态跟踪、用户引导等重要职责，是提升考生体验和减少咨询压力的关键模块。

#### 业务场景分析
1. **信息查询场景**：考生需要快速了解自己的基本信息、考试产品、培训机构等
2. **状态跟踪场景**：考生关心当前考试进度，下一步需要做什么
3. **问题排查场景**：当考生遇到问题时，需要通过个人信息进行自助排查

#### 详细功能设计

##### 1. 页面架构设计
```
pages/candidate/
├── profile/
│   ├── index/           # 个人中心主页
│   ├── basic-info/      # 基本信息详情页
│   ├── exam-info/       # 考试信息详情页
│   ├── status-track/    # 状态跟踪页
│   └── progress-guide/  # 进度指引页
```

##### 2. 核心功能实现思路

**2.1 个人信息数据获取与缓存**
```javascript
// 个人信息管理类
class CandidateProfileManager {
  constructor() {
    this.candidateId = wx.getStorageSync('userInfo').candidate_id;
    this.profileData = null;
    this.lastUpdateTime = 0;
    this.cacheExpireTime = 5 * 60 * 1000; // 5分钟缓存
  }
  
  // 获取考生详细信息
  async getCandidateInfo(forceRefresh = false) {
    // 检查缓存有效性
    if (!forceRefresh && this.profileData && 
        (Date.now() - this.lastUpdateTime < this.cacheExpireTime)) {
      return this.profileData;
    }
    
    try {
      wx.showLoading({ title: '加载中...' });
      
      const response = await wx.request({
        url: `${API_BASE}/wx/candidate-info/${this.candidateId}`,
        method: 'GET',
        header: {
          'Authorization': `Bearer ${wx.getStorageSync('authToken')}`
        }
      });
      
      if (response.statusCode === 200) {
        this.profileData = response.data.data;
        this.lastUpdateTime = Date.now();
        
        // 缓存到本地存储
        wx.setStorageSync('candidateProfile', this.profileData);
        
        return this.profileData;
      } else {
        throw new Error(response.data.detail || '获取信息失败');
      }
    } catch (error) {
      // 网络异常时使用本地缓存
      const cachedData = wx.getStorageSync('candidateProfile');
      if (cachedData) {
        console.warn('使用缓存数据:', error.message);
        return cachedData;
      }
      throw error;
    } finally {
      wx.hideLoading();
    }
  }
}
```

**2.2 信息展示与数据处理**
```javascript
// 个人中心页面逻辑
Page({
  data: {
    candidateInfo: {},
    statusConfig: {
      '待排期': { color: '#ff9500', icon: 'clock' },
      '已排期': { color: '#007aff', icon: 'calendar' },
      '考试中': { color: '#34c759', icon: 'play' },
      '已完成': { color: '#8e8e93', icon: 'checkmark' }
    },
    loading: true,
    error: null
  },
  
  async onLoad() {
    await this.loadCandidateInfo();
  },
  
  async onPullDownRefresh() {
    await this.loadCandidateInfo(true);
    wx.stopPullDownRefresh();
  },
  
  // 加载考生信息
  async loadCandidateInfo(forceRefresh = false) {
    try {
      this.setData({ loading: true, error: null });
      
      const profileManager = new CandidateProfileManager();
      const candidateInfo = await profileManager.getCandidateInfo(forceRefresh);
      
      // 数据处理和格式化
      const processedInfo = this.processCandidateInfo(candidateInfo);
      
      this.setData({
        candidateInfo: processedInfo,
        loading: false
      });
      
    } catch (error) {
      console.error('加载考生信息失败:', error);
      this.setData({
        error: error.message,
        loading: false
      });
      
      wx.showToast({
        title: '加载失败，请重试',
        icon: 'error'
      });
    }
  },
  
  // 数据处理和格式化
  processCandidateInfo(rawData) {
    return {
      // 基本信息处理
      basicInfo: {
        name: rawData.name,
        idNumber: this.maskIdNumber(rawData.id_number),
        phone: this.maskPhone(rawData.phone),
        email: rawData.email || '未填写',
        registrationDate: this.formatDate(rawData.registration_date),
        status: rawData.status
      },
      
      // 考试信息处理
      examInfo: {
        product: rawData.exam_product,
        institution: rawData.institution,
        institutionId: rawData.institution_id
      },
      
      // 状态信息处理
      statusInfo: {
        current: rawData.status,
        nextStep: this.getNextStepGuide(rawData.status),
        progress: this.calculateProgress(rawData.status),
        upcomingSchedules: rawData.upcoming_schedules || []
      }
    };
  }
}
```

**2.3 敏感信息脱敏处理**
```javascript
// 数据脱敏工具方法
const DataMaskUtils = {
  // 身份证号脱敏
  maskIdNumber(idNumber) {
    if (!idNumber || idNumber.length !== 18) return idNumber;
    return idNumber.substring(0, 6) + '****' + idNumber.substring(14);
  },
  
  // 手机号脱敏
  maskPhone(phone) {
    if (!phone || phone.length !== 11) return phone;
    return phone.substring(0, 3) + '****' + phone.substring(7);
  },
  
  // 邮箱脱敏
  maskEmail(email) {
    if (!email || !email.includes('@')) return email;
    const [username, domain] = email.split('@');
    const maskedUsername = username.length > 2 
      ? username.substring(0, 2) + '***' 
      : username;
    return maskedUsername + '@' + domain;
  }
};
```

##### 3. API接口对接详情

**3.1 考生详细信息接口**
```javascript
// API: GET /wx/candidate-info/{candidate_id}
// 请求头：Authorization: Bearer {access_token}

// 响应数据结构：
{
  "message": "考生信息获取成功",
  "data": {
    "id": 1,
    "name": "张三",
    "id_number": "110101199001011234",
    "phone": "13800138001",
    "email": "zhangsan@example.com",
    "exam_product": "无人机驾驶员考试",
    "institution": "北京航空培训中心",
    "institution_id": 1,
    "status": "已排期",
    "registration_date": "2025-08-01",
    "upcoming_schedules": [
      {
        "id": 1,
        "activity_name": "理论考试",
        "exam_date": "2025-08-15",
        "start_time": "09:00",
        "end_time": "10:30",
        "venue": "理论考场A",
        "status": "scheduled"
      }
    ],
    "current_queue_info": {
      "venue": "实操场地1",
      "position": 3,
      "estimated_wait_time": "约45分钟"
    }
  }
}
```

##### 4. 用户界面设计

**4.1 个人中心主页布局**
```xml
<!-- 个人中心主页模板 -->
<view class="profile-container">
  <!-- 头部信息卡片 -->
  <view class="profile-header">
    <view class="avatar-section">
      <image class="avatar" src="{{candidateInfo.avatar || '/images/default-avatar.png'}}" />
      <view class="status-badge status-{{candidateInfo.basicInfo.status}}">
        {{candidateInfo.basicInfo.status}}
      </view>
    </view>
    
    <view class="basic-info">
      <text class="name">{{candidateInfo.basicInfo.name}}</text>
      <text class="id-number">{{candidateInfo.basicInfo.idNumber}}</text>
      <text class="phone">{{candidateInfo.basicInfo.phone}}</text>
    </view>
  </view>
  
  <!-- 考试信息卡片 -->
  <view class="exam-info-card">
    <view class="card-title">考试信息</view>
    <view class="info-item">
      <text class="label">考试产品：</text>
      <text class="value">{{candidateInfo.examInfo.product}}</text>
    </view>
    <view class="info-item">
      <text class="label">培训机构：</text>
      <text class="value">{{candidateInfo.examInfo.institution}}</text>
    </view>
    <view class="info-item">
      <text class="label">报名时间：</text>
      <text class="value">{{candidateInfo.basicInfo.registrationDate}}</text>
    </view>
  </view>
  
  <!-- 状态跟踪卡片 -->
  <view class="status-track-card">
    <view class="card-title">考试进度</view>
    <view class="progress-bar">
      <view class="progress-fill" style="width: {{candidateInfo.statusInfo.progress}}%"></view>
    </view>
    <view class="next-step">
      <text class="step-title">下一步：</text>
      <text class="step-content">{{candidateInfo.statusInfo.nextStep}}</text>
    </view>
  </view>
  
  <!-- 功能入口 -->
  <view class="function-entries">
    <navigator url="/pages/candidate/schedule/index" class="entry-item">
      <image class="entry-icon" src="/images/schedule-icon.png" />
      <text class="entry-text">考试安排</text>
    </navigator>
    
    <navigator url="/pages/candidate/qrcode/index" class="entry-item">
      <image class="entry-icon" src="/images/qrcode-icon.png" />
      <text class="entry-text">我的二维码</text>
    </navigator>
    
    <navigator url="/pages/public/venues/index" class="entry-item">
      <image class="entry-icon" src="/images/venues-icon.png" />
      <text class="entry-text">考场状态</text>
    </navigator>
  </view>
</view>
```

**4.2 状态指示与进度计算**
```javascript
// 状态处理工具类
class StatusManager {
  // 获取下一步操作指引
  static getNextStepGuide(currentStatus) {
    const stepGuides = {
      '待排期': '请耐心等待考务管理员为您安排考试时间',
      '已排期': '请查看考试安排，准时参加考试',
      '考试中': '请按照考务人员指引完成考试流程',
      '已完成': '考试已完成，请等待成绩公布'
    };
    
    return stepGuides[currentStatus] || '请联系培训机构了解详情';
  }
  
  // 计算考试进度百分比
  static calculateProgress(currentStatus) {
    const progressMap = {
      '待排期': 25,
      '已排期': 50,
      '考试中': 75,
      '已完成': 100
    };
    
    return progressMap[currentStatus] || 0;
  }
  
  // 获取状态颜色配置
  static getStatusColor(status) {
    const colorMap = {
      '待排期': '#ff9500',
      '已排期': '#007aff',
      '考试中': '#34c759',
      '已完成': '#8e8e93'
    };
    
    return colorMap[status] || '#8e8e93';
  }
}
```

##### 5. 交互体验优化

**5.1 下拉刷新与上拉加载**
```javascript
// 下拉刷新实现
onPullDownRefresh() {
  this.loadCandidateInfo(true).then(() => {
    wx.stopPullDownRefresh();
    wx.showToast({
      title: '刷新成功',
      icon: 'success',
      duration: 1500
    });
  });
},

// 页面显示时自动刷新
onShow() {
  // 如果数据超过5分钟，自动刷新
  const lastUpdate = wx.getStorageSync('profileLastUpdate') || 0;
  if (Date.now() - lastUpdate > 5 * 60 * 1000) {
    this.loadCandidateInfo(true);
  }
}
```

**5.2 错误处理与重试机制**
```javascript
// 错误处理组件
const ErrorHandler = {
  // 显示错误信息
  showError(error, retryCallback) {
    wx.showModal({
      title: '加载失败',
      content: error.message || '网络异常，请检查网络连接',
      confirmText: '重试',
      cancelText: '取消',
      success: (res) => {
        if (res.confirm && retryCallback) {
          retryCallback();
        }
      }
    });
  },
  
  // 网络状态检查
  checkNetworkStatus() {
    return new Promise((resolve) => {
      wx.getNetworkType({
        success: (res) => {
          if (res.networkType === 'none') {
            wx.showToast({
              title: '网络连接异常',
              icon: 'error'
            });
            resolve(false);
          } else {
            resolve(true);
          }
        }
      });
    });
  }
};
```

##### 6. 数据同步与状态管理

**6.1 全局状态同步**
```javascript
// 全局状态管理
const GlobalState = {
  candidateInfo: null,
  
  // 更新考生信息
  updateCandidateInfo(newInfo) {
    this.candidateInfo = newInfo;
    
    // 通知其他页面更新
    wx.$emit('candidateInfoUpdated', newInfo);
    
    // 更新本地存储
    wx.setStorageSync('candidateProfile', newInfo);
  },
  
  // 获取考生信息
  getCandidateInfo() {
    if (!this.candidateInfo) {
      this.candidateInfo = wx.getStorageSync('candidateProfile');
    }
    return this.candidateInfo;
  }
};
```

**6.2 数据变更监听**
```javascript
// 页面数据变更监听
onLoad() {
  // 监听考生信息更新事件
  wx.$on('candidateInfoUpdated', (newInfo) => {
    this.setData({
      candidateInfo: this.processCandidateInfo(newInfo)
    });
  });
  
  // 监听考试状态变更
  wx.$on('examStatusChanged', (newStatus) => {
    this.updateExamStatus(newStatus);
  });
},

onUnload() {
  // 清理事件监听
  wx.$off('candidateInfoUpdated');
  wx.$off('examStatusChanged');
}
```

##### 7. 性能优化策略

**7.1 图片懒加载**
```javascript
// 图片懒加载实现
const ImageLazyLoader = {
  // 观察器实例
  observer: null,
  
  // 初始化懒加载
  init() {
    this.observer = wx.createIntersectionObserver();
    
    this.observer.relativeToViewport().observe('.lazy-image', (res) => {
      if (res.intersectionRatio > 0) {
        // 图片进入视口，开始加载
        const dataset = res.target.dataset;
        if (dataset.src) {
          res.target.src = dataset.src;
          res.target.classList.remove('lazy-image');
        }
      }
    });
  },
  
  // 销毁观察器
  destroy() {
    if (this.observer) {
      this.observer.disconnect();
    }
  }
};
```

**7.2 数据预加载**
```javascript
// 相关数据预加载
preloadRelatedData() {
  // 预加载考试安排数据
  wx.request({
    url: `${API_BASE}/wx/candidate-info/${this.candidateId}`,
    method: 'GET',
    header: {
      'Authorization': `Bearer ${wx.getStorageSync('authToken')}`
    },
    success: (res) => {
      // 缓存预加载的数据
      wx.setStorageSync('preloadedSchedules', res.data.upcoming_schedules);
    }
  });
}
```

#### 模块总结
考生个人中心模块通过清晰的信息展示、智能的状态跟踪、友好的交互体验，为考生提供了全面的个人信息管理功能。该模块不仅展示静态信息，更重要的是通过状态跟踪和进度指引，帮助考生了解当前所处的考试阶段和下一步操作，大大减少了考生的困惑和咨询需求。通过合理的缓存策略和性能优化，确保了良好的用户体验。
# 考点运营与流程管理微信小程序 - 详细模块分析

## 一、模块总览

基于需求文档和现有API分析，微信小程序可划分为以下9个功能模块：

### 核心业务模块（6个）
1. **身份认证模块** - 用户登录和身份验证
2. **考生个人中心模块** - 个人信息展示和管理
3. **动态二维码模块** - 考生身份凭证生成和展示
4. **考试日程模块** - 个人考试安排和排队状态
5. **考务扫码模块** - 考务人员签到操作
6. **公共看板模块** - 实时考场状态广播

### 辅助支持模块（3个）
7. **消息通知模块** - 状态变更和重要提醒
8. **帮助指引模块** - 使用说明和常见问题
9. **系统设置模块** - 个人偏好和应用设置

---

## 二、详细模块分析

### 模块1：身份认证模块（详细设计）

#### 模块作用与重要性
身份认证模块是整个小程序的入口和安全基础，承担着用户身份验证、权限分离、会话管理等核心职责。该模块的设计质量直接影响用户体验和系统安全性。

#### 业务场景分析
1. **考生场景**：考生通过身份证号快速登录，无需记忆复杂账号密码，降低使用门槛
2. **考务人员场景**：考务人员使用管理员分配的专用账号，确保操作权限的严格控制
3. **自动登录场景**：已登录用户再次进入小程序时自动识别身份，提升使用便利性

#### 详细功能设计

##### 1. 页面架构设计
```
app.js (应用入口)
├── pages/auth/
│   ├── role-select/     # 角色选择页
│   ├── candidate-login/ # 考生登录页
│   ├── staff-login/     # 考务登录页
│   ├── login-result/    # 登录结果页
│   └── auto-login/      # 自动登录处理页
```

##### 2. 核心功能实现思路

**2.1 角色选择与路由分发**
```javascript
// 实现思路：智能角色识别
onLaunch() {
  // 检查本地存储的用户信息
  const userInfo = wx.getStorageSync('userInfo');
  const userRole = wx.getStorageSync('userRole');
  
  if (userInfo && userRole) {
    // 自动登录验证
    this.autoLogin(userInfo, userRole);
  } else {
    // 跳转角色选择页
    wx.navigateTo({
      url: '/pages/auth/role-select/index'
    });
  }
}
```

**2.2 考生身份证登录机制**
```javascript
// 考生登录核心逻辑
candidateLogin(idCard) {
  // 1. 前端验证身份证格式
  if (!this.validateIdCard(idCard)) {
    wx.showToast({
      title: '身份证格式不正确',
      icon: 'error'
    });
    return;
  }
  
  // 2. 调用后端API验证
  wx.request({
    url: `${API_BASE}/wx/login-by-idcard`,
    method: 'POST',
    data: { id_card: idCard },
    success: (res) => {
      if (res.statusCode === 200) {
        // 3. 保存用户信息和令牌
        this.saveUserSession(res.data, 'candidate');
        // 4. 绑定微信openid
        this.bindWechatOpenId(res.data.access_token);
        // 5. 跳转到考生主页
        wx.switchTab({
          url: '/pages/candidate/index/index'
        });
      } else {
        this.handleLoginError(res.data);
      }
    }
  });
}
```

**2.3 考务人员账号登录机制**
```javascript
// 考务人员登录核心逻辑
staffLogin(username, password) {
  // 1. 前端基础验证
  if (!username || !password) {
    wx.showToast({
      title: '请输入账号和密码',
      icon: 'error'
    });
    return;
  }
  
  // 2. 调用标准登录接口
  wx.request({
    url: `${API_BASE}/wx/login`,
    method: 'POST',
    data: {
      code: '', // 微信登录code（可选）
      username: username,
      password: password,
      user_type: 'staff'
    },
    success: (res) => {
      if (res.statusCode === 200) {
        // 3. 保存会话信息
        this.saveUserSession(res.data, 'staff');
        // 4. 跳转到考务工作台
        wx.switchTab({
          url: '/pages/staff/workspace/index'
        });
      } else {
        this.handleLoginError(res.data);
      }
    }
  });
}
```

**2.4 自动登录与会话管理**
```javascript
// 自动登录验证机制
autoLogin(userInfo, userRole) {
  // 1. 检查令牌有效性
  wx.request({
    url: `${API_BASE}/wx/health`,
    method: 'GET',
    header: {
      'Authorization': `Bearer ${userInfo.access_token}`
    },
    success: (res) => {
      if (res.statusCode === 200) {
        // 令牌有效，直接跳转对应主页
        this.navigateToHomePage(userRole);
      } else {
        // 令牌失效，清除本地数据，重新登录
        this.clearUserSession();
        wx.navigateTo({
          url: '/pages/auth/role-select/index'
        });
      }
    }
  });
}
```

##### 3. API接口对接详情

**3.1 考生身份证登录接口**
```javascript
// API: POST /wx/login-by-idcard
// 请求参数：
{
  "id_card": "110101199001011234"  // 18位身份证号
}

// 响应数据：
{
  "message": "登录成功",
  "access_token": "candidate_1_1234",
  "candidate_info": {
    "id": 1,
    "name": "张三",
    "id_number": "110101199001011234",
    "phone": "13800138001",
    "exam_product": "无人机驾驶员考试",
    "institution": "北京航空培训中心",
    "status": "待排期"
  },
  "login_time": "2025-08-03T19:45:00"
}
```

**3.2 标准登录接口**
```javascript
// API: POST /wx/login
// 请求参数：
{
  "code": "微信登录code（可选）",
  "id_card": "身份证号（考生用）",
  "username": "用户名（考务用）",
  "password": "密码（考务用）"
}

// 响应数据：
{
  "access_token": "JWT令牌",
  "token_type": "bearer",
  "candidate_id": 1,  // 考生ID（考生登录时）
  "candidate_name": "张三",
  "phone": "13800138001",
  "status": "已排期"
}
```

**3.3 健康检查接口**
```javascript
// API: GET /wx/health
// 用途：验证服务可用性和令牌有效性
// 响应数据：
{
  "status": "healthy",
  "service": "微信小程序服务",
  "version": "1.0.0",
  "features": ["考生登录", "信息查询", "签到功能"]
}
```

##### 4. 技术实现细节

**4.1 身份证号验证算法**
```javascript
// 身份证号格式验证
validateIdCard(idCard) {
  // 基础格式检查
  if (!/^\d{17}[\dXx]$/.test(idCard)) {
    return false;
  }
  
  // 校验码验证
  const weights = [7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2];
  const checkCodes = ['1', '0', 'X', '9', '8', '7', '6', '5', '4', '3', '2'];
  
  let sum = 0;
  for (let i = 0; i < 17; i++) {
    sum += parseInt(idCard[i]) * weights[i];
  }
  
  const checkCode = checkCodes[sum % 11];
  return checkCode === idCard[17].toUpperCase();
}
```

**4.2 会话状态管理**
```javascript
// 用户会话管理工具类
class SessionManager {
  // 保存用户会话
  static saveUserSession(userData, userRole) {
    wx.setStorageSync('userInfo', userData);
    wx.setStorageSync('userRole', userRole);
    wx.setStorageSync('loginTime', new Date().getTime());
    
    // 设置全局请求头
    wx.setStorageSync('authToken', userData.access_token);
  }
  
  // 清除用户会话
  static clearUserSession() {
    wx.removeStorageSync('userInfo');
    wx.removeStorageSync('userRole');
    wx.removeStorageSync('loginTime');
    wx.removeStorageSync('authToken');
  }
  
  // 检查会话有效性
  static isSessionValid() {
    const loginTime = wx.getStorageSync('loginTime');
    const currentTime = new Date().getTime();
    const sessionTimeout = 24 * 60 * 60 * 1000; // 24小时
    
    return loginTime && (currentTime - loginTime < sessionTimeout);
  }
}
```

**4.3 微信OpenID绑定机制**
```javascript
// 绑定微信OpenID
bindWechatOpenId(accessToken) {
  wx.login({
    success: (res) => {
      if (res.code) {
        // 将微信code发送到后端进行OpenID绑定
        wx.request({
          url: `${API_BASE}/wx/bind-openid`,
          method: 'POST',
          header: {
            'Authorization': `Bearer ${accessToken}`
          },
          data: {
            wx_code: res.code
          },
          success: (bindRes) => {
            console.log('OpenID绑定成功', bindRes.data);
          }
        });
      }
    }
  });
}
```

##### 5. 用户体验优化

**5.1 加载状态管理**
```javascript
// 登录过程中的用户反馈
showLoginLoading() {
  wx.showLoading({
    title: '登录中...',
    mask: true
  });
}

hideLoginLoading() {
  wx.hideLoading();
}
```

**5.2 错误处理与用户提示**
```javascript
// 统一的错误处理机制
handleLoginError(errorData) {
  const errorMessages = {
    400: '输入信息格式不正确',
    404: '未找到该考生信息，请联系培训机构',
    403: '账号状态异常，无法登录',
    500: '系统繁忙，请稍后重试'
  };
  
  const message = errorMessages[errorData.status_code] || errorData.detail || '登录失败';
  
  wx.showModal({
    title: '登录失败',
    content: message,
    showCancel: false,
    confirmText: '确定'
  });
}
```

##### 6. 安全性考虑

**6.1 数据传输安全**
- 所有API请求使用HTTPS加密传输
- 敏感信息（如身份证号）在传输前进行基础验证
- 访问令牌采用JWT格式，包含过期时间

**6.2 本地存储安全**
- 敏感信息加密存储在本地
- 定期清理过期的会话数据
- 防止信息泄露的安全措施

**6.3 防重放攻击**
```javascript
// 请求防重复提交
let isSubmitting = false;

submitLogin() {
  if (isSubmitting) {
    wx.showToast({
      title: '请勿重复提交',
      icon: 'error'
    });
    return;
  }
  
  isSubmitting = true;
  
  // 执行登录逻辑
  this.performLogin().finally(() => {
    isSubmitting = false;
  });
}
```

##### 7. 数据流转详细设计

```
用户进入小程序
    ↓
检查本地会话状态
    ↓
[有效会话] → 自动登录验证 → [成功] → 跳转对应主页
    ↓                      ↓
[无效/无会话]              [失败] → 清除本地数据
    ↓                      ↓
显示角色选择页面 ←----------┘
    ↓
[考生] → 身份证登录页 → 输入身份证 → API验证 → 保存会话 → 考生主页
    ↓
[考务] → 账号登录页 → 输入账号密码 → API验证 → 保存会话 → 考务工作台
```

##### 8. 性能优化策略

**8.1 页面预加载**
```javascript
// 在角色选择页预加载后续页面
onReady() {
  // 预加载考生登录页
  wx.preloadPage({
    url: '/pages/auth/candidate-login/index'
  });
  
  // 预加载考务登录页
  wx.preloadPage({
    url: '/pages/auth/staff-login/index'
  });
}
```

**8.2 网络请求优化**
```javascript
// 网络请求封装，支持重试和缓存
class NetworkManager {
  static async request(options, retryCount = 3) {
    try {
      const response = await wx.request(options);
      return response;
    } catch (error) {
      if (retryCount > 0) {
        await this.delay(1000); // 延迟1秒重试
        return this.request(options, retryCount - 1);
      }
      throw error;
    }
  }
  
  static delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}
```

#### 模块总结
身份认证模块作为整个小程序的入口，需要在安全性、易用性、性能等方面做到平衡。通过双重登录机制（考生身份证登录 + 考务账号登录）、自动登录、会话管理等功能，为不同角色用户提供便捷而安全的身份验证服务。该模块的成功实现将为后续所有功能模块奠定坚实的基础。
# 考点运营与流程管理微信小程序 - 详细模块分析

## 一、模块总览

基于需求文档和现有API分析，微信小程序可划分为以下9个功能模块：

### 核心业务模块（6个）
1. **身份认证模块** - 用户登录和身份验证
2. **考生个人中心模块** - 个人信息展示和管理
3. **动态二维码模块** - 考生身份凭证生成和展示
4. **考试日程模块** - 个人考试安排和排队状态
5. **考务扫码模块** - 考务人员签到操作
6. **公共看板模块** - 实时考场状态广播

### 辅助支持模块（3个）
7. **消息通知模块** - 状态变更和重要提醒
8. **帮助指引模块** - 使用说明和常见问题
9. **系统设置模块** - 个人偏好和应用设置

---

## 二、详细模块分析

# 考点运营与流程管理微信小程序 - 详细模块分析

## 一、模块总览

基于需求文档和现有API分析，微信小程序可划分为以下9个功能模块：

### 核心业务模块（6个）
1. **身份认证模块** - 用户登录和身份验证
2. **考生个人中心模块** - 个人信息展示和管理
3. **动态二维码模块** - 考生身份凭证生成和展示
4. **考试日程模块** - 个人考试安排和排队状态
5. **考务扫码模块** - 考务人员签到操作
6. **公共看板模块** - 实时考场状态广播

### 辅助支持模块（3个）
7. **消息通知模块** - 状态变更和重要提醒
8. **帮助指引模块** - 使用说明和常见问题
9. **系统设置模块** - 个人偏好和应用设置

---

## 二、详细模块分析

### 模块1：身份认证模块

#### 功能描述
为考生和考务人员提供不同的登录方式，实现身份验证和权限分离。

#### 页面设计
- **登录选择页** - 用户角色选择（考生/考务人员）
- **考生登录页** - 身份证号快速登录
- **考务登录页** - 账号密码登录
- **登录结果页** - 登录成功/失败反馈

#### 核心功能点
1. **考生登录流程**：
   - 输入18位身份证号码
   - 系统验证身份证格式和考生信息
   - 绑定微信openid实现后续自动登录
   - 返回考生基本信息和访问令牌

2. **考务人员登录流程**：
   - 使用管理员分配的账号密码
   - 验证考务人员身份和权限
   - 进入考务工作台

3. **自动登录机制**：
   - 检测已绑定的微信用户
   - 自动跳转到对应角色的主页面

#### 对接API
- `POST /wx/login-by-idcard` - 考生身份证登录
- `POST /wx/login` - 标准登录接口
- `GET /wx/health` - 服务健康检查

#### 数据流转
```
用户输入 → 身份验证 → 角色判断 → 生成令牌 → 跳转主页
```

---

# 考点运营与流程管理微信小程序 - 详细模块分析

## 一、模块总览

基于需求文档和现有API分析，微信小程序可划分为以下9个功能模块：

### 核心业务模块（6个）
1. **身份认证模块** - 用户登录和身份验证
2. **考生个人中心模块** - 个人信息展示和管理
3. **动态二维码模块** - 考生身份凭证生成和展示
4. **考试日程模块** - 个人考试安排和排队状态
5. **考务扫码模块** - 考务人员签到操作
6. **公共看板模块** - 实时考场状态广播

### 辅助支持模块（3个）
7. **消息通知模块** - 状态变更和重要提醒
8. **帮助指引模块** - 使用说明和常见问题
9. **系统设置模块** - 个人偏好和应用设置

---

## 二、详细模块分析

### 模块1：身份认证模块（详细设计）

#### 模块作用与重要性
身份认证模块是整个小程序的入口和安全基础，承担着用户身份验证、权限分离、会话管理等核心职责。该模块的设计质量直接影响用户体验和系统安全性。

#### 业务场景分析
1. **考生场景**：考生通过身份证号快速登录，无需记忆复杂账号密码，降低使用门槛
2. **考务人员场景**：考务人员使用管理员分配的专用账号，确保操作权限的严格控制
3. **自动登录场景**：已登录用户再次进入小程序时自动识别身份，提升使用便利性

#### 详细功能设计

##### 1. 页面架构设计
```
app.js (应用入口)
├── pages/auth/
│   ├── role-select/     # 角色选择页
│   ├── candidate-login/ # 考生登录页
│   ├── staff-login/     # 考务登录页
│   ├── login-result/    # 登录结果页
│   └── auto-login/      # 自动登录处理页
```

##### 2. 核心功能实现思路

**2.1 角色选择与路由分发**
```javascript
// 实现思路：智能角色识别
onLaunch() {
  // 检查本地存储的用户信息
  const userInfo = wx.getStorageSync('userInfo');
  const userRole = wx.getStorageSync('userRole');
  
  if (userInfo && userRole) {
    // 自动登录验证
    this.autoLogin(userInfo, userRole);
  } else {
    // 跳转角色选择页
    wx.navigateTo({
      url: '/pages/auth/role-select/index'
    });
  }
}
```

**2.2 考生身份证登录机制**
```javascript
// 考生登录核心逻辑
candidateLogin(idCard) {
  // 1. 前端验证身份证格式
  if (!this.validateIdCard(idCard)) {
    wx.showToast({
      title: '身份证格式不正确',
      icon: 'error'
    });
    return;
  }
  
  // 2. 调用后端API验证
  wx.request({
    url: `${API_BASE}/wx/login-by-idcard`,
    method: 'POST',
    data: { id_card: idCard },
    success: (res) => {
      if (res.statusCode === 200) {
        // 3. 保存用户信息和令牌
        this.saveUserSession(res.data, 'candidate');
        // 4. 绑定微信openid
        this.bindWechatOpenId(res.data.access_token);
        // 5. 跳转到考生主页
        wx.switchTab({
          url: '/pages/candidate/index/index'
        });
      } else {
        this.handleLoginError(res.data);
      }
    }
  });
}
```

**2.3 考务人员账号登录机制**
```javascript
// 考务人员登录核心逻辑
staffLogin(username, password) {
  // 1. 前端基础验证
  if (!username || !password) {
    wx.showToast({
      title: '请输入账号和密码',
      icon: 'error'
    });
    return;
  }
  
  // 2. 调用标准登录接口
  wx.request({
    url: `${API_BASE}/wx/login`,
    method: 'POST',
    data: {
      code: '', // 微信登录code（可选）
      username: username,
      password: password,
      user_type: 'staff'
    },
    success: (res) => {
      if (res.statusCode === 200) {
        // 3. 保存会话信息
        this.saveUserSession(res.data, 'staff');
        // 4. 跳转到考务工作台
        wx.switchTab({
          url: '/pages/staff/workspace/index'
        });
      } else {
        this.handleLoginError(res.data);
      }
    }
  });
}
```

**2.4 自动登录与会话管理**
```javascript
// 自动登录验证机制
autoLogin(userInfo, userRole) {
  // 1. 检查令牌有效性
  wx.request({
    url: `${API_BASE}/wx/health`,
    method: 'GET',
    header: {
      'Authorization': `Bearer ${userInfo.access_token}`
    },
    success: (res) => {
      if (res.statusCode === 200) {
        // 令牌有效，直接跳转对应主页
        this.navigateToHomePage(userRole);
      } else {
        // 令牌失效，清除本地数据，重新登录
        this.clearUserSession();
        wx.navigateTo({
          url: '/pages/auth/role-select/index'
        });
      }
    }
  });
}
```

##### 3. API接口对接详情

**3.1 考生身份证登录接口**
```javascript
// API: POST /wx/login-by-idcard
// 请求参数：
{
  "id_card": "110101199001011234"  // 18位身份证号
}

// 响应数据：
{
  "message": "登录成功",
  "access_token": "candidate_1_1234",
  "candidate_info": {
    "id": 1,
    "name": "张三",
    "id_number": "110101199001011234",
    "phone": "13800138001",
    "exam_product": "无人机驾驶员考试",
    "institution": "北京航空培训中心",
    "status": "待排期"
  },
  "login_time": "2025-08-03T19:45:00"
}
```

**3.2 标准登录接口**
```javascript
// API: POST /wx/login
// 请求参数：
{
  "code": "微信登录code（可选）",
  "id_card": "身份证号（考生用）",
  "username": "用户名（考务用）",
  "password": "密码（考务用）"
}

// 响应数据：
{
  "access_token": "JWT令牌",
  "token_type": "bearer",
  "candidate_id": 1,  // 考生ID（考生登录时）
  "candidate_name": "张三",
  "phone": "13800138001",
  "status": "已排期"
}
```

**3.3 健康检查接口**
```javascript
// API: GET /wx/health
// 用途：验证服务可用性和令牌有效性
// 响应数据：
{
  "status": "healthy",
  "service": "微信小程序服务",
  "version": "1.0.0",
  "features": ["考生登录", "信息查询", "签到功能"]
}
```

##### 4. 技术实现细节

**4.1 身份证号验证算法**
```javascript
// 身份证号格式验证
validateIdCard(idCard) {
  // 基础格式检查
  if (!/^\d{17}[\dXx]$/.test(idCard)) {
    return false;
  }
  
  // 校验码验证
  const weights = [7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2];
  const checkCodes = ['1', '0', 'X', '9', '8', '7', '6', '5', '4', '3', '2'];
  
  let sum = 0;
  for (let i = 0; i < 17; i++) {
    sum += parseInt(idCard[i]) * weights[i];
  }
  
  const checkCode = checkCodes[sum % 11];
  return checkCode === idCard[17].toUpperCase();
}
```

**4.2 会话状态管理**
```javascript
// 用户会话管理工具类
class SessionManager {
  // 保存用户会话
  static saveUserSession(userData, userRole) {
    wx.setStorageSync('userInfo', userData);
    wx.setStorageSync('userRole', userRole);
    wx.setStorageSync('loginTime', new Date().getTime());
    
    // 设置全局请求头
    wx.setStorageSync('authToken', userData.access_token);
  }
  
  // 清除用户会话
  static clearUserSession() {
    wx.removeStorageSync('userInfo');
    wx.removeStorageSync('userRole');
    wx.removeStorageSync('loginTime');
    wx.removeStorageSync('authToken');
  }
  
  // 检查会话有效性
  static isSessionValid() {
    const loginTime = wx.getStorageSync('loginTime');
    const currentTime = new Date().getTime();
    const sessionTimeout = 24 * 60 * 60 * 1000; // 24小时
    
    return loginTime && (currentTime - loginTime < sessionTimeout);
  }
}
```

**4.3 微信OpenID绑定机制**
```javascript
// 绑定微信OpenID
bindWechatOpenId(accessToken) {
  wx.login({
    success: (res) => {
      if (res.code) {
        // 将微信code发送到后端进行OpenID绑定
        wx.request({
          url: `${API_BASE}/wx/bind-openid`,
          method: 'POST',
          header: {
            'Authorization': `Bearer ${accessToken}`
          },
          data: {
            wx_code: res.code
          },
          success: (bindRes) => {
            console.log('OpenID绑定成功', bindRes.data);
          }
        });
      }
    }
  });
}
```

##### 5. 用户体验优化

**5.1 加载状态管理**
```javascript
// 登录过程中的用户反馈
showLoginLoading() {
  wx.showLoading({
    title: '登录中...',
    mask: true
  });
}

hideLoginLoading() {
  wx.hideLoading();
}
```

**5.2 错误处理与用户提示**
```javascript
// 统一的错误处理机制
handleLoginError(errorData) {
  const errorMessages = {
    400: '输入信息格式不正确',
    404: '未找到该考生信息，请联系培训机构',
    403: '账号状态异常，无法登录',
    500: '系统繁忙，请稍后重试'
  };
  
  const message = errorMessages[errorData.status_code] || errorData.detail || '登录失败';
  
  wx.showModal({
    title: '登录失败',
    content: message,
    showCancel: false,
    confirmText: '确定'
  });
}
```

##### 6. 安全性考虑

**6.1 数据传输安全**
- 所有API请求使用HTTPS加密传输
- 敏感信息（如身份证号）在传输前进行基础验证
- 访问令牌采用JWT格式，包含过期时间

**6.2 本地存储安全**
- 敏感信息加密存储在本地
- 定期清理过期的会话数据
- 防止信息泄露的安全措施

**6.3 防重放攻击**
```javascript
// 请求防重复提交
let isSubmitting = false;

submitLogin() {
  if (isSubmitting) {
    wx.showToast({
      title: '请勿重复提交',
      icon: 'error'
    });
    return;
  }
  
  isSubmitting = true;
  
  // 执行登录逻辑
  this.performLogin().finally(() => {
    isSubmitting = false;
  });
}
```

##### 7. 数据流转详细设计

```
用户进入小程序
    ↓
检查本地会话状态
    ↓
[有效会话] → 自动登录验证 → [成功] → 跳转对应主页
    ↓                      ↓
[无效/无会话]              [失败] → 清除本地数据
    ↓                      ↓
显示角色选择页面 ←----------┘
    ↓
[考生] → 身份证登录页 → 输入身份证 → API验证 → 保存会话 → 考生主页
    ↓
[考务] → 账号登录页 → 输入账号密码 → API验证 → 保存会话 → 考务工作台
```

##### 8. 性能优化策略

**8.1 页面预加载**
```javascript
// 在角色选择页预加载后续页面
onReady() {
  // 预加载考生登录页
  wx.preloadPage({
    url: '/pages/auth/candidate-login/index'
  });
  
  // 预加载考务登录页
  wx.preloadPage({
    url: '/pages/auth/staff-login/index'
  });
}
```

**8.2 网络请求优化**
```javascript
// 网络请求封装，支持重试和缓存
class NetworkManager {
  static async request(options, retryCount = 3) {
    try {
      const response = await wx.request(options);
      return response;
    } catch (error) {
      if (retryCount > 0) {
        await this.delay(1000); // 延迟1秒重试
        return this.request(options, retryCount - 1);
      }
      throw error;
    }
  }
  
  static delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}
```

#### 模块总结
身份认证模块作为整个小程序的入口，需要在安全性、易用性、性能等方面做到平衡。通过双重登录机制（考生身份证登录 + 考务账号登录）、自动登录、会话管理等功能，为不同角色用户提供便捷而安全的身份验证服务。该模块的成功实现将为后续所有功能模块奠定坚实的基础。
# 考点运营与流程管理微信小程序 - 详细模块分析

## 一、模块总览

基于需求文档和现有API分析，微信小程序可划分为以下9个功能模块：

### 核心业务模块（6个）
1. **身份认证模块** - 用户登录和身份验证
2. **考生个人中心模块** - 个人信息展示和管理
3. **动态二维码模块** - 考生身份凭证生成和展示
4. **考试日程模块** - 个人考试安排和排队状态
5. **考务扫码模块** - 考务人员签到操作
6. **公共看板模块** - 实时考场状态广播

### 辅助支持模块（3个）
7. **消息通知模块** - 状态变更和重要提醒
8. **帮助指引模块** - 使用说明和常见问题
9. **系统设置模块** - 个人偏好和应用设置

---

## 二、详细模块分析

# 考点运营与流程管理微信小程序 - 详细模块分析

## 一、模块总览

基于需求文档和现有API分析，微信小程序可划分为以下9个功能模块：

### 核心业务模块（6个）
1. **身份认证模块** - 用户登录和身份验证
2. **考生个人中心模块** - 个人信息展示和管理
3. **动态二维码模块** - 考生身份凭证生成和展示
4. **考试日程模块** - 个人考试安排和排队状态
5. **考务扫码模块** - 考务人员签到操作
6. **公共看板模块** - 实时考场状态广播

### 辅助支持模块（3个）
7. **消息通知模块** - 状态变更和重要提醒
8. **帮助指引模块** - 使用说明和常见问题
9. **系统设置模块** - 个人偏好和应用设置

---

## 二、详细模块分析

### 模块1：身份认证模块

#### 功能描述
为考生和考务人员提供不同的登录方式，实现身份验证和权限分离。

#### 页面设计
- **登录选择页** - 用户角色选择（考生/考务人员）
- **考生登录页** - 身份证号快速登录
- **考务登录页** - 账号密码登录
- **登录结果页** - 登录成功/失败反馈

#### 核心功能点
1. **考生登录流程**：
   - 输入18位身份证号码
   - 系统验证身份证格式和考生信息
   - 绑定微信openid实现后续自动登录
   - 返回考生基本信息和访问令牌

2. **考务人员登录流程**：
   - 使用管理员分配的账号密码
   - 验证考务人员身份和权限
   - 进入考务工作台

3. **自动登录机制**：
   - 检测已绑定的微信用户
   - 自动跳转到对应角色的主页面

#### 对接API
- `POST /wx/login-by-idcard` - 考生身份证登录
- `POST /wx/login` - 标准登录接口
- `GET /wx/health` - 服务健康检查

#### 数据流转
```
用户输入 → 身份验证 → 角色判断 → 生成令牌 → 跳转主页
```

---

### 模块2：考生个人中心模块

#### 功能描述
展示考生的完整个人信息，包括基本资料、考试产品、培训机构等信息。

#### 页面设计
- **个人信息页** - 基本资料展示
- **考试信息页** - 考试产品和机构信息
- **状态概览页** - 当前考试状态和进度

#### 核心功能点
1. **基本信息展示**：
   - 考生姓名、身份证号（脱敏显示）
   - 联系电话、邮箱
   - 报名时间和当前状态

2. **考试相关信息**：
   - 报考的考试产品（如"多旋翼视距内驾驶员"）
   - 所属培训机构信息
   - 考试进度和完成状态

3. **状态跟踪**：
   - 当前考试阶段（待排期/已排期/考试中/已完成）
   - 下一步操作提示
   - 重要时间节点提醒

#### 对接API
- `GET /wx/candidate-info/{candidate_id}` - 获取考生详细信息

#### 数据展示结构
```json
{
  "basic_info": {
    "name": "张三",
    "id_number": "110101****1234",
    "phone": "138****8001",
    "status": "已排期"
  },
  "exam_info": {
    "product": "无人机驾驶员考试",
    "institution": "北京航空培训中心",
    "registration_date": "2025-08-01"
  }
}
```

---

# 考点运营与流程管理微信小程序 - 详细模块分析

## 一、模块总览

基于需求文档和现有API分析，微信小程序可划分为以下9个功能模块：

### 核心业务模块（6个）
1. **身份认证模块** - 用户登录和身份验证
2. **考生个人中心模块** - 个人信息展示和管理
3. **动态二维码模块** - 考生身份凭证生成和展示
4. **考试日程模块** - 个人考试安排和排队状态
5. **考务扫码模块** - 考务人员签到操作
6. **公共看板模块** - 实时考场状态广播

### 辅助支持模块（3个）
7. **消息通知模块** - 状态变更和重要提醒
8. **帮助指引模块** - 使用说明和常见问题
9. **系统设置模块** - 个人偏好和应用设置

---

## 二、详细模块分析

### 模块1：身份认证模块（详细设计）

#### 模块作用与重要性
身份认证模块是整个小程序的入口和安全基础，承担着用户身份验证、权限分离、会话管理等核心职责。该模块的设计质量直接影响用户体验和系统安全性。

#### 业务场景分析
1. **考生场景**：考生通过身份证号快速登录，无需记忆复杂账号密码，降低使用门槛
2. **考务人员场景**：考务人员使用管理员分配的专用账号，确保操作权限的严格控制
3. **自动登录场景**：已登录用户再次进入小程序时自动识别身份，提升使用便利性

#### 详细功能设计

##### 1. 页面架构设计
```
app.js (应用入口)
├── pages/auth/
│   ├── role-select/     # 角色选择页
│   ├── candidate-login/ # 考生登录页
│   ├── staff-login/     # 考务登录页
│   ├── login-result/    # 登录结果页
│   └── auto-login/      # 自动登录处理页
```

##### 2. 核心功能实现思路

**2.1 角色选择与路由分发**
```javascript
// 实现思路：智能角色识别
onLaunch() {
  // 检查本地存储的用户信息
  const userInfo = wx.getStorageSync('userInfo');
  const userRole = wx.getStorageSync('userRole');
  
  if (userInfo && userRole) {
    // 自动登录验证
    this.autoLogin(userInfo, userRole);
  } else {
    // 跳转角色选择页
    wx.navigateTo({
      url: '/pages/auth/role-select/index'
    });
  }
}
```

**2.2 考生身份证登录机制**
```javascript
// 考生登录核心逻辑
candidateLogin(idCard) {
  // 1. 前端验证身份证格式
  if (!this.validateIdCard(idCard)) {
    wx.showToast({
      title: '身份证格式不正确',
      icon: 'error'
    });
    return;
  }
  
  // 2. 调用后端API验证
  wx.request({
    url: `${API_BASE}/wx/login-by-idcard`,
    method: 'POST',
    data: { id_card: idCard },
    success: (res) => {
      if (res.statusCode === 200) {
        // 3. 保存用户信息和令牌
        this.saveUserSession(res.data, 'candidate');
        // 4. 绑定微信openid
        this.bindWechatOpenId(res.data.access_token);
        // 5. 跳转到考生主页
        wx.switchTab({
          url: '/pages/candidate/index/index'
        });
      } else {
        this.handleLoginError(res.data);
      }
    }
  });
}
```

**2.3 考务人员账号登录机制**
```javascript
// 考务人员登录核心逻辑
staffLogin(username, password) {
  // 1. 前端基础验证
  if (!username || !password) {
    wx.showToast({
      title: '请输入账号和密码',
      icon: 'error'
    });
    return;
  }
  
  // 2. 调用标准登录接口
  wx.request({
    url: `${API_BASE}/wx/login`,
    method: 'POST',
    data: {
      code: '', // 微信登录code（可选）
      username: username,
      password: password,
      user_type: 'staff'
    },
    success: (res) => {
      if (res.statusCode === 200) {
        // 3. 保存会话信息
        this.saveUserSession(res.data, 'staff');
        // 4. 跳转到考务工作台
        wx.switchTab({
          url: '/pages/staff/workspace/index'
        });
      } else {
        this.handleLoginError(res.data);
      }
    }
  });
}
```

**2.4 自动登录与会话管理**
```javascript
// 自动登录验证机制
autoLogin(userInfo, userRole) {
  // 1. 检查令牌有效性
  wx.request({
    url: `${API_BASE}/wx/health`,
    method: 'GET',
    header: {
      'Authorization': `Bearer ${userInfo.access_token}`
    },
    success: (res) => {
      if (res.statusCode === 200) {
        // 令牌有效，直接跳转对应主页
        this.navigateToHomePage(userRole);
      } else {
        // 令牌失效，清除本地数据，重新登录
        this.clearUserSession();
        wx.navigateTo({
          url: '/pages/auth/role-select/index'
        });
      }
    }
  });
}
```

##### 3. API接口对接详情

**3.1 考生身份证登录接口**
```javascript
// API: POST /wx/login-by-idcard
// 请求参数：
{
  "id_card": "110101199001011234"  // 18位身份证号
}

// 响应数据：
{
  "message": "登录成功",
  "access_token": "candidate_1_1234",
  "candidate_info": {
    "id": 1,
    "name": "张三",
    "id_number": "110101199001011234",
    "phone": "13800138001",
    "exam_product": "无人机驾驶员考试",
    "institution": "北京航空培训中心",
    "status": "待排期"
  },
  "login_time": "2025-08-03T19:45:00"
}
```

**3.2 标准登录接口**
```javascript
// API: POST /wx/login
// 请求参数：
{
  "code": "微信登录code（可选）",
  "id_card": "身份证号（考生用）",
  "username": "用户名（考务用）",
  "password": "密码（考务用）"
}

// 响应数据：
{
  "access_token": "JWT令牌",
  "token_type": "bearer",
  "candidate_id": 1,  // 考生ID（考生登录时）
  "candidate_name": "张三",
  "phone": "13800138001",
  "status": "已排期"
}
```

**3.3 健康检查接口**
```javascript
// API: GET /wx/health
// 用途：验证服务可用性和令牌有效性
// 响应数据：
{
  "status": "healthy",
  "service": "微信小程序服务",
  "version": "1.0.0",
  "features": ["考生登录", "信息查询", "签到功能"]
}
```

##### 4. 技术实现细节

**4.1 身份证号验证算法**
```javascript
// 身份证号格式验证
validateIdCard(idCard) {
  // 基础格式检查
  if (!/^\d{17}[\dXx]$/.test(idCard)) {
    return false;
  }
  
  // 校验码验证
  const weights = [7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2];
  const checkCodes = ['1', '0', 'X', '9', '8', '7', '6', '5', '4', '3', '2'];
  
  let sum = 0;
  for (let i = 0; i < 17; i++) {
    sum += parseInt(idCard[i]) * weights[i];
  }
  
  const checkCode = checkCodes[sum % 11];
  return checkCode === idCard[17].toUpperCase();
}
```

**4.2 会话状态管理**
```javascript
// 用户会话管理工具类
class SessionManager {
  // 保存用户会话
  static saveUserSession(userData, userRole) {
    wx.setStorageSync('userInfo', userData);
    wx.setStorageSync('userRole', userRole);
    wx.setStorageSync('loginTime', new Date().getTime());
    
    // 设置全局请求头
    wx.setStorageSync('authToken', userData.access_token);
  }
  
  // 清除用户会话
  static clearUserSession() {
    wx.removeStorageSync('userInfo');
    wx.removeStorageSync('userRole');
    wx.removeStorageSync('loginTime');
    wx.removeStorageSync('authToken');
  }
  
  // 检查会话有效性
  static isSessionValid() {
    const loginTime = wx.getStorageSync('loginTime');
    const currentTime = new Date().getTime();
    const sessionTimeout = 24 * 60 * 60 * 1000; // 24小时
    
    return loginTime && (currentTime - loginTime < sessionTimeout);
  }
}
```

**4.3 微信OpenID绑定机制**
```javascript
// 绑定微信OpenID
bindWechatOpenId(accessToken) {
  wx.login({
    success: (res) => {
      if (res.code) {
        // 将微信code发送到后端进行OpenID绑定
        wx.request({
          url: `${API_BASE}/wx/bind-openid`,
          method: 'POST',
          header: {
            'Authorization': `Bearer ${accessToken}`
          },
          data: {
            wx_code: res.code
          },
          success: (bindRes) => {
            console.log('OpenID绑定成功', bindRes.data);
          }
        });
      }
    }
  });
}
```

##### 5. 用户体验优化

**5.1 加载状态管理**
```javascript
// 登录过程中的用户反馈
showLoginLoading() {
  wx.showLoading({
    title: '登录中...',
    mask: true
  });
}

hideLoginLoading() {
  wx.hideLoading();
}
```

**5.2 错误处理与用户提示**
```javascript
// 统一的错误处理机制
handleLoginError(errorData) {
  const errorMessages = {
    400: '输入信息格式不正确',
    404: '未找到该考生信息，请联系培训机构',
    403: '账号状态异常，无法登录',
    500: '系统繁忙，请稍后重试'
  };
  
  const message = errorMessages[errorData.status_code] || errorData.detail || '登录失败';
  
  wx.showModal({
    title: '登录失败',
    content: message,
    showCancel: false,
    confirmText: '确定'
  });
}
```

##### 6. 安全性考虑

**6.1 数据传输安全**
- 所有API请求使用HTTPS加密传输
- 敏感信息（如身份证号）在传输前进行基础验证
- 访问令牌采用JWT格式，包含过期时间

**6.2 本地存储安全**
- 敏感信息加密存储在本地
- 定期清理过期的会话数据
- 防止信息泄露的安全措施

**6.3 防重放攻击**
```javascript
// 请求防重复提交
let isSubmitting = false;

submitLogin() {
  if (isSubmitting) {
    wx.showToast({
      title: '请勿重复提交',
      icon: 'error'
    });
    return;
  }
  
  isSubmitting = true;
  
  // 执行登录逻辑
  this.performLogin().finally(() => {
    isSubmitting = false;
  });
}
```

##### 7. 数据流转详细设计

```
用户进入小程序
    ↓
检查本地会话状态
    ↓
[有效会话] → 自动登录验证 → [成功] → 跳转对应主页
    ↓                      ↓
[无效/无会话]              [失败] → 清除本地数据
    ↓                      ↓
显示角色选择页面 ←----------┘
    ↓
[考生] → 身份证登录页 → 输入身份证 → API验证 → 保存会话 → 考生主页
    ↓
[考务] → 账号登录页 → 输入账号密码 → API验证 → 保存会话 → 考务工作台
```

##### 8. 性能优化策略

**8.1 页面预加载**
```javascript
// 在角色选择页预加载后续页面
onReady() {
  // 预加载考生登录页
  wx.preloadPage({
    url: '/pages/auth/candidate-login/index'
  });
  
  // 预加载考务登录页
  wx.preloadPage({
    url: '/pages/auth/staff-login/index'
  });
}
```

**8.2 网络请求优化**
```javascript
// 网络请求封装，支持重试和缓存
class NetworkManager {
  static async request(options, retryCount = 3) {
    try {
      const response = await wx.request(options);
      return response;
    } catch (error) {
      if (retryCount > 0) {
        await this.delay(1000); // 延迟1秒重试
        return this.request(options, retryCount - 1);
      }
      throw error;
    }
  }
  
  static delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}
```

#### 模块总结
身份认证模块作为整个小程序的入口，需要在安全性、易用性、性能等方面做到平衡。通过双重登录机制（考生身份证登录 + 考务账号登录）、自动登录、会话管理等功能，为不同角色用户提供便捷而安全的身份验证服务。该模块的成功实现将为后续所有功能模块奠定坚实的基础。
# 考点运营与流程管理微信小程序 - 详细模块分析

## 一、模块总览

基于需求文档和现有API分析，微信小程序可划分为以下9个功能模块：

### 核心业务模块（6个）
1. **身份认证模块** - 用户登录和身份验证
2. **考生个人中心模块** - 个人信息展示和管理
3. **动态二维码模块** - 考生身份凭证生成和展示
4. **考试日程模块** - 个人考试安排和排队状态
5. **考务扫码模块** - 考务人员签到操作
6. **公共看板模块** - 实时考场状态广播

### 辅助支持模块（3个）
7. **消息通知模块** - 状态变更和重要提醒
8. **帮助指引模块** - 使用说明和常见问题
9. **系统设置模块** - 个人偏好和应用设置

---

## 二、详细模块分析

# 考点运营与流程管理微信小程序 - 详细模块分析

## 一、模块总览

基于需求文档和现有API分析，微信小程序可划分为以下9个功能模块：

### 核心业务模块（6个）
1. **身份认证模块** - 用户登录和身份验证
2. **考生个人中心模块** - 个人信息展示和管理
3. **动态二维码模块** - 考生身份凭证生成和展示
4. **考试日程模块** - 个人考试安排和排队状态
5. **考务扫码模块** - 考务人员签到操作
6. **公共看板模块** - 实时考场状态广播

### 辅助支持模块（3个）
7. **消息通知模块** - 状态变更和重要提醒
8. **帮助指引模块** - 使用说明和常见问题
9. **系统设置模块** - 个人偏好和应用设置

---

## 二、详细模块分析

### 模块1：身份认证模块

#### 功能描述
为考生和考务人员提供不同的登录方式，实现身份验证和权限分离。

#### 页面设计
- **登录选择页** - 用户角色选择（考生/考务人员）
- **考生登录页** - 身份证号快速登录
- **考务登录页** - 账号密码登录
- **登录结果页** - 登录成功/失败反馈

#### 核心功能点
1. **考生登录流程**：
   - 输入18位身份证号码
   - 系统验证身份证格式和考生信息
   - 绑定微信openid实现后续自动登录
   - 返回考生基本信息和访问令牌

2. **考务人员登录流程**：
   - 使用管理员分配的账号密码
   - 验证考务人员身份和权限
   - 进入考务工作台

3. **自动登录机制**：
   - 检测已绑定的微信用户
   - 自动跳转到对应角色的主页面

#### 对接API
- `POST /wx/login-by-idcard` - 考生身份证登录
- `POST /wx/login` - 标准登录接口
- `GET /wx/health` - 服务健康检查

#### 数据流转
```
用户输入 → 身份验证 → 角色判断 → 生成令牌 → 跳转主页
```

---

### 模块2：考生个人中心模块（详细设计）

#### 模块作用与重要性
考生个人中心模块是考生了解自身考试状态、查看个人信息的核心入口。该模块承担着信息展示、状态跟踪、用户引导等重要职责，是提升考生体验和减少咨询压力的关键模块。

#### 业务场景分析
1. **信息查询场景**：考生需要快速了解自己的基本信息、考试产品、培训机构等
2. **状态跟踪场景**：考生关心当前考试进度，下一步需要做什么
3. **问题排查场景**：当考生遇到问题时，需要通过个人信息进行自助排查

#### 详细功能设计

##### 1. 页面架构设计
```
pages/candidate/
├── profile/
│   ├── index/           # 个人中心主页
│   ├── basic-info/      # 基本信息详情页
│   ├── exam-info/       # 考试信息详情页
│   ├── status-track/    # 状态跟踪页
│   └── progress-guide/  # 进度指引页
```

##### 2. 核心功能实现思路

**2.1 个人信息数据获取与缓存**
```javascript
// 个人信息管理类
class CandidateProfileManager {
  constructor() {
    this.candidateId = wx.getStorageSync('userInfo').candidate_id;
    this.profileData = null;
    this.lastUpdateTime = 0;
    this.cacheExpireTime = 5 * 60 * 1000; // 5分钟缓存
  }
  
  // 获取考生详细信息
  async getCandidateInfo(forceRefresh = false) {
    // 检查缓存有效性
    if (!forceRefresh && this.profileData && 
        (Date.now() - this.lastUpdateTime < this.cacheExpireTime)) {
      return this.profileData;
    }
    
    try {
      wx.showLoading({ title: '加载中...' });
      
      const response = await wx.request({
        url: `${API_BASE}/wx/candidate-info/${this.candidateId}`,
        method: 'GET',
        header: {
          'Authorization': `Bearer ${wx.getStorageSync('authToken')}`
        }
      });
      
      if (response.statusCode === 200) {
        this.profileData = response.data.data;
        this.lastUpdateTime = Date.now();
        
        // 缓存到本地存储
        wx.setStorageSync('candidateProfile', this.profileData);
        
        return this.profileData;
      } else {
        throw new Error(response.data.detail || '获取信息失败');
      }
    } catch (error) {
      // 网络异常时使用本地缓存
      const cachedData = wx.getStorageSync('candidateProfile');
      if (cachedData) {
        console.warn('使用缓存数据:', error.message);
        return cachedData;
      }
      throw error;
    } finally {
      wx.hideLoading();
    }
  }
}
```

**2.2 信息展示与数据处理**
```javascript
// 个人中心页面逻辑
Page({
  data: {
    candidateInfo: {},
    statusConfig: {
      '待排期': { color: '#ff9500', icon: 'clock' },
      '已排期': { color: '#007aff', icon: 'calendar' },
      '考试中': { color: '#34c759', icon: 'play' },
      '已完成': { color: '#8e8e93', icon: 'checkmark' }
    },
    loading: true,
    error: null
  },
  
  async onLoad() {
    await this.loadCandidateInfo();
  },
  
  async onPullDownRefresh() {
    await this.loadCandidateInfo(true);
    wx.stopPullDownRefresh();
  },
  
  // 加载考生信息
  async loadCandidateInfo(forceRefresh = false) {
    try {
      this.setData({ loading: true, error: null });
      
      const profileManager = new CandidateProfileManager();
      const candidateInfo = await profileManager.getCandidateInfo(forceRefresh);
      
      // 数据处理和格式化
      const processedInfo = this.processCandidateInfo(candidateInfo);
      
      this.setData({
        candidateInfo: processedInfo,
        loading: false
      });
      
    } catch (error) {
      console.error('加载考生信息失败:', error);
      this.setData({
        error: error.message,
        loading: false
      });
      
      wx.showToast({
        title: '加载失败，请重试',
        icon: 'error'
      });
    }
  },
  
  // 数据处理和格式化
  processCandidateInfo(rawData) {
    return {
      // 基本信息处理
      basicInfo: {
        name: rawData.name,
        idNumber: this.maskIdNumber(rawData.id_number),
        phone: this.maskPhone(rawData.phone),
        email: rawData.email || '未填写',
        registrationDate: this.formatDate(rawData.registration_date),
        status: rawData.status
      },
      
      // 考试信息处理
      examInfo: {
        product: rawData.exam_product,
        institution: rawData.institution,
        institutionId: rawData.institution_id
      },
      
      // 状态信息处理
      statusInfo: {
        current: rawData.status,
        nextStep: this.getNextStepGuide(rawData.status),
        progress: this.calculateProgress(rawData.status),
        upcomingSchedules: rawData.upcoming_schedules || []
      }
    };
  }
}
```

**2.3 敏感信息脱敏处理**
```javascript
// 数据脱敏工具方法
const DataMaskUtils = {
  // 身份证号脱敏
  maskIdNumber(idNumber) {
    if (!idNumber || idNumber.length !== 18) return idNumber;
    return idNumber.substring(0, 6) + '****' + idNumber.substring(14);
  },
  
  // 手机号脱敏
  maskPhone(phone) {
    if (!phone || phone.length !== 11) return phone;
    return phone.substring(0, 3) + '****' + phone.substring(7);
  },
  
  // 邮箱脱敏
  maskEmail(email) {
    if (!email || !email.includes('@')) return email;
    const [username, domain] = email.split('@');
    const maskedUsername = username.length > 2 
      ? username.substring(0, 2) + '***' 
      : username;
    return maskedUsername + '@' + domain;
  }
};
```

##### 3. API接口对接详情

**3.1 考生详细信息接口**
```javascript
// API: GET /wx/candidate-info/{candidate_id}
// 请求头：Authorization: Bearer {access_token}

// 响应数据结构：
{
  "message": "考生信息获取成功",
  "data": {
    "id": 1,
    "name": "张三",
    "id_number": "110101199001011234",
    "phone": "13800138001",
    "email": "zhangsan@example.com",
    "exam_product": "无人机驾驶员考试",
    "institution": "北京航空培训中心",
    "institution_id": 1,
    "status": "已排期",
    "registration_date": "2025-08-01",
    "upcoming_schedules": [
      {
        "id": 1,
        "activity_name": "理论考试",
        "exam_date": "2025-08-15",
        "start_time": "09:00",
        "end_time": "10:30",
        "venue": "理论考场A",
        "status": "scheduled"
      }
    ],
    "current_queue_info": {
      "venue": "实操场地1",
      "position": 3,
      "estimated_wait_time": "约45分钟"
    }
  }
}
```

##### 4. 用户界面设计

**4.1 个人中心主页布局**
```xml
<!-- 个人中心主页模板 -->
<view class="profile-container">
  <!-- 头部信息卡片 -->
  <view class="profile-header">
    <view class="avatar-section">
      <image class="avatar" src="{{candidateInfo.avatar || '/images/default-avatar.png'}}" />
      <view class="status-badge status-{{candidateInfo.basicInfo.status}}">
        {{candidateInfo.basicInfo.status}}
      </view>
    </view>
    
    <view class="basic-info">
      <text class="name">{{candidateInfo.basicInfo.name}}</text>
      <text class="id-number">{{candidateInfo.basicInfo.idNumber}}</text>
      <text class="phone">{{candidateInfo.basicInfo.phone}}</text>
    </view>
  </view>
  
  <!-- 考试信息卡片 -->
  <view class="exam-info-card">
    <view class="card-title">考试信息</view>
    <view class="info-item">
      <text class="label">考试产品：</text>
      <text class="value">{{candidateInfo.examInfo.product}}</text>
    </view>
    <view class="info-item">
      <text class="label">培训机构：</text>
      <text class="value">{{candidateInfo.examInfo.institution}}</text>
    </view>
    <view class="info-item">
      <text class="label">报名时间：</text>
      <text class="value">{{candidateInfo.basicInfo.registrationDate}}</text>
    </view>
  </view>
  
  <!-- 状态跟踪卡片 -->
  <view class="status-track-card">
    <view class="card-title">考试进度</view>
    <view class="progress-bar">
      <view class="progress-fill" style="width: {{candidateInfo.statusInfo.progress}}%"></view>
    </view>
    <view class="next-step">
      <text class="step-title">下一步：</text>
      <text class="step-content">{{candidateInfo.statusInfo.nextStep}}</text>
    </view>
  </view>
  
  <!-- 功能入口 -->
  <view class="function-entries">
    <navigator url="/pages/candidate/schedule/index" class="entry-item">
      <image class="entry-icon" src="/images/schedule-icon.png" />
      <text class="entry-text">考试安排</text>
    </navigator>
    
    <navigator url="/pages/candidate/qrcode/index" class="entry-item">
      <image class="entry-icon" src="/images/qrcode-icon.png" />
      <text class="entry-text">我的二维码</text>
    </navigator>
    
    <navigator url="/pages/public/venues/index" class="entry-item">
      <image class="entry-icon" src="/images/venues-icon.png" />
      <text class="entry-text">考场状态</text>
    </navigator>
  </view>
</view>
```

**4.2 状态指示与进度计算**
```javascript
// 状态处理工具类
class StatusManager {
  // 获取下一步操作指引
  static getNextStepGuide(currentStatus) {
    const stepGuides = {
      '待排期': '请耐心等待考务管理员为您安排考试时间',
      '已排期': '请查看考试安排，准时参加考试',
      '考试中': '请按照考务人员指引完成考试流程',
      '已完成': '考试已完成，请等待成绩公布'
    };
    
    return stepGuides[currentStatus] || '请联系培训机构了解详情';
  }
  
  // 计算考试进度百分比
  static calculateProgress(currentStatus) {
    const progressMap = {
      '待排期': 25,
      '已排期': 50,
      '考试中': 75,
      '已完成': 100
    };
    
    return progressMap[currentStatus] || 0;
  }
  
  // 获取状态颜色配置
  static getStatusColor(status) {
    const colorMap = {
      '待排期': '#ff9500',
      '已排期': '#007aff',
      '考试中': '#34c759',
      '已完成': '#8e8e93'
    };
    
    return colorMap[status] || '#8e8e93';
  }
}
```

##### 5. 交互体验优化

**5.1 下拉刷新与上拉加载**
```javascript
// 下拉刷新实现
onPullDownRefresh() {
  this.loadCandidateInfo(true).then(() => {
    wx.stopPullDownRefresh();
    wx.showToast({
      title: '刷新成功',
      icon: 'success',
      duration: 1500
    });
  });
},

// 页面显示时自动刷新
onShow() {
  // 如果数据超过5分钟，自动刷新
  const lastUpdate = wx.getStorageSync('profileLastUpdate') || 0;
  if (Date.now() - lastUpdate > 5 * 60 * 1000) {
    this.loadCandidateInfo(true);
  }
}
```

**5.2 错误处理与重试机制**
```javascript
// 错误处理组件
const ErrorHandler = {
  // 显示错误信息
  showError(error, retryCallback) {
    wx.showModal({
      title: '加载失败',
      content: error.message || '网络异常，请检查网络连接',
      confirmText: '重试',
      cancelText: '取消',
      success: (res) => {
        if (res.confirm && retryCallback) {
          retryCallback();
        }
      }
    });
  },
  
  // 网络状态检查
  checkNetworkStatus() {
    return new Promise((resolve) => {
      wx.getNetworkType({
        success: (res) => {
          if (res.networkType === 'none') {
            wx.showToast({
              title: '网络连接异常',
              icon: 'error'
            });
            resolve(false);
          } else {
            resolve(true);
          }
        }
      });
    });
  }
};
```

##### 6. 数据同步与状态管理

**6.1 全局状态同步**
```javascript
// 全局状态管理
const GlobalState = {
  candidateInfo: null,
  
  // 更新考生信息
  updateCandidateInfo(newInfo) {
    this.candidateInfo = newInfo;
    
    // 通知其他页面更新
    wx.$emit('candidateInfoUpdated', newInfo);
    
    // 更新本地存储
    wx.setStorageSync('candidateProfile', newInfo);
  },
  
  // 获取考生信息
  getCandidateInfo() {
    if (!this.candidateInfo) {
      this.candidateInfo = wx.getStorageSync('candidateProfile');
    }
    return this.candidateInfo;
  }
};
```

**6.2 数据变更监听**
```javascript
// 页面数据变更监听
onLoad() {
  // 监听考生信息更新事件
  wx.$on('candidateInfoUpdated', (newInfo) => {
    this.setData({
      candidateInfo: this.processCandidateInfo(newInfo)
    });
  });
  
  // 监听考试状态变更
  wx.$on('examStatusChanged', (newStatus) => {
    this.updateExamStatus(newStatus);
  });
},

onUnload() {
  // 清理事件监听
  wx.$off('candidateInfoUpdated');
  wx.$off('examStatusChanged');
}
```

##### 7. 性能优化策略

**7.1 图片懒加载**
```javascript
// 图片懒加载实现
const ImageLazyLoader = {
  // 观察器实例
  observer: null,
  
  // 初始化懒加载
  init() {
    this.observer = wx.createIntersectionObserver();
    
    this.observer.relativeToViewport().observe('.lazy-image', (res) => {
      if (res.intersectionRatio > 0) {
        // 图片进入视口，开始加载
        const dataset = res.target.dataset;
        if (dataset.src) {
          res.target.src = dataset.src;
          res.target.classList.remove('lazy-image');
        }
      }
    });
  },
  
  // 销毁观察器
  destroy() {
    if (this.observer) {
      this.observer.disconnect();
    }
  }
};
```

**7.2 数据预加载**
```javascript
// 相关数据预加载
preloadRelatedData() {
  // 预加载考试安排数据
  wx.request({
    url: `${API_BASE}/wx/candidate-info/${this.candidateId}`,
    method: 'GET',
    header: {
      'Authorization': `Bearer ${wx.getStorageSync('authToken')}`
    },
    success: (res) => {
      // 缓存预加载的数据
      wx.setStorageSync('preloadedSchedules', res.data.upcoming_schedules);
    }
  });
}
```

#### 模块总结
考生个人中心模块通过清晰的信息展示、智能的状态跟踪、友好的交互体验，为考生提供了全面的个人信息管理功能。该模块不仅展示静态信息，更重要的是通过状态跟踪和进度指引，帮助考生了解当前所处的考试阶段和下一步操作，大大减少了考生的困惑和咨询需求。通过合理的缓存策略和性能优化，确保了良好的用户体验。
# 考点运营与流程管理微信小程序 - 详细模块分析

## 一、模块总览

基于需求文档和现有API分析，微信小程序可划分为以下9个功能模块：

### 核心业务模块（6个）
1. **身份认证模块** - 用户登录和身份验证
2. **考生个人中心模块** - 个人信息展示和管理
3. **动态二维码模块** - 考生身份凭证生成和展示
4. **考试日程模块** - 个人考试安排和排队状态
5. **考务扫码模块** - 考务人员签到操作
6. **公共看板模块** - 实时考场状态广播

### 辅助支持模块（3个）
7. **消息通知模块** - 状态变更和重要提醒
8. **帮助指引模块** - 使用说明和常见问题
9. **系统设置模块** - 个人偏好和应用设置

---

## 二、详细模块分析

### 模块1：身份认证模块（详细设计）

#### 模块作用与重要性
身份认证模块是整个小程序的入口和安全基础，承担着用户身份验证、权限分离、会话管理等核心职责。该模块的设计质量直接影响用户体验和系统安全性。

#### 业务场景分析
1. **考生场景**：考生通过身份证号快速登录，无需记忆复杂账号密码，降低使用门槛
2. **考务人员场景**：考务人员使用管理员分配的专用账号，确保操作权限的严格控制
3. **自动登录场景**：已登录用户再次进入小程序时自动识别身份，提升使用便利性

#### 详细功能设计

##### 1. 页面架构设计
```
app.js (应用入口)
├── pages/auth/
│   ├── role-select/     # 角色选择页
│   ├── candidate-login/ # 考生登录页
│   ├── staff-login/     # 考务登录页
│   ├── login-result/    # 登录结果页
│   └── auto-login/      # 自动登录处理页
```

##### 2. 核心功能实现思路

**2.1 角色选择与路由分发**
```javascript
// 实现思路：智能角色识别
onLaunch() {
  // 检查本地存储的用户信息
  const userInfo = wx.getStorageSync('userInfo');
  const userRole = wx.getStorageSync('userRole');
  
  if (userInfo && userRole) {
    // 自动登录验证
    this.autoLogin(userInfo, userRole);
  } else {
    // 跳转角色选择页
    wx.navigateTo({
      url: '/pages/auth/role-select/index'
    });
  }
}
```

**2.2 考生身份证登录机制**
```javascript
// 考生登录核心逻辑
candidateLogin(idCard) {
  // 1. 前端验证身份证格式
  if (!this.validateIdCard(idCard)) {
    wx.showToast({
      title: '身份证格式不正确',
      icon: 'error'
    });
    return;
  }
  
  // 2. 调用后端API验证
  wx.request({
    url: `${API_BASE}/wx/login-by-idcard`,
    method: 'POST',
    data: { id_card: idCard },
    success: (res) => {
      if (res.statusCode === 200) {
        // 3. 保存用户信息和令牌
        this.saveUserSession(res.data, 'candidate');
        // 4. 绑定微信openid
        this.bindWechatOpenId(res.data.access_token);
        // 5. 跳转到考生主页
        wx.switchTab({
          url: '/pages/candidate/index/index'
        });
      } else {
        this.handleLoginError(res.data);
      }
    }
  });
}
```

**2.3 考务人员账号登录机制**
```javascript
// 考务人员登录核心逻辑
staffLogin(username, password) {
  // 1. 前端基础验证
  if (!username || !password) {
    wx.showToast({
      title: '请输入账号和密码',
      icon: 'error'
    });
    return;
  }
  
  // 2. 调用标准登录接口
  wx.request({
    url: `${API_BASE}/wx/login`,
    method: 'POST',
    data: {
      code: '', // 微信登录code（可选）
      username: username,
      password: password,
      user_type: 'staff'
    },
    success: (res) => {
      if (res.statusCode === 200) {
        // 3. 保存会话信息
        this.saveUserSession(res.data, 'staff');
        // 4. 跳转到考务工作台
        wx.switchTab({
          url: '/pages/staff/workspace/index'
        });
      } else {
        this.handleLoginError(res.data);
      }
    }
  });
}
```

**2.4 自动登录与会话管理**
```javascript
// 自动登录验证机制
autoLogin(userInfo, userRole) {
  // 1. 检查令牌有效性
  wx.request({
    url: `${API_BASE}/wx/health`,
    method: 'GET',
    header: {
      'Authorization': `Bearer ${userInfo.access_token}`
    },
    success: (res) => {
      if (res.statusCode === 200) {
        // 令牌有效，直接跳转对应主页
        this.navigateToHomePage(userRole);
      } else {
        // 令牌失效，清除本地数据，重新登录
        this.clearUserSession();
        wx.navigateTo({
          url: '/pages/auth/role-select/index'
        });
      }
    }
  });
}
```

##### 3. API接口对接详情

**3.1 考生身份证登录接口**
```javascript
// API: POST /wx/login-by-idcard
// 请求参数：
{
  "id_card": "110101199001011234"  // 18位身份证号
}

// 响应数据：
{
  "message": "登录成功",
  "access_token": "candidate_1_1234",
  "candidate_info": {
    "id": 1,
    "name": "张三",
    "id_number": "110101199001011234",
    "phone": "13800138001",
    "exam_product": "无人机驾驶员考试",
    "institution": "北京航空培训中心",
    "status": "待排期"
  },
  "login_time": "2025-08-03T19:45:00"
}
```

**3.2 标准登录接口**
```javascript
// API: POST /wx/login
// 请求参数：
{
  "code": "微信登录code（可选）",
  "id_card": "身份证号（考生用）",
  "username": "用户名（考务用）",
  "password": "密码（考务用）"
}

// 响应数据：
{
  "access_token": "JWT令牌",
  "token_type": "bearer",
  "candidate_id": 1,  // 考生ID（考生登录时）
  "candidate_name": "张三",
  "phone": "13800138001",
  "status": "已排期"
}
```

**3.3 健康检查接口**
```javascript
// API: GET /wx/health
// 用途：验证服务可用性和令牌有效性
// 响应数据：
{
  "status": "healthy",
  "service": "微信小程序服务",
  "version": "1.0.0",
  "features": ["考生登录", "信息查询", "签到功能"]
}
```

##### 4. 技术实现细节

**4.1 身份证号验证算法**
```javascript
// 身份证号格式验证
validateIdCard(idCard) {
  // 基础格式检查
  if (!/^\d{17}[\dXx]$/.test(idCard)) {
    return false;
  }
  
  // 校验码验证
  const weights = [7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2];
  const checkCodes = ['1', '0', 'X', '9', '8', '7', '6', '5', '4', '3', '2'];
  
  let sum = 0;
  for (let i = 0; i < 17; i++) {
    sum += parseInt(idCard[i]) * weights[i];
  }
  
  const checkCode = checkCodes[sum % 11];
  return checkCode === idCard[17].toUpperCase();
}
```

**4.2 会话状态管理**
```javascript
// 用户会话管理工具类
class SessionManager {
  // 保存用户会话
  static saveUserSession(userData, userRole) {
    wx.setStorageSync('userInfo', userData);
    wx.setStorageSync('userRole', userRole);
    wx.setStorageSync('loginTime', new Date().getTime());
    
    // 设置全局请求头
    wx.setStorageSync('authToken', userData.access_token);
  }
  
  // 清除用户会话
  static clearUserSession() {
    wx.removeStorageSync('userInfo');
    wx.removeStorageSync('userRole');
    wx.removeStorageSync('loginTime');
    wx.removeStorageSync('authToken');
  }
  
  // 检查会话有效性
  static isSessionValid() {
    const loginTime = wx.getStorageSync('loginTime');
    const currentTime = new Date().getTime();
    const sessionTimeout = 24 * 60 * 60 * 1000; // 24小时
    
    return loginTime && (currentTime - loginTime < sessionTimeout);
  }
}
```

**4.3 微信OpenID绑定机制**
```javascript
// 绑定微信OpenID
bindWechatOpenId(accessToken) {
  wx.login({
    success: (res) => {
      if (res.code) {
        // 将微信code发送到后端进行OpenID绑定
        wx.request({
          url: `${API_BASE}/wx/bind-openid`,
          method: 'POST',
          header: {
            'Authorization': `Bearer ${accessToken}`
          },
          data: {
            wx_code: res.code
          },
          success: (bindRes) => {
            console.log('OpenID绑定成功', bindRes.data);
          }
        });
      }
    }
  });
}
```

##### 5. 用户体验优化

**5.1 加载状态管理**
```javascript
// 登录过程中的用户反馈
showLoginLoading() {
  wx.showLoading({
    title: '登录中...',
    mask: true
  });
}

hideLoginLoading() {
  wx.hideLoading();
}
```

**5.2 错误处理与用户提示**
```javascript
// 统一的错误处理机制
handleLoginError(errorData) {
  const errorMessages = {
    400: '输入信息格式不正确',
    404: '未找到该考生信息，请联系培训机构',
    403: '账号状态异常，无法登录',
    500: '系统繁忙，请稍后重试'
  };
  
  const message = errorMessages[errorData.status_code] || errorData.detail || '登录失败';
  
  wx.showModal({
    title: '登录失败',
    content: message,
    showCancel: false,
    confirmText: '确定'
  });
}
```

##### 6. 安全性考虑

**6.1 数据传输安全**
- 所有API请求使用HTTPS加密传输
- 敏感信息（如身份证号）在传输前进行基础验证
- 访问令牌采用JWT格式，包含过期时间

**6.2 本地存储安全**
- 敏感信息加密存储在本地
- 定期清理过期的会话数据
- 防止信息泄露的安全措施

**6.3 防重放攻击**
```javascript
// 请求防重复提交
let isSubmitting = false;

submitLogin() {
  if (isSubmitting) {
    wx.showToast({
      title: '请勿重复提交',
      icon: 'error'
    });
    return;
  }
  
  isSubmitting = true;
  
  // 执行登录逻辑
  this.performLogin().finally(() => {
    isSubmitting = false;
  });
}
```

##### 7. 数据流转详细设计

```
用户进入小程序
    ↓
检查本地会话状态
    ↓
[有效会话] → 自动登录验证 → [成功] → 跳转对应主页
    ↓                      ↓
[无效/无会话]              [失败] → 清除本地数据
    ↓                      ↓
显示角色选择页面 ←----------┘
    ↓
[考生] → 身份证登录页 → 输入身份证 → API验证 → 保存会话 → 考生主页
    ↓
[考务] → 账号登录页 → 输入账号密码 → API验证 → 保存会话 → 考务工作台
```

##### 8. 性能优化策略

**8.1 页面预加载**
```javascript
// 在角色选择页预加载后续页面
onReady() {
  // 预加载考生登录页
  wx.preloadPage({
    url: '/pages/auth/candidate-login/index'
  });
  
  // 预加载考务登录页
  wx.preloadPage({
    url: '/pages/auth/staff-login/index'
  });
}
```

**8.2 网络请求优化**
```javascript
// 网络请求封装，支持重试和缓存
class NetworkManager {
  static async request(options, retryCount = 3) {
    try {
      const response = await wx.request(options);
      return response;
    } catch (error) {
      if (retryCount > 0) {
        await this.delay(1000); // 延迟1秒重试
        return this.request(options, retryCount - 1);
      }
      throw error;
    }
  }
  
  static delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}
```

#### 模块总结
身份认证模块作为整个小程序的入口，需要在安全性、易用性、性能等方面做到平衡。通过双重登录机制（考生身份证登录 + 考务账号登录）、自动登录、会话管理等功能，为不同角色用户提供便捷而安全的身份验证服务。该模块的成功实现将为后续所有功能模块奠定坚实的基础。
# 考点运营与流程管理微信小程序 - 详细模块分析

## 一、模块总览

基于需求文档和现有API分析，微信小程序可划分为以下9个功能模块：

### 核心业务模块（6个）
1. **身份认证模块** - 用户登录和身份验证
2. **考生个人中心模块** - 个人信息展示和管理
3. **动态二维码模块** - 考生身份凭证生成和展示
4. **考试日程模块** - 个人考试安排和排队状态
5. **考务扫码模块** - 考务人员签到操作
6. **公共看板模块** - 实时考场状态广播

### 辅助支持模块（3个）
7. **消息通知模块** - 状态变更和重要提醒
8. **帮助指引模块** - 使用说明和常见问题
9. **系统设置模块** - 个人偏好和应用设置

---

## 二、详细模块分析

# 考点运营与流程管理微信小程序 - 详细模块分析

## 一、模块总览

基于需求文档和现有API分析，微信小程序可划分为以下9个功能模块：

### 核心业务模块（6个）
1. **身份认证模块** - 用户登录和身份验证
2. **考生个人中心模块** - 个人信息展示和管理
3. **动态二维码模块** - 考生身份凭证生成和展示
4. **考试日程模块** - 个人考试安排和排队状态
5. **考务扫码模块** - 考务人员签到操作
6. **公共看板模块** - 实时考场状态广播

### 辅助支持模块（3个）
7. **消息通知模块** - 状态变更和重要提醒
8. **帮助指引模块** - 使用说明和常见问题
9. **系统设置模块** - 个人偏好和应用设置

---

## 二、详细模块分析

### 模块1：身份认证模块

#### 功能描述
为考生和考务人员提供不同的登录方式，实现身份验证和权限分离。

#### 页面设计
- **登录选择页** - 用户角色选择（考生/考务人员）
- **考生登录页** - 身份证号快速登录
- **考务登录页** - 账号密码登录
- **登录结果页** - 登录成功/失败反馈

#### 核心功能点
1. **考生登录流程**：
   - 输入18位身份证号码
   - 系统验证身份证格式和考生信息
   - 绑定微信openid实现后续自动登录
   - 返回考生基本信息和访问令牌

2. **考务人员登录流程**：
   - 使用管理员分配的账号密码
   - 验证考务人员身份和权限
   - 进入考务工作台

3. **自动登录机制**：
   - 检测已绑定的微信用户
   - 自动跳转到对应角色的主页面

#### 对接API
- `POST /wx/login-by-idcard` - 考生身份证登录
- `POST /wx/login` - 标准登录接口
- `GET /wx/health` - 服务健康检查

#### 数据流转
```
用户输入 → 身份验证 → 角色判断 → 生成令牌 → 跳转主页
```

---

# 考点运营与流程管理微信小程序 - 详细模块分析

## 一、模块总览

基于需求文档和现有API分析，微信小程序可划分为以下9个功能模块：

### 核心业务模块（6个）
1. **身份认证模块** - 用户登录和身份验证
2. **考生个人中心模块** - 个人信息展示和管理
3. **动态二维码模块** - 考生身份凭证生成和展示
4. **考试日程模块** - 个人考试安排和排队状态
5. **考务扫码模块** - 考务人员签到操作
6. **公共看板模块** - 实时考场状态广播

### 辅助支持模块（3个）
7. **消息通知模块** - 状态变更和重要提醒
8. **帮助指引模块** - 使用说明和常见问题
9. **系统设置模块** - 个人偏好和应用设置

---

## 二、详细模块分析

### 模块1：身份认证模块（详细设计）

#### 模块作用与重要性
身份认证模块是整个小程序的入口和安全基础，承担着用户身份验证、权限分离、会话管理等核心职责。该模块的设计质量直接影响用户体验和系统安全性。

#### 业务场景分析
1. **考生场景**：考生通过身份证号快速登录，无需记忆复杂账号密码，降低使用门槛
2. **考务人员场景**：考务人员使用管理员分配的专用账号，确保操作权限的严格控制
3. **自动登录场景**：已登录用户再次进入小程序时自动识别身份，提升使用便利性

#### 详细功能设计

##### 1. 页面架构设计
```
app.js (应用入口)
├── pages/auth/
│   ├── role-select/     # 角色选择页
│   ├── candidate-login/ # 考生登录页
│   ├── staff-login/     # 考务登录页
│   ├── login-result/    # 登录结果页
│   └── auto-login/      # 自动登录处理页
```

##### 2. 核心功能实现思路

**2.1 角色选择与路由分发**
```javascript
// 实现思路：智能角色识别
onLaunch() {
  // 检查本地存储的用户信息
  const userInfo = wx.getStorageSync('userInfo');
  const userRole = wx.getStorageSync('userRole');
  
  if (userInfo && userRole) {
    // 自动登录验证
    this.autoLogin(userInfo, userRole);
  } else {
    // 跳转角色选择页
    wx.navigateTo({
      url: '/pages/auth/role-select/index'
    });
  }
}
```

**2.2 考生身份证登录机制**
```javascript
// 考生登录核心逻辑
candidateLogin(idCard) {
  // 1. 前端验证身份证格式
  if (!this.validateIdCard(idCard)) {
    wx.showToast({
      title: '身份证格式不正确',
      icon: 'error'
    });
    return;
  }
  
  // 2. 调用后端API验证
  wx.request({
    url: `${API_BASE}/wx/login-by-idcard`,
    method: 'POST',
    data: { id_card: idCard },
    success: (res) => {
      if (res.statusCode === 200) {
        // 3. 保存用户信息和令牌
        this.saveUserSession(res.data, 'candidate');
        // 4. 绑定微信openid
        this.bindWechatOpenId(res.data.access_token);
        // 5. 跳转到考生主页
        wx.switchTab({
          url: '/pages/candidate/index/index'
        });
      } else {
        this.handleLoginError(res.data);
      }
    }
  });
}
```

**2.3 考务人员账号登录机制**
```javascript
// 考务人员登录核心逻辑
staffLogin(username, password) {
  // 1. 前端基础验证
  if (!username || !password) {
    wx.showToast({
      title: '请输入账号和密码',
      icon: 'error'
    });
    return;
  }
  
  // 2. 调用标准登录接口
  wx.request({
    url: `${API_BASE}/wx/login`,
    method: 'POST',
    data: {
      code: '', // 微信登录code（可选）
      username: username,
      password: password,
      user_type: 'staff'
    },
    success: (res) => {
      if (res.statusCode === 200) {
        // 3. 保存会话信息
        this.saveUserSession(res.data, 'staff');
        // 4. 跳转到考务工作台
        wx.switchTab({
          url: '/pages/staff/workspace/index'
        });
      } else {
        this.handleLoginError(res.data);
      }
    }
  });
}
```

**2.4 自动登录与会话管理**
```javascript
// 自动登录验证机制
autoLogin(userInfo, userRole) {
  // 1. 检查令牌有效性
  wx.request({
    url: `${API_BASE}/wx/health`,
    method: 'GET',
    header: {
      'Authorization': `Bearer ${userInfo.access_token}`
    },
    success: (res) => {
      if (res.statusCode === 200) {
        // 令牌有效，直接跳转对应主页
        this.navigateToHomePage(userRole);
      } else {
        // 令牌失效，清除本地数据，重新登录
        this.clearUserSession();
        wx.navigateTo({
          url: '/pages/auth/role-select/index'
        });
      }
    }
  });
}
```

##### 3. API接口对接详情

**3.1 考生身份证登录接口**
```javascript
// API: POST /wx/login-by-idcard
// 请求参数：
{
  "id_card": "110101199001011234"  // 18位身份证号
}

// 响应数据：
{
  "message": "登录成功",
  "access_token": "candidate_1_1234",
  "candidate_info": {
    "id": 1,
    "name": "张三",
    "id_number": "110101199001011234",
    "phone": "13800138001",
    "exam_product": "无人机驾驶员考试",
    "institution": "北京航空培训中心",
    "status": "待排期"
  },
  "login_time": "2025-08-03T19:45:00"
}
```

**3.2 标准登录接口**
```javascript
// API: POST /wx/login
// 请求参数：
{
  "code": "微信登录code（可选）",
  "id_card": "身份证号（考生用）",
  "username": "用户名（考务用）",
  "password": "密码（考务用）"
}

// 响应数据：
{
  "access_token": "JWT令牌",
  "token_type": "bearer",
  "candidate_id": 1,  // 考生ID（考生登录时）
  "candidate_name": "张三",
  "phone": "13800138001",
  "status": "已排期"
}
```

**3.3 健康检查接口**
```javascript
// API: GET /wx/health
// 用途：验证服务可用性和令牌有效性
// 响应数据：
{
  "status": "healthy",
  "service": "微信小程序服务",
  "version": "1.0.0",
  "features": ["考生登录", "信息查询", "签到功能"]
}
```

##### 4. 技术实现细节

**4.1 身份证号验证算法**
```javascript
// 身份证号格式验证
validateIdCard(idCard) {
  // 基础格式检查
  if (!/^\d{17}[\dXx]$/.test(idCard)) {
    return false;
  }
  
  // 校验码验证
  const weights = [7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2];
  const checkCodes = ['1', '0', 'X', '9', '8', '7', '6', '5', '4', '3', '2'];
  
  let sum = 0;
  for (let i = 0; i < 17; i++) {
    sum += parseInt(idCard[i]) * weights[i];
  }
  
  const checkCode = checkCodes[sum % 11];
  return checkCode === idCard[17].toUpperCase();
}
```

**4.2 会话状态管理**
```javascript
// 用户会话管理工具类
class SessionManager {
  // 保存用户会话
  static saveUserSession(userData, userRole) {
    wx.setStorageSync('userInfo', userData);
    wx.setStorageSync('userRole', userRole);
    wx.setStorageSync('loginTime', new Date().getTime());
    
    // 设置全局请求头
    wx.setStorageSync('authToken', userData.access_token);
  }
  
  // 清除用户会话
  static clearUserSession() {
    wx.removeStorageSync('userInfo');
    wx.removeStorageSync('userRole');
    wx.removeStorageSync('loginTime');
    wx.removeStorageSync('authToken');
  }
  
  // 检查会话有效性
  static isSessionValid() {
    const loginTime = wx.getStorageSync('loginTime');
    const currentTime = new Date().getTime();
    const sessionTimeout = 24 * 60 * 60 * 1000; // 24小时
    
    return loginTime && (currentTime - loginTime < sessionTimeout);
  }
}
```

**4.3 微信OpenID绑定机制**
```javascript
// 绑定微信OpenID
bindWechatOpenId(accessToken) {
  wx.login({
    success: (res) => {
      if (res.code) {
        // 将微信code发送到后端进行OpenID绑定
        wx.request({
          url: `${API_BASE}/wx/bind-openid`,
          method: 'POST',
          header: {
            'Authorization': `Bearer ${accessToken}`
          },
          data: {
            wx_code: res.code
          },
          success: (bindRes) => {
            console.log('OpenID绑定成功', bindRes.data);
          }
        });
      }
    }
  });
}
```

##### 5. 用户体验优化

**5.1 加载状态管理**
```javascript
// 登录过程中的用户反馈
showLoginLoading() {
  wx.showLoading({
    title: '登录中...',
    mask: true
  });
}

hideLoginLoading() {
  wx.hideLoading();
}
```

**5.2 错误处理与用户提示**
```javascript
// 统一的错误处理机制
handleLoginError(errorData) {
  const errorMessages = {
    400: '输入信息格式不正确',
    404: '未找到该考生信息，请联系培训机构',
    403: '账号状态异常，无法登录',
    500: '系统繁忙，请稍后重试'
  };
  
  const message = errorMessages[errorData.status_code] || errorData.detail || '登录失败';
  
  wx.showModal({
    title: '登录失败',
    content: message,
    showCancel: false,
    confirmText: '确定'
  });
}
```

##### 6. 安全性考虑

**6.1 数据传输安全**
- 所有API请求使用HTTPS加密传输
- 敏感信息（如身份证号）在传输前进行基础验证
- 访问令牌采用JWT格式，包含过期时间

**6.2 本地存储安全**
- 敏感信息加密存储在本地
- 定期清理过期的会话数据
- 防止信息泄露的安全措施

**6.3 防重放攻击**
```javascript
// 请求防重复提交
let isSubmitting = false;

submitLogin() {
  if (isSubmitting) {
    wx.showToast({
      title: '请勿重复提交',
      icon: 'error'
    });
    return;
  }
  
  isSubmitting = true;
  
  // 执行登录逻辑
  this.performLogin().finally(() => {
    isSubmitting = false;
  });
}
```

##### 7. 数据流转详细设计

```
用户进入小程序
    ↓
检查本地会话状态
    ↓
[有效会话] → 自动登录验证 → [成功] → 跳转对应主页
    ↓                      ↓
[无效/无会话]              [失败] → 清除本地数据
    ↓                      ↓
显示角色选择页面 ←----------┘
    ↓
[考生] → 身份证登录页 → 输入身份证 → API验证 → 保存会话 → 考生主页
    ↓
[考务] → 账号登录页 → 输入账号密码 → API验证 → 保存会话 → 考务工作台
```

##### 8. 性能优化策略

**8.1 页面预加载**
```javascript
// 在角色选择页预加载后续页面
onReady() {
  // 预加载考生登录页
  wx.preloadPage({
    url: '/pages/auth/candidate-login/index'
  });
  
  // 预加载考务登录页
  wx.preloadPage({
    url: '/pages/auth/staff-login/index'
  });
}
```

**8.2 网络请求优化**
```javascript
// 网络请求封装，支持重试和缓存
class NetworkManager {
  static async request(options, retryCount = 3) {
    try {
      const response = await wx.request(options);
      return response;
    } catch (error) {
      if (retryCount > 0) {
        await this.delay(1000); // 延迟1秒重试
        return this.request(options, retryCount - 1);
      }
      throw error;
    }
  }
  
  static delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}
```

#### 模块总结
身份认证模块作为整个小程序的入口，需要在安全性、易用性、性能等方面做到平衡。通过双重登录机制（考生身份证登录 + 考务账号登录）、自动登录、会话管理等功能，为不同角色用户提供便捷而安全的身份验证服务。该模块的成功实现将为后续所有功能模块奠定坚实的基础。
# 考点运营与流程管理微信小程序 - 详细模块分析

## 一、模块总览

基于需求文档和现有API分析，微信小程序可划分为以下9个功能模块：

### 核心业务模块（6个）
1. **身份认证模块** - 用户登录和身份验证
2. **考生个人中心模块** - 个人信息展示和管理
3. **动态二维码模块** - 考生身份凭证生成和展示
4. **考试日程模块** - 个人考试安排和排队状态
5. **考务扫码模块** - 考务人员签到操作
6. **公共看板模块** - 实时考场状态广播

### 辅助支持模块（3个）
7. **消息通知模块** - 状态变更和重要提醒
8. **帮助指引模块** - 使用说明和常见问题
9. **系统设置模块** - 个人偏好和应用设置

---

## 二、详细模块分析

# 考点运营与流程管理微信小程序 - 详细模块分析

## 一、模块总览

基于需求文档和现有API分析，微信小程序可划分为以下9个功能模块：

### 核心业务模块（6个）
1. **身份认证模块** - 用户登录和身份验证
2. **考生个人中心模块** - 个人信息展示和管理
3. **动态二维码模块** - 考生身份凭证生成和展示
4. **考试日程模块** - 个人考试安排和排队状态
5. **考务扫码模块** - 考务人员签到操作
6. **公共看板模块** - 实时考场状态广播

### 辅助支持模块（3个）
7. **消息通知模块** - 状态变更和重要提醒
8. **帮助指引模块** - 使用说明和常见问题
9. **系统设置模块** - 个人偏好和应用设置

---

## 二、详细模块分析

### 模块1：身份认证模块

#### 功能描述
为考生和考务人员提供不同的登录方式，实现身份验证和权限分离。

#### 页面设计
- **登录选择页** - 用户角色选择（考生/考务人员）
- **考生登录页** - 身份证号快速登录
- **考务登录页** - 账号密码登录
- **登录结果页** - 登录成功/失败反馈

#### 核心功能点
1. **考生登录流程**：
   - 输入18位身份证号码
   - 系统验证身份证格式和考生信息
   - 绑定微信openid实现后续自动登录
   - 返回考生基本信息和访问令牌

2. **考务人员登录流程**：
   - 使用管理员分配的账号密码
   - 验证考务人员身份和权限
   - 进入考务工作台

3. **自动登录机制**：
   - 检测已绑定的微信用户
   - 自动跳转到对应角色的主页面

#### 对接API
- `POST /wx/login-by-idcard` - 考生身份证登录
- `POST /wx/login` - 标准登录接口
- `GET /wx/health` - 服务健康检查

#### 数据流转
```
用户输入 → 身份验证 → 角色判断 → 生成令牌 → 跳转主页
```

---

### 模块2：考生个人中心模块

#### 功能描述
展示考生的完整个人信息，包括基本资料、考试产品、培训机构等信息。

#### 页面设计
- **个人信息页** - 基本资料展示
- **考试信息页** - 考试产品和机构信息
- **状态概览页** - 当前考试状态和进度

#### 核心功能点
1. **基本信息展示**：
   - 考生姓名、身份证号（脱敏显示）
   - 联系电话、邮箱
   - 报名时间和当前状态

2. **考试相关信息**：
   - 报考的考试产品（如"多旋翼视距内驾驶员"）
   - 所属培训机构信息
   - 考试进度和完成状态

3. **状态跟踪**：
   - 当前考试阶段（待排期/已排期/考试中/已完成）
   - 下一步操作提示
   - 重要时间节点提醒

#### 对接API
- `GET /wx/candidate-info/{candidate_id}` - 获取考生详细信息

#### 数据展示结构
```json
{
  "basic_info": {
    "name": "张三",
    "id_number": "110101****1234",
    "phone": "138****8001",
    "status": "已排期"
  },
  "exam_info": {
    "product": "无人机驾驶员考试",
    "institution": "北京航空培训中心",
    "registration_date": "2025-08-01"
  }
}
```

---

### 模块3：动态二维码模块（核心功能）

#### 功能描述
为考生生成动态身份二维码，作为现场签到的唯一凭证。

#### 页面设计
- **二维码展示页** - 主要的二维码显示界面
- **二维码说明页** - 使用方法和注意事项
- **刷新状态页** - 二维码更新和有效期提示

#### 核心功能点
1. **动态二维码生成**：
   - 包含考生ID和下一个待进行日程的ID
   - 自动关联考生的下一个考试安排
   - 包含时间戳和有效期验证

2. **自动刷新机制**：
   - 每5分钟自动刷新二维码
   - 考生状态变更时立即更新
   - 显示二维码剩余有效时间

3. **状态适配**：
   - 有考试安排时显示对应二维码
   - 无安排时显示"暂无考试安排"
   - 考试完成后显示完成状态

#### 对接API
- `GET /wx/my-qrcode/{candidate_id}` - 生成考生动态二维码

#### 二维码数据结构
```json
{
  "qr_data": {
    "type": "candidate_checkin",
    "candidate_id": 1,
    "schedule_id": 1,
    "candidate_name": "张三",
    "activity_name": "理论考试",
    "venue": "理论考场A",
    "timestamp": "2025-08-03T19:50:00",
    "valid_until": "2025-08-15T23:59:59"
  },
  "qr_url": "二维码图片URL",
  "refresh_interval": 300
}
```

---

### 模块4：考试日程模块

#### 功能描述
展示考生的完整考试安排，包括已完成和待进行的所有日程，以及实时排队状态。

#### 页面设计
- **日程列表页** - 所有考试安排的时间线展示
- **日程详情页** - 单个考试安排的详细信息
- **排队状态页** - 实时排队位置和等待时间

#### 核心功能点
1. **日程展示**：
   - 按时间顺序展示所有考试安排
   - 区分理论考试、实操考试、候考等类型
   - 显示考试时间、地点、状态

2. **实时排队状态**：
   - 显示当前在指定考场的排队位置
   - 预估等待时间
   - 前方考生数量

3. **状态跟踪**：
   - 待进行、进行中、已完成状态标识
   - 考试结果反馈（如适用）
   - 下一步操作指引

#### 对接API
- `GET /wx/candidate-info/{candidate_id}` - 获取考生日程信息

#### 日程数据结构
```json
{
  "upcoming_schedules": [
    {
      "id": 1,
      "activity_name": "理论考试",
      "exam_date": "2025-08-15",
      "start_time": "09:00",
      "end_time": "10:30",
      "venue": "理论考场A",
      "status": "scheduled"
    }
  ],
  "current_queue_info": {
    "venue": "实操场地1",
    "position": 3,
    "estimated_wait_time": "约45分钟"
  }
}
```

---

### 模块5：考务扫码模块（详细设计）

#### 模块作用与重要性
考务扫码模块是现场考务人员的核心工作工具，承担着考生身份验证、流程节点确认、状态更新等关键职责。该模块的效率和准确性直接影响现场考务工作的顺畅进行和考生体验。

#### 业务场景分析
1. **现场签到场景**：考务人员扫描考生二维码，确认考生身份并完成签到
2. **流程节点确认场景**：在考试的各个环节（理论考试、实操考试等）进行流程确认
3. **异常处理场景**：处理二维码无效、考生信息异常等特殊情况

#### 详细功能设计

##### 1. 页面架构设计
```
pages/staff/scan/
├── index/              # 考务工作台主页
├── result/             # 扫码结果页
├── history/            # 操作历史页
└── components/
    ├── scan-camera/    # 扫码相机组件
    ├── candidate-card/ # 考生信息卡片组件
    ├── result-feedback/ # 结果反馈组件
    └── operation-log/  # 操作日志组件
```

##### 2. 核心功能实现思路

**2.1 扫码管理核心类**
```javascript
// 扫码管理核心类
class ScanManager {
  constructor(staffId) {
    this.staffId = staffId;
    this.scanHistory = [];
    this.currentSession = null;
    this.isScanning = false;
  }
  
  // 开始扫码
  async startScan() {
    if (this.isScanning) {
      console.warn('扫码正在进行中');
      return;
    }
    
    try {
      this.isScanning = true;
      
      // 调用微信扫码API
      const scanResult = await wx.scanCode({
        onlyFromCamera: true,
        scanType: ['qrCode']
      });
      
      if (scanResult.result) {
        return await this.processScanResult(scanResult.result);
      } else {
        throw new Error('扫码结果为空');
      }
      
    } catch (error) {
      console.error('扫码失败:', error);
      
      if (error.errMsg && error.errMsg.includes('cancel')) {
        throw new Error('用户取消扫码');
      } else {
        throw new Error('扫码失败，请重试');
      }
    } finally {
      this.isScanning = false;
    }
  }
  
  // 处理扫码结果
  async processScanResult(qrData) {
    try {
      // 解析二维码数据
      const parsedData = this.parseQRCode(qrData);
      
      if (!parsedData) {
        throw new Error('二维码格式不正确');
      }
      
      // 验证二维码有效性
      const validationResult = await this.validateQRCode(parsedData);
      
      if (!validationResult.valid) {
        throw new Error(validationResult.message);
      }
      
      // 执行签到操作
      const checkInResult = await this.performCheckIn(parsedData);
      
      // 记录操作历史
      this.recordOperation({
        type: 'check_in',
        qrData: parsedData,
        result: checkInResult,
        timestamp: new Date().toISOString(),
        staffId: this.staffId
      });
      
      return {
        success: true,
        data: checkInResult,
        qrData: parsedData
      };
      
    } catch (error) {
      console.error('处理扫码结果失败:', error);
      
      // 记录失败操作
      this.recordOperation({
        type: 'check_in_failed',
        qrData: qrData,
        error: error.message,
        timestamp: new Date().toISOString(),
        staffId: this.staffId
      });
      
      throw error;
    }
  }
  
  // 解析二维码
  parseQRCode(qrData) {
    try {
      // 尝试解析JSON格式的二维码
      if (qrData.startsWith('{')) {
        return JSON.parse(qrData);
      }
      
      // 尝试解析URL格式的二维码
      if (qrData.startsWith('http')) {
        const url = new URL(qrData);
        const params = new URLSearchParams(url.search);
        
        return {
          type: 'candidate_checkin',
          candidate_id: parseInt(params.get('candidate_id')),
          schedule_id: parseInt(params.get('schedule_id')),
          timestamp: params.get('timestamp')
        };
      }
      
      // 尝试解析简单格式：schedule_1_candidate_1
      const simpleMatch = qrData.match(/schedule_(\d+)_candidate_(\d+)/);
      if (simpleMatch) {
        return {
          type: 'candidate_checkin',
          schedule_id: parseInt(simpleMatch[1]),
          candidate_id: parseInt(simpleMatch[2])
        };
      }
      
      return null;
      
    } catch (error) {
      console.error('解析二维码失败:', error);
      return null;
    }
  }
  
  // 验证二维码有效性
  async validateQRCode(qrData) {
    try {
      const response = await wx.request({
        url: `${API_BASE}/qrcode/validate`,
        method: 'POST',
        header: {
          'Authorization': `Bearer ${wx.getStorageSync('staffToken')}`,
          'Content-Type': 'application/json'
        },
        data: {
          qr_data: qrData,
          staff_id: this.staffId
        }
      });
      
      if (response.statusCode === 200) {
        return response.data;
      } else {
        return {
          valid: false,
          message: response.data.detail || '二维码验证失败'
        };
      }
      
    } catch (error) {
      console.error('验证二维码失败:', error);
      return {
        valid: false,
        message: '网络异常，验证失败'
      };
    }
  }
  
  // 执行签到操作
  async performCheckIn(qrData) {
    try {
      const response = await wx.request({
        url: `${API_BASE}/qrcode/checkin`,
        method: 'POST',
        header: {
          'Authorization': `Bearer ${wx.getStorageSync('staffToken')}`,
          'Content-Type': 'application/json'
        },
        data: {
          schedule_id: qrData.schedule_id,
          candidate_id: qrData.candidate_id,
          staff_id: this.staffId,
          scan_timestamp: new Date().toISOString(),
          qr_timestamp: qrData.timestamp
        }
      });
      
      if (response.statusCode === 200) {
        return response.data;
      } else {
        throw new Error(response.data.detail || '签到操作失败');
      }
      
    } catch (error) {
      console.error('执行签到失败:', error);
      throw error;
    }
  }
  
  // 记录操作历史
  recordOperation(operation) {
    this.scanHistory.unshift(operation);
    
    // 限制历史记录数量
    if (this.scanHistory.length > 100) {
      this.scanHistory = this.scanHistory.slice(0, 100);
    }
    
    // 持久化存储
    wx.setStorageSync('scanHistory', this.scanHistory);
    
    // 发送事件通知
    wx.eventBus && wx.eventBus.emit('scanOperationRecorded', operation);
  }
  
  // 获取操作历史
  getScanHistory(limit = 20) {
    return this.scanHistory.slice(0, limit);
  }
  
  // 清空操作历史
  clearScanHistory() {
    this.scanHistory = [];
    wx.removeStorageSync('scanHistory');
  }
  
  // 加载历史记录
  loadScanHistory() {
    const history = wx.getStorageSync('scanHistory') || [];
    this.scanHistory = history;
    return history;
  }
}
```

**2.2 考务工作台页面实现**
```javascript
// 考务工作台页面
Page({
  data: {
    staffInfo: null,
    scanCount: 0,
    todayScanCount: 0,
    recentOperations: [],
    isScanning: false,
    currentTime: '',
    workStatus: 'active', // active, break, offline
    scanStats: {
      success: 0,
      failed: 0,
      total: 0
    }
  },
  
  scanManager: null,
  timeTimer: null,
  
  onLoad() {
    this.initializePage();
  },
  
  onShow() {
    this.refreshPageData();
    this.startTimeUpdate();
  },
  
  onHide() {
    this.stopTimeUpdate();
  },
  
  onUnload() {
    this.cleanup();
  },
  
  // 初始化页面
  async initializePage() {
    try {
      // 获取考务人员信息
      const staffInfo = wx.getStorageSync('staffInfo');
      if (!staffInfo) {
        wx.redirectTo({
          url: '/pages/staff/login/index'
        });
        return;
      }
      
      this.setData({ staffInfo });
      
      // 初始化扫码管理器
      this.scanManager = new ScanManager(staffInfo.id);
      this.scanManager.loadScanHistory();
      
      // 加载页面数据
      await this.loadPageData();
      
    } catch (error) {
      console.error('初始化页面失败:', error);
      this.showErrorToast('初始化失败');
    }
  },
  
  // 加载页面数据
  async loadPageData() {
    try {
      // 获取今日扫码统计
      const stats = await this.getTodayStats();
      
      // 获取最近操作记录
      const recentOps = this.scanManager.getScanHistory(5);
      
      this.setData({
        scanCount: stats.total,
        todayScanCount: stats.today,
        scanStats: stats.details,
        recentOperations: recentOps
      });
      
    } catch (error) {
      console.error('加载页面数据失败:', error);
    }
  },
  
  // 刷新页面数据
  async refreshPageData() {
    await this.loadPageData();
  },
  
  // 开始扫码
  async onStartScan() {
    if (this.data.isScanning) {
      return;
    }
    
    try {
      this.setData({ isScanning: true });
      
      // 检查相机权限
      const authResult = await this.checkCameraAuth();
      if (!authResult) {
        throw new Error('需要相机权限才能扫码');
      }
      
      // 开始扫码
      const result = await this.scanManager.startScan();
      
      // 跳转到结果页面
      wx.navigateTo({
        url: `/pages/staff/scan/result/index?result=${encodeURIComponent(JSON.stringify(result))}`
      });
      
      // 刷新统计数据
      this.refreshPageData();
      
    } catch (error) {
      console.error('扫码失败:', error);
      
      if (error.message !== '用户取消扫码') {
        this.showScanError(error.message);
      }
    } finally {
      this.setData({ isScanning: false });
    }
  },
  
  // 检查相机权限
  async checkCameraAuth() {
    return new Promise((resolve) => {
      wx.getSetting({
        success: (res) => {
          if (res.authSetting['scope.camera'] === false) {
            // 权限被拒绝，引导用户开启
            wx.showModal({
              title: '需要相机权限',
              content: '扫码功能需要使用相机，请在设置中开启相机权限',
              confirmText: '去设置',
              success: (modalRes) => {
                if (modalRes.confirm) {
                  wx.openSetting({
                    success: (settingRes) => {
                      resolve(settingRes.authSetting['scope.camera'] === true);
                    },
                    fail: () => resolve(false)
                  });
                } else {
                  resolve(false);
                }
              }
            });
          } else {
            resolve(true);
          }
        },
        fail: () => resolve(false)
      });
    });
  },
  
  // 显示扫码错误
  showScanError(message) {
    wx.showModal({
      title: '扫码失败',
      content: message,
      showCancel: false,
      confirmText: '知道了'
    });
  },
  
  // 查看操作历史
  onViewHistory() {
    wx.navigateTo({
      url: '/pages/staff/scan/history/index'
    });
  },
  
  // 切换工作状态
  onToggleWorkStatus() {
    const currentStatus = this.data.workStatus;
    let newStatus;
    
    switch (currentStatus) {
      case 'active':
        newStatus = 'break';
        break;
      case 'break':
        newStatus = 'active';
        break;
      default:
        newStatus = 'active';
    }
    
    this.setData({ workStatus: newStatus });
    
    // 保存状态到本地
    wx.setStorageSync('workStatus', newStatus);
    
    // 显示状态变更提示
    const statusText = {
      'active': '工作中',
      'break': '休息中',
      'offline': '离线'
    };
    
    wx.showToast({
      title: `已切换到${statusText[newStatus]}`,
      icon: 'success'
    });
  },
  
  // 获取今日统计
  async getTodayStats() {
    try {
      const response = await wx.request({
        url: `${API_BASE}/staff/scan-stats/${this.data.staffInfo.id}`,
        method: 'GET',
        header: {
          'Authorization': `Bearer ${wx.getStorageSync('staffToken')}`
        }
      });
      
      if (response.statusCode === 200) {
        return response.data;
      } else {
        throw new Error('获取统计数据失败');
      }
    } catch (error) {
      console.error('获取统计数据失败:', error);
      return {
        total: 0,
        today: 0,
        details: { success: 0, failed: 0, total: 0 }
      };
    }
  },
  
  // 开始时间更新
  startTimeUpdate() {
    this.updateCurrentTime();
    this.timeTimer = setInterval(() => {
      this.updateCurrentTime();
    }, 1000);
  },
  
  // 停止时间更新
  stopTimeUpdate() {
    if (this.timeTimer) {
      clearInterval(this.timeTimer);
      this.timeTimer = null;
    }
  },
  
  // 更新当前时间
  updateCurrentTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('zh-CN', {
      hour12: false,
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    });
    
    this.setData({ currentTime: timeString });
  },
  
  // 显示错误提示
  showErrorToast(message) {
    wx.showToast({
      title: message,
      icon: 'none',
      duration: 2000
    });
  },
  
  // 清理资源
  cleanup() {
    this.stopTimeUpdate();
  }
});
```

##### 3. API接口对接详情

**3.1 二维码验证接口**
```javascript
// API: POST /qrcode/validate
// 请求头：Authorization: Bearer {staff_token}
// 请求体：
{
  "qr_data": {
    "type": "candidate_checkin",
    "candidate_id": 1,
    "schedule_id": 1,
    "timestamp": "2025-08-03T19:50:00"
  },
  "staff_id": 1
}

// 成功响应：
{
  "valid": true,
  "message": "二维码验证成功",
  "candidate_info": {
    "id": 1,
    "name": "张三",
    "id_number": "110101199001011234",
    "exam_product": "无人机驾驶员考试",
    "institution": "北京航空培训中心"
  },
  "schedule_info": {
    "id": 1,
    "activity_name": "理论考试",
    "exam_date": "2025-08-15",
    "start_time": "09:00",
    "venue": "理论考场A",
    "status": "scheduled"
  },
  "can_checkin": true,
  "checkin_window": {
    "start": "2025-08-15T08:30:00",
    "end": "2025-08-15T09:00:00"
  }
}

// 失败响应：
{
  "valid": false,
  "message": "二维码已过期",
  "error_code": "QR_EXPIRED"
}
```

**3.2 签到操作接口**
```javascript
// API: POST /qrcode/checkin
// 请求头：Authorization: Bearer {staff_token}
// 请求体：
{
  "schedule_id": 1,
  "candidate_id": 1,
  "staff_id": 1,
  "scan_timestamp": "2025-08-15T08:45:00",
  "qr_timestamp": "2025-08-03T19:50:00"
}

// 成功响应：
{
  "message": "签到成功",
  "checkin_id": 123,
  "candidate_info": {
    "id": 1,
    "name": "张三",
    "id_number": "110101199001011234"
  },
  "schedule_info": {
    "id": 1,
    "activity_name": "理论考试",
    "venue": "理论考场A"
  },
  "checkin_time": "2025-08-15T08:45:00",
  "next_schedule": {
    "id": 2,
    "activity_name": "实操考试",
    "exam_date": "2025-08-16",
    "start_time": "14:00"
  },
  "instructions": "请引导考生前往理论考场A参加考试"
}
```

##### 4. 用户界面设计

**4.1 考务工作台页面模板**
```xml
<!-- 考务工作台页面 -->
<view class="staff-workbench">
  <!-- 顶部状态栏 -->
  <view class="status-bar">
    <view class="staff-info">
      <image class="avatar" src="{{staffInfo.avatar || '/images/default-avatar.png'}}" />
      <view class="info-text">
        <text class="name">{{staffInfo.name}}</text>
        <text class="role">{{staffInfo.role_name}}</text>
      </view>
    </view>
    
    <view class="work-status">
      <view class="status-indicator {{workStatus}}"></view>
      <text class="status-text">{{workStatus === 'active' ? '工作中' : '休息中'}}</text>
      <text class="current-time">{{currentTime}}</text>
    </view>
  </view>
  
  <!-- 统计卡片 -->
  <view class="stats-cards">
    <view class="stat-card">
      <text class="stat-number">{{todayScanCount}}</text>
      <text class="stat-label">今日扫码</text>
    </view>
    
    <view class="stat-card">
      <text class="stat-number">{{scanStats.success}}</text>
      <text class="stat-label">成功签到</text>
    </view>
    
    <view class="stat-card">
      <text class="stat-number">{{scanStats.failed}}</text>
      <text class="stat-label">失败次数</text>
    </view>
    
    <view class="stat-card">
      <text class="stat-number">{{(scanStats.total > 0 ? (scanStats.success / scanStats.total * 100).toFixed(1) : 0)}}%</text>
      <text class="stat-label">成功率</text>
    </view>
  </view>
  
  <!-- 主要操作区域 -->
  <view class="main-actions">
    <!-- 扫码按钮 -->
    <view class="scan-button-container">
      <button 
        class="scan-button {{isScanning ? 'scanning' : ''}}" 
        bindtap="onStartScan"
        disabled="{{isScanning || workStatus !== 'active'}}"
      >
        <view class="scan-icon">
          <image wx:if="{{!isScanning}}" src="/images/scan-icon.png" />
          <view wx:else class="scanning-animation"></view>
        </view>
        <text class="scan-text">
          {{isScanning ? '扫码中...' : '开始扫码'}}
        </text>
      </button>
      
      <text class="scan-hint">
        {{workStatus === 'active' ? '点击按钮扫描考生二维码' : '请先切换到工作状态'}}
      </text>
    </view>
    
    <!-- 快捷操作 -->
    <view class="quick-actions">
      <button class="action-btn" bindtap="onViewHistory">
        <image class="btn-icon" src="/images/history.png" />
        <text class="btn-text">操作历史</text>
      </button>
      
      <button class="action-btn" bindtap="onToggleWorkStatus">
        <image class="btn-icon" src="/images/{{workStatus === 'active' ? 'break' : 'work'}}.png" />
        <text class="btn-text">{{workStatus === 'active' ? '休息' : '上班'}}</text>
      </button>
    </view>
  </view>
  
  <!-- 最近操作 -->
  <view wx:if="{{recentOperations.length > 0}}" class="recent-operations">
    <view class="section-header">
      <text class="section-title">最近操作</text>
      <text class="view-all" bindtap="onViewHistory">查看全部</text>
    </view>
    
    <view class="operations-list">
      <view 
        wx:for="{{recentOperations}}" 
        wx:key="timestamp" 
        class="operation-item {{item.type === 'check_in_failed' ? 'failed' : 'success'}}"
      >
        <view class="operation-icon">
          <image src="/images/{{item.type === 'check_in_failed' ? 'failed' : 'success'}}.png" />
        </view>
        
        <view class="operation-content">
          <text class="operation-title">
            {{item.type === 'check_in' ? '签到成功' : '签到失败'}}
          </text>
          <text class="operation-detail">
            {{item.qrData.candidate_name || '考生'}} - {{item.qrData.activity_name || '未知活动'}}
          </text>
          <text class="operation-time">{{formatTime(item.timestamp)}}</text>
        </view>
        
        <view class="operation-status">
          <text class="status-text">
            {{item.type === 'check_in' ? '成功' : '失败'}}
          </text>
        </view>
      </view>
    </view>
  </view>
  
  <!-- 空状态 -->
  <view wx:else class="empty-operations">
    <image class="empty-icon" src="/images/empty-operations.png" />
    <text class="empty-text">暂无操作记录</text>
    <text class="empty-hint">开始扫码后这里会显示操作历史</text>
  </view>
</view>
```

#### 模块总结
考务扫码模块作为现场考务人员的核心工作工具，通过智能的扫码识别、完善的验证机制、友好的操作界面和详细的操作记录，为考务人员提供了高效、准确的签到管理功能。该模块不仅要确保扫码操作的准确性和安全性，还要考虑用户体验、权限管理、异常处理等多个方面，是保障现场考务工作顺利进行的重要技术支撑。

---

### 模块6：公共看板模块

#### 功能描述
无需登录的公开页面，实时展示所有考场的使用状态和排队情况。

#### 页面设计
- **考场状态看板** - 所有考场的实时状态展示
- **考场详情页** - 单个考场的详细信息
- **刷新设置页** - 自动刷新间隔设置

#### 核心功能点
1. **实时状态展示**：
   - 所有考场的使用状态（空闲/使用中）
   - 当前考核的考生信息（脱敏显示）
   - 等待队列长度

2. **自动刷新机制**：
   - 每10-15秒自动刷新数据
   - 支持手动下拉刷新
   - 网络异常时的重试机制

3. **信息展示**：
   - 考场名称和类型
   - 当前占用率
   - 预估等待时间

#### 对接API
- `GET /public/venues-status` - 获取所有考场状态

#### 看板数据结构
```json
{
  "timestamp": "2025-08-03T20:00:00",
  "venues": [
    {
      "venue_id": 1,
      "venue_name": "理论考场A",
      "status": "使用中",
      "current_occupancy": 8,
      "total_capacity": 10,
      "occupancy_rate": 80.0,
      "current_candidate": "张*"
    }
  ]
}
```

---

### 模块7：消息通知模块

#### 功能描述
为用户提供重要状态变更和时间提醒的消息通知服务。

#### 页面设计
- **消息中心页** - 所有通知消息的列表
- **消息详情页** - 单条消息的详细内容
- **通知设置页** - 消息推送偏好设置

#### 核心功能点
1. **消息类型**：
   - 考试安排通知
   - 状态变更提醒
   - 排队位置更新
   - 系统重要公告

2. **推送机制**：
   - 微信小程序模板消息
   - 应用内消息提醒
   - 关键时间节点推送

3. **消息管理**：
   - 已读/未读状态管理
   - 消息分类和筛选
   - 历史消息查看

---

### 模块8：帮助指引模块

#### 功能描述
为用户提供系统使用说明、常见问题解答和操作指引。

#### 页面设计
- **帮助首页** - 功能导航和快速入口
- **使用指南页** - 详细的操作步骤说明
- **FAQ页面** - 常见问题和解答
- **联系客服页** - 技术支持联系方式

#### 核心功能点
1. **使用指南**：
   - 考生端操作流程说明
   - 考务端扫码操作指引
   - 二维码使用注意事项

2. **常见问题**：
   - 登录问题解决方案
   - 二维码显示异常处理
   - 考试安排查询方法

3. **技术支持**：
   - 在线客服联系方式
   - 问题反馈渠道
   - 系统更新说明

---

### 模块9：系统设置模块

#### 功能描述
提供个人偏好设置、缓存管理和应用配置功能。

#### 页面设计
- **设置首页** - 所有设置选项的入口
- **个人设置页** - 个人信息和偏好配置
- **系统设置页** - 应用行为和缓存管理
- **关于页面** - 应用版本和法律信息

#### 核心功能点
1. **个人设置**：
   - 消息推送偏好
   - 界面显示设置
   - 隐私保护选项

2. **系统管理**：
   - 缓存清理功能
   - 数据同步设置
   - 网络连接配置

3. **应用信息**：
   - 版本信息展示
   - 用户协议和隐私政策
   - 意见反馈入口

---

## 三、模块间交互关系

### 数据流转图
```
身份认证模块 → 个人中心模块 → 日程模块
     ↓              ↓           ↓
动态二维码模块 ← 消息通知模块 → 公共看板模块
     ↓              ↓           ↓
考务扫码模块 → 帮助指引模块 → 系统设置模块
```

### 核心业务流程
1. **考生使用流程**：登录 → 查看个人信息 → 查看考试安排 → 生成二维码 → 现场签到
2. **考务使用流程**：登录 → 进入工作台 → 扫码签到 → 确认结果
3. **公共查询流程**：直接访问 → 查看考场状态 → 了解排队情况

### 技术架构考虑
- **状态管理**：使用微信小程序的全局状态管理
- **数据缓存**：关键数据本地缓存，提升用户体验
- **网络处理**：统一的API调用封装和错误处理
- **权限控制**：基于用户角色的页面和功能访问控制

---

## 四、开发优先级建议

### 第一阶段（MVP核心功能）
1. 身份认证模块
2. 动态二维码模块
3. 考务扫码模块
4. 公共看板模块

### 第二阶段（完善功能）
5. 考生个人中心模块
6. 考试日程模块

### 第三阶段（增值功能）
7. 消息通知模块
8. 帮助指引模块
9. 系统设置模块

这样的模块划分既保证了核心业务功能的完整性，又为后续功能扩展预留了空间，符合MVP快速迭代的开发理念。